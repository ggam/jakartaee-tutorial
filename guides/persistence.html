<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.2">
<title>Persistence</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement when using as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-left">
<div id="header">
<h1>Persistence</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel2">
<li><a href="#introduction-to-jakarta-persistence">Introduction to Jakarta Persistence</a></li>
<li><a href="#running-the-persistence-examples">Running the Persistence Examples</a></li>
<li><a href="#the-jakarta-persistence-query-language">The Jakarta Persistence Query Language</a></li>
<li><a href="#using-the-criteria-api-to-create-queries">Using the Criteria API to Create Queries</a></li>
<li><a href="#creating-and-using-string-based-criteria-queries">Creating and Using String-Based Criteria Queries</a></li>
<li><a href="#controlling-concurrent-access-to-entity-data-with-locking">Controlling Concurrent Access to Entity Data with Locking</a></li>
<li><a href="#creating-fetch-plans-with-entity-graphs">Creating Fetch Plans with Entity Graphs</a></li>
<li><a href="#using-a-second-level-cache-with-jakarta-persistence-applications">Using a Second-Level Cache with Jakarta Persistence Applications</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect2">
<h3 id="introduction-to-jakarta-persistence"><a class="anchor" href="#introduction-to-jakarta-persistence"></a>Introduction to Jakarta Persistence</h3>
<div class="paragraph">
<p><a id="BNBPZ"></a><a id="introduction-to-the-java-persistence-api"></a></p>
</div>
<div class="paragraph">
<p>This chapter provides a description of Jakarta Persistence.</p>
</div>
<div class="paragraph">
<p><a id="A1019685"></a><a id="overview-of-the-java-persistence-api"></a></p>
</div>
<div class="sect3">
<h4 id="overview-of-jakarta-persistence"><a class="anchor" href="#overview-of-jakarta-persistence"></a>Overview of Jakarta Persistence</h4>
<div class="paragraph">
<p>Jakarta Persistence provides Java developers with an
object/relational mapping facility for managing relational data in Java
applications. Jakarta Persistence consists of four areas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Jakarta Persistence</p>
</li>
<li>
<p>The query language</p>
</li>
<li>
<p>The Jakarta Persistence Criteria API</p>
</li>
<li>
<p>Object/relational mapping metadata</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBQA"></a><a id="entities"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="entities"><a class="anchor" href="#entities"></a>Entities</h4>
<div class="paragraph">
<p>An entity is a lightweight persistence domain object. Typically, an
entity represents a table in a relational database, and each entity
instance corresponds to a row in that table. The primary programming
artifact of an entity is the entity class, although entities can use
helper classes.</p>
</div>
<div class="paragraph">
<p>The persistent state of an entity is represented through either
persistent fields or persistent properties. These fields or properties
use object/relational mapping annotations to map the entities and entity
relationships to the relational data in the underlying data store.</p>
</div>
<div class="paragraph">
<p><a id="BNBQB"></a><a id="requirements-for-entity-classes"></a></p>
</div>
<div class="sect4">
<h5 id="requirements-for-entity-classes"><a class="anchor" href="#requirements-for-entity-classes"></a>Requirements for Entity Classes</h5>
<div class="paragraph">
<p>An entity class must follow these requirements.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The class must be annotated with the <code>javax.persistence.Entity</code>
annotation.</p>
</li>
<li>
<p>The class must have a public or protected, no-argument constructor.
The class may have other constructors.</p>
</li>
<li>
<p>The class must not be declared <code>final</code>. No methods or persistent
instance variables must be declared <code>final</code>.</p>
</li>
<li>
<p>If an entity instance is passed by value as a detached object, such as
through a session bean&#8217;s remote business interface, the class must
implement the <code>Serializable</code> interface.</p>
</li>
<li>
<p>Entities may extend both entity and non-entity classes, and non-entity
classes may extend entity classes.</p>
</li>
<li>
<p>Persistent instance variables must be declared private, protected, or
package-private and can be accessed directly only by the entity class&#8217;s
methods. Clients must access the entity&#8217;s state through accessor or
business methods.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBQC"></a><a id="persistent-fields-and-properties-in-entity-classes"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="persistent-fields-and-properties-in-entity-classes"><a class="anchor" href="#persistent-fields-and-properties-in-entity-classes"></a>Persistent Fields and Properties in Entity Classes</h5>
<div class="paragraph">
<p>The persistent state of an entity can be accessed through either the
entity&#8217;s instance variables or properties. The fields or properties must
be of the following Java language types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java primitive types</p>
</li>
<li>
<p><code>java.lang.String</code></p>
</li>
<li>
<p>Other serializable types, including:</p>
<div class="ulist">
<ul>
<li>
<p>Wrappers of Java primitive types</p>
</li>
<li>
<p><code>java.math.BigInteger</code></p>
</li>
<li>
<p><code>java.math.BigDecimal</code></p>
</li>
<li>
<p><code>java.util.Date</code></p>
</li>
<li>
<p><code>java.util.Calendar</code></p>
</li>
<li>
<p><code>java.sql.Date</code></p>
</li>
<li>
<p><code>java.sql.Time</code></p>
</li>
<li>
<p><code>java.sql.TimeStamp</code></p>
</li>
<li>
<p>User-defined serializable types</p>
</li>
<li>
<p><code>byte[]</code></p>
</li>
<li>
<p><code>Byte[]</code></p>
</li>
<li>
<p><code>char[]</code></p>
</li>
<li>
<p><code>Character[]</code></p>
</li>
</ul>
</div>
</li>
<li>
<p>Enumerated types</p>
</li>
<li>
<p>Other entities and/or collections of entities</p>
</li>
<li>
<p>Embeddable classes</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Entities may use persistent fields, persistent properties, or a
combination of both. If the mapping annotations are applied to the
entity&#8217;s instance variables, the entity uses persistent fields. If the
mapping annotations are applied to the entity&#8217;s getter methods for
JavaBeans-style properties, the entity uses persistent properties.</p>
</div>
<div class="paragraph">
<p><a id="BNBQD"></a><a id="persistent-fields"></a></p>
</div>
<div class="sect5">
<h6 id="persistent-fields"><a class="anchor" href="#persistent-fields"></a>Persistent Fields</h6>
<div class="paragraph">
<p>If the entity class uses persistent fields, the Persistence runtime
accesses entity-class instance variables directly. All fields not
annotated <code>javax.persistence.Transient</code> or not marked as Java
<code>transient</code> will be persisted to the data store. The object/relational
mapping annotations must be applied to the instance variables.</p>
</div>
<div class="paragraph">
<p><a id="BNBQE"></a><a id="persistent-properties"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="persistent-properties"><a class="anchor" href="#persistent-properties"></a>Persistent Properties</h6>
<div class="paragraph">
<p>If the entity uses persistent properties, the entity must follow the
method conventions of JavaBeans components. JavaBeans-style properties
use getter and setter methods that are typically named after the entity
class&#8217;s instance variable names. For every persistent property property
of type Type of the entity, there is a getter method <code>get`Property and
setter method `set`Property. If the property is a Boolean, you may use
`is`Property instead of `get`Property. For example, if a `Customer</code>
entity uses persistent properties and has a private instance variable
called <code>firstName</code>, the class defines a <code>getFirstName</code> and
<code>setFirstName</code> method for retrieving and setting the state of the
<code>firstName</code> instance variable.</p>
</div>
<div class="paragraph">
<p>The method signatures for single-valued persistent properties are as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Type</span> getProperty()
<span class="type">void</span> setProperty(<span class="predefined-type">Type</span> type)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The object/relational mapping annotations for persistent properties must
be applied to the getter methods. Mapping annotations cannot be applied
to fields or properties annotated <code>@Transient</code> or marked <code>transient</code>.</p>
</div>
<div class="paragraph">
<p><a id="GIQVN"></a><a id="using-collections-in-entity-fields-and-properties"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="using-collections-in-entity-fields-and-properties"><a class="anchor" href="#using-collections-in-entity-fields-and-properties"></a>Using Collections in Entity Fields and Properties</h6>
<div class="paragraph">
<p>Collection-valued persistent fields and properties must use the
supported Java collection interfaces regardless of whether the entity
uses persistent fields or properties. The following collection
interfaces may be used:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java.util.Collection</code></p>
</li>
<li>
<p><code>java.util.Set</code></p>
</li>
<li>
<p><code>java.util.List</code></p>
</li>
<li>
<p><code>java.util.Map</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the entity class uses persistent fields, the type in the preceding
method signatures must be one of these collection types. Generic
variants of these collection types may also be used. For example, if it
has a persistent property that contains a set of phone numbers, the
<code>Customer</code> entity would have the following methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Set</span>&lt;PhoneNumber&gt; getPhoneNumbers() { ... }
<span class="type">void</span> setPhoneNumbers(<span class="predefined-type">Set</span>&lt;PhoneNumber&gt;) { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>If a field or property of an entity consists of a collection of basic
types or embeddable classes, use the
<code>javax.persistence.ElementCollection</code> annotation on the field or
property.</p>
</div>
<div class="paragraph">
<p>The two attributes of <code>@ElementCollection</code> are <code>targetClass</code> and
<code>fetch</code>. The <code>targetClass</code> attribute specifies the class name of the
basic or embeddable class and is optional if the field or property is
defined using Java programming language generics. The optional <code>fetch</code>
attribute is used to specify whether the collection should be retrieved
lazily or eagerly, using the <code>javax.persistence.FetchType</code> constants of
either <code>LAZY</code> or <code>EAGER</code>, respectively. By default, the collection will
be fetched lazily.</p>
</div>
<div class="paragraph">
<p>The following entity, <code>Person</code>, has a persistent field, <code>nicknames</code>,
which is a collection of <code>String</code> classes that will be fetched eagerly.
The <code>targetClass</code> element is not required, because it uses generics to
define the field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Person</span> {
    ...
    <span class="annotation">@ElementCollection</span>(fetch=EAGER)
    <span class="directive">protected</span> <span class="predefined-type">Set</span>&lt;<span class="predefined-type">String</span>&gt; nickname = <span class="keyword">new</span> <span class="predefined-type">HashSet</span>();
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Collections of entity elements and relationships may be represented by
<code>java.util.Map</code> collections. A <code>Map</code> consists of a key and a value.</p>
</div>
<div class="paragraph">
<p>When using <code>Map</code> elements or relationships, the following rules apply.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>Map</code> key or value may be a basic Java programming language type,
an embeddable class, or an entity.</p>
</li>
<li>
<p>When the <code>Map</code> value is an embeddable class or basic type, use the
<code>@ElementCollection</code> annotation.</p>
</li>
<li>
<p>When the <code>Map</code> value is an entity, use the <code>@OneToMany</code> or
<code>@ManyToMany</code> annotation.</p>
</li>
<li>
<p>Use the <code>Map</code> type on only one side of a bidirectional relationship.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the key type of a <code>Map</code> is a Java programming language basic type,
use the annotation <code>javax.persistence.MapKeyColumn</code> to set the column
mapping for the key. By default, the <code>name</code> attribute of <code>@MapKeyColumn</code>
is of the form RELATIONSHIP-FIELD/PROPERTY-NAME`_KEY`. For example, if
the referencing relationship field name is <code>image</code>, the default <code>name</code>
attribute is <code>IMAGE_KEY</code>.</p>
</div>
<div class="paragraph">
<p>If the key type of a <code>Map</code> is an entity, use the
<code>javax.persistence.MapKeyJoinColumn</code> annotation. If the multiple columns
are needed to set the mapping, use the annotation
<code>javax.persistence.MapKeyJoinColumns</code> to include multiple
<code>@MapKeyJoinColumn</code> annotations. If no <code>@MapKeyJoinColumn</code> is present,
the mapping column name is by default set to
RELATIONSHIP-FIELD/PROPERTY-NAME`_KEY`. For example, if the relationship
field name is <code>employee</code>, the default <code>name</code> attribute is
<code>EMPLOYEE_KEY</code>.</p>
</div>
<div class="paragraph">
<p>If Java programming language generic types are not used in the
relationship field or property, the key class must be explicitly set
using the <code>javax.persistence.MapKeyClass</code> annotation.</p>
</div>
<div class="paragraph">
<p>If the <code>Map</code> key is the primary key or a persistent field or property of
the entity that is the <code>Map</code> value, use the <code>javax.persistence.MapKey</code>
annotation. The <code>@MapKeyClass</code> and <code>@MapKey</code> annotations cannot be used
on the same field or property.</p>
</div>
<div class="paragraph">
<p>If the <code>Map</code> value is a Java programming language basic type or an
embeddable class, it will be mapped as a collection table in the
underlying database. If generic types are not used, the
<code>@ElementCollection</code> annotation&#8217;s <code>targetClass</code> attribute must be set to
the type of the <code>Map</code> value.</p>
</div>
<div class="paragraph">
<p>If the <code>Map</code> value is an entity and part of a many-to-many or
one-to-many unidirectional relationship, it will be mapped as a join
table in the underlying database. A unidirectional one-to-many
relationship that uses a <code>Map</code> may also be mapped using the
<code>@JoinColumn</code> annotation.</p>
</div>
<div class="paragraph">
<p>If the entity is part of a one-to-many/many-to-one bidirectional
relationship, it will be mapped in the table of the entity that
represents the value of the <code>Map</code>. If generic types are not used, the
<code>targetEntity</code> attribute of the <code>@OneToMany</code> and <code>@ManyToMany</code>
annotations must be set to the type of the <code>Map</code> value.</p>
</div>
<div class="paragraph">
<p><a id="GKAHQ"></a><a id="validating-persistent-fields-and-properties"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="validating-persistent-fields-and-properties"><a class="anchor" href="#validating-persistent-fields-and-properties"></a>Validating Persistent Fields and Properties</h6>
<div class="paragraph">
<p>Jakarta Bean Validation provides a
mechanism for validating application data. Bean Validation is integrated
into the Jakarta EE containers, allowing the same validation logic to be
used in any of the tiers of an enterprise application.</p>
</div>
<div class="paragraph">
<p>Bean Validation constraints may be applied to persistent entity classes,
embeddable classes, and mapped superclasses. By default, the Persistence
provider will automatically perform validation on entities with
persistent fields or properties annotated with Bean Validation
constraints immediately after the <code>PrePersist</code>, <code>PreUpdate</code>, and
<code>PreRemove</code> lifecycle events.</p>
</div>
<div class="paragraph">
<p>Bean Validation constraints are annotations applied to the fields or
properties of Java programming language classes. Bean Validation
provides a set of constraints as well as an API for defining custom
constraints. Custom constraints can be specific combinations of the
default constraints, or new constraints that don&#8217;t use the default
constraints. Each constraint is associated with at least one validator
class that validates the value of the constrained field or property.
Custom constraint developers must also provide a validator class for the
constraint.</p>
</div>
<div class="paragraph">
<p>Bean Validation constraints are applied to the persistent fields or
properties of persistent classes. When adding Bean Validation
constraints, use the same access strategy as the persistent class. That
is, if the persistent class uses field access, apply the Bean Validation
constraint annotations on the class&#8217;s fields. If the class uses property
access, apply the constraints on the getter methods.</p>
</div>
<div class="paragraph">
<p><a href="#GKAGK">Table 22-1</a> lists Bean Validation&#8217;s
built-in constraints, defined in the <code>javax.validation.constraints</code>
package.</p>
</div>
<div class="paragraph">
<p>All the built-in constraints listed in
<a href="#GKAGK">Table 22-1</a> have a corresponding
annotation, ConstraintName`.List`, for grouping multiple constraints of
the same type on the same field or property. For example, the following
persistent field has two <code>@Pattern</code> constraints:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Pattern</span>.List({
    <span class="annotation">@Pattern</span>(regexp=<span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span>),
    <span class="annotation">@Pattern</span>(regexp=<span class="string"><span class="delimiter">&quot;</span><span class="content">...</span><span class="delimiter">&quot;</span></span>)
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following entity class, <code>Contact</code>, has Bean Validation constraints
applied to its persistent fields:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Contact</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>(strategy = GenerationType.AUTO)
    <span class="directive">private</span> <span class="predefined-type">Long</span> id;
    <span class="annotation">@NotNull</span>
    <span class="directive">protected</span> <span class="predefined-type">String</span> firstName;
    <span class="annotation">@NotNull</span>
    <span class="directive">protected</span> <span class="predefined-type">String</span> lastName;
    <span class="annotation">@Pattern</span>(regexp = <span class="string"><span class="delimiter">&quot;</span><span class="content">[a-z0-9!#$%&amp;'*+/=?^_`{|}~-]+(?:</span><span class="char">\\</span><span class="content">.</span><span class="delimiter">&quot;</span></span>
            + <span class="string"><span class="delimiter">&quot;</span><span class="content">[a-z0-9!#$%&amp;'*+/=?^_`{|}~-]+)*@</span><span class="delimiter">&quot;</span></span>
            + <span class="string"><span class="delimiter">&quot;</span><span class="content">(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?</span><span class="char">\\</span><span class="content">.)+[a-z0-9]</span><span class="delimiter">&quot;</span></span>
            + <span class="string"><span class="delimiter">&quot;</span><span class="content">(?:[a-z0-9-]*[a-z0-9])?</span><span class="delimiter">&quot;</span></span>,
            message = <span class="string"><span class="delimiter">&quot;</span><span class="content">{invalid.email}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">protected</span> <span class="predefined-type">String</span> email;
    <span class="annotation">@Pattern</span>(regexp = <span class="string"><span class="delimiter">&quot;</span><span class="content">^</span><span class="char">\\</span><span class="content">(?(</span><span class="char">\\</span><span class="content">d{3})</span><span class="char">\\</span><span class="content">)?[- ]?(</span><span class="char">\\</span><span class="content">d{3})[- ]?(</span><span class="char">\\</span><span class="content">d{4})$</span><span class="delimiter">&quot;</span></span>,
            message = <span class="string"><span class="delimiter">&quot;</span><span class="content">{invalid.phonenumber}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">protected</span> <span class="predefined-type">String</span> mobilePhone;
    <span class="annotation">@Pattern</span>(regexp = <span class="string"><span class="delimiter">&quot;</span><span class="content">^</span><span class="char">\\</span><span class="content">(?(</span><span class="char">\\</span><span class="content">d{3})</span><span class="char">\\</span><span class="content">)?[- ]?(</span><span class="char">\\</span><span class="content">d{3})[- ]?(</span><span class="char">\\</span><span class="content">d{4})$</span><span class="delimiter">&quot;</span></span>,
            message = <span class="string"><span class="delimiter">&quot;</span><span class="content">{invalid.phonenumber}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">protected</span> <span class="predefined-type">String</span> homePhone;
    <span class="annotation">@Temporal</span>(javax.persistence.TemporalType.DATE)
    <span class="annotation">@Past</span>
    <span class="directive">protected</span> <span class="predefined-type">Date</span> birthday;
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@NotNull</code> annotation on the <code>firstName</code> and <code>lastName</code> fields
specifies that those fields are now required. If a new <code>Contact</code>
instance is created where <code>firstName</code> or <code>lastName</code> have not been
initialized, Bean Validation will throw a validation error. Similarly,
if a previously created instance of <code>Contact</code> has been modified so that
<code>firstName</code> or <code>lastName</code> are null, a validation error will be thrown.</p>
</div>
<div class="paragraph">
<p>The <code>email</code> field has a <code>@Pattern</code> constraint applied to it, with a
complicated regular expression that matches most valid email addresses.
If the value of <code>email</code> doesn&#8217;t match this regular expression, a
validation error will be thrown.</p>
</div>
<div class="paragraph">
<p>The <code>homePhone</code> and <code>mobilePhone</code> fields have the same <code>@Pattern</code>
constraints. The regular expression matches 10 digit telephone numbers
in the United States and Canada of the form <code>(`xxx</code>)` xxx`-`xxxx.</p>
</div>
<div class="paragraph">
<p>The <code>birthday</code> field is annotated with the <code>@Past</code> constraint, which
ensures that the value of <code>birthday</code> must be in the past.</p>
</div>
<div class="paragraph">
<p><a id="BNBQF"></a><a id="primary-keys-in-entities"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="primary-keys-in-entities"><a class="anchor" href="#primary-keys-in-entities"></a>Primary Keys in Entities</h5>
<div class="paragraph">
<p>Each entity has a unique object identifier. A customer entity, for
example, might be identified by a customer number. The unique
identifier, or primary key, enables clients to locate a particular
entity instance. Every entity must have a primary key. An entity may
have either a simple or a composite primary key.</p>
</div>
<div class="paragraph">
<p>Simple primary keys use the <code>javax.persistence.Id</code> annotation to denote
the primary key property or field.</p>
</div>
<div class="paragraph">
<p>Composite primary keys are used when a primary key consists of more than
one attribute, which corresponds to a set of single persistent
properties or fields. Composite primary keys must be defined in a
primary key class. Composite primary keys are denoted using the
<code>javax.persistence.EmbeddedId</code> and <code>javax.persistence.IdClass</code>
annotations.</p>
</div>
<div class="paragraph">
<p>The primary key, or the property or field of a composite primary key,
must be one of the following Java language types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Java primitive types</p>
</li>
<li>
<p>Java primitive wrapper types</p>
</li>
<li>
<p><code>java.lang.String</code></p>
</li>
<li>
<p><code>java.util.Date</code> (the temporal type should be <code>DATE</code>)</p>
</li>
<li>
<p><code>java.sql.Date</code></p>
</li>
<li>
<p><code>java.math.BigDecimal</code></p>
</li>
<li>
<p><code>java.math.BigInteger</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Floating-point types should never be used in primary keys. If you use a
generated primary key, only integral types will be portable.</p>
</div>
<div class="paragraph">
<p>A primary key class must meet these requirements.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The access control modifier of the class must be <code>public</code>.</p>
</li>
<li>
<p>The properties of the primary key class must be <code>public</code> or
<code>protected</code> if property-based access is used.</p>
</li>
<li>
<p>The class must have a public default constructor.</p>
</li>
<li>
<p>The class must implement the <code>hashCode()</code> and <code>equals(Object other)</code>
methods.</p>
</li>
<li>
<p>The class must be serializable.</p>
</li>
<li>
<p>A composite primary key must be represented and mapped to multiple
fields or properties of the entity class or must be represented and
mapped as an embeddable class.</p>
</li>
<li>
<p>If the class is mapped to multiple fields or properties of the entity
class, the names and types of the primary key fields or properties in
the primary key class must match those of the entity class.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following primary key class is a composite key, and the
<code>customerOrder</code> and <code>itemId</code> fields together uniquely identify an
entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">LineItemKey</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
    <span class="directive">private</span> <span class="predefined-type">Integer</span> customerOrder;
    <span class="directive">private</span> <span class="type">int</span> itemId;

    <span class="directive">public</span> LineItemKey() {}

    <span class="directive">public</span> LineItemKey(<span class="predefined-type">Integer</span> order, <span class="type">int</span> itemId) {
        <span class="local-variable">this</span>.setCustomerOrder(order);
        <span class="local-variable">this</span>.setItemId(itemId);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">int</span> hashCode() {
        <span class="keyword">return</span> ((<span class="local-variable">this</span>.getCustomerOrder() == <span class="predefined-constant">null</span>
                ? <span class="integer">0</span> : <span class="local-variable">this</span>.getCustomerOrder().hashCode())
                ^ ((<span class="type">int</span>) <span class="local-variable">this</span>.getItemId()));
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> equals(<span class="predefined-type">Object</span> otherOb) {
        <span class="keyword">if</span> (<span class="local-variable">this</span> == otherOb) {
            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        }
        <span class="keyword">if</span> (!(otherOb <span class="keyword">instanceof</span> LineItemKey)) {
            <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        }
        LineItemKey other = (LineItemKey) otherOb;
        <span class="keyword">return</span> ((<span class="local-variable">this</span>.getCustomerOrder() == <span class="predefined-constant">null</span>
                ? other.getCustomerOrder() == <span class="predefined-constant">null</span> : <span class="local-variable">this</span>.getCustomerOrder()
                .equals(other.getCustomerOrder()))
                &amp;&amp; (<span class="local-variable">this</span>.getItemId() == other.getItemId()));
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toString() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> + getCustomerOrder() + <span class="string"><span class="delimiter">&quot;</span><span class="content">-</span><span class="delimiter">&quot;</span></span> + getItemId();
    }
    <span class="comment">/* Getters and setters */</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBQH"></a><a id="multiplicity-in-entity-relationships"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="multiplicity-in-entity-relationships"><a class="anchor" href="#multiplicity-in-entity-relationships"></a>Multiplicity in Entity Relationships</h5>
<div class="paragraph">
<p>Multiplicities are of the following types.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One-to-one: Each entity instance is related to a single instance of
another entity. For example, to model a physical warehouse in which each
storage bin contains a single widget, <code>StorageBin</code> and <code>Widget</code> would
have a one-to-one relationship. One-to-one relationships use the
<code>javax.persistence.OneToOne</code> annotation on the corresponding persistent
property or field.</p>
</li>
<li>
<p>One-to-many: An entity instance can be related to multiple instances
of the other entities. A sales order, for example, can have multiple
line items. In the order application, <code>CustomerOrder</code> would have a
one-to-many relationship with <code>LineItem</code>. One-to-many relationships use
the <code>javax.persistence.OneToMany</code> annotation on the corresponding
persistent property or field.</p>
</li>
<li>
<p>Many-to-one: Multiple instances of an entity can be related to a
single instance of the other entity. This multiplicity is the opposite
of a one-to-many relationship. In the example just mentioned, the
relationship to <code>CustomerOrder</code> from the perspective of <code>LineItem</code> is
many-to-one. Many-to-one relationships use the
<code>javax.persistence.ManyToOne</code> annotation on the corresponding persistent
property or field.</p>
</li>
<li>
<p>Many-to-many: The entity instances can be related to multiple
instances of each other. For example, each college course has many
students, and every student may take several courses. Therefore, in an
enrollment application, <code>Course</code> and <code>Student</code> would have a many-to-many
relationship. Many-to-many relationships use the
<code>javax.persistence.ManyToMany</code> annotation on the corresponding
persistent property or field.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBQI"></a><a id="direction-in-entity-relationships"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="direction-in-entity-relationships"><a class="anchor" href="#direction-in-entity-relationships"></a>Direction in Entity Relationships</h5>
<div class="paragraph">
<p>The direction of a relationship can be either bidirectional or
unidirectional. A bidirectional relationship has both an owning side and
an inverse side. A unidirectional relationship has only an owning side.
The owning side of a relationship determines how the Persistence runtime
makes updates to the relationship in the database.</p>
</div>
<div class="paragraph">
<p><a id="BNBQJ"></a><a id="bidirectional-relationships"></a></p>
</div>
<div class="sect5">
<h6 id="bidirectional-relationships"><a class="anchor" href="#bidirectional-relationships"></a>Bidirectional Relationships</h6>
<div class="paragraph">
<p>In a bidirectional relationship, each entity has a relationship field or
property that refers to the other entity. Through the relationship field
or property, an entity class&#8217;s code can access its related object. If an
entity has a related field, the entity is said to "know" about its
related object. For example, if <code>CustomerOrder</code> knows what <code>LineItem</code>
instances it has and if <code>LineItem</code> knows what <code>CustomerOrder</code> it belongs
to, they have a bidirectional relationship.</p>
</div>
<div class="paragraph">
<p>Bidirectional relationships must follow these rules.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The inverse side of a bidirectional relationship must refer to its
owning side by using the <code>mappedBy</code> element of the <code>@OneToOne</code>,
<code>@OneToMany</code>, or <code>@ManyToMany</code> annotation. The <code>mappedBy</code> element
designates the property or field in the entity that is the owner of the
relationship.</p>
</li>
<li>
<p>The many side of many-to-one bidirectional relationships must not
define the <code>mappedBy</code> element. The many side is always the owning side
of the relationship.</p>
</li>
<li>
<p>For one-to-one bidirectional relationships, the owning side
corresponds to the side that contains the corresponding foreign key.</p>
</li>
<li>
<p>For many-to-many bidirectional relationships, either side may be the
owning side.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBQK"></a><a id="unidirectional-relationships"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="unidirectional-relationships"><a class="anchor" href="#unidirectional-relationships"></a>Unidirectional Relationships</h6>
<div class="paragraph">
<p>In a unidirectional relationship, only one entity has a relationship
field or property that refers to the other. For example, <code>LineItem</code>
would have a relationship field that identifies <code>Product</code>, but <code>Product</code>
would not have a relationship field or property for <code>LineItem</code>. In other
words, <code>LineItem</code> knows about <code>Product</code>, but <code>Product</code> doesn&#8217;t know
which <code>LineItem</code> instances refer to it.</p>
</div>
<div class="paragraph">
<p><a id="BNBQL"></a><a id="queries-and-relationship-direction"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="queries-and-relationship-direction"><a class="anchor" href="#queries-and-relationship-direction"></a>Queries and Relationship Direction</h6>
<div class="paragraph">
<p>Jakarta Persistence query language and Criteria API queries often navigate
across relationships. The direction of a relationship determines whether
a query can navigate from one entity to another. For example, a query
can navigate from <code>LineItem</code> to <code>Product</code> but cannot navigate in the
opposite direction. For <code>CustomerOrder</code> and <code>LineItem</code>, a query could
navigate in both directions because these two entities have a
bidirectional relationship.</p>
</div>
<div class="paragraph">
<p><a id="BNBQM"></a><a id="cascade-operations-and-relationships"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="cascade-operations-and-relationships"><a class="anchor" href="#cascade-operations-and-relationships"></a>Cascade Operations and Relationships</h6>
<div class="paragraph">
<p>Entities that use relationships often have dependencies on the existence
of the other entity in the relationship. For example, a line item is
part of an order; if the order is deleted, the line item also should be
deleted. This is called a cascade delete relationship.</p>
</div>
<div class="paragraph">
<p>The <code>javax.persistence.CascadeType</code> enumerated type defines the cascade
operations that are applied in the <code>cascade</code> element of the relationship
annotations. <a href="#GJJNJ">Table 40-1</a> lists the cascade operations for
entities.</p>
</div>
<div class="paragraph">
<p><a id="sthref159"></a><a id="GJJNJ"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 40-1 Cascade Operations for Entities</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 75%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Cascade Operation</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ALL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All cascade operations will be applied to the parent entity&#8217;s
related entity. <code>All</code> is equivalent to specifying
<code>cascade={DETACH, MERGE, PERSIST, REFRESH, REMOVE}</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DETACH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the parent entity is detached from the persistence
context, the related entity will also be detached.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MERGE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the parent entity is merged into the persistence context,
the related entity will also be merged.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PERSIST</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the parent entity is persisted into the persistence
context, the related entity will also be persisted.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REFRESH</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the parent entity is refreshed in the current persistence
context, the related entity will also be refreshed.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>REMOVE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">If the parent entity is removed from the current persistence
context, the related entity will also be removed.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Cascade delete relationships are specified using the <code>cascade=REMOVE</code>
element specification for <code>@OneToOne</code> and <code>@OneToMany</code> relationships.
For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OneToMany</span>(cascade=REMOVE, mappedBy=<span class="string"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="predefined-type">Set</span>&lt;CustomerOrder&gt; getOrders() { <span class="keyword">return</span> orders; }</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GIQXY"></a><a id="orphan-removal-in-relationships"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="orphan-removal-in-relationships"><a class="anchor" href="#orphan-removal-in-relationships"></a>Orphan Removal in Relationships</h6>
<div class="paragraph">
<p>When a target entity in a one-to-one or one-to-many relationship is
removed from the relationship, it is often desirable to cascade the
remove operation to the target entity. Such target entities are
considered "orphans," and the <code>orphanRemoval</code> attribute can be used to
specify that orphaned entities should be removed. For example, if an
order has many line items and one of them is removed from the order, the
removed line item is considered an orphan. If <code>orphanRemoval</code> is set to
<code>true</code>, the line item entity will be deleted when the line item is
removed from the order.</p>
</div>
<div class="paragraph">
<p>The <code>orphanRemoval</code> attribute in <code>@OneToMany</code> and <code>@oneToOne</code> takes a
Boolean value and is by default false.</p>
</div>
<div class="paragraph">
<p>The following example will cascade the remove operation to the orphaned
<code>order</code> entity when the <code>customer</code> entity is deleted:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OneToMany</span>(mappedBy=<span class="string"><span class="delimiter">&quot;</span><span class="content">customer</span><span class="delimiter">&quot;</span></span>, orphanRemoval=<span class="string"><span class="delimiter">&quot;</span><span class="content">true</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="predefined-type">List</span>&lt;CustomerOrder&gt; getOrders() { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GJIWZ"></a><a id="embeddable-classes-in-entities"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="embeddable-classes-in-entities"><a class="anchor" href="#embeddable-classes-in-entities"></a>Embeddable Classes in Entities</h5>
<div class="paragraph">
<p>Embeddable classes are used to represent the state of an entity but
don&#8217;t have a persistent identity of their own, unlike entity classes.
Instances of an embeddable class share the identity of the entity that
owns it. Embeddable classes exist only as the state of another entity.
An entity may have single-valued or collection-valued embeddable class
attributes.</p>
</div>
<div class="paragraph">
<p>Embeddable classes have the same rules as entity classes but are
annotated with the <code>javax.persistence.Embeddable</code> annotation instead of
<code>@Entity</code>.</p>
</div>
<div class="paragraph">
<p>The following embeddable class, <code>ZipCode</code>, has the fields <code>zip</code> and
<code>plusFour</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Embeddable</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">ZipCode</span> {
    <span class="predefined-type">String</span> zip;
    <span class="predefined-type">String</span> plusFour;
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This embeddable class is used by the <code>Address</code> entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Address</span> {
    <span class="annotation">@Id</span>
    <span class="directive">protected</span> <span class="type">long</span> id
    <span class="predefined-type">String</span> street1;
    <span class="predefined-type">String</span> street2;
    <span class="predefined-type">String</span> city;
    <span class="predefined-type">String</span> province;
    <span class="annotation">@Embedded</span>
    ZipCode zipCode;
    <span class="predefined-type">String</span> country;
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Entities that own embeddable classes as part of their persistent state
may annotate the field or property with the <code>javax.persistence.Embedded</code>
annotation but are not required to do so.</p>
</div>
<div class="paragraph">
<p>Embeddable classes may themselves use other embeddable classes to
represent their state. They may also contain collections of basic Java
programming language types or other embeddable classes. Embeddable
classes may also contain relationships to other entities or collections
of entities. If the embeddable class has such a relationship, the
relationship is from the target entity or collection of entities to the
entity that owns the embeddable class.</p>
</div>
<div class="paragraph">
<p><a id="BNBQN"></a><a id="entity-inheritance"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="entity-inheritance"><a class="anchor" href="#entity-inheritance"></a>Entity Inheritance</h4>
<div class="paragraph">
<p>Entities support class inheritance, polymorphic associations, and
polymorphic queries. Entity classes can extend non-entity classes, and
non-entity classes can extend entity classes. Entity classes can be both
abstract and concrete.</p>
</div>
<div class="paragraph">
<p>The <code>roster</code> example application demonstrates entity inheritance, as
described in <a href="#GIQRF">Entity
Inheritance in the roster Application</a>.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#BNBQO">Abstract Entities</a></p>
</li>
<li>
<p><a href="#BNBQP">Mapped Superclasses</a></p>
</li>
<li>
<p><a href="#BNBQQ">Non-Entity Superclasses</a></p>
</li>
<li>
<p><a href="#BNBQR">Entity Inheritance Mapping Strategies</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBQO"></a><a id="abstract-entities"></a></p>
</div>
<div class="sect4">
<h5 id="abstract-entities"><a class="anchor" href="#abstract-entities"></a>Abstract Entities</h5>
<div class="paragraph">
<p>An abstract class may be declared an entity by decorating the class with
<code>@Entity</code>. Abstract entities are like concrete entities but cannot be
instantiated.</p>
</div>
<div class="paragraph">
<p>Abstract entities can be queried just like concrete entities. If an
abstract entity is the target of a query, the query operates on all the
concrete subclasses of the abstract entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">Employee</span> {
    <span class="annotation">@Id</span>
    <span class="directive">protected</span> <span class="predefined-type">Integer</span> employeeId;
    ...
}
<span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">FullTimeEmployee</span> <span class="directive">extends</span> Employee {
    <span class="directive">protected</span> <span class="predefined-type">Integer</span> salary;
    ...
}
<span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PartTimeEmployee</span> <span class="directive">extends</span> Employee {
    <span class="directive">protected</span> <span class="predefined-type">Float</span> hourlyWage;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBQP"></a><a id="mapped-superclasses"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="mapped-superclasses"><a class="anchor" href="#mapped-superclasses"></a>Mapped Superclasses</h5>
<div class="paragraph">
<p>Entities may inherit from superclasses that contain persistent state and
mapping information but are not entities. That is, the superclass is not
decorated with the <code>@Entity</code> annotation and is not mapped as an entity
by the Jakarta Persistence provider. These superclasses are most often used
when you have state and mapping information common to multiple entity
classes.</p>
</div>
<div class="paragraph">
<p>Mapped superclasses are specified by decorating the class with the
annotation <code>javax.persistence.MappedSuperclass</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@MappedSuperclass</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Employee</span> {
    <span class="annotation">@Id</span>
    <span class="directive">protected</span> <span class="predefined-type">Integer</span> employeeId;
    ...
}
<span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">FullTimeEmployee</span> <span class="directive">extends</span> Employee {
    <span class="directive">protected</span> <span class="predefined-type">Integer</span> salary;
    ...
}
<span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">PartTimeEmployee</span> <span class="directive">extends</span> Employee {
    <span class="directive">protected</span> <span class="predefined-type">Float</span> hourlyWage;
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Mapped superclasses cannot be queried and cannot be used in
<code>EntityManager</code> or <code>Query</code> operations. You must use entity subclasses of
the mapped superclass in <code>EntityManager</code> or <code>Query</code> operations. Mapped
superclasses can&#8217;t be targets of entity relationships. Mapped
superclasses can be abstract or concrete.</p>
</div>
<div class="paragraph">
<p>Mapped superclasses do not have any corresponding tables in the
underlying datastore. Entities that inherit from the mapped superclass
define the table mappings. For instance, in the preceding code sample,
the underlying tables would be <code>FULLTIMEEMPLOYEE</code> and
<code>PARTTIMEEMPLOYEE</code>, but there is no <code>EMPLOYEE</code> table.</p>
</div>
<div class="paragraph">
<p><a id="BNBQQ"></a><a id="non-entity-superclasses"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="non-entity-superclasses"><a class="anchor" href="#non-entity-superclasses"></a>Non-Entity Superclasses</h5>
<div class="paragraph">
<p>Entities may have non-entity superclasses, and these superclasses can be
either abstract or concrete. The state of non-entity superclasses is
nonpersistent, and any state inherited from the non-entity superclass by
an entity class is nonpersistent. Non-entity superclasses may not be
used in <code>EntityManager</code> or <code>Query</code> operations. Any mapping or
relationship annotations in non-entity superclasses are ignored.</p>
</div>
<div class="paragraph">
<p><a id="BNBQR"></a><a id="entity-inheritance-mapping-strategies"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="entity-inheritance-mapping-strategies"><a class="anchor" href="#entity-inheritance-mapping-strategies"></a>Entity Inheritance Mapping Strategies</h5>
<div class="paragraph">
<p>You can configure how the Jakarta Persistence provider maps inherited
entities to the underlying datastore by decorating the root class of the
hierarchy with the annotation <code>javax.persistence.Inheritance</code>. The
following mapping strategies are used to map the entity data to the
underlying database:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A single table per class hierarchy</p>
</li>
<li>
<p>A table per concrete entity class</p>
</li>
<li>
<p>A "join" strategy, whereby fields or properties that are specific to a
subclass are mapped to a different table than the fields or properties
that are common to the parent class</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The strategy is configured by setting the <code>strategy</code> element of
<code>@Inheritance</code> to one of the options defined in the
<code>javax.persistence.InheritanceType</code> enumerated type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">enum</span> InheritanceType {
    SINGLE_TABLE,
    JOINED,
    TABLE_PER_CLASS
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default strategy, <code>InheritanceType.SINGLE_TABLE</code>, is used if the
<code>@Inheritance</code> annotation is not specified on the root class of the
entity hierarchy.</p>
</div>
<div class="paragraph">
<p><a id="BNBQS"></a><a id="the-single-table-per-class-hierarchy-strategy"></a></p>
</div>
<div class="sect5">
<h6 id="the-single-table-per-class-hierarchy-strategy"><a class="anchor" href="#the-single-table-per-class-hierarchy-strategy"></a>The Single Table per Class Hierarchy Strategy</h6>
<div class="paragraph">
<p>With this strategy, which corresponds to the default
<code>InheritanceType.SINGLE_TABLE</code>, all classes in the hierarchy are mapped
to a single table in the database. This table has a discriminator column
containing a value that identifies the subclass to which the instance
represented by the row belongs.</p>
</div>
<div class="paragraph">
<p>The discriminator column, whose elements are shown in <a href="#BNBQT">Table
40-2</a>, can be specified by using the
<code>javax.persistence.DiscriminatorColumn</code> annotation on the root of the
entity class hierarchy.</p>
</div>
<div class="paragraph">
<p><a id="sthref160"></a><a id="BNBQT"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 40-2 @DiscriminatorColumn Elements</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 99%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Type</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Name</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>name</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The name of the column to be used as the
discriminator column. The default is <code>DTYPE</code>. This element is optional.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DiscriminatorType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>discriminatorType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The type of the column to be
used as a discriminator column. The default is
<code>DiscriminatorType.STRING</code>. This element is optional.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>columnDefinition</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The SQL fragment to use when creating the
discriminator column. The default is generated by the Persistence
provider and is implementation-specific. This element is optional.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>length</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The column length for <code>String</code>-based discriminator
types. This element is ignored for non-<code>String</code> discriminator types. The
default is 31. This element is optional.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>javax.persistence.DiscriminatorType</code> enumerated type is used to set
the type of the discriminator column in the database by setting the
<code>discriminatorType</code> element of <code>@DiscriminatorColumn</code> to one of the
defined types. <code>DiscriminatorType</code> is defined as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">enum</span> DiscriminatorType {
    STRING,
    CHAR,
    INTEGER
};</code></pre>
</div>
</div>
<div class="paragraph">
<p>If <code>@DiscriminatorColumn</code> is not specified on the root of the entity
hierarchy and a discriminator column is required, the Persistence
provider assumes a default column name of <code>DTYPE</code> and column type of
<code>DiscriminatorType.STRING</code>.</p>
</div>
<div class="paragraph">
<p>The <code>javax.persistence.DiscriminatorValue</code> annotation may be used to set
the value entered into the discriminator column for each entity in a
class hierarchy. You may decorate only concrete entity classes with
<code>@DiscriminatorValue</code>.</p>
</div>
<div class="paragraph">
<p>If <code>@DiscriminatorValue</code> is not specified on an entity in a class
hierarchy that uses a discriminator column, the Persistence provider
will provide a default, implementation-specific value. If the
<code>discriminatorType</code> element of <code>@DiscriminatorColumn</code> is
<code>DiscriminatorType.STRING</code>, the default value is the name of the entity.</p>
</div>
<div class="paragraph">
<p>This strategy provides good support for polymorphic relationships
between entities and queries that cover the entire entity class
hierarchy. However, this strategy requires the columns that contain the
state of subclasses to be nullable.</p>
</div>
<div class="paragraph">
<p><a id="BNBQU"></a><a id="the-table-per-concrete-class-strategy"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="the-table-per-concrete-class-strategy"><a class="anchor" href="#the-table-per-concrete-class-strategy"></a>The Table per Concrete Class Strategy</h6>
<div class="paragraph">
<p>In this strategy, which corresponds to
<code>InheritanceType.TABLE_PER_CLASS</code>, each concrete class is mapped to a
separate table in the database. All fields or properties in the class,
including inherited fields or properties, are mapped to columns in the
class&#8217;s table in the database.</p>
</div>
<div class="paragraph">
<p>This strategy provides poor support for polymorphic relationships and
usually requires either SQL <code>UNION</code> queries or separate SQL queries for
each subclass for queries that cover the entire entity class hierarchy.</p>
</div>
<div class="paragraph">
<p>Support for this strategy is optional and may not be supported by all
Jakarta Persistence providers. The default Jakarta Persistence
provider in GlassFish Server does not support this strategy.</p>
</div>
<div class="paragraph">
<p><a id="BNBQV"></a><a id="the-joined-subclass-strategy"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="the-joined-subclass-strategy"><a class="anchor" href="#the-joined-subclass-strategy"></a>The Joined Subclass Strategy</h6>
<div class="paragraph">
<p>In this strategy, which corresponds to <code>InheritanceType.JOINED</code>, the
root of the class hierarchy is represented by a single table, and each
subclass has a separate table that contains only those fields specific
to that subclass. That is, the subclass table does not contain columns
for inherited fields or properties. The subclass table also has a column
or columns that represent its primary key, which is a foreign key to the
primary key of the superclass table.</p>
</div>
<div class="paragraph">
<p>This strategy provides good support for polymorphic relationships but
requires one or more join operations to be performed when instantiating
entity subclasses. This may result in poor performance for extensive
class hierarchies. Similarly, queries that cover the entire class
hierarchy require join operations between the subclass tables, resulting
in decreased performance.</p>
</div>
<div class="paragraph">
<p>Some Jakarta Persistence providers, including the default provider in
GlassFish Server, require a discriminator column that corresponds to the
root entity when using the joined subclass strategy. If you are not
using automatic table creation in your application, make sure that the
database table is set up correctly for the discriminator column
defaults, or use the <code>@DiscriminatorColumn</code> annotation to match your
database schema. For information on discriminator columns, see
<a href="#BNBQS">The Single Table per Class Hierarchy Strategy</a>.</p>
</div>
<div class="paragraph">
<p><a id="BNBQW"></a><a id="managing-entities"></a></p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="managing-entities"><a class="anchor" href="#managing-entities"></a>Managing Entities</h4>
<div class="paragraph">
<p>Entities are managed by the entity manager, which is represented by
<code>javax.persistence.EntityManager</code> instances. Each <code>EntityManager</code>
instance is associated with a persistence context: a set of managed
entity instances that exist in a particular data store. A persistence
context defines the scope under which particular entity instances are
created, persisted, and removed. The <code>EntityManager</code> interface defines
the methods that are used to interact with the persistence context.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#BNBQY">The EntityManager Interface</a></p>
</li>
<li>
<p><a href="#BNBRJ">Persistence Units</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBQY"></a><a id="the-entitymanager-interface"></a></p>
</div>
<div class="sect4">
<h5 id="the-entitymanager-interface"><a class="anchor" href="#the-entitymanager-interface"></a>The EntityManager Interface</h5>
<div class="paragraph">
<p>The <code>EntityManager</code> API creates and removes persistent entity instances,
finds entities by the entity&#8217;s primary key, and allows queries to be run
on entities.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#BNBQZ">Container-Managed Entity Managers</a></p>
</li>
<li>
<p><a href="#BNBRA">Application-Managed Entity Managers</a></p>
</li>
<li>
<p><a href="#BNBRB">Finding Entities Using the EntityManager</a></p>
</li>
<li>
<p><a href="#BNBRC">Managing an Entity Instance&#8217;s Lifecycle</a></p>
</li>
<li>
<p><a href="#BNBRD">Persisting Entity Instances</a></p>
</li>
<li>
<p><a href="#BNBRE">Removing Entity Instances</a></p>
</li>
<li>
<p><a href="#BNBRF">Synchronizing Entity Data to the Database</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBQZ"></a><a id="container-managed-entity-managers"></a></p>
</div>
<div class="sect5">
<h6 id="container-managed-entity-managers"><a class="anchor" href="#container-managed-entity-managers"></a>Container-Managed Entity Managers</h6>
<div class="paragraph">
<p>With a container-managed entity manager, an <code>EntityManager</code> instance&#8217;s
persistence context is automatically propagated by the container to all
application components that use the <code>EntityManager</code> instance within a
single Jakarta transaction.</p>
</div>
<div class="paragraph">
<p>Jakarta transactions usually involve calls across application components. To
complete a Jakarta transaction, these components usually need access to a
single persistence context. This occurs when an <code>EntityManager</code> is
injected into the application components by means of the
<code>javax.persistence.PersistenceContext</code> annotation. The persistence
context is automatically propagated with the current Jakarta transaction,
and <code>EntityManager</code> references that are mapped to the same persistence
unit provide access to the persistence context within that transaction.
By automatically propagating the persistence context, application
components don&#8217;t need to pass references to <code>EntityManager</code> instances to
each other in order to make changes within a single transaction. The
Jakarta EE container manages the lifecycle of container-managed entity
managers.</p>
</div>
<div class="paragraph">
<p>To obtain an <code>EntityManager</code> instance, inject the entity manager into
the application component:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@PersistenceContext</span>
EntityManager em;</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBRA"></a><a id="application-managed-entity-managers"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="application-managed-entity-managers"><a class="anchor" href="#application-managed-entity-managers"></a>Application-Managed Entity Managers</h6>
<div class="paragraph">
<p>With an application-managed entity manager, on the other hand, the
persistence context is not propagated to application components, and the
lifecycle of <code>EntityManager</code> instances is managed by the application.</p>
</div>
<div class="paragraph">
<p>Application-managed entity managers are used when applications need to
access a persistence context that is not propagated with the Jakarta
transaction across <code>EntityManager</code> instances in a particular persistence
unit. In this case, each <code>EntityManager</code> creates a new, isolated
persistence context. The <code>EntityManager</code> and its associated persistence
context are created and destroyed explicitly by the application. They
are also used when directly injecting <code>EntityManager</code> instances can&#8217;t be
done because <code>EntityManager</code> instances are not thread-safe.
<code>EntityManagerFactory</code> instances are thread-safe.</p>
</div>
<div class="paragraph">
<p>Applications create <code>EntityManager</code> instances in this case by using the
<code>createEntityManager</code> method of
<code>javax.persistence.EntityManagerFactory</code>.</p>
</div>
<div class="paragraph">
<p>To obtain an <code>EntityManager</code> instance, you first must obtain an
<code>EntityManagerFactory</code> instance by injecting it into the application
component by means of the <code>javax.persistence.PersistenceUnit</code>
annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@PersistenceUnit</span>
EntityManagerFactory emf;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then obtain an <code>EntityManager</code> from the <code>EntityManagerFactory</code> instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = emf.createEntityManager();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Application-managed entity managers don&#8217;t automatically propagate the
Jakarta transaction context. Such applications need to manually gain access
to the Jakarta transaction manager and add transaction demarcation
information when performing entity operations. The
<code>javax.transaction.UserTransaction</code> interface defines methods to begin,
commit, and roll back transactions. Inject an instance of
<code>UserTransaction</code> by creating an instance variable annotated with
<code>@Resource</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Resource</span>
UserTransaction utx;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To begin a transaction, call the <code>UserTransaction.begin</code> method. When
all the entity operations are complete, call the
<code>UserTransaction.commit</code> method to commit the transaction. The
<code>UserTransaction.rollback</code> method is used to roll back the current
transaction.</p>
</div>
<div class="paragraph">
<p>The following example shows how to manage transactions in an application
that uses an application-managed entity manager:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@PersistenceUnit</span>
EntityManagerFactory emf;
EntityManager em;
<span class="annotation">@Resource</span>
UserTransaction utx;
...
em = emf.createEntityManager();
<span class="keyword">try</span> {
    utx.begin();
    em.persist(SomeEntity);
    em.merge(AnotherEntity);
    em.remove(ThirdEntity);
    utx.commit();
} <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
    utx.rollback();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBRB"></a><a id="finding-entities-using-the-entitymanager"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="finding-entities-using-the-entitymanager"><a class="anchor" href="#finding-entities-using-the-entitymanager"></a>Finding Entities Using the EntityManager</h6>
<div class="paragraph">
<p>The <code>EntityManager.find</code> method is used to look up entities in the data
store by the entity&#8217;s primary key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@PersistenceContext</span>
EntityManager em;
<span class="directive">public</span> <span class="type">void</span> enterOrder(<span class="type">int</span> custID, CustomerOrder newOrder) {
    Customer cust = em.find(Customer.class, custID);
    cust.getOrders().add(newOrder);
    newOrder.setCustomer(cust);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBRC"></a><a id="managing-an-entity-instances-lifecycle"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="managing-an-entity-instances-lifecycle"><a class="anchor" href="#managing-an-entity-instances-lifecycle"></a>Managing an Entity Instance&#8217;s Lifecycle</h6>
<div class="paragraph">
<p>You manage entity instances by invoking operations on the entity by
means of an <code>EntityManager</code> instance. Entity instances are in one of
four states: new, managed, detached, or removed.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>New entity instances have no persistent identity and are not yet
associated with a persistence context.</p>
</li>
<li>
<p>Managed entity instances have a persistent identity and are associated
with a persistence context.</p>
</li>
<li>
<p>Detached entity instances have a persistent identity and are not
currently associated with a persistence context.</p>
</li>
<li>
<p>Removed entity instances have a persistent identity, are associated
with a persistent context, and are scheduled for removal from the data
store.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBRD"></a><a id="persisting-entity-instances"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="persisting-entity-instances"><a class="anchor" href="#persisting-entity-instances"></a>Persisting Entity Instances</h6>
<div class="paragraph">
<p>New entity instances become managed and persistent either by invoking
the <code>persist</code> method or by a cascading <code>persist</code> operation invoked from
related entities that have the <code>cascade=PERSIST</code> or <code>cascade=ALL</code>
elements set in the relationship annotation. This means that the
entity&#8217;s data is stored to the database when the transaction associated
with the <code>persist</code> operation is completed. If the entity is already
managed, the <code>persist</code> operation is ignored, although the <code>persist</code>
operation will cascade to related entities that have the <code>cascade</code>
element set to <code>PERSIST</code> or <code>ALL</code> in the relationship annotation. If
<code>persist</code> is called on a removed entity instance, the entity becomes
managed. If the entity is detached, either <code>persist</code> will throw an
<code>IllegalArgumentException</code>, or the transaction commit will fail. The
following method performs a <code>persist</code> operation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@PersistenceContext</span>
EntityManager em;
...
public LineItem createLineItem(CustomerOrder order, Product product,
        <span class="type">int</span> quantity) {
    LineItem li = <span class="keyword">new</span> LineItem(order, product, quantity);
    order.getLineItems().add(li);
    em.persist(li);
    <span class="keyword">return</span> li;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>persist</code> operation is propagated to all entities related to the
calling entity that have the <code>cascade</code> element set to <code>ALL</code> or <code>PERSIST</code>
in the relationship annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OneToMany</span>(cascade=ALL, mappedBy=<span class="string"><span class="delimiter">&quot;</span><span class="content">order</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;LineItem&gt; getLineItems() {
    <span class="keyword">return</span> lineItems;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBRE"></a><a id="removing-entity-instances"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="removing-entity-instances"><a class="anchor" href="#removing-entity-instances"></a>Removing Entity Instances</h6>
<div class="paragraph">
<p>Managed entity instances are removed by invoking the <code>remove</code> method or
by a cascading <code>remove</code> operation invoked from related entities that
have the <code>cascade=REMOVE</code> or <code>cascade=ALL</code> elements set in the
relationship annotation. If the <code>remove</code> method is invoked on a new
entity, the <code>remove</code> operation is ignored, although <code>remove</code> will
cascade to related entities that have the <code>cascade</code> element set to
<code>REMOVE</code> or <code>ALL</code> in the relationship annotation. If <code>remove</code> is invoked
on a detached entity, either <code>remove</code> will throw an
<code>IllegalArgumentException</code>, or the transaction commit will fail. If
invoked on an already removed entity, <code>remove</code> will be ignored. The
entity&#8217;s data will be removed from the data store when the transaction
is completed or as a result of the <code>flush</code> operation.</p>
</div>
<div class="paragraph">
<p>In the following example, all <code>LineItem</code> entities associated with the
order are also removed, as <code>CustomerOrder.getLineItems</code> has
<code>cascade=ALL</code> set in the relationship annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> removeOrder(<span class="predefined-type">Integer</span> orderId) {
    <span class="keyword">try</span> {
        CustomerOrder order = em.find(CustomerOrder.class, orderId);
        em.remove(order);
    }...</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBRF"></a><a id="synchronizing-entity-data-to-the-database"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="synchronizing-entity-data-to-the-database"><a class="anchor" href="#synchronizing-entity-data-to-the-database"></a>Synchronizing Entity Data to the Database</h6>
<div class="paragraph">
<p>The state of persistent entities is synchronized to the database when
the transaction with which the entity is associated commits. If a
managed entity is in a bidirectional relationship with another managed
entity, the data will be persisted, based on the owning side of the
relationship.</p>
</div>
<div class="paragraph">
<p>To force synchronization of the managed entity to the data store, invoke
the <code>flush</code> method of the <code>EntityManager</code> instance. If the entity is
related to another entity and the relationship annotation has the
<code>cascade</code> element set to <code>PERSIST</code> or <code>ALL</code>, the related entity&#8217;s data
will be synchronized with the data store when <code>flush</code> is called.</p>
</div>
<div class="paragraph">
<p>If the entity is removed, calling <code>flush</code> will remove the entity data
from the data store.</p>
</div>
<div class="paragraph">
<p><a id="BNBRJ"></a><a id="persistence-units"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="persistence-units"><a class="anchor" href="#persistence-units"></a>Persistence Units</h5>
<div class="paragraph">
<p>A persistence unit defines a set of all entity classes that are managed
by <code>EntityManager</code> instances in an application. This set of entity
classes represents the data contained within a single data store.</p>
</div>
<div class="paragraph">
<p>Persistence units are defined by the <code>persistence.xml</code> configuration
file. The following is an example <code>persistence.xml</code> file:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence&gt;</span>
    <span class="tag">&lt;persistence-unit</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">OrderManagement</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;description&gt;</span>This unit manages orders and customers.
            It does not rely on any vendor-specific features and can
            therefore be deployed to any persistence provider.
        <span class="tag">&lt;/description&gt;</span>
        <span class="tag">&lt;jta-data-source&gt;</span>jdbc/MyOrderDB<span class="tag">&lt;/jta-data-source&gt;</span>
        <span class="tag">&lt;jar-file&gt;</span>MyOrderApp.jar<span class="tag">&lt;/jar-file&gt;</span>
        <span class="tag">&lt;class&gt;</span>com.widgets.CustomerOrder<span class="tag">&lt;/class&gt;</span>
        <span class="tag">&lt;class&gt;</span>com.widgets.Customer<span class="tag">&lt;/class&gt;</span>
    <span class="tag">&lt;/persistence-unit&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This file defines a persistence unit named <code>OrderManagement</code>, which uses
a Jakarta Transactions aware data source, <code>jdbc/MyOrderDB</code>. The <code>jar-file</code> and <code>class</code>
elements specify managed persistence classes: entity classes, embeddable
classes, and mapped superclasses. The <code>jar-file</code> element specifies JAR
files that are visible to the packaged persistence unit that contain
managed persistence classes, whereas the <code>class</code> element explicitly
names managed persistence classes.</p>
</div>
<div class="paragraph">
<p>The <code>jta-data-source</code> (for Jakarta Transactions aware data sources) and
<code>non-jta-data-source</code> (for non Jakarta Transactions aware data sources) elements specify
the global JNDI name of the data source to be used by the container.</p>
</div>
<div class="paragraph">
<p>The JAR file or directory whose <code>META-INF</code> directory contains
<code>persistence.xml</code> is called the root of the persistence unit. The scope
of the persistence unit is determined by the persistence unit&#8217;s root.
Each persistence unit must be identified with a name that is unique to
the persistence unit&#8217;s scope.</p>
</div>
<div class="paragraph">
<p>Persistent units can be packaged as part of a WAR or enterprise bean JAR file or can
be packaged as a JAR file that can then be included in an WAR or EAR
file.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you package the persistent unit as a set of classes in an enterprise bean JAR
file, <code>persistence.xml</code> should be put in the enterprise bean JAR&#8217;s <code>META-INF</code>
directory.</p>
</li>
<li>
<p>If you package the persistence unit as a set of classes in a WAR file,
<code>persistence.xml</code> should be located in the WAR file&#8217;s
<code>WEB-INF/classes/META-INF</code> directory.</p>
</li>
<li>
<p>If you package the persistence unit in a JAR file that will be
included in a WAR or EAR file, the JAR file should be located in either</p>
<div class="ulist">
<ul>
<li>
<p>The <code>WEB-INF/lib</code> directory of a WAR</p>
</li>
<li>
<p>Or the EAR file&#8217;s library directory</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Note</strong>:</p>
</div>
<div class="paragraph">
<p>In the Java Persistence API 1.0, JAR files could be located at the root
of an EAR file as the root of the persistence unit. This is no longer
supported. Portable applications should use the EAR file&#8217;s library
directory as the root of the persistence unit.</p>
</div></div></td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="GJISE"></a><a id="querying-entities"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="querying-entities"><a class="anchor" href="#querying-entities"></a>Querying Entities</h4>
<div class="paragraph">
<p>Jakarta Persistence provides the following methods for querying
entities.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Jakarta Persistence query language (JPQL) is a simple, string-based
language similar to SQL used to query entities and their relationships.
See <a href="#BNBTG">Chapter 42, "The Jakarta
Persistence Query Language"</a> for more information.</p>
</li>
<li>
<p>The Criteria API is used to create typesafe queries using Java
programming language APIs to query for entities and their relationships.
See <a href="#GJITV">Chapter 43, "Using the Criteria
API to Create Queries"</a> for more information.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Both JPQL and the Criteria API have advantages and disadvantages.</p>
</div>
<div class="paragraph">
<p>Just a few lines long, JPQL queries are typically more concise and more
readable than Criteria queries. Developers familiar with SQL will find
it easy to learn the syntax of JPQL. JPQL named queries can be defined
in the entity class using a Java programming language annotation or in
the application&#8217;s deployment descriptor. JPQL queries are not typesafe,
however, and require a cast when retrieving the query result from the
entity manager. This means that type-casting errors may not be caught at
compile time. JPQL queries don&#8217;t support open-ended parameters.</p>
</div>
<div class="paragraph">
<p>Criteria queries allow you to define the query in the business tier of
the application. Although this is also possible using JPQL dynamic
queries, Criteria queries provide better performance because JPQL
dynamic queries must be parsed each time they are called. Criteria
queries are typesafe and therefore don&#8217;t require casting, as JPQL
queries do. The Criteria API is just another Java programming language
API and doesn&#8217;t require developers to learn the syntax of another query
language. Criteria queries are typically more verbose than JPQL queries
and require the developer to create several objects and perform
operations on those objects before submitting the query to the entity
manager.</p>
</div>
<div class="paragraph">
<p><a id="CHDBEGIC"></a><a id="database-schema-creation"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="database-schema-creation"><a class="anchor" href="#database-schema-creation"></a>Database Schema Creation</h4>
<div class="paragraph">
<p>The persistence provider can be configured to automatically create the
database tables, load data into the tables, and remove the tables during
application deployment using standard properties in the application&#8217;s
deployment descriptor. These tasks are typically used during the
development phase of a release, not against a production database.</p>
</div>
<div class="paragraph">
<p>The following is an example of a <code>persistence.xml</code> deployment descriptor
that specifies that the provider should drop all database artifacts
using a provided script, create the artifacts with a provided script,
and load data from a provided script when the application is deployed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;persistence</span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2.1</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/persistence</span><span class="delimiter">&quot;</span></span>
 <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
 <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/persistence</span>
 <span class="content">http://xmlns.jcp.org/xml/ns/persistence/persistence_2_1.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;persistence-unit</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">examplePU</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transaction-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">JTA</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;jta-data-source&gt;</span>java:global/ExampleDataSource<span class="tag">&lt;/jta-data-source&gt;</span>
    <span class="tag">&lt;properties&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.schema-generation.database.action</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">drop-and-create</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.schema-generation.create-source</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">script</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.schema-generation.create-script-source</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">META-INF/sql/create.sql</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.sql-load-script-source</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">META-INF/sql/data.sql</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.schema-generation.drop-source</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">script</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
        <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.schema-generation.drop-script-source</span><span class="delimiter">&quot;</span></span>
                  <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">META-INF/sql/drop.sql</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
    <span class="tag">&lt;/properties&gt;</span>
  <span class="tag">&lt;/persistence-unit&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="sthref161"></a><a id="configuring-an-application-to-create-or-drop-database-tables"></a></p>
</div>
<div class="sect4">
<h5 id="configuring-an-application-to-create-or-drop-database-tables"><a class="anchor" href="#configuring-an-application-to-create-or-drop-database-tables"></a>Configuring an Application to Create or Drop Database Tables</h5>
<div class="paragraph">
<p>The <code>javax.persistence.schema-generation.database.action</code> property is
used to specify the action taken by the persistence provider when an
application is deployed. If the property is not set, the persistence
provider will not create or drop any database artifacts.</p>
</div>
<div class="paragraph">
<p><a id="sthref162"></a><a id="sthref163"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 40-3 Schema Creation Actions</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 75%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Setting</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>none</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No schema creation or deletion will take place.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>create</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The provider will create the database artifacts on
application deployment. The artifacts will remain unchanged after
application redeployment.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>drop-and-create</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any artifacts in the database will be deleted, and
the provider will create the database artifacts on deployment.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>drop</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Any artifacts in the database will be deleted on application
deployment.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In this example, the persistence provider will delete any remaining
database artifacts and then create the artifacts when the application is
deployed:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.schema-generation.database.action</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">drop-and-create</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the object/relational metadata in the persistence unit is
used to create the database artifacts. You may also supply scripts used
by the provider to create and delete the database artifacts. The
<code>javax.persistence.schema-generation.create-source</code> and
<code>javax.persistence.schema-generation.drop-source</code> properties control how
the provider will create or delete the database artifacts.</p>
</div>
<div class="paragraph">
<p><a id="sthref164"></a><a id="sthref165"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 40-4 Settings for Create and Delete Source Properties</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 75%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Setting</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>metadata</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use the object/relational metadata in the application to
create or delete the database artifacts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>script</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use a provided script for creating or deleting the database
artifacts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>metadata-then-script</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use a combination of object/relational
metadata, then a user-provided script to create or delete the database
artifacts.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>script-then-metadata</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Use a combination of a user-provided script,
then the object/relational metadata to create and delete the database
artifacts.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>In this example, the persistence provider will use a script packaged
within the application to create the database artifacts:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.schema-generation.create-source</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">script</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If you specify a script in <code>create-source</code> or <code>drop-source</code>, specify the
location of the script using the
<code>javax.persistence.schema-generation.create-script-source</code> or
<code>javax.persistence.schema-generation.drop-script-source</code> property. The
location of the script is relative to the root of the persistence unit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.schema-generation.create-script-source</span><span class="delimiter">&quot;</span></span>
           <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">META-INF/sql/create.sql</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the above example, the <code>create-script-source</code> is set to a SQL file
called <code>create.sql</code> in the <code>META-INF/sql</code> directory relative to root of
the persistence unit.</p>
</div>
<div class="paragraph">
<p><a id="sthref166"></a><a id="loading-data-using-sql-scripts"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="loading-data-using-sql-scripts"><a class="anchor" href="#loading-data-using-sql-scripts"></a>Loading Data Using SQL Scripts</h5>
<div class="paragraph">
<p>If you want to populate the database tables with data before the
application loads, specify the location of a load script in the
<code>javax.persistence.sql-load-script-source property</code>. The location
specified in this property is relative to the root of the persistence
unit.</p>
</div>
<div class="paragraph">
<p>In this example, the load script is a file called <code>data.sql</code> in the
<code>META-INF/sql</code> directory relative to the root of the persistence unit:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.sql-load-script-source</span><span class="delimiter">&quot;</span></span>
          <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">META-INF/sql/data.sql</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GKCLC"></a><a id="further-information-about-persistence"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="further-information-about-persistence"><a class="anchor" href="#further-information-about-persistence"></a>Further Information about Persistence</h4>
<div class="paragraph">
<p>For more information about Jakarta Persistence, see</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Jakarta Persistence 2.2 API specification:</p>
<div class="paragraph">
<p><code><a href="https://jakarta.ee/specifications/persistence/2.2/" class="bare">https://jakarta.ee/specifications/persistence/2.2/</a></code></p>
</div>
</li>
<li>
<p>EclipseLink, the Jakarta Persistence implementation in GlassFish
Server:</p>
<div class="paragraph">
<p><code><a href="http://www.eclipse.org/eclipselink/jpa.php" class="bare">http://www.eclipse.org/eclipselink/jpa.php</a></code></p>
</div>
</li>
<li>
<p>EclipseLink team blog:</p>
<div class="paragraph">
<p><code><a href="http://eclipselink.blogspot.com/" class="bare">http://eclipselink.blogspot.com/</a></code></p>
</div>
</li>
<li>
<p>EclipseLink wiki documentation:</p>
<div class="paragraph">
<p><code><a href="http://wiki.eclipse.org/EclipseLink" class="bare">http://wiki.eclipse.org/EclipseLink</a></code></p>
</div>
</li>
</ul>
</div>
</div>
</div>
<div class="sect2">
<h3 id="running-the-persistence-examples"><a class="anchor" href="#running-the-persistence-examples"></a>Running the Persistence Examples</h3>
<div class="paragraph">
<p><a id="GIJST"></a><a id="running-the-persistence-examples"></a></p>
</div>
<div class="paragraph">
<p>This chapter explains how to use Jakarta Persistence. The material
here focuses on the source code and settings of three examples.</p>
</div>
<div class="paragraph">
<p><a id="A1023268"></a><a id="overview-of-the-persistence-examples"></a></p>
</div>
<div class="sect3">
<h4 id="overview-of-the-persistence-examples"><a class="anchor" href="#overview-of-the-persistence-examples"></a>Overview of the Persistence Examples</h4>
<div class="paragraph">
<p>The first example, <code>order</code>, is an application that uses a stateful
session bean to manage entities related to an ordering system. The
second example, <code>roster</code>, is an application that manages a community
sports system. The third example, <code>address-book</code>, is a web application
that stores contact data. This chapter assumes that you are familiar
with the concepts detailed in <a href="#BNBPZ">Chapter
40, "Introduction to Jakarta Persistence."</a></p>
</div>
<div class="paragraph">
<p><a id="GIQST"></a><a id="the-order-application"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="the-order-application"><a class="anchor" href="#the-order-application"></a>The order Application</h4>
<div class="paragraph">
<p>The <code>order</code> application is a simple inventory and ordering application
for maintaining a catalog of parts and placing an itemized order of
those parts. The application has entities that represent parts, vendors,
orders, and line items. These entities are accessed using a stateful
session bean that holds the business logic of the application. A simple
singleton session bean creates the initial entities on application
deployment. A Facelets web application manipulates the data and displays
data from the catalog.</p>
</div>
<div class="paragraph">
<p>The information contained in an order can be divided into elements. What
is the order number? What parts are included in the order? What parts
make up that part? Who makes the part? What are the specifications for
the part? Are there any schematics for the part? The <code>order</code> application
is a simplified version of an ordering system that has all these
elements.</p>
</div>
<div class="paragraph">
<p>The <code>order</code> application consists of a single WAR module that includes
the enterprise bean classes, the entities, the support classes, and the
Facelets XHTML and class files.</p>
</div>
<div class="paragraph">
<p>The database schema in the Derby database for <code>order</code> is shown in
<a href="#CHDGGDIA">Figure 41-1</a>.</p>
</div>
<div id="CHDGGDIA" class="paragraph">
<div class="title"><strong>Figure 41-1 Database Schema for the order Application</strong></div>
<p><span class="image"><img src="data:image/png;base64," alt="Diagram showing the database schema for the order application"></span></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Note:</p>
</div>
<div class="paragraph">
<p>In this diagram, for simplicity, the <code>PERSISTENCE_ORDER_</code> prefix is
omitted from the table names.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="GIQRH"></a><a id="entity-relationships-in-the-order-application"></a></p>
</div>
<div class="sect4">
<h5 id="entity-relationships-in-the-order-application"><a class="anchor" href="#entity-relationships-in-the-order-application"></a>Entity Relationships in the order Application</h5>
<div class="paragraph">
<p>The <code>order</code> application demonstrates several types of entity
relationships: self-referential, one-to-one, one-to-many, many-to-one,
and unidirectional relationships.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#GIQQR">Self-Referential Relationships</a></p>
</li>
<li>
<p><a href="#GIQSR">One-to-One Relationships</a></p>
</li>
<li>
<p><a href="#GIQTJ">One-to-Many Relationship Mapped to Overlapping Primary and
Foreign Keys</a></p>
</li>
<li>
<p><a href="#GIQUD">Unidirectional Relationships</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="GIQQR"></a><a id="self-referential-relationships"></a></p>
</div>
<div class="sect5">
<h6 id="self-referential-relationships"><a class="anchor" href="#self-referential-relationships"></a>Self-Referential Relationships</h6>
<div class="paragraph">
<p>A self-referential relationship occurs between relationship fields in
the same entity. <code>Part</code> has a field, <code>bomPart</code>, which has a one-to-many
relationship with the field <code>parts</code>, which is also in <code>Part</code>. That is, a
part can be made up of many parts, and each of those parts has exactly
one bill-of-material part.</p>
</div>
<div class="paragraph">
<p>The primary key for <code>Part</code> is a compound primary key, a combination of
the <code>partNumber</code> and <code>revision</code> fields. This key is mapped to the
<code>PARTNUMBER</code> and <code>REVISION</code> columns in the <code>PERSISTENCE_ORDER_PART</code>
table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
<span class="annotation">@ManyToOne</span>
<span class="annotation">@JoinColumns</span>({
    <span class="annotation">@JoinColumn</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">BOMPARTNUMBER</span><span class="delimiter">&quot;</span></span>, referencedColumnName=<span class="string"><span class="delimiter">&quot;</span><span class="content">PARTNUMBER</span><span class="delimiter">&quot;</span></span>),
    <span class="annotation">@JoinColumn</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">BOMREVISION</span><span class="delimiter">&quot;</span></span>, referencedColumnName=<span class="string"><span class="delimiter">&quot;</span><span class="content">REVISION</span><span class="delimiter">&quot;</span></span>)
})
<span class="directive">public</span> Part getBomPart() {
    <span class="keyword">return</span> bomPart;
}
...
<span class="annotation">@OneToMany</span>(mappedBy=<span class="string"><span class="delimiter">&quot;</span><span class="content">bomPart</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;Part&gt; getParts() {
    <span class="keyword">return</span> parts;
}
...</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GIQSR"></a><a id="one-to-one-relationships"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="one-to-one-relationships"><a class="anchor" href="#one-to-one-relationships"></a>One-to-One Relationships</h6>
<div class="paragraph">
<p><code>Part</code> has a field, <code>vendorPart</code>, that has a one-to-one relationship
with <code>VendorPart&#8217;s `part</code> field. That is, each part has exactly one
vendor part, and vice versa.</p>
</div>
<div class="paragraph">
<p>Here is the relationship mapping in <code>Part</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OneToOne</span>(mappedBy=<span class="string"><span class="delimiter">&quot;</span><span class="content">part</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> VendorPart getVendorPart() {
    <span class="keyword">return</span> vendorPart;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the relationship mapping in <code>VendorPart</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OneToOne</span>
<span class="annotation">@JoinColumns</span>({
    <span class="annotation">@JoinColumn</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">PARTNUMBER</span><span class="delimiter">&quot;</span></span>, referencedColumnName=<span class="string"><span class="delimiter">&quot;</span><span class="content">PARTNUMBER</span><span class="delimiter">&quot;</span></span>),
    <span class="annotation">@JoinColumn</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">PARTREVISION</span><span class="delimiter">&quot;</span></span>, referencedColumnName=<span class="string"><span class="delimiter">&quot;</span><span class="content">REVISION</span><span class="delimiter">&quot;</span></span>)
})
<span class="directive">public</span> Part getPart() {
    <span class="keyword">return</span> part;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that, because <code>Part</code> uses a compound primary key, the
<code>@JoinColumns</code> annotation is used to map the columns in the
<code>PERSISTENCE_ORDER_VENDOR_PART</code> table to the columns in
<code>PERSISTENCE_ORDER_PART</code>. The <code>PERSISTENCE_ORDER_VENDOR_PART</code> table&#8217;s
<code>PARTREVISION</code> column refers to <code>PERSISTENCE_ORDER_PART&#8217;s `REVISION</code>
column.</p>
</div>
<div class="paragraph">
<p><a id="GIQTJ"></a><a id="one-to-many-relationship-mapped-to-overlapping-primary-and-foreign-keys"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="one-to-many-relationship-mapped-to-overlapping-primary-and-foreign-keys"><a class="anchor" href="#one-to-many-relationship-mapped-to-overlapping-primary-and-foreign-keys"></a>One-to-Many Relationship Mapped to Overlapping Primary and Foreign Keys</h6>
<div class="paragraph">
<p><code>CustomerOrder</code> has a field, <code>lineItems</code>, that has a one-to-many
relationship with <code>LineItem&#8217;s field `customerOrder</code>. That is, each
order has one or more line item.</p>
</div>
<div class="paragraph">
<p><code>LineItem</code> uses a compound primary key that is made up of the <code>orderId</code>
and <code>itemId</code> fields. This compound primary key maps to the <code>ORDERID</code> and
<code>ITEMID</code> columns in the <code>PERSISTENCE_ORDER_LINEITEM</code> table. <code>ORDERID</code> is
a foreign key to the <code>ORDERID</code> column in the
<code>PERSISTENCE_ORDER_CUSTOMERORDER</code> table. This means that the <code>ORDERID</code>
column is mapped twice: once as a primary key field, <code>orderId</code>; and
again as a relationship field, <code>order</code>.</p>
</div>
<div class="paragraph">
<p>Here is the relationship mapping in <code>CustomerOrder</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OneToMany</span>(cascade=ALL, mappedBy=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerOrder</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;LineItem&gt; getLineItems() {
    <span class="keyword">return</span> lineItems;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the relationship mapping in <code>LineItem</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Id</span>
<span class="annotation">@ManyToOne</span>
<span class="annotation">@JoinColumn</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">ORDERID</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> CustomerOrder getCustomerOrder() {
    <span class="keyword">return</span> customerOrder;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GIQUD"></a><a id="unidirectional-relationships"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="unidirectional-relationships-2"><a class="anchor" href="#unidirectional-relationships-2"></a>Unidirectional Relationships</h6>
<div class="paragraph">
<p><code>LineItem</code> has a field, <code>vendorPart</code>, that has a unidirectional
many-to-one relationship with <code>VendorPart</code>. That is, there is no field
in the target entity in this relationship:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JoinColumn</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">VENDORPARTNUMBER</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@ManyToOne</span>
<span class="directive">public</span> VendorPart getVendorPart() {
    <span class="keyword">return</span> vendorPart;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GIQQY"></a><a id="primary-keys-in-the-order-application"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="primary-keys-in-the-order-application"><a class="anchor" href="#primary-keys-in-the-order-application"></a>Primary Keys in the order Application</h5>
<div class="paragraph">
<p>The <code>order</code> application uses several types of primary keys:
single-valued primary keys, generated primary keys, and compound primary
keys.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#GIQUV">Generated Primary Keys</a></p>
</li>
<li>
<p><a href="#GIQUF">Compound Primary Keys</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="GIQUV"></a><a id="generated-primary-keys"></a></p>
</div>
<div class="sect5">
<h6 id="generated-primary-keys"><a class="anchor" href="#generated-primary-keys"></a>Generated Primary Keys</h6>
<div class="paragraph">
<p><code>VendorPart</code> uses a generated primary key value. That is, the
application does not assign primary key values for the entities but
instead relies on the persistence provider to generate the primary key
values. The <code>@GeneratedValue</code> annotation is used to specify that an
entity will use a generated primary key.</p>
</div>
<div class="paragraph">
<p>In <code>VendorPart</code>, the following code specifies the settings for
generating primary key values:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@TableGenerator</span>(
    name=<span class="string"><span class="delimiter">&quot;</span><span class="content">vendorPartGen</span><span class="delimiter">&quot;</span></span>,
    table=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENCE_ORDER_SEQUENCE_GENERATOR</span><span class="delimiter">&quot;</span></span>,
    pkColumnName=<span class="string"><span class="delimiter">&quot;</span><span class="content">GEN_KEY</span><span class="delimiter">&quot;</span></span>,
    valueColumnName=<span class="string"><span class="delimiter">&quot;</span><span class="content">GEN_VALUE</span><span class="delimiter">&quot;</span></span>,
    pkColumnValue=<span class="string"><span class="delimiter">&quot;</span><span class="content">VENDOR_PART_ID</span><span class="delimiter">&quot;</span></span>,
    allocationSize=<span class="integer">10</span>)
<span class="annotation">@Id</span>
<span class="annotation">@GeneratedValue</span>(strategy=GenerationType.TABLE, generator=<span class="string"><span class="delimiter">&quot;</span><span class="content">vendorPartGen</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="predefined-type">Long</span> getVendorPartNumber() {
    <span class="keyword">return</span> vendorPartNumber;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@TableGenerator</code> annotation is used in conjunction with
<code>@GeneratedValue&#8217;s `strategy=TABLE</code> element. That is, the strategy used
to generate the primary keys is to use a table in the database. The
<code>@TableGenerator</code> annotation is used to configure the settings for the
generator table. The name element sets the name of the generator, which
is <code>vendorPartGen</code> in <code>VendorPart</code>.</p>
</div>
<div class="paragraph">
<p>The <code>PERSISTENCE_ORDER_SEQUENCE_GENERATOR</code> table, whose two columns are
<code>GEN_KEY</code> and <code>GEN_VALUE</code>, will store the generated primary key values.
This table could be used to generate other entities' primary keys, so
the <code>pkColumnValue</code> element is set to <code>VENDOR_PART_ID</code> to distinguish
this entity&#8217;s generated primary keys from other entities' generated
primary keys. The <code>allocationSize</code> element specifies the amount to
increment when allocating primary key values. In this case, each
`VendorPart&#8217;s primary key will increment by 10.</p>
</div>
<div class="paragraph">
<p>The primary key field <code>vendorPartNumber</code> is of type <code>Long</code>, as the
generated primary key&#8217;s field must be an integral type.</p>
</div>
<div class="paragraph">
<p><a id="GIQUF"></a><a id="compound-primary-keys"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="compound-primary-keys"><a class="anchor" href="#compound-primary-keys"></a>Compound Primary Keys</h6>
<div class="paragraph">
<p>A compound primary key is made up of multiple fields and follows the
requirements described in <a href="#BNBQF">Primary
Keys in Entities</a>. To use a compound primary key, you must create a
wrapper class.</p>
</div>
<div class="paragraph">
<p>In <code>order</code>, two entities use compound primary keys: <code>Part</code> and
<code>LineItem</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Part</code> uses the <code>PartKey</code> wrapper class. <code>Part&#8217;s primary key is a
combination of the part number and the revision number. `PartKey</code>
encapsulates this primary key.</p>
</li>
<li>
<p><code>LineItem</code> uses the <code>LineItemKey</code> class. <code>LineItem&#8217;s primary key is a
combination of the order number and the item number. `LineItemKey</code>
encapsulates this primary key.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>This is the <code>LineItemKey</code> compound primary key wrapper class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">jakarta.tutorial.order.entity</span>;

<span class="keyword">import</span> <span class="include">java.io.Serializable</span>;

<span class="directive">public</span> <span class="directive">final</span> <span class="type">class</span> <span class="class">LineItemKey</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="directive">private</span> <span class="predefined-type">Integer</span> customerOrder;
    <span class="directive">private</span> <span class="type">int</span> itemId;

    <span class="directive">public</span> LineItemKey() {}

    <span class="directive">public</span> LineItemKey(<span class="predefined-type">Integer</span> order, <span class="type">int</span> itemId) {
        <span class="local-variable">this</span>.setCustomerOrder(order);
        <span class="local-variable">this</span>.setItemId(itemId);
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">int</span> hashCode() {
        <span class="keyword">return</span> ((<span class="local-variable">this</span>.getCustomerOrder() == <span class="predefined-constant">null</span>
                ? <span class="integer">0</span> : <span class="local-variable">this</span>.getCustomerOrder().hashCode())
                ^ ((<span class="type">int</span>) <span class="local-variable">this</span>.getItemId()));
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">boolean</span> equals(<span class="predefined-type">Object</span> otherOb) {
        <span class="keyword">if</span> (<span class="local-variable">this</span> == otherOb) {
            <span class="keyword">return</span> <span class="predefined-constant">true</span>;
        }
        <span class="keyword">if</span> (!(otherOb <span class="keyword">instanceof</span> LineItemKey)) {
            <span class="keyword">return</span> <span class="predefined-constant">false</span>;
        }
        LineItemKey other = (LineItemKey) otherOb;
        <span class="keyword">return</span> ((<span class="local-variable">this</span>.getCustomerOrder() == <span class="predefined-constant">null</span>
                ? other.getCustomerOrder == <span class="predefined-constant">null</span> : <span class="local-variable">this</span>.getOrderId()
                .equals(other.getCustomerOrder()))
                &amp;&amp; (<span class="local-variable">this</span>.getItemId == oother.getItemId()));
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="predefined-type">String</span> toString() {
        <span class="keyword">return</span> <span class="string"><span class="delimiter">&quot;</span><span class="delimiter">&quot;</span></span> + getCustomerOrder() + <span class="string"><span class="delimiter">&quot;</span><span class="content">-</span><span class="delimiter">&quot;</span></span> + getItemId();
    }

    <span class="directive">public</span> <span class="predefined-type">Integer</span> getCustomerOrder() {
        <span class="keyword">return</span> customerOrder;
    }

    <span class="directive">public</span> <span class="type">void</span> setCustomerOrder(<span class="predefined-type">Integer</span> order) {
        <span class="local-variable">this</span>.customerOrder = order;
    }

    <span class="directive">public</span> <span class="type">int</span> getItemId() {
        <span class="keyword">return</span> itemId;
    }

    <span class="directive">public</span> <span class="type">void</span> setItemId(<span class="type">int</span> itemId) {
        <span class="local-variable">this</span>.itemId = itemId;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@IdClass</code> annotation is used to specify the primary key class in
the entity class. In <code>LineItem</code>, <code>@IdClass</code> is used as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@IdClass</span>(LineItemKey.class)
<span class="annotation">@Entity</span>
...
public <span class="type">class</span> <span class="class">LineItem</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The two fields in <code>LineItem</code> are tagged with the <code>@Id</code> annotation to
mark those fields as part of the compound primary key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Id</span>
<span class="directive">public</span> <span class="type">int</span> getItemId() {
    <span class="keyword">return</span> itemId;
}
...
<span class="annotation">@Id</span>
<span class="annotation">@ManyToOne</span>
<span class="annotation">@JoinColumn</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">ORDERID</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> CustomerOrder getCustomerOrder() {
    <span class="keyword">return</span> customerOrder;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>For <code>customerOrder</code>, you also use the <code>@JoinColumn</code> annotation to
specify the column name in the table and that this column is an
overlapping foreign key pointing at the
<code>PERSISTENCE_ORDER_CUSTOMERORDER</code> table&#8217;s <code>ORDERID</code> column (see
<a href="#GIQTJ">One-to-Many Relationship Mapped to Overlapping Primary and
Foreign Keys</a>). That is, <code>customerOrder</code> will be set by the
<code>CustomerOrder</code> entity.</p>
</div>
<div class="paragraph">
<p>In <code>LineItem&#8217;s constructor, the line item number (`LineItem.itemId</code>) is
set using the <code>CustomerOrder.getNextId</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> LineItem(CustomerOrder order, <span class="type">int</span> quantity, VendorPart vendorPart) {
    <span class="local-variable">this</span>.customerOrder = order;
    <span class="local-variable">this</span>.itemId = order.getNextId();
    <span class="local-variable">this</span>.quantity = quantity;
    <span class="local-variable">this</span>.vendorPart = vendorPart;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>CustomerOrder.getNextId</code> counts the number of current line items, adds
1, and returns that number:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Transient</span>
<span class="directive">public</span> <span class="type">int</span> getNextId() {
    <span class="keyword">return</span> <span class="local-variable">this</span>.lineItems.size() + <span class="integer">1</span>;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>Part</code> requires the <code>@Column</code> annotation on the two fields that comprise
`Part&#8217;s compound primary key, because `Part&#8217;s compound primary key is
an overlapping primary key/foreign key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@IdClass</span>(PartKey.class)
<span class="annotation">@Entity</span>
...
public <span class="type">class</span> <span class="class">Part</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
    ...
    <span class="annotation">@Id</span>
    <span class="annotation">@Column</span>(nullable=<span class="predefined-constant">false</span>)
    <span class="directive">public</span> <span class="predefined-type">String</span> getPartNumber() {
        <span class="keyword">return</span> partNumber;
    }
    ...
    <span class="annotation">@Id</span>
    <span class="annotation">@Column</span>(nullable=<span class="predefined-constant">false</span>)
    <span class="directive">public</span> <span class="type">int</span> getRevision() {
        <span class="keyword">return</span> revision;
    }
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GIQTL"></a><a id="entity-mapped-to-more-than-one-database-table"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="entity-mapped-to-more-than-one-database-table"><a class="anchor" href="#entity-mapped-to-more-than-one-database-table"></a>Entity Mapped to More Than One Database Table</h5>
<div class="paragraph">
<p><code>Part&#8217;s fields map to more than one database table:
`PERSISTENCE_ORDER_PART</code> and <code>PERSISTENCE_ORDER_PART_DETAIL</code>. The
<code>PERSISTENCE_ORDER_PART_DETAIL</code> table holds the specification and
schematics for the part. The <code>@SecondaryTable</code> annotation is used to
specify the secondary table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
<span class="annotation">@Entity</span>
<span class="annotation">@Table</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENCE_ORDER_PART</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@SecondaryTable</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENCE_ORDER_PART_DETAIL</span><span class="delimiter">&quot;</span></span>, pkJoinColumns={
    <span class="annotation">@PrimaryKeyJoinColumn</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">PARTNUMBER</span><span class="delimiter">&quot;</span></span>,
        referencedColumnName=<span class="string"><span class="delimiter">&quot;</span><span class="content">PARTNUMBER</span><span class="delimiter">&quot;</span></span>),
    <span class="annotation">@PrimaryKeyJoinColumn</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">REVISION</span><span class="delimiter">&quot;</span></span>,
        referencedColumnName=<span class="string"><span class="delimiter">&quot;</span><span class="content">REVISION</span><span class="delimiter">&quot;</span></span>)
})
<span class="directive">public</span> <span class="type">class</span> <span class="class">Part</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>PERSISTENCE_ORDER_PART_DETAIL</code> and <code>PERSISTENCE_ORDER_PART</code> share the
same primary key values. The <code>pkJoinColumns</code> element of
<code>@SecondaryTable</code> is used to specify that
<code>PERSISTENCE_ORDER_PART_DETAIL&#8217;s primary key columns are foreign keys
to `PERSISTENCE_ORDER_PART</code>. The <code>@PrimaryKeyJoinColumn</code> annotation sets
the primary key column names and specifies which column in the primary
table the column refers to. In this case, the primary key column names
for both <code>PERSISTENCE_ORDER_PART_DETAIL</code> and <code>PERSISTENCE_ORDER_PART</code>
are the same: <code>PARTNUMBER</code> and <code>REVISION</code>, respectively.</p>
</div>
<div class="paragraph">
<p><a id="GIQUE"></a><a id="cascade-operations-in-the-order-application"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="cascade-operations-in-the-order-application"><a class="anchor" href="#cascade-operations-in-the-order-application"></a>Cascade Operations in the order Application</h5>
<div class="paragraph">
<p>Entities that have relationships to other entities often have
dependencies on the existence of the other entity in the relationship.
For example, a line item is part of an order; if the order is deleted,
then the line item also should be deleted. This is called a cascade
delete relationship.</p>
</div>
<div class="paragraph">
<p>In <code>order</code>, there are two cascade delete dependencies in the entity
relationships. If the <code>CustomerOrder</code> to which a <code>LineItem</code> is related
is deleted, the <code>LineItem</code> also should be deleted. If the <code>Vendor</code> to
which a <code>VendorPart</code> is related is deleted, the <code>VendorPart</code> also should
be deleted.</p>
</div>
<div class="paragraph">
<p>You specify the cascade operations for entity relationships by setting
the <code>cascade</code> element in the inverse (nonowning) side of the
relationship. The cascade element is set to <code>ALL</code> in the case of
<code>CustomerOrder.lineItems</code>. This means that all persistence operations
(deletes, updates, and so on) are cascaded from orders to line items.</p>
</div>
<div class="paragraph">
<p>Here is the relationship mapping in <code>CustomerOrder</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@OneToMany</span>(cascade=ALL, mappedBy=<span class="string"><span class="delimiter">&quot;</span><span class="content">customerOrder</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;LineItem&gt; getLineItems() {
    <span class="keyword">return</span> lineItems;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is the relationship mapping in <code>LineItem</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Id</span>
<span class="annotation">@ManyToOne</span>
<span class="annotation">@JoinColumn</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">ORDERID</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> CustomerOrder getCustomerOrder() {
    <span class="keyword">return</span> customerOrder;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GIQSC"></a><a id="blob-and-clob-database-types-in-the-order-application"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="blob-and-clob-database-types-in-the-order-application"><a class="anchor" href="#blob-and-clob-database-types-in-the-order-application"></a>BLOB and CLOB Database Types in the order Application</h5>
<div class="paragraph">
<p>The <code>PARTDETAIL</code> table in the database has a column, <code>DRAWING</code>, of type
<code>BLOB</code>. <code>BLOB</code> stands for binary large objects, which are used for
storing binary data, such as an image. The <code>DRAWING</code> column is mapped to
the field <code>Part.drawing</code> of type <code>java.io.Serializable</code>. The <code>@Lob</code>
annotation is used to denote that the field is a large object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Column</span>(table=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENCE_ORDER_PART_DETAIL</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Lob</span>
<span class="directive">public</span> <span class="predefined-type">Serializable</span> getDrawing() {
    <span class="keyword">return</span> drawing;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>PERSISTENCE_ORDER_PART_DETAIL</code> also has a column, <code>SPECIFICATION</code>, of
type <code>CLOB</code>. <code>CLOB</code> stands for character large objects, which are used
to store string data too large to be stored in a <code>VARCHAR</code> column.
<code>SPECIFICATION</code> is mapped to the field <code>Part.specification</code> of type
<code>java.lang.String</code>. The <code>@Lob</code> annotation is also used here to denote
that the field is a large object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Column</span>(table=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENCE_ORDER_PART_DETAIL</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Lob</span>
<span class="directive">public</span> <span class="predefined-type">String</span> getSpecification() {
    <span class="keyword">return</span> specification;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both of these fields use the <code>@Column</code> annotation and set the <code>table</code>
element to the secondary table.</p>
</div>
<div class="paragraph">
<p><a id="GIQUM"></a><a id="temporal-types-in-the-order-application"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="temporal-types-in-the-order-application"><a class="anchor" href="#temporal-types-in-the-order-application"></a>Temporal Types in the order Application</h5>
<div class="paragraph">
<p>The <code>CustomerOrder.lastUpdate</code> persistent property, which is of type
<code>java.util.Date</code>, is mapped to the
<code>PERSISTENCE_ORDER_CUSTOMERORDER.LASTUPDATE</code> database field, which is of
the SQL type <code>TIMESTAMP</code>. To ensure the proper mapping between these
types, you must use the <code>@Temporal</code> annotation with the proper temporal
type specified in <code>@Temporal&#8217;s element. `@Temporal&#8217;s elements are of
type `javax.persistence.TemporalType</code>. The possible values are</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>DATE</code>, which maps to <code>java.sql.Date</code></p>
</li>
<li>
<p><code>TIME</code>, which maps to <code>java.sql.Time</code></p>
</li>
<li>
<p><code>TIMESTAMP</code>, which maps to <code>java.sql.Timestamp</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Here is the relevant section of <code>CustomerOrder</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Temporal</span>(TIMESTAMP)
<span class="directive">public</span> <span class="predefined-type">Date</span> getLastUpdate() {
    <span class="keyword">return</span> lastUpdate;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GIQQV"></a><a id="managing-the-order-applications-entities"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="managing-the-order-applications-entities"><a class="anchor" href="#managing-the-order-applications-entities"></a>Managing the order Application&#8217;s Entities</h5>
<div class="paragraph">
<p>The <code>RequestBean</code> stateful session bean contains the business logic and
manages the entities of <code>order</code>. <code>RequestBean</code> uses the
<code>@PersistenceContext</code> annotation to retrieve an entity manager instance,
which is used to manage `order&#8217;s entities in `RequestBean&#8217;s business
methods:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@PersistenceContext</span>
<span class="directive">private</span> EntityManager em;</code></pre>
</div>
</div>
<div class="paragraph">
<p>This <code>EntityManager</code> instance is a container-managed entity manager, so
the container takes care of all the transactions involved in managing
`order&#8217;s entities.</p>
</div>
<div class="paragraph">
<p><a id="GIQRR"></a><a id="creating-entities"></a></p>
</div>
<div class="sect5">
<h6 id="creating-entities"><a class="anchor" href="#creating-entities"></a>Creating Entities</h6>
<div class="paragraph">
<p>The <code>RequestBean.createPart</code> business method creates a new <code>Part</code>
entity. The <code>EntityManager.persist</code> method is used to persist the newly
created entity to the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Part part = <span class="keyword">new</span> Part(partNumber,
        revision,
        description,
        revisionDate,
        specification,
        drawing);
em.persist(part);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>ConfigBean</code> singleton session bean is used to initialize the data
in <code>order</code>. <code>ConfigBean</code> is annotated with <code>@Startup</code>, which indicates
that the enterprise bean container should create <code>ConfigBean</code> when <code>order</code> is
deployed. The <code>createData</code> method is annotated with <code>@PostConstruct</code> and
creates the initial entities used by <code>order</code> by calling `RequestBean&#8217;s
business methods.</p>
</div>
<div class="paragraph">
<p><a id="GIQQC"></a><a id="finding-entities"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="finding-entities"><a class="anchor" href="#finding-entities"></a>Finding Entities</h6>
<div class="paragraph">
<p>The <code>RequestBean.getOrderPrice</code> business method returns the price of a
given order based on the <code>orderId</code>. The <code>EntityManager.find</code> method is
used to retrieve the entity from the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CustomerOrder order = em.find(CustomerOrder.class, orderId);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first argument of <code>EntityManager.find</code> is the entity class, and the
second is the primary key.</p>
</div>
<div class="paragraph">
<p><a id="GIQUK"></a><a id="setting-entity-relationships"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="setting-entity-relationships"><a class="anchor" href="#setting-entity-relationships"></a>Setting Entity Relationships</h6>
<div class="paragraph">
<p>The <code>RequestBean.createVendorPart</code> business method creates a
<code>VendorPart</code> associated with a particular <code>Vendor</code>. The
<code>EntityManager.persist</code> method is used to persist the newly created
<code>VendorPart</code> entity to the database, and the <code>VendorPart.setVendor</code> and
<code>Vendor.setVendorPart</code> methods are used to associate the <code>VendorPart</code>
with the <code>Vendor</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">PartKey pkey = <span class="keyword">new</span> PartKey();
pkey.setPartNumber(partNumber);
pkey.setRevision(revision);

Part part = em.find(Part.class, pkey);

VendorPart vendorPart = <span class="keyword">new</span> VendorPart(description, price, part);
em.persist(vendorPart);

Vendor vendor = em.find(Vendor.class, vendorId);
vendor.addVendorPart(vendorPart);
vendorPart.setVendor(vendor);</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GIQSV"></a><a id="using-queries"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="using-queries"><a class="anchor" href="#using-queries"></a>Using Queries</h6>
<div class="paragraph">
<p>The <code>RequestBean.adjustOrderDiscount</code> business method updates the
discount applied to all orders. This method uses the <code>findAllOrders</code>
named query, defined in <code>CustomerOrder</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@NamedQuery</span>(
    name=<span class="string"><span class="delimiter">&quot;</span><span class="content">findAllOrders</span><span class="delimiter">&quot;</span></span>,
    query=<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT co FROM CustomerOrder co </span><span class="delimiter">&quot;</span></span> +
          <span class="string"><span class="delimiter">&quot;</span><span class="content">ORDER BY co.orderId</span><span class="delimiter">&quot;</span></span>
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>EntityManager.createNamedQuery</code> method is used to run the query.
Because the query returns a <code>List</code> of all the orders, the
<code>Query.getResultList</code> method is used:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span> orders = em.createNamedQuery(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">findAllOrders</span><span class="delimiter">&quot;</span></span>)
        .getResultList();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>RequestBean.getTotalPricePerVendor</code> business method returns the
total price of all the parts for a particular vendor. This method uses a
named parameter, <code>id</code>, defined in the named query
<code>findTotalVendorPartPricePerVendor</code> defined in <code>VendorPart</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@NamedQuery</span>(
    name=<span class="string"><span class="delimiter">&quot;</span><span class="content">findTotalVendorPartPricePerVendor</span><span class="delimiter">&quot;</span></span>,
    query=<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT SUM(vp.price) </span><span class="delimiter">&quot;</span></span> +
    <span class="string"><span class="delimiter">&quot;</span><span class="content">FROM VendorPart vp </span><span class="delimiter">&quot;</span></span> +
    <span class="string"><span class="delimiter">&quot;</span><span class="content">WHERE vp.vendor.vendorId = :id</span><span class="delimiter">&quot;</span></span>
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>When running the query, the <code>Query.setParameter</code> method is used to set
the named parameter <code>id</code> to the value of <code>vendorId</code>, the parameter to
<code>RequestBean.getTotalPricePerVendor</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">return</span> (<span class="predefined-type">Double</span>) em.createNamedQuery(
    <span class="string"><span class="delimiter">&quot;</span><span class="content">findTotalVendorPartPricePerVendor</span><span class="delimiter">&quot;</span></span>)
    .setParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">id</span><span class="delimiter">&quot;</span></span>, vendorId)
    .getSingleResult();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Query.getSingleResult</code> method is used for this query because the
query returns a single value.</p>
</div>
<div class="paragraph">
<p><a id="GIQTW"></a><a id="removing-entities"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="removing-entities"><a class="anchor" href="#removing-entities"></a>Removing Entities</h6>
<div class="paragraph">
<p>The <code>RequestBean.removeOrder</code> business method deletes a given order from
the database. This method uses the <code>EntityManager.remove</code> method to
delete the entity from the database:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CustomerOrder order = em.find(CustomerOrder.class, orderId);
em.remove(order);</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GIQUP"></a><a id="running-the-order-example"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="running-the-order-example"><a class="anchor" href="#running-the-order-example"></a>Running the order Example</h5>
<div class="paragraph">
<p>You can use either NetBeans IDE or Maven to build, package, deploy, and
run the <code>order</code> application. First, you will create the database tables
in Apache Derby.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#GIQSG">To Run the order Example Using NetBeans IDE</a></p>
</li>
<li>
<p><a href="#GIQTY">To Run the order Example Using Maven</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="GIQSG"></a><a id="to-run-the-order-example-using-netbeans-ide"></a></p>
</div>
<div class="sect5">
<h6 id="to-run-the-order-example-using-netbeans-ide"><a class="anchor" href="#to-run-the-order-example-using-netbeans-ide"></a>To Run the order Example Using NetBeans IDE</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>).</p>
</li>
<li>
<p>If the database server is not already running, start it by following
the instructions in <a href="#BNADK">Starting and
Stopping Apache Derby</a>.</p>
</li>
<li>
<p>From the File menu, choose Open Project.</p>
</li>
<li>
<p>In the Open Project dialog box, navigate to:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/persistence</code></pre>
</div>
</div>
</li>
<li>
<p>Select the <code>order</code> folder.</p>
</li>
<li>
<p>Click Open Project.</p>
</li>
<li>
<p>In the Projects tab, right-click the <code>order</code> project and select Run.</p>
<div class="paragraph">
<p>NetBeans IDE opens a web browser to the following URL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">http:<span class="comment">//localhost:8080/order/</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="GIQTY"></a><a id="to-run-the-order-example-using-maven"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="to-run-the-order-example-using-maven"><a class="anchor" href="#to-run-the-order-example-using-maven"></a>To Run the order Example Using Maven</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>).</p>
</li>
<li>
<p>If the database server is not already running, start it by following
the instructions in <a href="#BNADK">Starting and
Stopping Apache Derby</a>.</p>
</li>
<li>
<p>In a terminal window, go to:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/persistence/order/</code></pre>
</div>
</div>
</li>
<li>
<p>Enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">mvn install</code></pre>
</div>
</div>
<div class="paragraph">
<p>This compiles the source files and packages the application into a WAR
file located at
tut-install`/examples/persistence/order/target/order.war`. Then the WAR
file is deployed to your GlassFish Server instance.</p>
</div>
</li>
<li>
<p>To create and update the order data, open a web browser to the
following URL:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">http:<span class="comment">//localhost:8080/order/</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="GIQSQ"></a><a id="the-roster-application"></a></p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="the-roster-application"><a class="anchor" href="#the-roster-application"></a>The roster Application</h4>
<div class="paragraph">
<p>The <code>roster</code> application maintains the team rosters for players in
recreational sports leagues. The application has four components: Jakarta
Persistence entities (<code>Player</code>, <code>Team</code>, and <code>League</code>), a stateful
session bean (<code>RequestBean</code>), an application client (<code>RosterClient</code>),
and three helper classes (<code>PlayerDetails</code>, <code>TeamDetails</code>, and
<code>LeagueDetails</code>).</p>
</div>
<div class="paragraph">
<p>Functionally, <code>roster</code> is similar to the <code>order</code> application, with three
new features that <code>order</code> does not have: many-to-many relationships,
entity inheritance, and automatic table creation at deployment time.</p>
</div>
<div class="paragraph">
<p>The database schema in Apache Derby for the <code>roster</code> application
is shown in <a href="#CHDCHJHG">Figure 41-2</a>.</p>
</div>
<div id="CHDCHJHG" class="paragraph">
<div class="title"><strong>Figure 41-2 Database Schema for the roster Application</strong></div>
<p><span class="image"><img src="data:image/png;base64," alt="Diagram showing the database schema for the roster application"></span></p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Note:</p>
</div>
<div class="paragraph">
<p>In this diagram, for simplicity, the <code>PERSISTENCE_ROSTER_</code> prefix is
omitted from the table names.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="GIQSO"></a><a id="relationships-in-the-roster-application"></a></p>
</div>
<div class="sect4">
<h5 id="relationships-in-the-roster-application"><a class="anchor" href="#relationships-in-the-roster-application"></a>Relationships in the roster Application</h5>
<div class="paragraph">
<p>A recreational sports system has the following relationships.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A player can be on many teams.</p>
</li>
<li>
<p>A team can have many players.</p>
</li>
<li>
<p>A team is in exactly one league.</p>
</li>
<li>
<p>A league has many teams.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In <code>roster</code> this system is reflected by the following relationships
between the <code>Player</code>, <code>Team</code>, and <code>League</code> entities.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>There is a many-to-many relationship between <code>Player</code> and <code>Team</code>.</p>
</li>
<li>
<p>There is a many-to-one relationship between <code>Team</code> and <code>League</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="GIQQK"></a><a id="the-many-to-many-relationship-in-roster"></a></p>
</div>
<div class="sect5">
<h6 id="the-many-to-many-relationship-in-roster"><a class="anchor" href="#the-many-to-many-relationship-in-roster"></a>The Many-To-Many Relationship in roster</h6>
<div class="paragraph">
<p>The many-to-many relationship between <code>Player</code> and <code>Team</code> is specified
by using the <code>@ManyToMany</code> annotation. In <code>Team.java</code>, the <code>@ManyToMany</code>
annotation decorates the <code>getPlayers</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ManyToMany</span>
<span class="annotation">@JoinTable</span>(
    name=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENCE_ROSTER_TEAM_PLAYER</span><span class="delimiter">&quot;</span></span>,
    joinColumns=
        <span class="annotation">@JoinColumn</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">TEAM_ID</span><span class="delimiter">&quot;</span></span>, referencedColumnName=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID</span><span class="delimiter">&quot;</span></span>),
    inverseJoinColumns=
        <span class="annotation">@JoinColumn</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">PLAYER_ID</span><span class="delimiter">&quot;</span></span>, referencedColumnName=<span class="string"><span class="delimiter">&quot;</span><span class="content">ID</span><span class="delimiter">&quot;</span></span>)
)
<span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;Player&gt; getPlayers() {
    <span class="keyword">return</span> players;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>@JoinTable</code> annotation is used to specify a database table that
will associate player IDs with team IDs. The entity that specifies the
<code>@JoinTable</code> is the owner of the relationship, so the <code>Team</code> entity is
the owner of the relationship with the <code>Player</code> entity. Because <code>roster</code>
uses automatic table creation at deployment time, the container will
create a join table named <code>PERSISTENCE_ROSTER_TEAM_PLAYER</code>.</p>
</div>
<div class="paragraph">
<p><code>Player</code> is the inverse, or nonowning, side of the relationship with
<code>Team</code>. As one-to-one and many-to-one relationships, the nonowning side
is marked by the <code>mappedBy</code> element in the relationship annotation.
Because the relationship between <code>Player</code> and <code>Team</code> is bidirectional,
the choice of which entity is the owner of the relationship is
arbitrary.</p>
</div>
<div class="paragraph">
<p>In <code>Player.java</code>, the <code>@ManyToMany</code> annotation decorates the <code>getTeams</code>
method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@ManyToMany</span>(mappedBy=<span class="string"><span class="delimiter">&quot;</span><span class="content">players</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="predefined-type">Collection</span>&lt;Team&gt; getTeams() {
    <span class="keyword">return</span> teams;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GIQRF"></a><a id="entity-inheritance-in-the-roster-application"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="entity-inheritance-in-the-roster-application"><a class="anchor" href="#entity-inheritance-in-the-roster-application"></a>Entity Inheritance in the roster Application</h5>
<div class="paragraph">
<p>The <code>roster</code> application shows how to use entity inheritance, as
described in <a href="#BNBQN">Entity Inheritance</a>.</p>
</div>
<div class="paragraph">
<p>The <code>League</code> entity in <code>roster</code> is an abstract entity with two concrete
subclasses: <code>SummerLeague</code> and <code>WinterLeague</code>. Because <code>League</code> is an
abstract class, it cannot be instantiated:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="annotation">@Table</span>(name = <span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENCE_ROSTER_LEAGUE</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">League</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead, when creating a league, clients use <code>SummerLeague</code> or
<code>WinterLeague</code>. <code>SummerLeague</code> and <code>WinterLeague</code> inherit the persistent
properties defined in <code>League</code> and add only a constructor that verifies
that the sport parameter matches the type of sport allowed in that
seasonal league. For example, here is the <code>SummerLeague</code> entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">...
<span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SummerLeague</span> <span class="directive">extends</span> League <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {

    <span class="comment">/** Creates a new instance of SummerLeague */</span>
    <span class="directive">public</span> SummerLeague() {
    }

    <span class="directive">public</span> SummerLeague(<span class="predefined-type">String</span> id, <span class="predefined-type">String</span> name, <span class="predefined-type">String</span> sport)
            <span class="directive">throws</span> IncorrectSportException {
        <span class="local-variable">this</span>.id = id;
        <span class="local-variable">this</span>.name = name;
        <span class="keyword">if</span> (sport.equalsIgnoreCase(<span class="string"><span class="delimiter">&quot;</span><span class="content">swimming</span><span class="delimiter">&quot;</span></span>) ||
                sport.equalsIgnoreCase(<span class="string"><span class="delimiter">&quot;</span><span class="content">soccer</span><span class="delimiter">&quot;</span></span>) ||
                sport.equalsIgnoreCase(<span class="string"><span class="delimiter">&quot;</span><span class="content">basketball</span><span class="delimiter">&quot;</span></span>) ||
                sport.equalsIgnoreCase(<span class="string"><span class="delimiter">&quot;</span><span class="content">baseball</span><span class="delimiter">&quot;</span></span>)) {
            <span class="local-variable">this</span>.sport = sport;
        } <span class="keyword">else</span> {
            <span class="keyword">throw</span> <span class="keyword">new</span> IncorrectSportException(<span class="string"><span class="delimiter">&quot;</span><span class="content">Sport is not a summer sport.</span><span class="delimiter">&quot;</span></span>);
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>roster</code> application uses the default mapping strategy of
<code>InheritanceType.SINGLE_TABLE</code>, so the <code>@Inheritance</code> annotation is not
required. If you want to use a different mapping strategy, decorate
<code>League</code> with <code>@Inheritance</code> and specify the mapping strategy in the
<code>strategy</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="annotation">@Inheritance</span>(strategy=JOINED)
<span class="annotation">@Table</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENCE_ROSTER_LEAGUE</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">League</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>roster</code> application uses the default discriminator column name, so
the <code>@DiscriminatorColumn</code> annotation is not required. Because you are
using automatic table generation in <code>roster</code>, the Persistence provider
will create a discriminator column called <code>DTYPE</code> in the
<code>PERSISTENCE_ROSTER_LEAGUE</code> table, which will store the name of the
inherited entity used to create the league. If you want to use a
different name for the discriminator column, decorate <code>League</code> with
<code>@DiscriminatorColumn</code> and set the <code>name</code> element:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="annotation">@DiscriminatorColumn</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">DISCRIMINATOR</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Table</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">PERSISTENCE_ROSTER_LEAGUE</span><span class="delimiter">&quot;</span></span>)
<span class="directive">public</span> <span class="directive">abstract</span> <span class="type">class</span> <span class="class">League</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GJJFL"></a><a id="criteria-queries-in-the-roster-application"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="criteria-queries-in-the-roster-application"><a class="anchor" href="#criteria-queries-in-the-roster-application"></a>Criteria Queries in the roster Application</h5>
<div class="paragraph">
<p>The <code>roster</code> application uses Criteria API queries, as opposed to the
JPQL queries used in <code>order</code>. Criteria queries are Java programming
language, typesafe queries defined in the business tier of <code>roster</code>, in
the <code>RequestBean</code> stateful session bean.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#GJJEX">Metamodel Classes in the roster Application</a></p>
</li>
<li>
<p><a href="#GJJFN">Obtaining a CriteriaBuilder Instance in RequestBean</a></p>
</li>
<li>
<p><a href="#GJJFF">Creating Criteria Queries in RequestBean&#8217;s Business
Methods</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="GJJEX"></a><a id="metamodel-classes-in-the-roster-application"></a></p>
</div>
<div class="sect5">
<h6 id="metamodel-classes-in-the-roster-application"><a class="anchor" href="#metamodel-classes-in-the-roster-application"></a>Metamodel Classes in the roster Application</h6>
<div class="paragraph">
<p>Metamodel classes model an entity&#8217;s attributes and are used by Criteria
queries to navigate to an entity&#8217;s attributes. Each entity class in
<code>roster</code> has a corresponding metamodel class, generated at compile time,
with the same package name as the entity and appended with an underscore
character (<em>). For example, the <code>roster.entity.Player</code> entity has a
corresponding metamodel class, <code>roster.entity.Player</em></code>.</p>
</div>
<div class="paragraph">
<p>Each persistent field or property in the entity class has a
corresponding attribute in the entity&#8217;s metamodel class. For the
<code>Player</code> entity, the corresponding metamodel class is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@StaticMetamodel</span>(Player.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Player_</span> {
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">volatile</span> SingularAttribute&lt;Player, <span class="predefined-type">String</span>&gt; id;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">volatile</span> SingularAttribute&lt;Player, <span class="predefined-type">String</span>&gt; name;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">volatile</span> SingularAttribute&lt;Player, <span class="predefined-type">String</span>&gt; position;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">volatile</span> SingularAttribute&lt;Player, <span class="predefined-type">Double</span>&gt; salary;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">volatile</span> CollectionAttribute&lt;Player, Team&gt; teams;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GJJFN"></a><a id="obtaining-a-criteriabuilder-instance-in-requestbean"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="obtaining-a-criteriabuilder-instance-in-requestbean"><a class="anchor" href="#obtaining-a-criteriabuilder-instance-in-requestbean"></a>Obtaining a CriteriaBuilder Instance in RequestBean</h6>
<div class="paragraph">
<p>The <code>CriteriaBuilder</code> interface defines methods to create criteria query
objects and create expressions for modifying those query objects.
<code>RequestBean</code> creates an instance of <code>CriteriaBuilder</code> by using a
<code>@PostConstruct</code> method, <code>init</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@PersistenceContext</span>
<span class="directive">private</span> EntityManager em;
<span class="directive">private</span> CriteriaBuilder cb;

<span class="annotation">@PostConstruct</span>
<span class="directive">private</span> <span class="type">void</span> init() {
    cb = em.getCriteriaBuilder();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>EntityManager</code> instance is injected at runtime, and then that
<code>EntityManager</code> object is used to create the <code>CriteriaBuilder</code> instance
by calling <code>getCriteriaBuilder</code>. The <code>CriteriaBuilder</code> instance is
created in a <code>@PostConstruct</code> method to ensure that the <code>EntityManager</code>
instance has been injected by the enterprise bean container.</p>
</div>
<div class="paragraph">
<p><a id="GJJFF"></a><a id="creating-criteria-queries-in-requestbeans-business-methods"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="creating-criteria-queries-in-requestbeans-business-methods"><a class="anchor" href="#creating-criteria-queries-in-requestbeans-business-methods"></a>Creating Criteria Queries in RequestBean&#8217;s Business Methods</h6>
<div class="paragraph">
<p>Many of the business methods in <code>RequestBean</code> define Criteria queries.
One business method, <code>getPlayersByPosition</code>, returns a list of players
who play a particular position on a team:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="predefined-type">List</span>&lt;PlayerDetails&gt; getPlayersByPosition(<span class="predefined-type">String</span> position) {
    logger.info(<span class="string"><span class="delimiter">&quot;</span><span class="content">getPlayersByPosition</span><span class="delimiter">&quot;</span></span>);
    <span class="predefined-type">List</span>&lt;Player&gt; players = <span class="predefined-constant">null</span>;

    <span class="keyword">try</span> {
        CriteriaQuery&lt;Player&gt; cq = cb.createQuery(Player.class);
        <span class="keyword">if</span> (cq != <span class="predefined-constant">null</span>) {
            Root&lt;Player&gt; player = cq.from(Player.class);

            <span class="comment">// set the where clause</span>
            cq.where(cb.equal(player.get(Player_.position), position));
            cq.select(player);
            TypedQuery&lt;Player&gt; q = em.createQuery(cq);
            players = q.getResultList();
        }
        <span class="keyword">return</span> copyPlayersToDetails(players);
    } <span class="keyword">catch</span> (<span class="exception">Exception</span> ex) {
        <span class="keyword">throw</span> <span class="keyword">new</span> EJBException(ex);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>A query object is created by calling the <code>CriteriaBuilder</code> object&#8217;s
<code>createQuery</code> method, with the type set to <code>Player</code> because the query
will return a list of players.</p>
</div>
<div class="paragraph">
<p>The query root, the base entity from which the query will navigate to
find the entity&#8217;s attributes and related entities, is created by calling
the <code>from</code> method of the query object. This sets the <code>FROM</code> clause of
the query.</p>
</div>
<div class="paragraph">
<p>The <code>WHERE</code> clause, set by calling the <code>where</code> method on the query
object, restricts the results of the query according to the conditions
of an expression. The <code>CriteriaBuilder.equal</code> method compares the two
expressions. In <code>getPlayersByPosition</code>, the <code>position</code> attribute of the
<code>Player_</code> metamodel class, accessed by calling the <code>get</code> method of the
query root, is compared to the <code>position</code> parameter passed to
<code>getPlayersByPosition</code>.</p>
</div>
<div class="paragraph">
<p>The <code>SELECT</code> clause of the query is set by calling the <code>select</code> method
of the query object. The query will return <code>Player</code> entities, so the
query root object is passed as a parameter to <code>select</code>.</p>
</div>
<div class="paragraph">
<p>The query object is prepared for execution by calling
<code>EntityManager.createQuery</code>, which returns a <code>TypedQuery&lt;T&gt;</code> object with
the type of the query, in this case <code>Player</code>. This typed query object is
used to execute the query, which occurs when the <code>getResultList</code> method
is called, and a <code>List&lt;Player&gt;</code> collection is returned.</p>
</div>
<div class="paragraph">
<p><a id="GIQRX"></a><a id="automatic-table-generation-in-the-roster-application"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="automatic-table-generation-in-the-roster-application"><a class="anchor" href="#automatic-table-generation-in-the-roster-application"></a>Automatic Table Generation in the roster Application</h5>
<div class="paragraph">
<p>At deployment time, GlassFish Server will automatically drop and create
the database tables used by <code>roster</code>. This is done by setting the
<code>javax.persistence.schema-generation.database.action</code> property to
<code>drop-and-create</code> in <code>persistence.xml</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;persistence</span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2.1</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/persistence</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
    <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/persistence</span>
        <span class="content">http://xmlns.jcp.org/xml/ns/persistence/persistence_2_1.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;persistence-unit</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">em</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transaction-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">JTA</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;jta-data-source&gt;</span>java:comp/DefaultDataSource<span class="tag">&lt;/jta-data-source&gt;</span>
    <span class="tag">&lt;properties&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.schema-generation.database.action</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">drop-and-create</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/properties&gt;</span>
  <span class="tag">&lt;/persistence-unit&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GIQUZ"></a><a id="running-the-roster-example"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="running-the-roster-example"><a class="anchor" href="#running-the-roster-example"></a>Running the roster Example</h5>
<div class="paragraph">
<p>You can use either NetBeans IDE or Maven to build, package, deploy, and
run the <code>roster</code> application.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#GIQUG">To Run the roster Example Using NetBeans IDE</a></p>
</li>
<li>
<p><a href="#GIQSJ">To Run the roster Example Using Maven</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="GIQUG"></a><a id="to-run-the-roster-example-using-netbeans-ide"></a></p>
</div>
<div class="sect5">
<h6 id="to-run-the-roster-example-using-netbeans-ide"><a class="anchor" href="#to-run-the-roster-example-using-netbeans-ide"></a>To Run the roster Example Using NetBeans IDE</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>).</p>
</li>
<li>
<p>If the database server is not already running, start it by following
the instructions in <a href="#BNADK">Starting and
Stopping Apache Derby</a>.</p>
</li>
<li>
<p>From the File menu, choose Open Project.</p>
</li>
<li>
<p>In the Open Project dialog box, navigate to:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/persistence</code></pre>
</div>
</div>
</li>
<li>
<p>Select the <code>roster</code> folder.</p>
</li>
<li>
<p>Select the Open Required Projects check box.</p>
</li>
<li>
<p>Click Open Project.</p>
</li>
<li>
<p>In the Projects tab, right-click the <code>roster</code> project and select
Build.</p>
<div class="paragraph">
<p>This will compile, package, and deploy the EAR to GlassFish Server.</p>
</div>
<div class="paragraph">
<p>You will see the following partial output from the application client in
the Output tab:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span> all players in team T2:
P6 Ian Carlyle goalkeeper <span class="float">555.0</span>
P7 Rebecca Struthers midfielder <span class="float">777.0</span>
P8 Anne Anderson forward <span class="float">65.0</span>
P9 Jan Wesley defender <span class="float">100.0</span>
P10 Terry Smithson midfielder <span class="float">100.0</span>

<span class="predefined-type">List</span> all teams in league L1:
T1 Honey Bees Visalia
T2 Gophers Manteca
T5 Crows Orland

<span class="predefined-type">List</span> all defenders:
P2 Alice Smith defender <span class="float">505.0</span>
P5 Barney Bold defender <span class="float">100.0</span>
P9 Jan Wesley defender <span class="float">100.0</span>
P22 Janice Walker defender <span class="float">857.0</span>
P25 Frank Fletcher defender <span class="float">399.0</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="GIQSJ"></a><a id="to-run-the-roster-example-using-maven"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="to-run-the-roster-example-using-maven"><a class="anchor" href="#to-run-the-roster-example-using-maven"></a>To Run the roster Example Using Maven</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>).</p>
</li>
<li>
<p>If the database server is not already running, start it by following
the instructions in <a href="#BNADK">Starting and
Stopping Apache Derby</a>.</p>
</li>
<li>
<p>In a terminal window, go to:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/persistence/roster/roster-ear/</code></pre>
</div>
</div>
</li>
<li>
<p>Enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">mvn install</code></pre>
</div>
</div>
<div class="paragraph">
<p>This compiles the source files and packages the application into an EAR
file located at
tut-install`/examples/persistence/roster/target/roster.ear`. The EAR
file is then deployed to GlassFish Server. GlassFish Server will then
drop and create the database tables during deployment, as specified in
<code>persistence.xml</code>.</p>
</div>
<div class="paragraph">
<p>After successfully deploying the EAR, the client stubs are retrieved and
the application client is run using the appclient application included
with GlassFish Server.</p>
</div>
<div class="paragraph">
<p>You will see the output, which begins as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">[echo] running application client container.
[exec] <span class="predefined-type">List</span> all players in team T2:
[exec] P6 Ian Carlyle goalkeeper <span class="float">555.0</span>
[exec] P7 Rebecca Struthers midfielder <span class="float">777.0</span>
[exec] P8 Anne Anderson forward <span class="float">65.0</span>
[exec] P9 Jan Wesley defender <span class="float">100.0</span>
[exec] P10 Terry Smithson midfielder <span class="float">100.0</span>

[exec] <span class="predefined-type">List</span> all teams in league L1:
[exec] T1 Honey Bees Visalia
[exec] T2 Gophers Manteca
[exec] T5 Crows Orland

[exec] <span class="predefined-type">List</span> all defenders:
[exec] P2 Alice Smith defender <span class="float">505.0</span>
[exec] P5 Barney Bold defender <span class="float">100.0</span>
[exec] P9 Jan Wesley defender <span class="float">100.0</span>
[exec] P22 Janice Walker defender <span class="float">857.0</span>
[exec] P25 Frank Fletcher defender <span class="float">399.0</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="GKANQ"></a><a id="the-address-book-application"></a></p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="the-address-book-application"><a class="anchor" href="#the-address-book-application"></a>The address-book Application</h4>
<div class="paragraph">
<p>The <code>address-book</code> example application is a simple web application that
stores contact data. It uses a single entity class, <code>Contact</code>, that uses
Jakarta Bean Validation to validate the
data stored in the persistent attributes of the entity, as described in
<a href="#GKAHQ">Validating Persistent Fields and
Properties</a>.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#GKAOJ">Bean Validation Constraints in address-book</a></p>
</li>
<li>
<p><a href="#GKANL">Specifying Error Messages for Constraints in address-book</a></p>
</li>
<li>
<p><a href="#GKAON">Validating Contact Input from a Jakarta Server Faces
Application</a></p>
</li>
<li>
<p><a href="#GKAOP">Running the address-book Example</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="GKAOJ"></a><a id="bean-validation-constraints-in-address-book"></a></p>
</div>
<div class="sect4">
<h5 id="bean-validation-constraints-in-address-book"><a class="anchor" href="#bean-validation-constraints-in-address-book"></a>Bean Validation Constraints in address-book</h5>
<div class="paragraph">
<p>The <code>Contact</code> entity uses the <code>@NotNull</code>, <code>@Pattern</code>, and <code>@Past</code>
constraints on the persistent attributes.</p>
</div>
<div class="paragraph">
<p>The <code>@NotNull</code> constraint marks the attribute as a required field. The
attribute must be set to a non-null value before the entity can be
persisted or modified. Bean Validation will throw a validation error if
the attribute is null when the entity is persisted or modified.</p>
</div>
<div class="paragraph">
<p>The <code>@Pattern</code> constraint defines a regular expression that the value of
the attribute must match before the entity can be persisted or modified.
This constraint has two different uses in <code>address-book</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The regular expression declared in the <code>@Pattern</code> annotation on the
<code>email</code> field matches email addresses of the form name`@<code>domain
name</code>.<code>top level domain, allowing only valid characters for email
addresses. For example, `<a href="mailto:username@example.com">username@example.com</a></code> will pass validation, as
will <code>firstname.lastname@mail.example.com</code>. However,
<code>firstname,<a href="mailto:lastname@example.com">lastname@example.com</a></code>, which contains an illegal comma
character in the local name, will fail validation.</p>
</li>
<li>
<p>The <code>mobilePhone</code> and <code>homePhone</code> fields are annotated with a
<code>@Pattern</code> constraint that defines a regular expression to match phone
numbers of the form <code>(`xxx</code>)` xxx`-`xxxx.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>@Past</code> constraint is applied to the birthday field, which must be a
<code>java.util.Date</code> in the past.</p>
</div>
<div class="paragraph">
<p>Here are the relevant parts of the <code>Contact</code> entity class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Contact</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
    <span class="annotation">@Id</span>
    <span class="annotation">@GeneratedValue</span>(strategy = GenerationType.AUTO)
    <span class="directive">private</span> <span class="predefined-type">Long</span> id;
    <span class="annotation">@NotNull</span>
    <span class="directive">protected</span> <span class="predefined-type">String</span> firstName;
    <span class="annotation">@NotNull</span>
    <span class="directive">protected</span> <span class="predefined-type">String</span> lastName;
    <span class="annotation">@Pattern</span>(regexp = <span class="string"><span class="delimiter">&quot;</span><span class="content">[a-z0-9!#$%&amp;'*+/=?^_`{|}~-]+(?:</span><span class="char">\\</span><span class="content">.</span><span class="delimiter">&quot;</span></span>
            + <span class="string"><span class="delimiter">&quot;</span><span class="content">[a-z0-9!#$%&amp;'*+/=?^_`{|}~-]+)*@</span><span class="delimiter">&quot;</span></span>
            + <span class="string"><span class="delimiter">&quot;</span><span class="content">(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?</span><span class="char">\\</span><span class="content">.)+[a-z0-9]</span><span class="delimiter">&quot;</span></span>
            + <span class="string"><span class="delimiter">&quot;</span><span class="content">(?:[a-z0-9-]*[a-z0-9])?</span><span class="delimiter">&quot;</span></span>,
            message = <span class="string"><span class="delimiter">&quot;</span><span class="content">{invalid.email}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">protected</span> <span class="predefined-type">String</span> email;
    <span class="annotation">@Pattern</span>(regexp = <span class="string"><span class="delimiter">&quot;</span><span class="content">^</span><span class="char">\\</span><span class="content">(?(</span><span class="char">\\</span><span class="content">d{3})</span><span class="char">\\</span><span class="content">)?[- ]?(</span><span class="char">\\</span><span class="content">d{3})[- ]?(</span><span class="char">\\</span><span class="content">d{4})$</span><span class="delimiter">&quot;</span></span>,
            message = <span class="string"><span class="delimiter">&quot;</span><span class="content">{invalid.phonenumber}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">protected</span> <span class="predefined-type">String</span> mobilePhone;
    <span class="annotation">@Pattern</span>(regexp = <span class="string"><span class="delimiter">&quot;</span><span class="content">^</span><span class="char">\\</span><span class="content">(?(</span><span class="char">\\</span><span class="content">d{3})</span><span class="char">\\</span><span class="content">)?[- ]?(</span><span class="char">\\</span><span class="content">d{3})[- ]?(</span><span class="char">\\</span><span class="content">d{4})$</span><span class="delimiter">&quot;</span></span>,
            message = <span class="string"><span class="delimiter">&quot;</span><span class="content">{invalid.phonenumber}</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">protected</span> <span class="predefined-type">String</span> homePhone;
    <span class="annotation">@Temporal</span>(javax.persistence.TemporalType.DATE)
    <span class="annotation">@Past</span>
    <span class="directive">protected</span> <span class="predefined-type">Date</span> birthday;
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GKANL"></a><a id="specifying-error-messages-for-constraints-in-address-book"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="specifying-error-messages-for-constraints-in-address-book"><a class="anchor" href="#specifying-error-messages-for-constraints-in-address-book"></a>Specifying Error Messages for Constraints in address-book</h5>
<div class="paragraph">
<p>Some of the constraints in the <code>Contact</code> entity specify an optional
message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Pattern</span>(regexp = <span class="string"><span class="delimiter">&quot;</span><span class="content">^</span><span class="char">\\</span><span class="content">(?(</span><span class="char">\\</span><span class="content">d{3})</span><span class="char">\\</span><span class="content">)?[- ]?(</span><span class="char">\\</span><span class="content">d{3})[- ]?(</span><span class="char">\\</span><span class="content">d{4})$</span><span class="delimiter">&quot;</span></span>,
        message = <span class="string"><span class="delimiter">&quot;</span><span class="content">{invalid.phonenumber}</span><span class="delimiter">&quot;</span></span>)
<span class="directive">protected</span> <span class="predefined-type">String</span> homePhone;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The optional message element in the <code>@Pattern</code> constraint overrides the
default validation message. The message can be specified directly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Pattern</span>(regexp = <span class="string"><span class="delimiter">&quot;</span><span class="content">^</span><span class="char">\\</span><span class="content">(?(</span><span class="char">\\</span><span class="content">d{3})</span><span class="char">\\</span><span class="content">)?[- ]?(</span><span class="char">\\</span><span class="content">d{3})[- ]?(</span><span class="char">\\</span><span class="content">d{4})$</span><span class="delimiter">&quot;</span></span>,
        message = <span class="string"><span class="delimiter">&quot;</span><span class="content">Invalid phone number!</span><span class="delimiter">&quot;</span></span>)
<span class="directive">protected</span> <span class="predefined-type">String</span> homePhone;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The constraints in <code>Contact</code>, however, are strings in the resource
bundle <code>ValidationMessages.properties</code>, under
<code><em>tut-install</em>/examples/persistence/address-book/src/java/</code>. This allows
the validation messages to be located in one single properties file and
the messages to be easily localized. Overridden Bean Validation messages
must be placed in a resource bundle properties file named
<code>ValidationMessages.properties</code> in the default package, with localized
resource bundles taking the form
<code>ValidationMessages_`locale-prefix</code>.properties`. For example,
<code>ValidationMessages_es.properties</code> is the resource bundle used in
Spanish-speaking locales.</p>
</div>
<div class="paragraph">
<p><a id="GKAON"></a><a id="validating-contact-input-from-a-javaserver-faces-application"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="validating-contact-input-from-a-jakarta-server-faces-application"><a class="anchor" href="#validating-contact-input-from-a-jakarta-server-faces-application"></a>Validating Contact Input from a Jakarta Server Faces Application</h5>
<div class="paragraph">
<p>The <code>address-book</code> application uses a Jakarta Server Faces web front end to
allow users to enter contacts. While Jakarta Server Faces has a form input
validation mechanism using tags in Facelets XHTML files, <code>address-book</code>
doesn&#8217;t use these validation tags. Bean Validation constraints in
Jakarta Server Faces managed beans, in this case in the <code>Contact</code> entity,
automatically trigger validation when the forms are submitted.</p>
</div>
<div class="paragraph">
<p>The following code snippet from the <code>Create.xhtml</code> Facelets file shows
some of the input form for creating new <code>Contact</code> instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;h:form&gt;</span>
    <span class="tag">&lt;table</span> <span class="attribute-name">columns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">3</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">role</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">presentation</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
        <span class="tag">&lt;tr&gt;</span>
            <span class="tag">&lt;td&gt;</span><span class="tag">&lt;h:outputLabel</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{bundle.CreateContactLabel_firstName}</span><span class="delimiter">&quot;</span></span>
                               <span class="attribute-name">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span><span class="tag">&lt;/td&gt;</span>
            <span class="tag">&lt;td&gt;</span><span class="tag">&lt;h:inputText</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{contactController.selected.firstName}</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">title</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{bundle.CreateContactTitle_firstName}</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
            <span class="tag">&lt;/td&gt;</span>
            <span class="tag">&lt;td&gt;</span><span class="tag">&lt;h:message</span> <span class="attribute-name">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">firstName</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span><span class="tag">&lt;/td&gt;</span>
        <span class="tag">&lt;/tr&gt;</span>
        <span class="tag">&lt;tr&gt;</span>
            <span class="tag">&lt;td&gt;</span><span class="tag">&lt;h:outputLabel</span> <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{bundle.CreateContactLabel_lastName}</span><span class="delimiter">&quot;</span></span>
                               <span class="attribute-name">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span><span class="tag">&lt;/td&gt;</span>
            <span class="tag">&lt;td&gt;</span><span class="tag">&lt;h:inputText</span> <span class="attribute-name">id</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{contactController.selected.lastName}</span><span class="delimiter">&quot;</span></span>
                             <span class="attribute-name">title</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">#{bundle.CreateContactTitle_lastName}</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span>
            <span class="tag">&lt;/td&gt;</span>
            <span class="tag">&lt;td&gt;</span><span class="tag">&lt;h:message</span> <span class="attribute-name">for</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">lastName</span><span class="delimiter">&quot;</span></span> <span class="tag">/&gt;</span><span class="tag">&lt;/td&gt;</span>
        <span class="tag">&lt;/tr&gt;</span>
        ...
    <span class="tag">&lt;/table&gt;</span>
<span class="tag">&lt;/h:form&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>&lt;h:inputText&gt;</code> tags <code>firstName</code> and <code>lastName</code> are bound to the
attributes in the <code>Contact</code> entity instance <code>selected</code> in the
<code>ContactController</code> stateless session bean. Each <code>&lt;h:inputText&gt;</code> tag has
an associated <code>&lt;h:message&gt;</code> tag that will display validation error
messages. The form doesn&#8217;t require any Jakarta Server Faces validation tags,
however.</p>
</div>
<div class="paragraph">
<p><a id="GKAOP"></a><a id="running-the-address-book-example"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="running-the-address-book-example"><a class="anchor" href="#running-the-address-book-example"></a>Running the address-book Example</h5>
<div class="paragraph">
<p>You can use either NetBeans IDE or Maven to build, package, deploy, and
run the <code>address-book</code> application.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#GKAOD">To Run the address-book Example Using NetBeans IDE</a></p>
</li>
<li>
<p><a href="#GKANZ">To Run the address-book Example Using Maven</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="GKAOD"></a><a id="to-run-the-address-book-example-using-netbeans-ide"></a></p>
</div>
<div class="sect5">
<h6 id="to-run-the-address-book-example-using-netbeans-ide"><a class="anchor" href="#to-run-the-address-book-example-using-netbeans-ide"></a>To Run the address-book Example Using NetBeans IDE</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>).</p>
</li>
<li>
<p>If the database server is not already running, start it by following
the instructions in <a href="#BNADK">Starting and
Stopping Apache Derby</a>.</p>
</li>
<li>
<p>From the File menu, choose Open Project.</p>
</li>
<li>
<p>In the Open Project dialog box, navigate to:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/persistence</code></pre>
</div>
</div>
</li>
<li>
<p>Select the <code>address-book</code> folder.</p>
</li>
<li>
<p>Click Open Project.</p>
</li>
<li>
<p>In the Projects tab, right-click the <code>address-book</code> project and
select Run.</p>
<div class="paragraph">
<p>After the application has been deployed, a web browser window appears at
the following URL:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">http:<span class="comment">//localhost:8080/address-book/</span></code></pre>
</div>
</div>
</li>
<li>
<p>Click Show All Contact Items, then Create New Contact. Enter values
in the fields; then click Save.</p>
<div class="paragraph">
<p>If any of the values entered violate the constraints in <code>Contact</code>, an
error message will appear in red beside the field with the incorrect
values.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="GKANZ"></a><a id="to-run-the-address-book-example-using-maven"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="to-run-the-address-book-example-using-maven"><a class="anchor" href="#to-run-the-address-book-example-using-maven"></a>To Run the address-book Example Using Maven</h6>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>).</p>
</li>
<li>
<p>If the database server is not already running, start it by following
the instructions in <a href="#BNADK">Starting and
Stopping Apache Derby</a>.</p>
</li>
<li>
<p>In a terminal window, go to:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/persistence/address-book/</code></pre>
</div>
</div>
</li>
<li>
<p>Enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">mvn install</code></pre>
</div>
</div>
<div class="paragraph">
<p>This will compile and assemble the <code>address-book</code> application into a
WAR. The WAR file is then deployed to GlassFish Server.</p>
</div>
</li>
<li>
<p>Open a web browser window and enter the following URL:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">http:<span class="comment">//localhost:8080/address-book/</span></code></pre>
</div>
</div>
</li>
<li>
<p>Click Show All Contact Items, then Create New Contact. Enter values
in the fields; then click Save.</p>
<div class="paragraph">
<p>If any of the values entered violate the constraints in <code>Contact</code>, an
error message will appear in red beside the field with the incorrect
values.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="the-jakarta-persistence-query-language"><a class="anchor" href="#the-jakarta-persistence-query-language"></a>The Jakarta Persistence Query Language</h3>
<div class="paragraph">
<p><a id="BNBTG"></a><a id="the-java-persistence-query-language"></a></p>
</div>
<div class="paragraph">
<p>This chapter describes the Jakarta Persistence query language that defines
queries for entities and their persistent state. The query language
allows you to write portable queries that work regardless of the
underlying data store.</p>
</div>
<div class="paragraph">
<p><a id="A1073303"></a><a id="overview-of-the-java-persistence-query-language"></a></p>
</div>
<div class="sect3">
<h4 id="overview-of-the-jakarta-persistence-query-language"><a class="anchor" href="#overview-of-the-jakarta-persistence-query-language"></a>Overview of the Jakarta Persistence Query Language</h4>
<div class="paragraph">
<p>The query language uses the abstract persistence schemas of entities,
including their relationships, for its data model and defines operators
and expressions based on this data model. The scope of a query spans the
abstract schemas of related entities that are packaged in the same
persistence unit. The query language uses an SQL-like syntax to select
objects or values based on entity abstract schema types and
relationships among them.</p>
</div>
<div class="paragraph">
<p>This chapter relies on the material presented in earlier chapters. For
conceptual information, see <a href="#BNBPZ">Chapter 40,
"Introduction to Jakarta Persistence"</a>. For code examples, see
<a href="#GIJST">Chapter 41, "Running the
Persistence Examples."</a></p>
</div>
<div class="paragraph">
<p><a id="BNBTH"></a><a id="query-language-terminology"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="query-language-terminology"><a class="anchor" href="#query-language-terminology"></a>Query Language Terminology</h4>
<div class="paragraph">
<p>The following list defines some of the terms referred to in this
chapter.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Abstract schema: The persistent schema abstraction (persistent
entities, their state, and their relationships) over which queries
operate. The query language translates queries over this persistent
schema abstraction into queries that are executed over the database
schema to which entities are mapped.</p>
</li>
<li>
<p>Abstract schema type: The type to which the persistent property of an
entity evaluates in the abstract schema. That is, each persistent field
or property in an entity has a corresponding state field of the same
type in the abstract schema. The abstract schema type of an entity is
derived from the entity class and the metadata information provided by
Java language annotations.</p>
</li>
<li>
<p>Backus-Naur Form (BNF): A notation that describes the syntax of
high-level languages. The syntax diagrams in this chapter are in BNF
notation.</p>
</li>
<li>
<p>Navigation: The traversal of relationships in a query language
expression. The navigation operator is a period.</p>
</li>
<li>
<p>Path expression: An expression that navigates to an entity&#8217;s state or
relationship field.</p>
</li>
<li>
<p>State field: A persistent field of an entity.</p>
</li>
<li>
<p>Relationship field: A persistent field of an entity whose type is the
abstract schema type of the related entity.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBRG"></a><a id="creating-queries-using-the-java-persistence-query-language"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="creating-queries-using-the-jakarta-persistence-query-language"><a class="anchor" href="#creating-queries-using-the-jakarta-persistence-query-language"></a>Creating Queries Using the Jakarta Persistence Query Language</h4>
<div class="paragraph">
<p>The <code>EntityManager.createQuery</code> and <code>EntityManager.createNamedQuery</code>
methods are used to query the datastore by using Jakarta Persistence query
language queries.</p>
</div>
<div class="paragraph">
<p>The <code>createQuery</code> method is used to create dynamic queries, which are
queries defined directly within an application&#8217;s business logic:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="predefined-type">List</span> findWithName(<span class="predefined-type">String</span> name) {
<span class="keyword">return</span> em.createQuery(
    <span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT c FROM Customer c WHERE c.name LIKE :custName</span><span class="delimiter">&quot;</span></span>)
    .setParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">custName</span><span class="delimiter">&quot;</span></span>, name)
    .setMaxResults(<span class="integer">10</span>)
    .getResultList();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>createNamedQuery</code> method is used to create static queries, or
queries that are defined in metadata by using the
<code>javax.persistence.NamedQuery</code> annotation. The <code>name</code> element of
<code>@NamedQuery</code> specifies the name of the query that will be used with the
<code>createNamedQuery</code> method. The <code>query</code> element of <code>@NamedQuery</code> is the
query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@NamedQuery</span>(
    name=<span class="string"><span class="delimiter">&quot;</span><span class="content">findAllCustomersWithName</span><span class="delimiter">&quot;</span></span>,
    query=<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT c FROM Customer c WHERE c.name LIKE :custName</span><span class="delimiter">&quot;</span></span>
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s an example of <code>createNamedQuery</code>, which uses the <code>@NamedQuery</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@PersistenceContext</span>
<span class="directive">public</span> EntityManager em;
...
customers = em.createNamedQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">findAllCustomersWithName</span><span class="delimiter">&quot;</span></span>)
    .setParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">custName</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Smith</span><span class="delimiter">&quot;</span></span>)
    .getResultList();</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBRH"></a><a id="named-parameters-in-queries"></a></p>
</div>
<div class="sect4">
<h5 id="named-parameters-in-queries"><a class="anchor" href="#named-parameters-in-queries"></a>Named Parameters in Queries</h5>
<div class="paragraph">
<p>Named parameters are query parameters that are prefixed with a colon
(<code>:</code>). Named parameters in a query are bound to an argument by the
following method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">javax.persistence.Query.setParameter(<span class="predefined-type">String</span> name, <span class="predefined-type">Object</span> value)</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the following example, the <code>name</code> argument to the <code>findWithName</code>
business method is bound to the <code>:custName</code> named parameter in the query
by calling <code>Query.setParameter</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="predefined-type">List</span> findWithName(<span class="predefined-type">String</span> name) {
    <span class="keyword">return</span> em.createQuery(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT c FROM Customer c WHERE c.name LIKE :custName</span><span class="delimiter">&quot;</span></span>)
        .setParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">custName</span><span class="delimiter">&quot;</span></span>, name)
        .getResultList();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Named parameters are case-sensitive and may be used by both dynamic and
static queries.</p>
</div>
<div class="paragraph">
<p><a id="BNBRI"></a><a id="positional-parameters-in-queries"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="positional-parameters-in-queries"><a class="anchor" href="#positional-parameters-in-queries"></a>Positional Parameters in Queries</h5>
<div class="paragraph">
<p>You may use positional parameters instead of named parameters in
queries. Positional parameters are prefixed with a question mark (<code>?</code>)
followed by the numeric position of the parameter in the query. The
method <code>Query.setParameter(integer position, Object value)</code> is used to
set the parameter values.</p>
</div>
<div class="paragraph">
<p>In the following example, the <code>findWithName</code> business method is
rewritten to use input parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="predefined-type">List</span> findWithName(<span class="predefined-type">String</span> name) {
    <span class="keyword">return</span> em.createQuery(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT c FROM Customer c WHERE c.name LIKE ?1</span><span class="delimiter">&quot;</span></span>)
        .setParameter(<span class="integer">1</span>, name)
        .getResultList();
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Input parameters are numbered starting from 1. Input parameters are
case-sensitive, and may be used by both dynamic and static queries.</p>
</div>
<div class="paragraph">
<p><a id="BNBTI"></a><a id="simplified-query-language-syntax"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="simplified-query-language-syntax"><a class="anchor" href="#simplified-query-language-syntax"></a>Simplified Query Language Syntax</h4>
<div class="paragraph">
<p>This section briefly describes the syntax of the query language so that
you can quickly move on to
<a href="#BNBTL">Example Queries</a>. When you
are ready to learn about the syntax in more detail, see
<a href="#BNBUF">Full Query Language Syntax</a>.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#BNBTJ">Select Statements</a></p>
</li>
<li>
<p><a href="#BNBTK">Update and Delete Statements</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBTJ"></a><a id="select-statements"></a></p>
</div>
<div class="sect4">
<h5 id="select-statements"><a class="anchor" href="#select-statements"></a>Select Statements</h5>
<div class="paragraph">
<p>A select query has six clauses: <code>SELECT</code>, <code>FROM</code>, <code>WHERE</code>, <code>GROUP BY</code>,
<code>HAVING</code>, and <code>ORDER BY</code>. The <code>SELECT</code> and <code>FROM</code> clauses are required,
but the <code>WHERE</code>, <code>GROUP BY</code>, <code>HAVING</code>, and <code>ORDER BY</code> clauses are
optional. Here is the high-level BNF syntax of a query language select
query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">QL_statement ::= select_clause from_clause
  [where_clause][groupby_clause][having_clause][orderby_clause]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The BNF syntax defines the following clauses.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>SELECT</code> clause defines the types of the objects or values
returned by the query.</p>
</li>
<li>
<p>The <code>FROM</code> clause defines the scope of the query by declaring one or
more identification variables, which can be referenced in the <code>SELECT</code>
and <code>WHERE</code> clauses. An identification variable represents one of the
following elements:</p>
<div class="ulist">
<ul>
<li>
<p>The abstract schema name of an entity</p>
</li>
<li>
<p>An element of a collection relationship</p>
</li>
<li>
<p>An element of a single-valued relationship</p>
</li>
<li>
<p>A member of a collection that is the multiple side of a one-to-many
relationship</p>
</li>
</ul>
</div>
</li>
<li>
<p>The <code>WHERE</code> clause is a conditional expression that restricts the
objects or values retrieved by the query. Although the clause is
optional, most queries have a <code>WHERE</code> clause.</p>
</li>
<li>
<p>The <code>GROUP BY</code> clause groups query results according to a set of
properties.</p>
</li>
<li>
<p>The <code>HAVING</code> clause is used with the <code>GROUP BY</code> clause to further
restrict the query results according to a conditional expression.</p>
</li>
<li>
<p>The <code>ORDER BY</code> clause sorts the objects or values returned by the
query into a specified order.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBTK"></a><a id="update-and-delete-statements"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="update-and-delete-statements"><a class="anchor" href="#update-and-delete-statements"></a>Update and Delete Statements</h5>
<div class="paragraph">
<p>Update and delete statements provide bulk operations over sets of
entities. These statements have the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">update_statement :: = update_clause [where_clause]
delete_statement :: = delete_clause [where_clause]</code></pre>
</div>
</div>
<div class="paragraph">
<p>The update and delete clauses determine the type of the entities to be
updated or deleted. The <code>WHERE</code> clause may be used to restrict the scope
of the update or delete operation.</p>
</div>
<div class="paragraph">
<p><a id="BNBTL"></a><a id="example-queries"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="example-queries"><a class="anchor" href="#example-queries"></a>Example Queries</h4>
<div class="paragraph">
<p>The following queries are from the <code>Player</code> entity of the <code>roster</code>
application, which is documented in
<a href="#GIQSQ">The roster Application</a>.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#BNBTM">Simple Queries</a></p>
</li>
<li>
<p><a href="#BNBTQ">Queries That Navigate to Related Entities</a></p>
</li>
<li>
<p><a href="#BNBTW">Queries with Other Conditional Expressions</a></p>
</li>
<li>
<p><a href="#BNBUC">Bulk Updates and Deletes</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBTM"></a><a id="simple-queries"></a></p>
</div>
<div class="sect4">
<h5 id="simple-queries"><a class="anchor" href="#simple-queries"></a>Simple Queries</h5>
<div class="paragraph">
<p>If you are unfamiliar with the query language, these simple queries are
a good place to start.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#BNBTN">A Basic Select Query</a></p>
</li>
<li>
<p><a href="#BNBTO">Eliminating Duplicate Values</a></p>
</li>
<li>
<p><a href="#BNBTP">Using Named Parameters</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBTN"></a><a id="a-basic-select-query"></a></p>
</div>
<div class="sect5">
<h6 id="a-basic-select-query"><a class="anchor" href="#a-basic-select-query"></a>A Basic Select Query</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> p
<span class="keyword">FROM</span> Player p</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Data retrieved: All players.</p>
</li>
<li>
<p>Description: The <code>FROM</code> clause declares an identification variable
named <code>p</code>, omitting the optional keyword <code>AS</code>. If the <code>AS</code> keyword were
included, the clause would be written as follows:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="keyword">FROM</span> Player <span class="keyword">AS</span> p</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Player</code> element is the abstract schema name of the <code>Player</code> entity.</p>
</div>
</li>
<li>
<p>See also: <a href="#BNBUM">Identification
Variables</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBTO"></a><a id="eliminating-duplicate-values"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="eliminating-duplicate-values"><a class="anchor" href="#eliminating-duplicate-values"></a>Eliminating Duplicate Values</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="keyword">DISTINCT</span> p
<span class="keyword">FROM</span> Player p
<span class="keyword">WHERE</span> p.position = <span class="error">?</span><span class="integer">1</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Data retrieved: The players with the position specified by the query&#8217;s
parameter.</p>
</li>
<li>
<p>Description: The <code>DISTINCT</code> keyword eliminates duplicate values.</p>
<div class="paragraph">
<p>The <code>WHERE</code> clause restricts the players retrieved by checking their
<code>position</code>, a persistent field of the <code>Player</code> entity. The <code>?1</code> element
denotes the input parameter of the query.</p>
</div>
</li>
<li>
<p>See also: <a href="#BNBVA">Input
Parameters</a> and <a href="#BNBWB">The DISTINCT
Keyword</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBTP"></a><a id="using-named-parameters"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="using-named-parameters"><a class="anchor" href="#using-named-parameters"></a>Using Named Parameters</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="keyword">DISTINCT</span> p
<span class="keyword">FROM</span> Player p
<span class="keyword">WHERE</span> p.position = :position <span class="keyword">AND</span> p.name = :name</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Data retrieved: The players having the specified positions and names.</p>
</li>
<li>
<p>Description: The <code>position</code> and <code>name</code> elements are persistent fields
of the <code>Player</code> entity. The <code>WHERE</code> clause compares the values of these
fields with the named parameters of the query, set using the
<code>Query.setNamedParameter</code> method. The query language denotes a named
input parameter using a colon (<code>:</code>) followed by an identifier. The first
input parameter is <code>:position</code>, the second is <code>:name</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBTQ"></a><a id="queries-that-navigate-to-related-entities"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="queries-that-navigate-to-related-entities"><a class="anchor" href="#queries-that-navigate-to-related-entities"></a>Queries That Navigate to Related Entities</h5>
<div class="paragraph">
<p>In the query language, an expression can traverse, or navigate, to
related entities. These expressions are the primary difference between
the Jakarta Persistence query language and SQL. Queries navigates to
related entities, whereas SQL joins tables.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#BNBTR">A Simple Query with Relationships</a></p>
</li>
<li>
<p><a href="#BNBTS">Navigating to Single-Valued Relationship Fields</a></p>
</li>
<li>
<p><a href="#BNBTT">Traversing Relationships with an Input Parameter</a></p>
</li>
<li>
<p><a href="#BNBTU">Traversing Multiple Relationships</a></p>
</li>
<li>
<p><a href="#BNBTV">Navigating According to Related Fields</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBTR"></a><a id="a-simple-query-with-relationships"></a></p>
</div>
<div class="sect5">
<h6 id="a-simple-query-with-relationships"><a class="anchor" href="#a-simple-query-with-relationships"></a>A Simple Query with Relationships</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="keyword">DISTINCT</span> p
<span class="keyword">FROM</span> Player p, <span class="keyword">IN</span> (p.teams) t</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Data retrieved: All players who belong to a team.</p>
</li>
<li>
<p>Description: The <code>FROM</code> clause declares two identification variables:
<code>p</code> and <code>t</code>. The <code>p</code> variable represents the <code>Player</code> entity, and the
<code>t</code> variable represents the related <code>Team</code> entity. The declaration for
<code>t</code> references the previously declared <code>p</code> variable. The <code>IN</code> keyword
signifies that <code>teams</code> is a collection of related entities. The
<code>p.teams</code> expression navigates from a <code>Player</code> to its related <code>Team</code>.
The period in the <code>p.teams</code> expression is the navigation operator.</p>
<div class="paragraph">
<p>You may also use the <code>JOIN</code> statement to write the same query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="keyword">DISTINCT</span> p
<span class="keyword">FROM</span> Player p <span class="keyword">JOIN</span> p.teams t</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query could also be rewritten as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="keyword">DISTINCT</span> p
<span class="keyword">FROM</span> Player p
<span class="keyword">WHERE</span> p.team <span class="keyword">IS</span> <span class="keyword">NOT</span> EMPTY</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBTS"></a><a id="navigating-to-single-valued-relationship-fields"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="navigating-to-single-valued-relationship-fields"><a class="anchor" href="#navigating-to-single-valued-relationship-fields"></a>Navigating to Single-Valued Relationship Fields</h6>
<div class="paragraph">
<p>Use the <code>JOIN</code> clause statement to navigate to a single-valued
relationship field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> t
<span class="keyword">FROM</span> Team t <span class="keyword">JOIN</span> t.league l
<span class="keyword">WHERE</span> l.sport = <span class="string"><span class="delimiter">'</span><span class="content">soccer</span><span class="delimiter">'</span></span> <span class="keyword">OR</span> l.sport =<span class="string"><span class="delimiter">'</span><span class="content">football</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the query will return all teams that are in either
soccer or football leagues.</p>
</div>
<div class="paragraph">
<p><a id="BNBTT"></a><a id="traversing-relationships-with-an-input-parameter"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="traversing-relationships-with-an-input-parameter"><a class="anchor" href="#traversing-relationships-with-an-input-parameter"></a>Traversing Relationships with an Input Parameter</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="keyword">DISTINCT</span> p
<span class="keyword">FROM</span> Player p, <span class="keyword">IN</span> (p.teams) <span class="keyword">AS</span> t
<span class="keyword">WHERE</span> t.city = :city</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Data retrieved: The players whose teams belong to the specified city.</p>
</li>
<li>
<p>Description: This query is similar to the previous example but adds an
input parameter. The <code>AS</code> keyword in the <code>FROM</code> clause is optional. In
the <code>WHERE</code> clause, the period preceding the persistent variable <code>city</code>
is a delimiter, not a navigation operator. Strictly speaking,
expressions can navigate to relationship fields (related entities) but
not to persistent fields. To access a persistent field, an expression
uses the period as a delimiter.</p>
<div class="paragraph">
<p>Expressions cannot navigate beyond (or further qualify) relationship
fields that are collections. In the syntax of an expression, a
collection-valued field is a terminal symbol. Because the <code>teams</code> field
is a collection, the <code>WHERE</code> clause cannot specify <code>p.teams.city</code> (an
illegal expression).</p>
</div>
</li>
<li>
<p>See also: <a href="#BNBUQ">Path
Expressions</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBTU"></a><a id="traversing-multiple-relationships"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="traversing-multiple-relationships"><a class="anchor" href="#traversing-multiple-relationships"></a>Traversing Multiple Relationships</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="keyword">DISTINCT</span> p
<span class="keyword">FROM</span> Player p, <span class="keyword">IN</span> (p.teams) t
<span class="keyword">WHERE</span> t.league = :league</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Data retrieved: The players who belong to the specified league.</p>
</li>
<li>
<p>Description: The expressions in this query navigate over two
relationships. The <code>p.teams</code> expression navigates the <code>Player</code>-<code>Team</code>
relationship, and the <code>t.league</code> expression navigates the
<code>Team</code>-<code>League</code> relationship.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>In the other examples, the input parameters are <code>String</code> objects; in
this example, the parameter is an object whose type is a <code>League</code>. This
type matches the <code>league</code> relationship field in the comparison
expression of the <code>WHERE</code> clause.</p>
</div>
<div class="paragraph">
<p><a id="BNBTV"></a><a id="navigating-according-to-related-fields"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="navigating-according-to-related-fields"><a class="anchor" href="#navigating-according-to-related-fields"></a>Navigating According to Related Fields</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="keyword">DISTINCT</span> p
<span class="keyword">FROM</span> Player p, <span class="keyword">IN</span> (p.teams) t
<span class="keyword">WHERE</span> t.league.sport = :sport</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Data retrieved: The players who participate in the specified sport.</p>
</li>
<li>
<p>Description: The <code>sport</code> persistent field belongs to the <code>League</code>
entity. To reach the <code>sport</code> field, the query must first navigate from
the <code>Player</code> entity to <code>Team</code> (<code>p.teams</code>) and then from <code>Team</code> to the
<code>League</code> entity (<code>t.league</code>). Because it is not a collection, the
<code>league</code> relationship field can be followed by the <code>sport</code> persistent
field.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBTW"></a><a id="queries-with-other-conditional-expressions"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="queries-with-other-conditional-expressions"><a class="anchor" href="#queries-with-other-conditional-expressions"></a>Queries with Other Conditional Expressions</h5>
<div class="paragraph">
<p>Every <code>WHERE</code> clause must specify a conditional expression, of which
there are several kinds. In the previous examples, the conditional
expressions are comparison expressions that test for equality. The
following examples demonstrate some of the other kinds of conditional
expressions. For descriptions of all conditional expressions, see
<a href="#BNBUU">WHERE Clause</a>.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#BNBTX">The LIKE Expression</a></p>
</li>
<li>
<p><a href="#BNBTY">The IS NULL Expression</a></p>
</li>
<li>
<p><a href="#BNBTZ">The IS EMPTY Expression</a></p>
</li>
<li>
<p><a href="#BNBUA">The BETWEEN Expression</a></p>
</li>
<li>
<p><a href="#BNBUB">Comparison Operators</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBTX"></a><a id="the-like-expression"></a></p>
</div>
<div class="sect5">
<h6 id="the-like-expression"><a class="anchor" href="#the-like-expression"></a>The LIKE Expression</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> p
<span class="keyword">FROM</span> Player p
<span class="keyword">WHERE</span> p.name <span class="keyword">LIKE</span> <span class="string"><span class="delimiter">'</span><span class="content">Mich%</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Data retrieved: All players whose names begin with "Mich."</p>
</li>
<li>
<p>Description: The <code>LIKE</code> expression uses wildcard characters to search
for strings that match the wildcard pattern. In this case, the query
uses the <code>LIKE</code> expression and the <code>%</code> wildcard to find all players
whose names begin with the string "Mich." For example, "Michael" and
"Michelle" both match the wildcard pattern.</p>
</li>
<li>
<p>See also: <a href="#BNBVG">LIKE
Expressions</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBTY"></a><a id="the-is-null-expression"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="the-is-null-expression"><a class="anchor" href="#the-is-null-expression"></a>The IS NULL Expression</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> t
<span class="keyword">FROM</span> Team t
<span class="keyword">WHERE</span> t.league <span class="keyword">IS</span> <span class="predefined-constant">NULL</span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Data retrieved: All teams not associated with a league.</p>
</li>
<li>
<p>Description: The <code>IS NULL</code> expression can be used to check whether a
relationship has been set between two entities. In this case, the query
checks whether the teams are associated with any leagues and returns the
teams that do not have a league.</p>
</li>
<li>
<p>See also: <a href="#BNBVI">NULL Comparison
Expressions</a> and <a href="#BNBVR">NULL
Values</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBTZ"></a><a id="the-is-empty-expression"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="the-is-empty-expression"><a class="anchor" href="#the-is-empty-expression"></a>The IS EMPTY Expression</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> p
<span class="keyword">FROM</span> Player p
<span class="keyword">WHERE</span> p.teams <span class="keyword">IS</span> EMPTY</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Data retrieved: All players who do not belong to a team.</p>
</li>
<li>
<p>Description: The <code>teams</code> relationship field of the <code>Player</code> entity is
a collection. If a player does not belong to a team, the <code>teams</code>
collection is empty, and the conditional expression is <code>TRUE</code>.</p>
</li>
<li>
<p>See also: <a href="#BNBVJ">Empty Collection
Comparison Expressions</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBUA"></a><a id="the-between-expression"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="the-between-expression"><a class="anchor" href="#the-between-expression"></a>The BETWEEN Expression</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="keyword">DISTINCT</span> p
<span class="keyword">FROM</span> Player p
<span class="keyword">WHERE</span> p.salary <span class="keyword">BETWEEN</span> :lowerSalary <span class="keyword">AND</span> :higherSalary</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Data retrieved: The players whose salaries fall within the range of
the specified salaries.</p>
</li>
<li>
<p>Description: This <code>BETWEEN</code> expression has three arithmetic
expressions: a persistent field (<code>p.salary</code>) and the two input
parameters (<code>:lowerSalary</code> and <code>:higherSalary</code>). The following
expression is equivalent to the <code>BETWEEN</code> expression:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">p.salary &gt;= :lowerSalary <span class="keyword">AND</span> p.salary &lt;= :higherSalary</code></pre>
</div>
</div>
</li>
<li>
<p>See also: <a href="#BNBVE">BETWEEN
Expressions</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBUB"></a><a id="comparison-operators"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="comparison-operators"><a class="anchor" href="#comparison-operators"></a>Comparison Operators</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="keyword">DISTINCT</span> p1
<span class="keyword">FROM</span> Player p1, Player p2
<span class="keyword">WHERE</span> p1.salary &gt; p2.salary <span class="keyword">AND</span> p2.name = :name</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Data retrieved: All players whose salaries are higher than the salary
of the player with the specified name.</p>
</li>
<li>
<p>Description: The <code>FROM</code> clause declares two identification variables
(<code>p1</code> and <code>p2</code>) of the same type (<code>Player</code>). Two identification
variables are needed because the <code>WHERE</code> clause compares the salary of
one player (<code>p2</code>) with that of the other players (<code>p1</code>).</p>
</li>
<li>
<p>See also: <a href="#BNBUM">Identification
Variables</a>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBUC"></a><a id="bulk-updates-and-deletes"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="bulk-updates-and-deletes"><a class="anchor" href="#bulk-updates-and-deletes"></a>Bulk Updates and Deletes</h5>
<div class="paragraph">
<p>The following examples show how to use the <code>UPDATE</code> and <code>DELETE</code>
expressions in queries. <code>UPDATE</code> and <code>DELETE</code> operate on multiple
entities according to the condition or conditions set in the <code>WHERE</code>
clause. The <code>WHERE</code> clause in <code>UPDATE</code> and <code>DELETE</code> queries follows the
same rules as <code>SELECT</code> queries.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#BNBUD">Update Queries</a></p>
</li>
<li>
<p><a href="#BNBUE">Delete Queries</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBUD"></a><a id="update-queries"></a></p>
</div>
<div class="sect5">
<h6 id="update-queries"><a class="anchor" href="#update-queries"></a>Update Queries</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">UPDATE</span> Player p
<span class="class">SET</span> p.status = <span class="string"><span class="delimiter">'</span><span class="content">inactive</span><span class="delimiter">'</span></span>
<span class="keyword">WHERE</span> p.lastPlayed &lt; :inactiveThresholdDate</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Description: This query sets the status of a set of players to
<code>inactive</code> if the player&#8217;s last game was longer ago than the date
specified in <code>inactiveThresholdDate</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBUE"></a><a id="delete-queries"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="delete-queries"><a class="anchor" href="#delete-queries"></a>Delete Queries</h6>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">DELETE</span>
<span class="keyword">FROM</span> Player p
<span class="keyword">WHERE</span> p.status = <span class="string"><span class="delimiter">'</span><span class="content">inactive</span><span class="delimiter">'</span></span>
<span class="keyword">AND</span> p.teams <span class="keyword">IS</span> EMPTY</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Description: This query deletes all inactive players who are not on a
team.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBUF"></a><a id="full-query-language-syntax"></a></p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="full-query-language-syntax"><a class="anchor" href="#full-query-language-syntax"></a>Full Query Language Syntax</h4>
<div class="paragraph">
<p>This section discusses the query language syntax, as defined in the Jakarta
Persistence 2.2 specification available at
<code><a href="https://jakarta.ee/specifications/persistence/2.2/" class="bare">https://jakarta.ee/specifications/persistence/2.2/</a></code>. Much of the following material
paraphrases or directly quotes the specification.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#BNBUG">BNF Symbols</a></p>
</li>
<li>
<p><a href="#BNBUI">BNF Grammar of the Jakarta Persistence Query Language</a></p>
</li>
<li>
<p><a href="#BNBUJ">FROM Clause</a></p>
</li>
<li>
<p><a href="#BNBUQ">Path Expressions</a></p>
</li>
<li>
<p><a href="#BNBUU">WHERE Clause</a></p>
</li>
<li>
<p><a href="#BNBVX">SELECT Clause</a></p>
</li>
<li>
<p><a href="#BNBWD">ORDER BY Clause</a></p>
</li>
<li>
<p><a href="#BNBWE">GROUP BY and HAVING Clauses</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBUG"></a><a id="bnf-symbols"></a></p>
</div>
<div class="sect4">
<h5 id="bnf-symbols"><a class="anchor" href="#bnf-symbols"></a>BNF Symbols</h5>
<div class="paragraph">
<p><a href="#BNBUH">Table 42-1</a> describes the BNF symbols used in this chapter.</p>
</div>
<div class="paragraph">
<p><a id="sthref169"></a><a id="BNBUH"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 42-1 BNF Symbol Summary</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 75%;">
<colgroup>
<col style="width: 35.7142%;">
<col style="width: 64.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Symbol</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>::=</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The element to the left of the symbol is defined by the
constructs on the right.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>*</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The preceding construct may occur zero or more times.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>{&#8230;&#8203;}</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The constructs within the braces are grouped together.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>[&#8230;&#8203;]</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The constructs within the brackets are optional.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>`</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">`</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">An exclusive <code>OR</code>.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BOLDFACE</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">A keyword; although capitalized in the BNF diagram,
keywords are not case-sensitive.</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">White space</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="BNBUI"></a><a id="bnf-grammar-of-the-java-persistence-query-language"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="bnf-grammar-of-the-jakarta-persistence-query-language"><a class="anchor" href="#bnf-grammar-of-the-jakarta-persistence-query-language"></a>BNF Grammar of the Jakarta Persistence Query Language</h5>
<div class="paragraph">
<p>Here is the entire BNF diagram for the query language:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">QL_statement ::= select_statement | update_statement | delete_statement
select_statement ::= select_clause from_clause [where_clause] [groupby_clause]
    [having_clause] [orderby_clause]
update_statement ::= update_clause [where_clause]
delete_statement ::= delete_clause [where_clause]
from_clause ::=
    <span class="keyword">FROM</span> identification_variable_declaration
        {, {identification_variable_declaration |
            collection_member_declaration}}*
identification_variable_declaration ::=
        range_variable_declaration { <span class="keyword">join</span> | fetch_join }*
range_variable_declaration ::= abstract_schema_name [<span class="keyword">AS</span>]
        identification_variable
<span class="keyword">join</span> ::= join_spec join_association_path_expression [<span class="keyword">AS</span>]
        identification_variable
fetch_join ::= join_specFETCH join_association_path_expression
association_path_expression ::=
        collection_valued_path_expression |
        single_valued_association_path_expression
join_spec::= [<span class="keyword">LEFT</span> [<span class="keyword">OUTER</span>] |<span class="keyword">INNER</span>] <span class="keyword">JOIN</span>
join_association_path_expression ::=
        join_collection_valued_path_expression |
        join_single_valued_association_path_expression
join_collection_valued_path_expression::=
    identification_variable.collection_valued_association_field
join_single_valued_association_path_expression::=
        identification_variable.single_valued_association_field
collection_member_declaration ::=
        <span class="keyword">IN</span> (collection_valued_path_expression) [<span class="keyword">AS</span>]
        identification_variable
single_valued_path_expression ::=
        state_field_path_expression |
        single_valued_association_path_expression
state_field_path_expression ::=
    {identification_variable |
    single_valued_association_path_expression}.state_field
single_valued_association_path_expression ::=
    identification_variable.{single_valued_association_field.}*
    single_valued_association_field
collection_valued_path_expression ::=
    identification_variable.{single_valued_association_field.}*
    collection_valued_association_field
state_field ::=
    {embedded_class_state_field.}*simple_state_field
update_clause ::=<span class="class">UPDATE</span> abstract_schema_name [[<span class="keyword">AS</span>]
    identification_variable] <span class="class">SET</span> update_item {, update_item}*
update_item ::= [identification_variable.]{state_field |
    single_valued_association_field} = new_value
new_value ::=
     simple_arithmetic_expression |
    string_primary |
    datetime_primary |
    boolean_primary |
    enum_primary simple_entity_expression |
    <span class="predefined-constant">NULL</span>
delete_clause ::= <span class="class">DELETE</span> <span class="keyword">FROM</span> abstract_schema_name [[<span class="keyword">AS</span>]
    identification_variable]
select_clause ::= <span class="class">SELECT</span> [<span class="keyword">DISTINCT</span>] select_expression {,
    select_expression}*
select_expression ::=
    single_valued_path_expression |
    aggregate_expression |
    identification_variable |
    OBJECT(identification_variable) |
    constructor_expression
constructor_expression ::=
    NEW constructor_name(constructor_item {,
    constructor_item}*)
constructor_item ::= single_valued_path_expression |
    aggregate_expression
aggregate_expression ::=
    {<span class="predefined">AVG</span> |<span class="predefined">MAX</span> |<span class="predefined">MIN</span> |<span class="predefined">SUM</span>} ([<span class="keyword">DISTINCT</span>]
        state_field_path_expression) |
    <span class="predefined">COUNT</span> ([<span class="keyword">DISTINCT</span>] identification_variable |
        state_field_path_expression |
        single_valued_association_path_expression)
where_clause ::= <span class="keyword">WHERE</span> conditional_expression
groupby_clause ::= <span class="keyword">GROUP</span> <span class="keyword">BY</span> groupby_item {, groupby_item}*
groupby_item ::= single_valued_path_expression
having_clause ::= <span class="keyword">HAVING</span> conditional_expression
orderby_clause ::= <span class="keyword">ORDER</span> <span class="keyword">BY</span> orderby_item {, orderby_item}*
orderby_item ::= state_field_path_expression [<span class="directive">ASC</span> |<span class="directive">DESC</span>]
subquery ::= simple_select_clause subquery_from_clause
    [where_clause] [groupby_clause] [having_clause]
subquery_from_clause ::=
    <span class="keyword">FROM</span> subselect_identification_variable_declaration
        {, subselect_identification_variable_declaration}*
subselect_identification_variable_declaration ::=
    identification_variable_declaration |
    association_path_expression [<span class="keyword">AS</span>] identification_variable |
    collection_member_declaration
simple_select_clause ::= <span class="class">SELECT</span> [<span class="keyword">DISTINCT</span>]
    simple_select_expression
simple_select_expression::=
    single_valued_path_expression |
    aggregate_expression |
    identification_variable
conditional_expression ::= conditional_term |
    conditional_expression <span class="keyword">OR</span> conditional_term
conditional_term ::= conditional_factor | conditional_term <span class="keyword">AND</span>
    conditional_factor
conditional_factor ::= [<span class="keyword">NOT</span>] conditional_primary
conditional_primary ::= simple_cond_expression |(
    conditional_expression)
simple_cond_expression ::=
    comparison_expression |
    between_expression |
    like_expression |
    in_expression |
    null_comparison_expression |
    empty_collection_comparison_expression |
    collection_member_expression |
    exists_expression
between_expression ::=
    arithmetic_expression [<span class="keyword">NOT</span>] <span class="keyword">BETWEEN</span>
        arithmetic_expressionAND arithmetic_expression |
    string_expression [<span class="keyword">NOT</span>] <span class="keyword">BETWEEN</span> string_expression <span class="keyword">AND</span>
        string_expression |
    datetime_expression [<span class="keyword">NOT</span>] <span class="keyword">BETWEEN</span>
        datetime_expression <span class="keyword">AND</span> datetime_expression
in_expression ::=
    state_field_path_expression [<span class="keyword">NOT</span>] <span class="keyword">IN</span> (in_item {, in_item}*
    | subquery)
in_item ::= literal | input_parameter
like_expression ::=
    string_expression [<span class="keyword">NOT</span>] <span class="keyword">LIKE</span> pattern_value [ESCAPE
        escape_character]
null_comparison_expression ::=
    {single_valued_path_expression | input_parameter} <span class="keyword">IS</span> [<span class="keyword">NOT</span>]
        <span class="predefined-constant">NULL</span>
empty_collection_comparison_expression ::=
    collection_valued_path_expression <span class="keyword">IS</span> [<span class="keyword">NOT</span>] EMPTY
collection_member_expression ::= entity_expression
    [<span class="keyword">NOT</span>] MEMBER [<span class="keyword">OF</span>] collection_valued_path_expression
exists_expression::= [<span class="keyword">NOT</span>] <span class="keyword">EXISTS</span> (subquery)
all_or_any_expression ::= {<span class="keyword">ALL</span> |<span class="keyword">ANY</span> |SOME} (subquery)
comparison_expression ::=
    string_expression comparison_operator {string_expression |
    all_or_any_expression} |
    boolean_expression {= |&lt;&gt; } {boolean_expression |
    all_or_any_expression} |
    enum_expression {= |&lt;&gt; } {enum_expression |
    all_or_any_expression} |
    datetime_expression comparison_operator
        {datetime_expression | all_or_any_expression} |
    entity_expression {= |&lt;&gt; } {entity_expression |
    all_or_any_expression} |
    arithmetic_expression comparison_operator
        {arithmetic_expression | all_or_any_expression}
comparison_operator ::= = |&gt; |&gt;= |&lt; |&lt;= |&lt;&gt;
arithmetic_expression ::= simple_arithmetic_expression |
    (subquery)
simple_arithmetic_expression ::=
    arithmetic_term | simple_arithmetic_expression {+ |- }
        arithmetic_term
arithmetic_term ::= arithmetic_factor | arithmetic_term {* |/ }
    arithmetic_factor
arithmetic_factor ::= [{+ |- }] arithmetic_primary
arithmetic_primary ::=
    state_field_path_expression |
    numeric_literal |
    (simple_arithmetic_expression) |
    input_parameter |
    functions_returning_numerics |
    aggregate_expression
string_expression ::= string_primary | (subquery)
string_primary ::=
    state_field_path_expression |
    string_literal |
    input_parameter |
    functions_returning_strings |
    aggregate_expression
datetime_expression ::= datetime_primary | (subquery)
datetime_primary ::=
    state_field_path_expression |
    input_parameter |
    functions_returning_datetime |
    aggregate_expression
boolean_expression ::= boolean_primary | (subquery)
boolean_primary ::=
    state_field_path_expression |
    boolean_literal |
    input_parameter
 enum_expression ::= enum_primary | (subquery)
enum_primary ::=
    state_field_path_expression |
    enum_literal |
    input_parameter
entity_expression ::=
    single_valued_association_path_expression |
        simple_entity_expression
simple_entity_expression ::=
    identification_variable |
    input_parameter
functions_returning_numerics::=
    LENGTH(string_primary) |
    LOCATE(string_primary, string_primary[,
        simple_arithmetic_expression]) |
    <span class="predefined">ABS</span>(simple_arithmetic_expression) |
    SQRT(simple_arithmetic_expression) |
    MOD(simple_arithmetic_expression,
        simple_arithmetic_expression) |
    SIZE(collection_valued_path_expression)
functions_returning_datetime ::=
    CURRENT_DATE |
    CURRENT_TIME |
    CURRENT_TIMESTAMP
functions_returning_strings ::=
    CONCAT(string_primary, string_primary) |
    <span class="predefined">SUBSTRING</span>(string_primary,
        simple_arithmetic_expression,
        simple_arithmetic_expression)|
    TRIM([[trim_specification] [trim_character] <span class="keyword">FROM</span>]
        string_primary) |
    LOWER(string_primary) |
    UPPER(string_primary)
trim_specification ::= LEADING | TRAILING | BOTH</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBUJ"></a><a id="from-clause"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="from-clause"><a class="anchor" href="#from-clause"></a>FROM Clause</h5>
<div class="paragraph">
<p>The <code>FROM</code> clause defines the domain of the query by declaring
identification variables.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#BNBUK">Identifiers</a></p>
</li>
<li>
<p><a href="#BNBUM">Identification Variables</a></p>
</li>
<li>
<p><a href="#BNBUN">Range Variable Declarations</a></p>
</li>
<li>
<p><a href="#BNBUO">Collection Member Declarations</a></p>
</li>
<li>
<p><a href="#BNBUP">Joins</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBUK"></a><a id="identifiers"></a></p>
</div>
<div class="sect5">
<h6 id="identifiers"><a class="anchor" href="#identifiers"></a>Identifiers</h6>
<div class="paragraph">
<p>An identifier is a sequence of one or more characters. The first
character must be a valid first character (letter, <code>$</code>, <code><em></code>) in an
identifier of the Java programming language, hereafter in this chapter
called simply "Java." Each subsequent character in the sequence must be
a valid nonfirst character (letter, digit, <code>$</code>, <code></em></code>) in a Java
identifier. (For details, see the Java SE API documentation of the
<code>isJavaIdentifierStart</code> and <code>isJavaIdentifierPart</code> methods of the
<code>Character</code> class.) The question mark (<code>?</code>) is a reserved character in
the query language and cannot be used in an identifier.</p>
</div>
<div class="paragraph">
<p>A query language identifier is case-sensitive, with two exceptions:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Keywords</p>
</li>
<li>
<p>Identification variables</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An identifier cannot be the same as a query language keyword. Here is a
list of query language keywords:</p>
</div>
<div class="paragraph">
<p><code>ABS</code><br>
<code>ALL</code><br>
<code>AND</code><br>
<code>ANY</code><br>
<code>AS</code><br>
<code>ASC</code><br>
<code>AVG</code><br>
<code>BETWEEN</code><br>
<code>BIT_LENGTH</code><br>
<code>BOTH</code><br>
<code>BY</code><br>
<code>CASE</code><br>
<code>CHAR_LENGTH</code><br>
<code>CHARACTER_LENGTH</code><br>
<code>CLASS</code><br>
<code>COALESCE</code><br>
<code>CONCAT</code><br>
<code>COUNT</code><br>
<code>CURRENT_DATE</code><br>
<code>CURRENT_TIMESTAMP</code><br>
<code>DELETE</code><br>
<code>DESC</code><br>
<code>DISTINCT</code><br>
<code>ELSE</code><br>
<code>EMPTY</code><br>
<code>END</code><br>
<code>ENTRY</code><br>
<code>ESCAPE</code><br>
<code>EXISTS</code><br>
<code>FALSE</code><br>
<code>FETCH</code><br>
<code>FROM</code><br>
<code>GROUP</code><br>
<code>HAVING</code><br>
<code>IN</code><br>
<code>INDEX</code><br>
<code>INNER</code><br>
<code>IS</code><br>
<code>JOIN</code><br>
<code>KEY</code><br>
<code>LEADING</code><br>
<code>LEFT</code><br>
<code>LENGTH</code><br>
<code>LIKE</code><br>
<code>LOCATE</code><br>
<code>LOWER</code><br>
<code>MAX</code><br>
<code>MEMBER</code><br>
<code>MIN</code><br>
<code>MOD</code><br>
<code>NEW</code><br>
<code>NOT</code><br>
<code>NULL</code><br>
<code>NULLIF</code><br>
<code>OBJECT</code><br>
<code>OF</code><br>
<code>OR</code><br>
<code>ORDER</code><br>
<code>OUTER</code><br>
<code>POSITION</code><br>
<code>SELECT</code><br>
<code>SET</code><br>
<code>SIZE</code><br>
<code>SOME</code><br>
<code>SQRT</code><br>
<code>SUBSTRING</code><br>
<code>SUM</code><br>
<code>THEN</code><br>
<code>TRAILING</code><br>
<code>TRIM</code><br>
<code>TRUE</code><br>
<code>TYPE</code><br>
<code>UNKNOWN</code><br>
<code>UPDATE</code><br>
<code>UPPER</code><br>
<code>VALUE</code><br>
<code>WHEN</code><br>
<code>WHERE</code><br></p>
</div>
<div class="paragraph">
<p>It is not recommended that you use an SQL keyword as an identifier,
because the list of keywords may expand to include other reserved SQL
words in the future.</p>
</div>
<div class="paragraph">
<p><a id="BNBUM"></a><a id="identification-variables"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="identification-variables"><a class="anchor" href="#identification-variables"></a>Identification Variables</h6>
<div class="paragraph">
<p>An identification variable is an identifier declared in the <code>FROM</code>
clause. Although they can reference identification variables, the
<code>SELECT</code> and <code>WHERE</code> clauses cannot declare them. All identification
variables must be declared in the <code>FROM</code> clause.</p>
</div>
<div class="paragraph">
<p>Because it is an identifier, an identification variable has the same
naming conventions and restrictions as an identifier, with the exception
that an identification variable is case-insensitive. For example, an
identification variable cannot be the same as a query language keyword.
(See <a href="#BNBUK">Identifiers</a> for more naming rules.) Also, within a
given persistence unit, an identification variable name must not match
the name of any entity or abstract schema.</p>
</div>
<div class="paragraph">
<p>The <code>FROM</code> clause can contain multiple declarations, separated by
commas. A declaration can reference another identification variable that
has been previously declared (to the left). In the following <code>FROM</code>
clause, the variable <code>t</code> references the previously declared variable
<code>p</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="keyword">FROM</span> Player p, <span class="keyword">IN</span> (p.teams) <span class="keyword">AS</span> t</code></pre>
</div>
</div>
<div class="paragraph">
<p>Even if it is not used in the <code>WHERE</code> clause, an identification
variable&#8217;s declaration can affect the results of the query. For example,
compare the next two queries. The following query returns all players,
whether or not they belong to a team:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> p
<span class="keyword">FROM</span> Player p</code></pre>
</div>
</div>
<div class="paragraph">
<p>In contrast, because it declares the <code>t</code> identification variable, the
next query fetches all players who belong to a team:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> p
<span class="keyword">FROM</span> Player p, <span class="keyword">IN</span> (p.teams) <span class="keyword">AS</span> t</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following query returns the same results as the preceding query, but
the <code>WHERE</code> clause makes it easier to read:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> p
<span class="keyword">FROM</span> Player p
<span class="keyword">WHERE</span> p.teams <span class="keyword">IS</span> <span class="keyword">NOT</span> EMPTY</code></pre>
</div>
</div>
<div class="paragraph">
<p>An identification variable always designates a reference to a single
value whose type is that of the expression used in the declaration.
There are two kinds of declarations: range variable and collection
member.</p>
</div>
<div class="paragraph">
<p><a id="BNBUN"></a><a id="range-variable-declarations"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="range-variable-declarations"><a class="anchor" href="#range-variable-declarations"></a>Range Variable Declarations</h6>
<div class="paragraph">
<p>To declare an identification variable as an abstract schema type, you
specify a range variable declaration. In other words, an identification
variable can range over the abstract schema type of an entity. In the
following example, an identification variable named <code>p</code> represents the
abstract schema named <code>Player</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="keyword">FROM</span> Player p</code></pre>
</div>
</div>
<div class="paragraph">
<p>A range variable declaration can include the optional <code>AS</code> operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="keyword">FROM</span> Player <span class="keyword">AS</span> p</code></pre>
</div>
</div>
<div class="paragraph">
<p>To obtain objects, a query usually uses path expressions to navigate
through the relationships. But for those objects that cannot be obtained
by navigation, you can use a range variable declaration to designate a
starting point, or query root.</p>
</div>
<div class="paragraph">
<p>If the query compares multiple values of the same abstract schema type,
the <code>FROM</code> clause must declare multiple identification variables for the
abstract schema:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="keyword">FROM</span> Player p1, Player p2</code></pre>
</div>
</div>
<div class="paragraph">
<p>For an example of such a query, see
<a href="#BNBUB">Comparison Operators</a>.</p>
</div>
<div class="paragraph">
<p><a id="BNBUO"></a><a id="collection-member-declarations"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="collection-member-declarations"><a class="anchor" href="#collection-member-declarations"></a>Collection Member Declarations</h6>
<div class="paragraph">
<p>In a one-to-many relationship, the multiple side consists of a
collection of entities. An identification variable can represent a
member of this collection. To access a collection member, the path
expression in the variable&#8217;s declaration navigates through the
relationships in the abstract schema. (For more information on path
expressions, see <a href="#BNBUQ">Path Expressions</a>.) Because a path
expression can be based on another path expression, the navigation can
traverse several relationships. See
<a href="#BNBTU">Traversing Multiple
Relationships</a>.</p>
</div>
<div class="paragraph">
<p>A collection member declaration must include the <code>IN</code> operator but can
omit the optional <code>AS</code> operator.</p>
</div>
<div class="paragraph">
<p>In the following example, the entity represented by the abstract schema
named <code>Player</code> has a relationship field called <code>teams</code>. The
identification variable called <code>t</code> represents a single member of the
<code>teams</code> collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="keyword">FROM</span> Player p, <span class="keyword">IN</span> (p.teams) t</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBUP"></a><a id="joins"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="joins"><a class="anchor" href="#joins"></a>Joins</h6>
<div class="paragraph">
<p>The <code>JOIN</code> operator is used to traverse over relationships between
entities and is functionally similar to the <code>IN</code> operator.</p>
</div>
<div class="paragraph">
<p>In the following example, the query joins over the relationship between
customers and orders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> c
<span class="keyword">FROM</span> Customer c <span class="keyword">JOIN</span> c.orders o
<span class="keyword">WHERE</span> c.status = <span class="integer">1</span> <span class="keyword">AND</span> o.totalPrice &gt; <span class="integer">10000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>INNER</code> keyword is optional:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> c
<span class="keyword">FROM</span> Customer c <span class="keyword">INNER</span> <span class="keyword">JOIN</span> c.orders o
<span class="keyword">WHERE</span> c.status = <span class="integer">1</span> <span class="keyword">AND</span> o.totalPrice &gt; <span class="integer">10000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>These examples are equivalent to the following query, which uses the
<code>IN</code> operator:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> c
<span class="keyword">FROM</span> Customer c, <span class="keyword">IN</span> (c.orders) o
<span class="keyword">WHERE</span> c.status = <span class="integer">1</span> <span class="keyword">AND</span> o.totalPrice &gt; <span class="integer">10000</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also join a single-valued relationship:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> t
<span class="keyword">FROM</span> Team t <span class="keyword">JOIN</span> t.league l
<span class="keyword">WHERE</span> l.sport = :sport</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>LEFT JOIN</code> or <code>LEFT OUTER JOIN</code> retrieves a set of entities where
matching values in the join condition may be absent. The <code>OUTER</code> keyword
is optional:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> c.name, o.totalPrice
<span class="keyword">FROM</span> CustomerOrder o <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> o.customer c</code></pre>
</div>
</div>
<div class="paragraph">
<p>A <code>FETCH JOIN</code> is a join operation that returns associated entities as a
side effect of running the query. In the following example, the query
returns a set of departments and, as a side effect, the associated
employees of the departments, even though the employees were not
explicitly retrieved by the <code>SELECT</code> clause:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> d
<span class="keyword">FROM</span> Department d <span class="keyword">LEFT</span> <span class="keyword">JOIN</span> FETCH d.employees
<span class="keyword">WHERE</span> d.deptno = <span class="integer">1</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBUQ"></a><a id="path-expressions"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="path-expressions"><a class="anchor" href="#path-expressions"></a>Path Expressions</h5>
<div class="paragraph">
<p>Path expressions are important constructs in the syntax of the query
language for several reasons. First, path expressions define navigation
paths through the relationships in the abstract schema. These path
definitions affect both the scope and the results of a query. Second,
path expressions can appear in any of the main clauses of a query
(<code>SELECT</code>, <code>DELETE</code>, <code>HAVING</code>, <code>UPDATE</code>, <code>WHERE</code>, <code>FROM</code>, <code>GROUP BY</code>,
<code>ORDER BY</code>). Finally, although much of the query language is a subset of
SQL, path expressions are extensions not found in SQL.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#BNBUR">Examples of Path Expressions</a></p>
</li>
<li>
<p><a href="#BNBUS">Expression Types</a></p>
</li>
<li>
<p><a href="#BNBUT">Navigation</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBUR"></a><a id="examples-of-path-expressions"></a></p>
</div>
<div class="sect5">
<h6 id="examples-of-path-expressions"><a class="anchor" href="#examples-of-path-expressions"></a>Examples of Path Expressions</h6>
<div class="paragraph">
<p>Here, the <code>WHERE</code> clause contains a <code>single_valued_path_expression</code>; the
<code>p</code> is an identification variable, and <code>salary</code> is a persistent field of
<code>Player</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="keyword">DISTINCT</span> p
<span class="keyword">FROM</span> Player p
<span class="keyword">WHERE</span> p.salary <span class="keyword">BETWEEN</span> :lowerSalary <span class="keyword">AND</span> :higherSalary</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, the <code>WHERE</code> clause also contains a
<code>single_valued_path_expression</code>; <code>t</code> is an identification variable,
<code>league</code> is a single-valued relationship field, and <code>sport</code> is a
persistent field of <code>league</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="keyword">DISTINCT</span> p
<span class="keyword">FROM</span> Player p, <span class="keyword">IN</span> (p.teams) t
<span class="keyword">WHERE</span> t.league.sport = :sport</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here, the <code>WHERE</code> clause contains a <code>collection_valued_path_expression</code>;
<code>p</code> is an identification variable, and <code>teams</code> designates a
collection-valued relationship field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="keyword">DISTINCT</span> p
<span class="keyword">FROM</span> Player p
<span class="keyword">WHERE</span> p.teams <span class="keyword">IS</span> EMPTY</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBUS"></a><a id="expression-types"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="expression-types"><a class="anchor" href="#expression-types"></a>Expression Types</h6>
<div class="paragraph">
<p>The type of a path expression is the type of the object represented by
the ending element, which can be one of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Persistent field</p>
</li>
<li>
<p>Single-valued relationship field</p>
</li>
<li>
<p>Collection-valued relationship field</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, the type of the expression <code>p.salary</code> is <code>double</code> because
the terminating persistent field (<code>salary</code>) is a <code>double</code>.</p>
</div>
<div class="paragraph">
<p>In the expression <code>p.teams</code>, the terminating element is a
collection-valued relationship field (<code>teams</code>). This expression&#8217;s type
is a collection of the abstract schema type named <code>Team</code>. Because <code>Team</code>
is the abstract schema name for the <code>Team</code> entity, this type maps to the
entity. For more information on the type mapping of abstract schemas,
see <a href="#BNBVY">Return Types</a>.</p>
</div>
<div class="paragraph">
<p><a id="BNBUT"></a><a id="navigation"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="navigation"><a class="anchor" href="#navigation"></a>Navigation</h6>
<div class="paragraph">
<p>A path expression enables the query to navigate to related entities. The
terminating elements of an expression determine whether navigation is
allowed. If an expression contains a single-valued relationship field,
the navigation can continue to an object that is related to the field.
However, an expression cannot navigate beyond a persistent field or a
collection-valued relationship field. For example, the expression
<code>p.teams.league.sport</code> is illegal because <code>teams</code> is a collection-valued
relationship field. To reach the <code>sport</code> field, the <code>FROM</code> clause could
define an identification variable named <code>t</code> for the <code>teams</code> field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="keyword">FROM</span> Player <span class="keyword">AS</span> p, <span class="keyword">IN</span> (p.teams) t
<span class="keyword">WHERE</span> t.league.sport = <span class="string"><span class="delimiter">'</span><span class="content">soccer</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBUU"></a><a id="where-clause"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="where-clause"><a class="anchor" href="#where-clause"></a>WHERE Clause</h5>
<div class="paragraph">
<p>The <code>WHERE</code> clause specifies a conditional expression that limits the
values returned by the query. The query returns all corresponding values
in the data store for which the conditional expression is <code>TRUE</code>.
Although usually specified, the <code>WHERE</code> clause is optional. If the
<code>WHERE</code> clause is omitted, the query returns all values. The high-level
syntax for the <code>WHERE</code> clause is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">where_clause ::= <span class="keyword">WHERE</span> conditional_expression</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#BNBUV">Literals</a></p>
</li>
<li>
<p><a href="#BNBVA">Input Parameters</a></p>
</li>
<li>
<p><a href="#BNBVB">Conditional Expressions</a></p>
</li>
<li>
<p><a href="#BNBVC">Operators and Their Precedence</a></p>
</li>
<li>
<p><a href="#BNBVE">BETWEEN Expressions</a></p>
</li>
<li>
<p><a href="#BNBVF">IN Expressions</a></p>
</li>
<li>
<p><a href="#BNBVG">LIKE Expressions</a></p>
</li>
<li>
<p><a href="#BNBVI">NULL Comparison Expressions</a></p>
</li>
<li>
<p><a href="#BNBVJ">Empty Collection Comparison Expressions</a></p>
</li>
<li>
<p><a href="#BNBVK">Collection Member Expressions</a></p>
</li>
<li>
<p><a href="#BNBVL">Subqueries</a></p>
</li>
<li>
<p><a href="#BNBVO">Functional Expressions</a></p>
</li>
<li>
<p><a href="#GJJND">Case Expressions</a></p>
</li>
<li>
<p><a href="#BNBVR">NULL Values</a></p>
</li>
<li>
<p><a href="#BNBVU">Equality Semantics</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBUV"></a><a id="literals"></a></p>
</div>
<div class="sect5">
<h6 id="literals"><a class="anchor" href="#literals"></a>Literals</h6>
<div class="paragraph">
<p>There are four kinds of literals: string, numeric, Boolean, and enum.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>String literals: A string literal is enclosed in single quotes:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="string"><span class="delimiter">'</span><span class="content">Duke</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If a string literal contains a single quote, you indicate the quote by
using two single quotes:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="string"><span class="delimiter">'</span><span class="content">Duke</span><span class="delimiter">'</span></span><span class="string"><span class="delimiter">'</span><span class="content">s</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Like a Java <code>String</code>, a string literal in the query language uses the
Unicode character encoding.</p>
</div>
</li>
<li>
<p>Numeric literals: There are two types of numeric literals: exact and
approximate.</p>
<div class="ulist">
<ul>
<li>
<p>An exact numeric literal is a numeric value without a decimal point,
such as 65, –233, and +12. Using the Java integer syntax, exact numeric
literals support numbers in the range of a Java <code>long</code>.</p>
</li>
<li>
<p>An approximate numeric literal is a numeric value in scientific
notation, such as 57., –85.7, and +2.1. Using the syntax of the Java
floating-point literal, approximate numeric literals support numbers in
the range of a Java <code>double</code>.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Boolean literals: A Boolean literal is either <code>TRUE</code> or <code>FALSE</code>. These
keywords are not case-sensitive.</p>
</li>
<li>
<p>Enum literals: The Jakarta Persistence query language supports the use of
enum literals using the Java enum literal syntax. The enum class name
must be specified as a fully qualified class name:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> e
<span class="keyword">FROM</span> Employee e
<span class="keyword">WHERE</span> e.status = com.example.EmployeeStatus.FULL_TIME</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBVA"></a><a id="input-parameters"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="input-parameters"><a class="anchor" href="#input-parameters"></a>Input Parameters</h6>
<div class="paragraph">
<p>An input parameter can be either a named parameter or a positional
parameter.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A named input parameter is designated by a colon (<code>:</code>) followed by a
string; for example, <code>:name</code>.</p>
</li>
<li>
<p>A positional input parameter is designated by a question mark (<code>?</code>)
followed by an integer. For example, the first input parameter is <code>?1</code>,
the second is <code>?2</code>, and so forth.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following rules apply to input parameters.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>They can be used only in a <code>WHERE</code> or <code>HAVING</code> clause.</p>
</li>
<li>
<p>Positional parameters must be numbered, starting with the integer 1.</p>
</li>
<li>
<p>Named parameters and positional parameters may not be mixed in a
single query.</p>
</li>
<li>
<p>Named parameters are case-sensitive.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBVB"></a><a id="conditional-expressions"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="conditional-expressions"><a class="anchor" href="#conditional-expressions"></a>Conditional Expressions</h6>
<div class="paragraph">
<p>A <code>WHERE</code> clause consists of a conditional expression, which is
evaluated from left to right within a precedence level. You can change
the order of evaluation by using parentheses.</p>
</div>
<div class="paragraph">
<p><a id="BNBVC"></a><a id="operators-and-their-precedence"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="operators-and-their-precedence"><a class="anchor" href="#operators-and-their-precedence"></a>Operators and Their Precedence</h6>
<div class="paragraph">
<p><a href="#BNBVD">Table 42-2</a> lists the query language operators in order of
decreasing precedence.</p>
</div>
<div class="paragraph">
<p><a id="sthref170"></a><a id="BNBVD"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 42-2 Query Language Order Precedence</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 75%;">
<colgroup>
<col style="width: 35.7142%;">
<col style="width: 64.2858%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Type</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Precedence Order</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Navigation</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>.</code> (a period)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Arithmetic</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>+ –</code> (unary)</p>
</div>
<div class="paragraph">
<p><code>* /</code> (multiplication and division)</p>
</div>
<div class="paragraph">
<p><code>+ –</code> (addition and subtraction)</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Comparison</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>=</code></p>
</div>
<div class="paragraph">
<p><code>&gt;</code></p>
</div>
<div class="paragraph">
<p><code>&gt;=</code></p>
</div>
<div class="paragraph">
<p><code>&lt;</code></p>
</div>
<div class="paragraph">
<p><code>&#8656;</code></p>
</div>
<div class="paragraph">
<p><code>&lt;&gt;</code> (not equal)</p>
</div>
<div class="paragraph">
<p><code>[NOT] BETWEEN</code></p>
</div>
<div class="paragraph">
<p><code>[NOT] LIKE</code></p>
</div>
<div class="paragraph">
<p><code>[NOT] IN</code></p>
</div>
<div class="paragraph">
<p><code>IS [NOT] NULL</code></p>
</div>
<div class="paragraph">
<p><code>IS [NOT] EMPTY</code></p>
</div>
<div class="paragraph">
<p><code>[NOT] MEMBER OF</code></p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Logical</p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>NOT</code></p>
</div>
<div class="paragraph">
<p><code>AND</code></p>
</div>
<div class="paragraph">
<p><code>OR</code></p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="BNBVE"></a><a id="between-expressions"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="between-expressions"><a class="anchor" href="#between-expressions"></a>BETWEEN Expressions</h6>
<div class="paragraph">
<p>A <code>BETWEEN</code> expression determines whether an arithmetic expression falls
within a range of values.</p>
</div>
<div class="paragraph">
<p>These two expressions are equivalent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">p.age <span class="keyword">BETWEEN</span> <span class="integer">15</span> <span class="keyword">AND</span> <span class="integer">19</span>
p.age &gt;= <span class="integer">15</span> <span class="keyword">AND</span> p.age &lt;= <span class="integer">19</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following two expressions also are equivalent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">p.age <span class="keyword">NOT</span> <span class="keyword">BETWEEN</span> <span class="integer">15</span> <span class="keyword">AND</span> <span class="integer">19</span>
p.age &lt; <span class="integer">15</span> <span class="keyword">OR</span> p.age &gt; <span class="integer">19</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If an arithmetic expression has a <code>NULL</code> value, the value of the
<code>BETWEEN</code> expression is unknown.</p>
</div>
<div class="paragraph">
<p><a id="BNBVF"></a><a id="in-expressions"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="in-expressions"><a class="anchor" href="#in-expressions"></a>IN Expressions</h6>
<div class="paragraph">
<p>An <code>IN</code> expression determines whether a string belongs to a set of
string literals or whether a number belongs to a set of number values.</p>
</div>
<div class="paragraph">
<p>The path expression must have a string or numeric value. If the path
expression has a <code>NULL</code> value, the value of the <code>IN</code> expression is
unknown.</p>
</div>
<div class="paragraph">
<p>In the following example, the expression is <code>TRUE</code> if the country is
<code>UK</code> , but <code>FALSE</code> if the country is <code>Peru</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">o.country <span class="keyword">IN</span> (<span class="string"><span class="delimiter">'</span><span class="content">UK</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">US</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">France</span><span class="delimiter">'</span></span>)</code></pre>
</div>
</div>
<div class="paragraph">
<p>You may also use input parameters:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql">o.country <span class="keyword">IN</span> (<span class="string"><span class="delimiter">'</span><span class="content">UK</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">US</span><span class="delimiter">'</span></span>, <span class="string"><span class="delimiter">'</span><span class="content">France</span><span class="delimiter">'</span></span>, :country)</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBVG"></a><a id="like-expressions"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="like-expressions"><a class="anchor" href="#like-expressions"></a>LIKE Expressions</h6>
<div class="paragraph">
<p>A <code>LIKE</code> expression determines whether a wildcard pattern matches a
string.</p>
</div>
<div class="paragraph">
<p>The path expression must have a string or numeric value. If this value
is <code>NULL</code>, the value of the <code>LIKE</code> expression is unknown. The pattern
value is a string literal that can contain wildcard characters. The
underscore (<code>_</code>) wildcard character represents any single character. The
percent (<code>%</code>) wildcard character represents zero or more characters. The
<code>ESCAPE</code> clause specifies an escape character for the wildcard
characters in the pattern value. <a href="#BNBVH">Table 42-3</a> shows some
sample <code>LIKE</code> expressions.</p>
</div>
<div class="paragraph">
<p><a id="sthref171"></a><a id="BNBVH"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 42-3 LIKE Expression Examples</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 75%;">
<colgroup>
<col style="width: 46.6666%;">
<col style="width: 26.6666%;">
<col style="width: 26.6668%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Expression</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>TRUE</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>FALSE</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>address.phone LIKE '12%3'</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>'123'</code></p>
</div>
<div class="paragraph">
<p><code>'12993'</code></p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'1234'</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>asentence.word LIKE 'l_se'</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'lose'</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'loose'</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>aword.underscored LIKE '\_%' ESCAPE '\'</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'_foo'</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'bar'</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>address.phone NOT LIKE '12%3'</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>'1234'</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>'123'</code></p>
</div>
<div class="paragraph">
<p><code>'12993'</code></p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="BNBVI"></a><a id="null-comparison-expressions"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="null-comparison-expressions"><a class="anchor" href="#null-comparison-expressions"></a>NULL Comparison Expressions</h6>
<div class="paragraph">
<p>A <code>NULL</code> comparison expression tests whether a single-valued path
expression or an input parameter has a <code>NULL</code> value. Usually, the <code>NULL</code>
comparison expression is used to test whether a single-valued
relationship has been set:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> t
<span class="keyword">FROM</span> Team t
<span class="keyword">WHERE</span> t.league <span class="keyword">IS</span> <span class="predefined-constant">NULL</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query selects all teams where the league relationship is not set.
Note that the following query is not equivalent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> t
<span class="keyword">FROM</span> Team t
<span class="keyword">WHERE</span> t.league = <span class="predefined-constant">NULL</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The comparison with <code>NULL</code> using the equals operator (<code>=</code>) always
returns an unknown value, even if the relationship is not set. The
second query will always return an empty result.</p>
</div>
<div class="paragraph">
<p><a id="BNBVJ"></a><a id="empty-collection-comparison-expressions"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="empty-collection-comparison-expressions"><a class="anchor" href="#empty-collection-comparison-expressions"></a>Empty Collection Comparison Expressions</h6>
<div class="paragraph">
<p>The <code>IS [NOT] EMPTY</code> comparison expression tests whether a
collection-valued path expression has no elements. In other words, it
tests whether a collection-valued relationship has been set.</p>
</div>
<div class="paragraph">
<p>If the collection-valued path expression is <code>NULL</code>, the empty collection
comparison expression has a <code>NULL</code> value.</p>
</div>
<div class="paragraph">
<p>Here is an example that finds all orders that do not have any line
items:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> o
<span class="keyword">FROM</span> CustomerOrder o
<span class="keyword">WHERE</span> o.lineItems <span class="keyword">IS</span> EMPTY</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBVK"></a><a id="collection-member-expressions"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="collection-member-expressions"><a class="anchor" href="#collection-member-expressions"></a>Collection Member Expressions</h6>
<div class="paragraph">
<p>The <code>[NOT]</code> <code>MEMBER [OF]</code> collection member expression determines
whether a value is a member of a collection. The value and the
collection members must have the same type.</p>
</div>
<div class="paragraph">
<p>If either the collection-valued or single-valued path expression is
unknown, the collection member expression is unknown. If the
collection-valued path expression designates an empty collection, the
collection member expression is <code>FALSE</code>.</p>
</div>
<div class="paragraph">
<p>The <code>OF</code> keyword is optional.</p>
</div>
<div class="paragraph">
<p>The following example tests whether a line item is part of an order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> o
<span class="keyword">FROM</span> CustomerOrder o
<span class="keyword">WHERE</span> :lineItem MEMBER <span class="keyword">OF</span> o.lineItems</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBVL"></a><a id="subqueries"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="subqueries"><a class="anchor" href="#subqueries"></a>Subqueries</h6>
<div class="paragraph">
<p>Subqueries may be used in the <code>WHERE</code> or <code>HAVING</code> clause of a query.
Subqueries must be surrounded by parentheses.</p>
</div>
<div class="paragraph">
<p>The following example finds all customers who have placed more than ten
orders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> c
<span class="keyword">FROM</span> Customer c
<span class="keyword">WHERE</span> (<span class="class">SELECT</span> <span class="predefined">COUNT</span>(o) <span class="keyword">FROM</span> c.orders o)&gt; <span class="integer">10</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Subqueries may contain <code>EXISTS</code>, <code>ALL</code>, and <code>ANY</code> expressions.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>EXISTS expressions: The <code>[NOT] EXISTS</code> expression is used with a
subquery and is true only if the result of the subquery consists of one
or more values; otherwise, it is false.</p>
<div class="paragraph">
<p>The following example finds all employees whose spouses are also
employees:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="keyword">DISTINCT</span> emp
<span class="keyword">FROM</span> Employee emp
<span class="keyword">WHERE</span> <span class="keyword">EXISTS</span> (
    <span class="class">SELECT</span> spouseEmp
    <span class="keyword">FROM</span> Employee spouseEmp
    <span class="keyword">WHERE</span> spouseEmp = emp.spouse)</code></pre>
</div>
</div>
</li>
<li>
<p>ALL and ANY expressions: The <code>ALL</code> expression is used with a subquery
and is true if all the values returned by the subquery are true or if
the subquery is empty.</p>
<div class="paragraph">
<p>The <code>ANY</code> expression is used with a subquery and is true if some of the
values returned by the subquery are true. An <code>ANY</code> expression is false
if the subquery result is empty or if all the values returned are false.
The <code>SOME</code> keyword is synonymous with <code>ANY</code>.</p>
</div>
<div class="paragraph">
<p>The <code>ALL</code> and <code>ANY</code> expressions are used with the <code>=</code>, <code>&lt;</code>, <code>&#8656;</code>, <code>&gt;</code>,
<code>&gt;=</code>, and <code>&lt;&gt;</code> comparison operators.</p>
</div>
<div class="paragraph">
<p>The following example finds all employees whose salaries are higher than
the salaries of the managers in the employee&#8217;s department:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> emp
<span class="keyword">FROM</span> Employee emp
<span class="keyword">WHERE</span> emp.salary &gt; <span class="keyword">ALL</span> (
    <span class="class">SELECT</span> m.salary
    <span class="keyword">FROM</span> Manager m
    <span class="keyword">WHERE</span> m.department = emp.department)</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBVO"></a><a id="functional-expressions"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="functional-expressions"><a class="anchor" href="#functional-expressions"></a>Functional Expressions</h6>
<div class="paragraph">
<p>The query language includes several string, arithmetic, and date/time
functions that may be used in the <code>SELECT</code>, <code>WHERE</code>, or <code>HAVING</code> clause
of a query. The functions are listed in <a href="#BNBVP">Table 42-4</a>,
<a href="#GJJNL">Table 42-6</a>.</p>
</div>
<div class="paragraph">
<p>In <a href="#BNBVP">Table 42-4</a>, the <code>start</code> and <code>length</code> arguments are of
type <code>int</code> and designate positions in the <code>String</code> argument. The first
position in a string is designated by 1.</p>
</div>
<div class="paragraph">
<p><a id="sthref172"></a><a id="BNBVP"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 42-4 String Expressions</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 75%;">
<colgroup>
<col style="width: 64.2857%;">
<col style="width: 35.7143%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Function Syntax</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Return Type</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CONCAT(String, String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LENGTH(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LOCATE(String, String [, start])</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SUBSTRING(String, start, length)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">`TRIM([[LEADING</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">TRAILING</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">BOTH] char) FROM] (String)`</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>LOWER(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UPPER(String)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>String</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>CONCAT</code> function concatenates two strings into one string.</p>
</div>
<div class="paragraph">
<p>The <code>LENGTH</code> function returns the length of a string in characters as an
integer.</p>
</div>
<div class="paragraph">
<p>The <code>LOCATE</code> function returns the position of a given string within a
string. This function returns the first position at which the string was
found as an integer. The first argument is the string to be located. The
second argument is the string to be searched. The optional third
argument is an integer that represents the starting string position. By
default, <code>LOCATE</code> starts at the beginning of the string. The starting
position of a string is <code>1</code>. If the string cannot be located, <code>LOCATE</code>
returns <code>0</code>.</p>
</div>
<div class="paragraph">
<p>The <code>SUBSTRING</code> function returns a string that is a substring of the
first argument based on the starting position and length.</p>
</div>
<div class="paragraph">
<p>The <code>TRIM</code> function trims the specified character from the beginning
and/or end of a string. If no character is specified, <code>TRIM</code> removes
spaces or blanks from the string. If the optional <code>LEADING</code>
specification is used, <code>TRIM</code> removes only the leading characters from
the string. If the optional <code>TRAILING</code> specification is used, <code>TRIM</code>
removes only the trailing characters from the string. The default is
<code>BOTH</code>, which removes the leading and trailing characters from the
string.</p>
</div>
<div class="paragraph">
<p>The <code>LOWER</code> and <code>UPPER</code> functions convert a string to lowercase or
uppercase, respectively.</p>
</div>
<div class="paragraph">
<p>In <a href="#BNBVQ">Table 42-5</a>, the <code>number</code> argument can be an <code>int</code>, a
<code>float</code>, or a <code>double</code>.</p>
</div>
<div class="paragraph">
<p><a id="sthref173"></a><a id="BNBVQ"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 42-5 Arithmetic Expressions</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 60%;">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Function Syntax</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Return Type</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ABS(number)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code>, <code>float</code>, or <code>double</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MOD(int, int)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SQRT(double)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>double</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SIZE(Collection)</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>int</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>ABS</code> function takes a numeric expression and returns a number of
the same type as the argument.</p>
</div>
<div class="paragraph">
<p>The <code>MOD</code> function returns the remainder of the first argument divided
by the second.</p>
</div>
<div class="paragraph">
<p>The <code>SQRT</code> function returns the square root of a number.</p>
</div>
<div class="paragraph">
<p>The <code>SIZE</code> function returns an integer of the number of elements in the
given collection.</p>
</div>
<div class="paragraph">
<p>In <a href="#GJJNL">Table 42-6</a>, the date/time functions return the date,
time, or timestamp on the database server.</p>
</div>
<div class="paragraph">
<p><a id="sthref174"></a><a id="GJJNL"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 42-6 Date/Time Expressions</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 60%;">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Function Syntax</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Return Type</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CURRENT_DATE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.sql.Date</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CURRENT_TIME</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.sql.Time</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>CURRENT_TIMESTAMP</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>java.sql.Timestamp</code></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="GJJND"></a><a id="case-expressions"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="case-expressions"><a class="anchor" href="#case-expressions"></a>Case Expressions</h6>
<div class="paragraph">
<p>Case expressions change based on a condition, similar to the <code>case</code>
keyword of the Java programming language. The <code>CASE</code> keyword indicates
the start of a case expression, and the expression is terminated by the
<code>END</code> keyword. The <code>WHEN</code> and <code>THEN</code> keywords define individual
conditions, and the <code>ELSE</code> keyword defines the default condition should
none of the other conditions be satisfied.</p>
</div>
<div class="paragraph">
<p>The following query selects the name of a person and a conditional
string, depending on the subtype of the <code>Person</code> entity. If the subtype
is <code>Student</code>, the string <code>kid</code> is returned. If the subtype is <code>Guardian</code>
or <code>Staff</code>, the string <code>adult</code> is returned. If the entity is some other
subtype of <code>Person</code>, the string <code>unknown</code> is returned:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> p.name
<span class="keyword">CASE</span> TYPE(p)
    <span class="keyword">WHEN</span> Student <span class="keyword">THEN</span> <span class="string"><span class="delimiter">'</span><span class="content">kid</span><span class="delimiter">'</span></span>
    <span class="keyword">WHEN</span> Guardian <span class="keyword">THEN</span> <span class="string"><span class="delimiter">'</span><span class="content">adult</span><span class="delimiter">'</span></span>
    <span class="keyword">WHEN</span> Staff <span class="keyword">THEN</span> <span class="string"><span class="delimiter">'</span><span class="content">adult</span><span class="delimiter">'</span></span>
    <span class="keyword">ELSE</span> <span class="string"><span class="delimiter">'</span><span class="content">unknown</span><span class="delimiter">'</span></span>
<span class="keyword">END</span>
<span class="keyword">FROM</span> Person p</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following query sets a discount for various types of customers.
Gold-level customers get a 20% discount, silver-level customers get a
15% discount, bronze-level customers get a 10% discount, and everyone
else gets a 5% discount:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">UPDATE</span> Customer c
<span class="class">SET</span> c.discount =
    <span class="keyword">CASE</span> c.level
        <span class="keyword">WHEN</span> <span class="string"><span class="delimiter">'</span><span class="content">Gold</span><span class="delimiter">'</span></span> <span class="keyword">THEN</span> <span class="integer">20</span>
        <span class="keyword">WHEN</span> <span class="string"><span class="delimiter">'</span><span class="content">SILVER</span><span class="delimiter">'</span></span> <span class="keyword">THEN</span> <span class="integer">15</span>
        <span class="keyword">WHEN</span> <span class="string"><span class="delimiter">'</span><span class="content">Bronze</span><span class="delimiter">'</span></span> <span class="keyword">THEN</span> <span class="integer">10</span>
        <span class="keyword">ELSE</span> <span class="integer">5</span>
    <span class="keyword">END</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBVR"></a><a id="null-values"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="null-values"><a class="anchor" href="#null-values"></a>NULL Values</h6>
<div class="paragraph">
<p>If the target of a reference is not in the persistent store, the target
is <code>NULL</code>. For conditional expressions containing <code>NULL</code>, the query
language uses the semantics defined by SQL92. Briefly, these semantics
are as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If a comparison or arithmetic operation has an unknown value, it
yields a <code>NULL</code> value.</p>
</li>
<li>
<p>Two <code>NULL</code> values are not equal. Comparing two <code>NULL</code> values yields an
unknown value.</p>
</li>
<li>
<p>The <code>IS NULL</code> test converts a <code>NULL</code> persistent field or a
single-valued relationship field to <code>TRUE</code>. The <code>IS NOT NULL</code> test
converts them to <code>FALSE</code>.</p>
</li>
<li>
<p>Boolean operators and conditional tests use the three-valued logic
defined by <a href="#BNBVT">Table 42-8</a>. (In
these tables, T stands for <code>TRUE</code>, F for <code>FALSE</code>, and U for unknown.)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="sthref175"></a><a id="BNBVS"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 42-7 AND Operator Logic</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 40%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>AND</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>T</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>F</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>U</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">T</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">U</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">U</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">U</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">U</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="sthref176"></a><a id="BNBVT"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 42-8 OR Operator Logic</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 40%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
<col style="width: 25%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>OR</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>T</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>F</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>U</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">T</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">U</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">U</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">U</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">U</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="BNBVU"></a><a id="equality-semantics"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="equality-semantics"><a class="anchor" href="#equality-semantics"></a>Equality Semantics</h6>
<div class="paragraph">
<p>In the query language, only values of the same type can be compared.
However, this rule has one exception: Exact and approximate numeric
values can be compared. In such a comparison, the required type
conversion adheres to the rules of Java numeric promotion.</p>
</div>
<div class="paragraph">
<p>The query language treats compared values as if they were Java types and
not as if they represented types in the underlying data store. For
example, a persistent field that could be either an integer or a <code>NULL</code>
must be designated as an <code>Integer</code> object and not as an <code>int</code> primitive.
This designation is required because a Java object can be <code>NULL</code>, but a
primitive cannot.</p>
</div>
<div class="paragraph">
<p>Two strings are equal only if they contain the same sequence of
characters. Trailing blanks are significant; for example, the strings
<code>'abc'</code> and <code>'abc '</code> are not equal.</p>
</div>
<div class="paragraph">
<p>Two entities of the same abstract schema type are equal only if their
primary keys have the same value. <a href="#BNBVV">Table 42-9</a> shows the
operator logic of a negation, and <a href="#BNBVW">Table 42-10</a> shows the
truth values of conditional tests.</p>
</div>
<div class="paragraph">
<p><a id="sthref177"></a><a id="BNBVV"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 42-9 NOT Operator Logic</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 30%;">
<colgroup>
<col style="width: 50%;">
<col style="width: 50%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>NOT Value</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Value</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">T</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">U</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">U</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="sthref178"></a><a id="BNBVW"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 42-10 Conditional Test</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 60%;">
<colgroup>
<col style="width: 50%;">
<col style="width: 16.6666%;">
<col style="width: 16.6666%;">
<col style="width: 16.6668%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Conditional Test</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>T</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>F</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>U</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expression <code>IS TRUE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expression <code>IS FALSE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expression is unknown</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">F</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">T</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="BNBVX"></a><a id="select-clause"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="select-clause"><a class="anchor" href="#select-clause"></a>SELECT Clause</h5>
<div class="paragraph">
<p>The <code>SELECT</code> clause defines the types of the objects or values returned
by the query.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#BNBVY">Return Types</a></p>
</li>
<li>
<p><a href="#BNBWB">The DISTINCT Keyword</a></p>
</li>
<li>
<p><a href="#BNBWC">Constructor Expressions</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNBVY"></a><a id="return-types"></a></p>
</div>
<div class="sect5">
<h6 id="return-types"><a class="anchor" href="#return-types"></a>Return Types</h6>
<div class="paragraph">
<p>The return type of the <code>SELECT</code> clause is defined by the result types of
the select expressions contained within it. If multiple expressions are
used, the result of the query is an <code>Object[]</code>, and the elements in the
array correspond to the order of the expressions in the <code>SELECT</code> clause
and in type to the result types of each expression.</p>
</div>
<div class="paragraph">
<p>A <code>SELECT</code> clause cannot specify a collection-valued expression. For
example, the <code>SELECT</code> clause <code>p.teams</code> is invalid because <code>teams</code> is a
collection. However, the clause in the following query is valid because
<code>t</code> is a single element of the <code>teams</code> collection:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> t
<span class="keyword">FROM</span> Player p, <span class="keyword">IN</span> (p.teams) t</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following query is an example of a query with multiple expressions
in the <code>SELECT</code> clause:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> c.name, c.country.name
<span class="keyword">FROM</span> customer c
<span class="keyword">WHERE</span> c.lastname = <span class="string"><span class="delimiter">'</span><span class="content">Coss</span><span class="delimiter">'</span></span> <span class="keyword">AND</span> c.firstname = <span class="string"><span class="delimiter">'</span><span class="content">Roxane</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>This query returns a list of <code>Object[]</code> elements; the first array
element is a string denoting the customer name, and the second array
element is a string denoting the name of the customer&#8217;s country.</p>
</div>
<div class="paragraph">
<p>The result of a query may be the result of an aggregate function, listed
in <a href="#BNBWA">Table 42-11</a>.</p>
</div>
<div class="paragraph">
<p><a id="sthref179"></a><a id="BNBWA"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 42-11 Aggregate Functions in Select Statements</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<colgroup>
<col style="width: 11.6279%;">
<col style="width: 38.7596%;">
<col style="width: 49.6125%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Name</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Return Type</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>AVG</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Double</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the mean average of the fields</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>COUNT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Long</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the total number of results</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MAX</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The type of the field</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the highest value in the result
set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MIN</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The type of the field</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the lowest value in the result
set</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>SUM</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><code>Long</code> (for integral fields)</p>
</div>
<div class="paragraph">
<p><code>Double</code> (for floating-point fields)</p>
</div>
<div class="paragraph">
<p><code>BigInteger</code> (for <code>BigInteger</code> fields)</p>
</div>
<div class="paragraph">
<p><code>BigDecimal</code> (for <code>BigDecimal</code> fields)</p>
</div></div></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Returns the sum of all the values in the result set</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For select method queries with an aggregate function (<code>AVG</code>, <code>COUNT</code>,
<code>MAX</code>, <code>MIN</code>, or <code>SUM</code>) in the <code>SELECT</code> clause, the following rules
apply.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>AVG</code>, <code>MAX</code>, <code>MIN</code>, and <code>SUM</code> functions return <code>null</code> if there
are no values to which the function can be applied.</p>
</li>
<li>
<p>The <code>COUNT</code> function returns 0 if there are no values to which the
function can be applied.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following example returns the average order quantity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="predefined">AVG</span>(o.quantity)
<span class="keyword">FROM</span> CustomerOrder o</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example returns the total cost of the items ordered by
Roxane Coss:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="predefined">SUM</span>(l.price)
<span class="keyword">FROM</span> CustomerOrder o <span class="keyword">JOIN</span> o.lineItems l <span class="keyword">JOIN</span> o.customer c
<span class="keyword">WHERE</span> c.lastname = <span class="string"><span class="delimiter">'</span><span class="content">Coss</span><span class="delimiter">'</span></span> <span class="keyword">AND</span> c.firstname = <span class="string"><span class="delimiter">'</span><span class="content">Roxane</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example returns the total number of orders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="predefined">COUNT</span>(o)
<span class="keyword">FROM</span> CustomerOrder o</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example returns the total number of items that have prices
in Hal Incandenza&#8217;s order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> <span class="predefined">COUNT</span>(l.price)
<span class="keyword">FROM</span> CustomerOrder o <span class="keyword">JOIN</span> o.lineItems l <span class="keyword">JOIN</span> o.customer c
<span class="keyword">WHERE</span> c.lastname = <span class="string"><span class="delimiter">'</span><span class="content">Incandenza</span><span class="delimiter">'</span></span> <span class="keyword">AND</span> c.firstname = <span class="string"><span class="delimiter">'</span><span class="content">Hal</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBWB"></a><a id="the-distinct-keyword"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="the-distinct-keyword"><a class="anchor" href="#the-distinct-keyword"></a>The DISTINCT Keyword</h6>
<div class="paragraph">
<p>The <code>DISTINCT</code> keyword eliminates duplicate return values. If a query
returns a <code>java.util.Collection</code>, which allows duplicates, you must
specify the <code>DISTINCT</code> keyword to eliminate duplicates.</p>
</div>
<div class="paragraph">
<p><a id="BNBWC"></a><a id="constructor-expressions"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="constructor-expressions"><a class="anchor" href="#constructor-expressions"></a>Constructor Expressions</h6>
<div class="paragraph">
<p>Constructor expressions allow you to return Java instances that store a
query result element instead of an <code>Object[]</code>.</p>
</div>
<div class="paragraph">
<p>The following query creates a <code>CustomerDetail</code> instance per <code>Customer</code>
matching the <code>WHERE</code> clause. A <code>CustomerDetail</code> stores the customer name
and customer&#8217;s country name. So the query returns a <code>List</code> of
<code>CustomerDetail</code> instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> NEW com.example.CustomerDetail(c.name, c.country.name)
<span class="keyword">FROM</span> customer c
<span class="keyword">WHERE</span> c.lastname = <span class="string"><span class="delimiter">'</span><span class="content">Coss</span><span class="delimiter">'</span></span> <span class="keyword">AND</span> c.firstname = <span class="string"><span class="delimiter">'</span><span class="content">Roxane</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBWD"></a><a id="order-by-clause"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="order-by-clause"><a class="anchor" href="#order-by-clause"></a>ORDER BY Clause</h5>
<div class="paragraph">
<p>As its name suggests, the <code>ORDER BY</code> clause orders the values or objects
returned by the query.</p>
</div>
<div class="paragraph">
<p>If the <code>ORDER BY</code> clause contains multiple elements, the left-to-right
sequence of the elements determines the high-to-low precedence.</p>
</div>
<div class="paragraph">
<p>The <code>ASC</code> keyword specifies ascending order, the default, and the <code>DESC</code>
keyword indicates descending order.</p>
</div>
<div class="paragraph">
<p>When using the <code>ORDER BY</code> clause, the <code>SELECT</code> clause must return an
orderable set of objects or values. You cannot order the values or
objects for values or objects not returned by the <code>SELECT</code> clause. For
example, the following query is valid because the <code>ORDER BY</code> clause uses
the objects returned by the <code>SELECT</code> clause:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> o
<span class="keyword">FROM</span> Customer c <span class="keyword">JOIN</span> c.orders o <span class="keyword">JOIN</span> c.address a
<span class="keyword">WHERE</span> a.state = <span class="string"><span class="delimiter">'</span><span class="content">CA</span><span class="delimiter">'</span></span>
<span class="keyword">ORDER</span> <span class="keyword">BY</span> o.quantity, o.totalcost</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following example is not valid, because the <code>ORDER BY</code> clause uses a
value not returned by the <code>SELECT</code> clause:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> p.product_name
<span class="keyword">FROM</span> CustomerOrder o, <span class="keyword">IN</span>(o.lineItems) l <span class="keyword">JOIN</span> o.customer c
<span class="keyword">WHERE</span> c.lastname = <span class="string"><span class="delimiter">'</span><span class="content">Faehmel</span><span class="delimiter">'</span></span> <span class="keyword">AND</span> c.firstname = <span class="string"><span class="delimiter">'</span><span class="content">Robert</span><span class="delimiter">'</span></span>
<span class="keyword">ORDER</span> <span class="keyword">BY</span> o.quantity</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBWE"></a><a id="group-by-and-having-clauses"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="group-by-and-having-clauses"><a class="anchor" href="#group-by-and-having-clauses"></a>GROUP BY and HAVING Clauses</h5>
<div class="paragraph">
<p>The <code>GROUP BY</code> clause allows you to group values according to a set of
properties.</p>
</div>
<div class="paragraph">
<p>The following query groups the customers by their country and returns
the number of customers per country:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> c.country, <span class="predefined">COUNT</span>(c)
<span class="keyword">FROM</span> Customer c <span class="keyword">GROUP</span> <span class="keyword">BY</span> c.country</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>HAVING</code> clause is used with the <code>GROUP BY</code> clause to further
restrict the returned result of a query.</p>
</div>
<div class="paragraph">
<p>The following query groups orders by the status of their customer and
returns the customer status plus the average <code>totalPrice</code> for all orders
where the corresponding customers have the same status. In addition, it
considers only customers with status <code>1</code>, <code>2</code>, or <code>3</code>, so orders of
other customers are not taken into account:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> c.status, <span class="predefined">AVG</span>(o.totalPrice)
<span class="keyword">FROM</span> CustomerOrder o <span class="keyword">JOIN</span> o.customer c
<span class="keyword">GROUP</span> <span class="keyword">BY</span> c.status <span class="keyword">HAVING</span> c.status <span class="keyword">IN</span> (<span class="integer">1</span>, <span class="integer">2</span>, <span class="integer">3</span>)</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-the-criteria-api-to-create-queries"><a class="anchor" href="#using-the-criteria-api-to-create-queries"></a>Using the Criteria API to Create Queries</h3>
<div class="paragraph">
<p><a id="GJITV"></a><a id="using-the-criteria-api-to-create-queries"></a></p>
</div>
<div class="paragraph">
<p>The Criteria API is used to define queries for entities and their
persistent state by creating query-defining objects. Criteria queries
are written using Java programming language APIs, are typesafe, and are
portable. Such queries work regardless of the underlying data store.</p>
</div>
<div class="paragraph">
<p><a id="GJRIJ"></a><a id="overview-of-the-criteria-and-metamodel-apis"></a></p>
</div>
<div class="sect3">
<h4 id="overview-of-the-criteria-and-metamodel-apis"><a class="anchor" href="#overview-of-the-criteria-and-metamodel-apis"></a>Overview of the Criteria and Metamodel APIs</h4>
<div class="paragraph">
<p>Similar to JPQL, the Criteria API is based on the abstract schema of
persistent entities, their relationships, and embedded objects. The
Criteria API operates on this abstract schema to allow developers to
find, modify, and delete persistent entities by invoking Jakarta
Persistence entity operations. The Metamodel API works in concert
with the Criteria API to model persistent entity classes for Criteria
queries.</p>
</div>
<div class="paragraph">
<p>The Criteria API and JPQL are closely related and are designed to allow
similar operations in their queries. Developers familiar with JPQL
syntax will find equivalent object-level operations in the Criteria API.</p>
</div>
<div class="paragraph">
<p>The following simple Criteria query returns all instances of the <code>Pet</code>
entity in the data source:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = ...;
CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
cq.select(pet);
TypedQuery&lt;Pet&gt; q = em.createQuery(cq);
<span class="predefined-type">List</span>&lt;Pet&gt; allPets = q.getResultList();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The equivalent JPQL query is</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="sql"><span class="class">SELECT</span> p
<span class="keyword">FROM</span> Pet p</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query demonstrates the basic steps to create a Criteria query.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use an <code>EntityManager</code> instance to create a <code>CriteriaBuilder</code>
object.</p>
</li>
<li>
<p>Create a query object by creating an instance of the <code>CriteriaQuery</code>
interface. This query object&#8217;s attributes will be modified with the
details of the query.</p>
</li>
<li>
<p>Set the query root by calling the <code>from</code> method on the
<code>CriteriaQuery</code> object.</p>
</li>
<li>
<p>Specify what the type of the query result will be by calling the
<code>select</code> method of the <code>CriteriaQuery</code> object.</p>
</li>
<li>
<p>Prepare the query for execution by creating a <code>TypedQuery&lt;T&gt;</code>
instance, specifying the type of the query result.</p>
</li>
<li>
<p>Execute the query by calling the <code>getResultList</code> method on the
<code>TypedQuery&lt;T&gt;</code> object. Because this query returns a collection of
entities, the result is stored in a <code>List</code>.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The tasks associated with each step are discussed in detail in this
chapter.</p>
</div>
<div class="paragraph">
<p>To create a <code>CriteriaBuilder</code> instance, call the <code>getCriteriaBuilder</code>
method on the <code>EntityManager</code> instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaBuilder cb = em.getCriteriaBuilder();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Use the <code>CriteriaBuilder</code> instance to create a query object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The query will return instances of the <code>Pet</code> entity. To create a
typesafe query, specify the type of the query when you create the
<code>CriteriaQuery</code> object.</p>
</div>
<div class="paragraph">
<p>Call the <code>from</code> method of the query object to set the <code>FROM</code> clause of
the query and to specify the root of the query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Root&lt;Pet&gt; pet = cq.from(Pet.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Call the <code>select</code> method of the query object, passing in the query root,
to set the <code>SELECT</code> clause of the query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cq.select(pet);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now, use the query object to create a <code>TypedQuery&lt;T&gt;</code> object that can be
executed against the data source. The modifications to the query object
are captured to create a ready-to-execute query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">TypedQuery&lt;Pet&gt; q = em.createQuery(cq);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Execute this typed query object by calling its <code>getResultList</code> method,
because this query will return multiple entity instances. The following
statement stores the results in a <code>List&lt;Pet&gt;</code> collection-valued object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">List</span>&lt;Pet&gt; allPets = q.getResultList();</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GJIUP"></a><a id="using-the-metamodel-api-to-model-entity-classes"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="using-the-metamodel-api-to-model-entity-classes"><a class="anchor" href="#using-the-metamodel-api-to-model-entity-classes"></a>Using the Metamodel API to Model Entity Classes</h4>
<div class="paragraph">
<p>Use the Metamodel API to create a metamodel of the managed entities in a
particular persistence unit. For each entity class in a particular
package, a metamodel class is created with a trailing underscore and
with attributes that correspond to the persistent fields or properties
of the entity class.</p>
</div>
<div class="paragraph">
<p>The following entity class, <code>com.example.Pet</code>, has four persistent
fields: <code>id</code>, <code>name</code>, <code>color</code>, and <code>owners</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example</span>;
...
<span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Pet</span> {
    <span class="annotation">@Id</span>
    <span class="directive">protected</span> <span class="predefined-type">Long</span> id;
    <span class="directive">protected</span> <span class="predefined-type">String</span> name;
    <span class="directive">protected</span> <span class="predefined-type">String</span> color;
    <span class="annotation">@ManyToOne</span>
    <span class="directive">protected</span> <span class="predefined-type">Set</span>&lt;Person&gt; owners;
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The corresponding Metamodel class is as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">package</span> <span class="namespace">com.example</span>;
...
<span class="annotation">@Static</span> Metamodel(Pet.class)
<span class="directive">public</span> <span class="type">class</span> <span class="class">Pet_</span> {

    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">volatile</span> SingularAttribute&lt;Pet, <span class="predefined-type">Long</span>&gt; id;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">volatile</span> SingularAttribute&lt;Pet, <span class="predefined-type">String</span>&gt; name;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">volatile</span> SingularAttribute&lt;Pet, <span class="predefined-type">String</span>&gt; color;
    <span class="directive">public</span> <span class="directive">static</span> <span class="directive">volatile</span> SetAttribute&lt;Pet, Person&gt; owners;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Criteria queries use the metamodel class and its attributes to refer to
the managed entity classes and their persistent state and relationships.</p>
</div>
<div class="paragraph">
<p><a id="GJIVL"></a><a id="using-metamodel-classes"></a></p>
</div>
<div class="sect4">
<h5 id="using-metamodel-classes"><a class="anchor" href="#using-metamodel-classes"></a>Using Metamodel Classes</h5>
<div class="paragraph">
<p>Metamodel classes that correspond to entity classes are of the following
type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">javax.persistence.metamodel.EntityType&lt;T&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Annotation processors typically generate metamodel classes either at
development time or at runtime. Developers of applications that use
Criteria queries may do either of the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Generate static metamodel classes by using the persistence provider&#8217;s
annotation processor</p>
</li>
<li>
<p>Obtain the metamodel class by doing one of the following:</p>
<div class="ulist">
<ul>
<li>
<p>Call the <code>getModel</code> method on the query root object</p>
</li>
<li>
<p>Obtain an instance of the <code>Metamodel</code> interface and then pass the
entity type to the instance&#8217;s <code>entity</code> method</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following code snippet shows how to obtain the <code>Pet</code> entity&#8217;s
metamodel class by calling <code>Root&lt;T&gt;.getModel</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = ...;
CriteriaBuilder cb = em.getCriteriaBuilder();
CriteriaQuery cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
EntityType&lt;Pet&gt; Pet_ = pet.getModel();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code snippet shows how to obtain the <code>Pet</code> entity&#8217;s
metamodel class by first obtaining a metamodel instance by using
<code>EntityManager.getMetamodel</code> and then calling <code>entity</code> on the metamodel
instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = ...;
Metamodel m = em.getMetamodel();
EntityType&lt;Pet&gt; Pet_ = m.entity(Pet.class);</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Note:</p>
</div>
<div class="paragraph">
<p>The most common use case is to generate typesafe static metamodel
classes at development time. Obtaining the metamodel classes
dynamically, by calling <code>Root&lt;T&gt;.getModel</code> or
<code>EntityManager.getMetamodel</code> and then the <code>entity</code> method, doesn&#8217;t allow
for type safety and doesn&#8217;t allow the application to call persistent
field or property names on the metamodel class.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="GJIVM"></a><a id="using-the-criteria-api-and-metamodel-api-to-create-basic-typesafe-queries"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="using-the-criteria-api-and-metamodel-api-to-create-basic-typesafe-queries"><a class="anchor" href="#using-the-criteria-api-and-metamodel-api-to-create-basic-typesafe-queries"></a>Using the Criteria API and Metamodel API to Create Basic Typesafe Queries</h4>
<div class="paragraph">
<p>The basic semantics of a Criteria query consists of a <code>SELECT</code> clause, a
<code>FROM</code> clause, and an optional <code>WHERE</code> clause, similar to a JPQL query.
Criteria queries set these clauses by using Java programming language
objects, so the query can be created in a typesafe manner.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#GJIVS">Creating a Criteria Query</a></p>
</li>
<li>
<p><a href="#GJIVQ">Query Roots</a></p>
</li>
<li>
<p><a href="#GJIUV">Querying Relationships Using Joins</a></p>
</li>
<li>
<p><a href="#GJIVE">Path Navigation in Criteria Queries</a></p>
</li>
<li>
<p><a href="#GJIVI">Restricting Criteria Query Results</a></p>
</li>
<li>
<p><a href="#GJIXE">Managing Criteria Query Results</a></p>
</li>
<li>
<p><a href="#GJIVY">Executing Queries</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="GJIVS"></a><a id="creating-a-criteria-query"></a></p>
</div>
<div class="sect4">
<h5 id="creating-a-criteria-query"><a class="anchor" href="#creating-a-criteria-query"></a>Creating a Criteria Query</h5>
<div class="paragraph">
<p>The <code>javax.persistence.criteria.CriteriaBuilder</code> interface is used to
construct</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Criteria queries</p>
</li>
<li>
<p>Selections</p>
</li>
<li>
<p>Expressions</p>
</li>
<li>
<p>Predicates</p>
</li>
<li>
<p>Ordering</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To obtain an instance of the <code>CriteriaBuilder</code> interface, call the
<code>getCriteriaBuilder</code> method on either an <code>EntityManager</code> or an
<code>EntityManagerFactory</code> instance.</p>
</div>
<div class="paragraph">
<p>The following code shows how to obtain a <code>CriteriaBuilder</code> instance by
using the <code>EntityManager.getCriteriaBuilder</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = ...;
CriteriaBuilder cb = em.getCriteriaBuilder();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Criteria queries are constructed by obtaining an instance of the
following interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">javax.persistence.criteria.CriteriaQuery</code></pre>
</div>
</div>
<div class="paragraph">
<p><code>CriteriaQuery</code> objects define a particular query that will navigate
over one or more entities. Obtain <code>CriteriaQuery</code> instances by calling
one of the <code>CriteriaBuilder.createQuery</code> methods. To create typesafe
queries, call the <code>CriteriaBuilder.createQuery</code> method as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>CriteriaQuery</code> object&#8217;s type should be set to the expected result
type of the query. In the preceding code, the object&#8217;s type is set to
<code>CriteriaQuery&lt;Pet&gt;</code> for a query that will find instances of the <code>Pet</code>
entity.</p>
</div>
<div class="paragraph">
<p>The following code snippet creates a <code>CriteriaQuery</code> object for a query
that returns a <code>String</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;<span class="predefined-type">String</span>&gt; cq = cb.createQuery(<span class="predefined-type">String</span>.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GJIVQ"></a><a id="query-roots"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="query-roots"><a class="anchor" href="#query-roots"></a>Query Roots</h5>
<div class="paragraph">
<p>For a particular <code>CriteriaQuery</code> object, the root entity of the query,
from which all navigation originates, is called the query root. It is
similar to the <code>FROM</code> clause in a JPQL query.</p>
</div>
<div class="paragraph">
<p>Create the query root by calling the <code>from</code> method on the
<code>CriteriaQuery</code> instance. The argument to the <code>from</code> method is either
the entity class or an <code>EntityType&lt;T&gt;</code> instance for the entity.</p>
</div>
<div class="paragraph">
<p>The following code sets the query root to the <code>Pet</code> entity:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code sets the query root to the <code>Pet</code> class by using an
<code>EntityType&lt;T&gt;</code> instance:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = ...;
Metamodel m = em.getMetamodel();
EntityType&lt;Pet&gt; Pet_ = m.entity(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet_);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Criteria queries may have more than one query root. This usually occurs
when the query navigates from several entities.</p>
</div>
<div class="paragraph">
<p>The following code has two <code>Root</code> instances:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet1 = cq.from(Pet.class);
Root&lt;Pet&gt; pet2 = cq.from(Pet.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GJIUV"></a><a id="querying-relationships-using-joins"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="querying-relationships-using-joins"><a class="anchor" href="#querying-relationships-using-joins"></a>Querying Relationships Using Joins</h5>
<div class="paragraph">
<p>For queries that navigate to related entity classes, the query must
define a join to the related entity by calling one of the <code>From.join</code>
methods on the query root object or another join object. The <code>join</code>
methods are similar to the <code>JOIN</code> keyword in JPQL.</p>
</div>
<div class="paragraph">
<p>The target of the join uses the Metamodel class of type <code>EntityType&lt;T&gt;</code>
to specify the persistent field or property of the joined entity.</p>
</div>
<div class="paragraph">
<p>The <code>join</code> methods return an object of type <code>Join&lt;X, Y&gt;</code>, where <code>X</code> is
the source entity and <code>Y</code> is the target of the join. In the following
code snippet, <code>Pet</code> is the source entity, <code>Owner</code> is the target, and
<code>Pet_</code> is a statically generated metamodel class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);

Root&lt;Pet&gt; pet = cq.from(Pet.class);
Join&lt;Pet, <span class="predefined-type">Owner</span>&gt; owner = pet.join(Pet_.owners);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can chain joins together to navigate to related entities of the
target entity without having to create a <code>Join&lt;X, Y&gt;</code> instance for each
join:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);

Root&lt;Pet&gt; pet = cq.from(Pet.class);
Join&lt;<span class="predefined-type">Owner</span>, Address&gt; address = pet.join(Pet_.owners).join(Owner_.addresses);</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GJIVE"></a><a id="path-navigation-in-criteria-queries"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="path-navigation-in-criteria-queries"><a class="anchor" href="#path-navigation-in-criteria-queries"></a>Path Navigation in Criteria Queries</h5>
<div class="paragraph">
<p><code>Path</code> objects, which are used in the <code>SELECT</code> and <code>WHERE</code> clauses of a
Criteria query, can be query root entities, join entities, or other
<code>Path</code> objects. Use the <code>Path.get</code> method to navigate to attributes of
the entities of a query.</p>
</div>
<div class="paragraph">
<p>The argument to the <code>get</code> method is the corresponding attribute of the
entity&#8217;s Metamodel class. The attribute can be either a single-valued
attribute, specified by <code>@SingularAttribute</code> in the Metamodel class, or
a collection-valued attribute, specified by one of
<code>@CollectionAttribute</code>, <code>@SetAttribute</code>, <code>@ListAttribute</code>, or
<code>@MapAttribute</code>.</p>
</div>
<div class="paragraph">
<p>The following query returns the names of all the pets in the data store.
The <code>get</code> method is called on the query root, <code>pet</code>, with the <code>name</code>
attribute of the <code>Pet</code> entity&#8217;s Metamodel class, <code>Pet_</code>, as the
argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;<span class="predefined-type">String</span>&gt; cq = cb.createQuery(<span class="predefined-type">String</span>.class);

Root&lt;Pet&gt; pet = cq.from(Pet.class);
cq.select(pet.get(Pet_.name));</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GJIVI"></a><a id="restricting-criteria-query-results"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="restricting-criteria-query-results"><a class="anchor" href="#restricting-criteria-query-results"></a>Restricting Criteria Query Results</h5>
<div class="paragraph">
<p>Conditions that are set by calling the <code>CriteriaQuery.where</code> method can
restrict the results of a query on the <code>CriteriaQuery</code> object. Calling
the <code>where</code> method is analogous to setting the <code>WHERE</code> clause in a JPQL
query.</p>
</div>
<div class="paragraph">
<p>The <code>where</code> method evaluates instances of the <code>Expression</code> interface to
restrict the results according to the conditions of the expressions. To
create <code>Expression</code> instances, use methods defined in the <code>Expression</code>
and <code>CriteriaBuilder</code> interfaces.</p>
</div>
<div class="paragraph">
<p><a id="GJIWN"></a><a id="the-expression-interface-methods"></a></p>
</div>
<div class="sect5">
<h6 id="the-expression-interface-methods"><a class="anchor" href="#the-expression-interface-methods"></a>The Expression Interface Methods</h6>
<div class="paragraph">
<p>An <code>Expression</code> object is used in a query&#8217;s <code>SELECT</code>, <code>WHERE</code>, or
<code>HAVING</code> clause. <a href="#GJIWW">Table 43-1</a> shows conditional methods you
can use with <code>Expression</code> objects.</p>
</div>
<div class="paragraph">
<p><a id="sthref180"></a><a id="GJIWW"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 43-1 Conditional Methods in the Expression Interface</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Method</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>isNull</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tests whether an expression is null</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>isNotNull</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tests whether an expression is not null</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>in</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tests whether an expression is within a list of values</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following query uses the <code>Expression.isNull</code> method to find all pets
where the <code>color</code> attribute is null:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
cq.where(pet.get(Pet_.color).isNull());</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following query uses the <code>Expression.in</code> method to find all brown
and black pets:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
cq.where(pet.get(Pet_.color).in(<span class="string"><span class="delimiter">&quot;</span><span class="content">brown</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">black</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>in</code> method can also check whether an attribute is a member of a
collection.</p>
</div>
<div class="paragraph">
<p><a id="GJIXA"></a><a id="expression-methods-in-the-criteriabuilder-interface"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="expression-methods-in-the-criteriabuilder-interface"><a class="anchor" href="#expression-methods-in-the-criteriabuilder-interface"></a>Expression Methods in the CriteriaBuilder Interface</h6>
<div class="paragraph">
<p>The <code>CriteriaBuilder</code> interface defines additional methods for creating
expressions. These methods correspond to the arithmetic, string, date,
time, and case operators and functions of JPQL. <a href="#GJIXL">Table 43-2</a>
shows conditional methods you can use with <code>CriteriaBuilder</code> objects.</p>
</div>
<div class="paragraph">
<p><a id="sthref181"></a><a id="GJIXL"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 43-2 Conditional Methods in the CriteriaBuilder Interface</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 60%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Conditional Method</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>equal</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tests whether two expressions are equal</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>notEqual</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tests whether two expressions are not equal</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>gt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tests whether the first numeric expression is greater than the
second numeric expression</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ge</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tests whether the first numeric expression is greater than or
equal to the second numeric expression</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>lt</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tests whether the first numeric expression is less than the
second numeric expression</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>le</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tests whether the first numeric expression is less than or equal
to the second numeric expression</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>between</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tests whether the first expression is between the second and
third expression in value</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>like</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Tests whether the expression matches a given pattern</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following code uses the <code>CriteriaBuilder.equal</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
cq.where(cb.equal(pet.get(Pet_.name), <span class="string"><span class="delimiter">&quot;</span><span class="content">Fido</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code uses the <code>CriteriaBuilder.gt</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
<span class="predefined-type">Date</span> someDate = <span class="keyword">new</span> <span class="predefined-type">Date</span>(...);
cq.where(cb.gt(pet.get(Pet_.birthday), date));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code uses the <code>CriteriaBuilder.between</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
<span class="predefined-type">Date</span> firstDate = <span class="keyword">new</span> <span class="predefined-type">Date</span>(...);
<span class="predefined-type">Date</span> secondDate = <span class="keyword">new</span> <span class="predefined-type">Date</span>(...);
cq.where(cb.between(pet.get(Pet_.birthday), firstDate, secondDate));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code uses the <code>CriteriaBuilder.like</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
cq.where(cb.like(pet.get(Pet_.name), <span class="string"><span class="delimiter">&quot;</span><span class="content">*do</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>To specify multiple conditional predicates, use the compound predicate
methods of the <code>CriteriaBuilder</code> interface, as shown in
<a href="#GJIWU">Table 43-3</a>.</p>
</div>
<div class="paragraph">
<p><a id="sthref182"></a><a id="GJIWU"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 43-3 Compound Predicate Methods in the CriteriaBuilder Interface</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 50%;">
<colgroup>
<col style="width: 30%;">
<col style="width: 70%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Method</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>and</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A logical conjunction of two Boolean expressions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>or</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A logical disjunction of two Boolean expressions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>not</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A logical negation of the given Boolean expression</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The following code shows the use of compound predicates in queries:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
cq.where(cb.equal(pet.get(Pet_.name), <span class="string"><span class="delimiter">&quot;</span><span class="content">Fido</span><span class="delimiter">&quot;</span></span>)
        .and(cb.equal(pet.get(Pet_.color), <span class="string"><span class="delimiter">&quot;</span><span class="content">brown</span><span class="delimiter">&quot;</span></span>)));</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GJIXE"></a><a id="managing-criteria-query-results"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="managing-criteria-query-results"><a class="anchor" href="#managing-criteria-query-results"></a>Managing Criteria Query Results</h5>
<div class="paragraph">
<p>For queries that return more than one result, it is often helpful to
organize those results. The <code>CriteriaQuery</code> interface defines the
following ordering and grouping methods:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>orderBy</code> method orders query results according to attributes of
an entity</p>
</li>
<li>
<p>The <code>groupBy</code> method groups the results of a query together according
to attributes of an entity, and the <code>having</code> method restricts those
groups according to a condition</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#GJIWO">Ordering Results</a></p>
</li>
<li>
<p><a href="#GJIXG">Grouping Results</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="GJIWO"></a><a id="ordering-results"></a></p>
</div>
<div class="sect5">
<h6 id="ordering-results"><a class="anchor" href="#ordering-results"></a>Ordering Results</h6>
<div class="paragraph">
<p>To order the results of a query, call the <code>CriteriaQuery.orderBy</code>
method, passing in an <code>Order</code> object. To create an <code>Order</code> object, call
either the <code>CriteriaBuilder.asc</code> or the <code>CriteriaBuilder.desc</code> method.
The <code>asc</code> method is used to order the results by ascending value of the
passed expression parameter. The <code>desc</code> method is used to order the
results by descending value of the passed expression parameter. The
following query shows the use of the <code>desc</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
cq.select(pet);
cq.orderBy(cb.desc(pet.get(Pet_.birthday)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this query, the results will be ordered by the pet&#8217;s birthday from
highest to lowest. That is, pets born in December will appear before
pets born in May.</p>
</div>
<div class="paragraph">
<p>The following query shows the use of the <code>asc</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
Join&lt;<span class="predefined-type">Owner</span>, Address&gt; address = pet.join(Pet_.owners).join(Owner_.address);
cq.select(pet);
cq.orderBy(cb.asc(address.get(Address_.postalCode)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this query, the results will be ordered by the pet owner&#8217;s postal
code from lowest to highest. That is, pets whose owner lives in the
10001 zip code will appear before pets whose owner lives in the 91000
zip code.</p>
</div>
<div class="paragraph">
<p>If more than one <code>Order</code> object is passed to <code>orderBy</code>, the precedence
is determined by the order in which they appear in the argument list of
<code>orderBy</code>. The first <code>Order</code> object has precedence.</p>
</div>
<div class="paragraph">
<p>The following code orders results by multiple criteria:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
Join&lt;Pet, <span class="predefined-type">Owner</span>&gt; owner = pet.join(Pet_.owners);
cq.select(pet);
cq.orderBy(cb.asc(owner.get(Owner_.lastName)), owner.get(Owner_.firstName)));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The results of this query will be ordered alphabetically by the pet
owner&#8217;s last name, then first name.</p>
</div>
<div class="paragraph">
<p><a id="GJIXG"></a><a id="grouping-results"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="grouping-results"><a class="anchor" href="#grouping-results"></a>Grouping Results</h6>
<div class="paragraph">
<p>The <code>CriteriaQuery.groupBy</code> method partitions the query results into
groups. To set these groups, pass an expression to <code>groupBy</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
cq.groupBy(pet.get(Pet_.color));</code></pre>
</div>
</div>
<div class="paragraph">
<p>This query returns all <code>Pet</code> entities and groups the results by the
pet&#8217;s color.</p>
</div>
<div class="paragraph">
<p>Use the <code>CriteriaQuery.having</code> method in conjunction with <code>groupBy</code> to
filter over the groups. The <code>having</code> method, which takes a conditional
expression as a parameter, restricts the query result according to the
conditional expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
cq.groupBy(pet.get(Pet_.color));
cq.having(cb.in(pet.get(Pet_.color)).value(<span class="string"><span class="delimiter">&quot;</span><span class="content">brown</span><span class="delimiter">&quot;</span></span>).value(<span class="string"><span class="delimiter">&quot;</span><span class="content">blonde</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the query groups the returned <code>Pet</code> entities by color,
as in the preceding example. However, the only returned groups will be
<code>Pet</code> entities where the <code>color</code> attribute is set to <code>brown</code> or
<code>blonde</code>. That is, no gray-colored pets will be returned in this query.</p>
</div>
<div class="paragraph">
<p><a id="GJIVY"></a><a id="executing-queries"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="executing-queries"><a class="anchor" href="#executing-queries"></a>Executing Queries</h5>
<div class="paragraph">
<p>To prepare a query for execution, create a <code>TypedQuery&lt;T&gt;</code> object with
the type of the query result, passing the <code>CriteriaQuery</code> object to
<code>EntityManager.createQuery</code>.</p>
</div>
<div class="paragraph">
<p>To execute a query, call either <code>getSingleResult</code> or <code>getResultList</code> on
the <code>TypedQuery&lt;T&gt;</code> object.</p>
</div>
<div class="paragraph">
<p><a id="GJIUR"></a><a id="single-valued-query-results"></a></p>
</div>
<div class="sect5">
<h6 id="single-valued-query-results"><a class="anchor" href="#single-valued-query-results"></a>Single-Valued Query Results</h6>
<div class="paragraph">
<p>Use the <code>TypedQuery&lt;T&gt;.getSingleResult</code> method to execute queries that
return a single result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
...
TypedQuery&lt;Pet&gt; q = em.createQuery(cq);
Pet result = q.getSingleResult();</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GJIVP"></a><a id="collection-valued-query-results"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="collection-valued-query-results"><a class="anchor" href="#collection-valued-query-results"></a>Collection-Valued Query Results</h6>
<div class="paragraph">
<p>Use the <code>TypedQuery&lt;T&gt;.getResultList</code> method to execute queries that
return a collection of objects:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
...
TypedQuery&lt;Pet&gt; q = em.createQuery(cq);
<span class="predefined-type">List</span>&lt;Pet&gt; results = q.getResultList();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-and-using-string-based-criteria-queries"><a class="anchor" href="#creating-and-using-string-based-criteria-queries"></a>Creating and Using String-Based Criteria Queries</h3>
<div class="paragraph">
<p><a id="GKJIQ"></a><a id="creating-and-using-string-based-criteria-queries"></a></p>
</div>
<div class="paragraph">
<p>This chapter describes how to create weakly typed string-based Criteria
API queries.</p>
</div>
<div class="paragraph">
<p><a id="GKJIV"></a><a id="overview-of-string-based-criteria-api-queries"></a></p>
</div>
<div class="sect3">
<h4 id="overview-of-string-based-criteria-api-queries"><a class="anchor" href="#overview-of-string-based-criteria-api-queries"></a>Overview of String-Based Criteria API Queries</h4>
<div class="paragraph">
<p>String-based Criteria API queries ("string-based queries") are Java
programming language queries that use strings rather than strongly typed
metamodel objects to specify entity attributes when traversing a data
hierarchy. String-based queries are constructed similarly to metamodel
queries, can be static or dynamic, and can express the same kind of
queries and operations as strongly typed metamodel queries.</p>
</div>
<div class="paragraph">
<p>Strongly typed metamodel queries are the preferred method of
constructing Criteria API queries.</p>
</div>
<div class="paragraph">
<p>The main advantage of string-based queries over metamodel queries is the
ability to construct Criteria queries at development time without the
need to generate static metamodel classes or otherwise access
dynamically generated metamodel classes.</p>
</div>
<div class="paragraph">
<p>The main disadvantage to string-based queries is their lack of type
safety; this problem may lead to runtime errors due to type mismatches
that would be caught at development time if you used strongly typed
metamodel queries.</p>
</div>
<div class="paragraph">
<p>For information on constructing criteria queries, see
<a href="#GJITV">Chapter 43, "Using the Criteria API
to Create Queries"</a>.</p>
</div>
<div class="paragraph">
<p><a id="GKJBQ"></a><a id="creating-string-based-queries"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="creating-string-based-queries"><a class="anchor" href="#creating-string-based-queries"></a>Creating String-Based Queries</h4>
<div class="paragraph">
<p>To create a string-based query, specify the attribute names of entity
classes directly as strings, instead of specifying the attributes of the
metamodel class. For example, this query finds all <code>Pet</code> entities where
the value of the <code>name</code> attribute is <code>Fido</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
cq.where(cb.equal(pet.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">Fido</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>The name of the attribute is specified as a string. This query is the
equivalent of the following metamodel query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Metamodel m = em.getMetamodel();
EntityType&lt;Pet&gt; Pet_ = m.entity(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
cq.where(cb.equal(pet.get(Pet_.name), <span class="string"><span class="delimiter">&quot;</span><span class="content">Fido</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Note:</p>
</div>
<div class="paragraph">
<p>Type mismatch errors in string-based queries will not appear until the
code is executed at runtime, unlike in the above metamodel query, where
type mismatches will be caught at compile time.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Joins are specified in the same way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
Join&lt;<span class="predefined-type">Owner</span>, Address&gt; address = pet.join(<span class="string"><span class="delimiter">&quot;</span><span class="content">owners</span><span class="delimiter">&quot;</span></span>).join(<span class="string"><span class="delimiter">&quot;</span><span class="content">addresses</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>All the conditional expressions, method expressions, path navigation
methods, and result restriction methods used in metamodel queries can
also be used in string-based queries. In each case, the attributes are
specified using strings. For example, here is a string-based query that
uses the <code>in</code> expression:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
cq.where(pet.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">color</span><span class="delimiter">&quot;</span></span>).in(<span class="string"><span class="delimiter">&quot;</span><span class="content">brown</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">black</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p>Here is a string-based query that orders the results in descending order
by date:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
cq.select(pet);
cq.orderBy(cb.desc(pet.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">birthday</span><span class="delimiter">&quot;</span></span>)));</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GKJDB"></a><a id="executing-string-based-queries"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="executing-string-based-queries"><a class="anchor" href="#executing-string-based-queries"></a>Executing String-Based Queries</h4>
<div class="paragraph">
<p>String-based queries are executed similarly to strongly typed Criteria
queries. First create a <code>javax.persistence.TypedQuery</code> object by passing
the criteria query object to the <code>EntityManager.createQuery</code> method,
then call either <code>getSingleResult</code> or <code>getResultList</code> on the query
object to execute the query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CriteriaQuery&lt;Pet&gt; cq = cb.createQuery(Pet.class);
Root&lt;Pet&gt; pet = cq.from(Pet.class);
cq.where(cb.equal(pet.get(<span class="string"><span class="delimiter">&quot;</span><span class="content">name</span><span class="delimiter">&quot;</span></span>), <span class="string"><span class="delimiter">&quot;</span><span class="content">Fido</span><span class="delimiter">&quot;</span></span>));
TypedQuery&lt;Pet&gt; q = em.createQuery(cq);
<span class="predefined-type">List</span>&lt;Pet&gt; results = q.getResultList();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="controlling-concurrent-access-to-entity-data-with-locking"><a class="anchor" href="#controlling-concurrent-access-to-entity-data-with-locking"></a>Controlling Concurrent Access to Entity Data with Locking</h3>
<div class="paragraph">
<p><a id="GKJJF"></a><a id="controlling-concurrent-access-to-entity-data-with-locking"></a></p>
</div>
<div class="paragraph">
<p>This chapter details how to handle concurrent access to entity data, and
the locking strategies available to Jakarta Persistence application
developers.</p>
</div>
<div class="paragraph">
<p><a id="GKJHZ"></a><a id="overview-of-entity-locking-and-concurrency"></a></p>
</div>
<div class="sect3">
<h4 id="overview-of-entity-locking-and-concurrency"><a class="anchor" href="#overview-of-entity-locking-and-concurrency"></a>Overview of Entity Locking and Concurrency</h4>
<div class="paragraph">
<p>Entity data is concurrently accessed if the data in a data source is
accessed at the same time by multiple applications. Ensure that the
underlying data&#8217;s integrity is preserved when it is accessed
concurrently.</p>
</div>
<div class="paragraph">
<p>When data is updated in the database tables in a transaction, the
persistence provider assumes the database management system will hold
short-term read locks and long-term write locks to maintain data
integrity. Most persistence providers will delay database writes until
the end of the transaction, except when the application explicitly calls
for a flush (that is, the application calls the <code>EntityManager.flush</code>
method or executes queries with the flush mode set to <code>AUTO</code>).</p>
</div>
<div class="paragraph">
<p>By default, persistence providers use optimistic locking, where, before
committing changes to the data, the persistence provider checks that no
other transaction has modified or deleted the data since the data was
read. This is accomplished by a version column in the database table,
with a corresponding version attribute in the entity class. When a row
is modified, the version value is incremented. The original transaction
checks the version attribute, and if the data has been modified by
another transaction, a <code>javax.persistence.OptimisticLockException</code> will
be thrown, and the original transaction will be rolled back. When the
application specifies optimistic lock modes, the persistence provider
verifies that a particular entity has not changed since it was read from
the database even if the entity data was not modified.</p>
</div>
<div class="paragraph">
<p>Pessimistic locking goes further than optimistic locking. With
pessimistic locking, the persistence provider creates a transaction that
obtains a long-term lock on the data until the transaction is completed,
which prevents other transactions from modifying or deleting the data
until the lock has ended. Pessimistic locking is a better strategy than
optimistic locking when the underlying data is frequently accessed and
modified by many transactions.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Note:</p>
</div>
<div class="paragraph">
<p>Using pessimistic locks on entities that are not subject to frequent
modification may result in decreased application performance.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="GKJJC"></a><a id="using-optimistic-locking"></a></p>
</div>
<div class="sect4">
<h5 id="using-optimistic-locking"><a class="anchor" href="#using-optimistic-locking"></a>Using Optimistic Locking</h5>
<div class="paragraph">
<p>Use the <code>javax.persistence.Version</code> annotation to mark a persistent
field or property as a version attribute of an entity. The version
attribute enables the entity for optimistic concurrency control. The
persistence provider reads and updates the version attribute when an
entity instance is modified during a transaction. The application may
read the version attribute, but must not modify the value.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Note:</p>
</div>
<div class="paragraph">
<p>Although some persistence providers may support optimistic locking for
entities that do not have version attributes, portable applications
should always use entities with version attributes when using optimistic
locking. If the application attempts to lock an entity that does not
have a version attribute, and the persistence provider does not support
optimistic locking for non-versioned entities, a <code>PersistenceException</code>
will be thrown.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>@Version</code> annotation has the following requirements.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Only a single <code>@Version</code> attribute may be defined per entity.</p>
</li>
<li>
<p>The <code>@Version</code> attribute must be in the primary table for an entity
mapped to multiple tables.</p>
</li>
<li>
<p>The type of the <code>@Version</code> attribute must be one of the following:
<code>int</code>, <code>Integer</code>, <code>long</code>, <code>Long</code>, <code>short</code>, <code>Short</code>, or
<code>java.sql.Timestamp</code>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The following code snippet shows how to define a version attribute in an
entity with persistent fields:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Version</span>
<span class="directive">protected</span> <span class="type">int</span> version;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code snippet shows how to define a version attribute in an
entity with persistent properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Version</span>
<span class="directive">protected</span> <span class="predefined-type">Short</span> getVersion() { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GKJIU"></a><a id="lock-modes"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="lock-modes"><a class="anchor" href="#lock-modes"></a>Lock Modes</h4>
<div class="paragraph">
<p>The application may increase the level of locking for an entity by
specifying the use of lock modes. Lock modes may be specified to
increase the level of optimistic locking or to request the use of
pessimistic locks.</p>
</div>
<div class="paragraph">
<p>The use of optimistic lock modes causes the persistence provider to
check the version attributes for entities that were read (but not
modified) during a transaction as well as for entities that were
updated.</p>
</div>
<div class="paragraph">
<p>The use of pessimistic lock modes specifies that the persistence
provider is to immediately acquire long-term read or write locks for the
database data corresponding to entity state.</p>
</div>
<div class="paragraph">
<p>You can set the lock mode for an entity operation by specifying one of
the lock modes defined in the <code>javax.persistence.LockModeType</code>
enumerated type, listed in <a href="#GKJIE">Table 45-1</a>.</p>
</div>
<div class="paragraph">
<p><a id="sthref183"></a><a id="GKJIE"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 45-1 Lock Modes for Concurrent Entity Access</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 75%;">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 66.6667%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Lock Mode</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OPTIMISTIC</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtain an optimistic read lock for all entities with
version attributes.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>OPTIMISTIC_FORCE_INCREMENT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Obtain an optimistic read lock for all
entities with version attributes, and increment the version attribute
value.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PESSIMISTIC_READ</code></p></td>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Immediately obtain a long-term read lock on the data to prevent the data
from being modified or deleted. Other transactions may read the data
while the lock is maintained, but may not modify or delete the data.</p>
</div>
<div class="paragraph">
<p>The persistence provider is permitted to obtain a database write lock
when a read lock was requested, but not vice versa.</p>
</div></div></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PESSIMISTIC_WRITE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immediately obtain a long-term write lock on the
data to prevent the data from being read, modified, or deleted.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>PESSIMISTIC_FORCE_INCREMENT</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Immediately obtain a long-term lock on
the data to prevent the data from being modified or deleted, and
increment the version attribute of versioned entities.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>READ</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A synonym for <code>OPTIMISTIC</code>. Use of <code>LockModeType.OPTIMISTIC</code> is
to be preferred for new applications.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>WRITE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A synonym for <code>OPTIMISTIC_FORCE_INCREMENT</code>. Use of
<code>LockModeType.OPTIMISTIC_FORCE_INCREMENT</code> is to be preferred for new
applications.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NONE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No additional locking will occur on the data in the database.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="GKJIK"></a><a id="setting-the-lock-mode"></a></p>
</div>
<div class="sect4">
<h5 id="setting-the-lock-mode"><a class="anchor" href="#setting-the-lock-mode"></a>Setting the Lock Mode</h5>
<div class="paragraph">
<p>To specify the lock mode, use one of the following techniques:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Call the <code>EntityManager.lock</code> method, passing in one of the lock
modes:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = ...;
Person person = ...;
em.lock(person, LockModeType.OPTIMISTIC);</code></pre>
</div>
</div>
</li>
<li>
<p>Call one of the <code>EntityManager.find</code> methods that take the lock mode
as a parameter:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = ...;
<span class="predefined-type">String</span> personPK = ...;
Person person = em.find(Person.class, personPK,
    LockModeType.PESSIMISTIC_WRITE);</code></pre>
</div>
</div>
</li>
<li>
<p>Call one of the <code>EntityManager.refresh</code> methods that take the lock
mode as a parameter:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = ...;
<span class="predefined-type">String</span> personPK = ...;
Person person = em.find(Person.class, personPK);
...
em.refresh(person, LockModeType.OPTIMISTIC_FORCE_INCREMENT);</code></pre>
</div>
</div>
</li>
<li>
<p>Call the <code>Query.setLockMode</code> or <code>TypedQuery.setLockMode</code> method,
passing the lock mode as the parameter:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Query</span> q = em.createQuery(...);
q.setLockMode(LockModeType.PESSIMISTIC_FORCE_INCREMENT);</code></pre>
</div>
</div>
</li>
<li>
<p>Add a <code>lockMode</code> element to the <code>@NamedQuery</code> annotation:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@NamedQuery</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">lockPersonQuery</span><span class="delimiter">&quot;</span></span>,
  query=<span class="string"><span class="delimiter">&quot;</span><span class="content">SELECT p FROM Person p WHERE p.name LIKE :name</span><span class="delimiter">&quot;</span></span>,
  lockMode=PESSIMISTIC_READ)</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="GKJIL"></a><a id="using-pessimistic-locking"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="using-pessimistic-locking"><a class="anchor" href="#using-pessimistic-locking"></a>Using Pessimistic Locking</h5>
<div class="paragraph">
<p>Versioned entities, as well as entities that do not have version
attributes, can be locked pessimistically.</p>
</div>
<div class="paragraph">
<p>To lock entities pessimistically, set the lock mode to
<code>PESSIMISTIC_READ</code>, <code>PESSIMISTIC_WRITE</code>, or
<code>PESSIMISTIC_FORCE_INCREMENT</code>.</p>
</div>
<div class="paragraph">
<p>If a pessimistic lock cannot be obtained on the database rows, and the
failure to lock the data results in a transaction rollback, a
<code>PessimisticLockException</code> is thrown. If a pessimistic lock cannot be
obtained, but the locking failure doesn&#8217;t result in a transaction
rollback, a <code>LockTimeoutException</code> is thrown.</p>
</div>
<div class="paragraph">
<p>Pessimistically locking a versioned entity with
<code>PESSIMISTIC_FORCE_INCREMENT</code> results in the version attribute being
incremented even if the entity data is unmodified. When pessimistically
locking a versioned entity, the persistence provider will perform the
version checks that occur during optimistic locking, and if the version
check fails, an <code>OptimisticLockException</code> will be thrown. An attempt to
lock a non-versioned entity with <code>PESSIMISTIC_FORCE_INCREMENT</code> is not
portable and may result in a <code>PersistenceException</code> if the persistence
provider does not support optimistic locks for non-versioned entities.
Locking a versioned entity with <code>PESSIMISTIC_WRITE</code> results in the
version attribute being incremented if the transaction was successfully
committed.</p>
</div>
<div class="paragraph">
<p><a id="GKJLQ"></a><a id="pessimistic-locking-timeouts"></a></p>
</div>
<div class="sect5">
<h6 id="pessimistic-locking-timeouts"><a class="anchor" href="#pessimistic-locking-timeouts"></a>Pessimistic Locking Timeouts</h6>
<div class="paragraph">
<p>Use the <code>javax.persistence.lock.timeout</code> property to specify the length
of time in milliseconds the persistence provider should wait to obtain a
lock on the database tables. If the time it takes to obtain a lock
exceeds the value of this property, a <code>LockTimeoutException</code> will be
thrown, but the current transaction will not be marked for rollback. If
you set this property to <code>0</code>, the persistence provider should throw a
<code>LockTimeoutException</code> if it cannot immediately obtain a lock.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Note:</p>
</div>
<div class="paragraph">
<p>Portable applications should not rely on the setting of
<code>javax.persistence.lock.timeout</code>, because the locking strategy and
underlying database may mean that the timeout value cannot be used. The
value of <code>javax.persistence.lock.timeout</code> is a hint, not a contract.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>This property may be set programmatically by passing it to the
<code>EntityManager</code> methods that allow lock modes to be specified, the
<code>Query.setLockMode</code> and <code>TypedQuery.setLockMode</code> methods, the
<code>@NamedQuery</code> annotation, and the
<code>Persistence.createEntityManagerFactory</code> method. It may also be set as a
property in the <code>persistence.xml</code> deployment descriptor.</p>
</div>
<div class="paragraph">
<p>If <code>javax.persistence.lock.timeout</code> is set in multiple places, the value
will be determined in the following order:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The argument to one of the <code>EntityManager</code> or <code>Query</code> methods</p>
</li>
<li>
<p>The setting in the <code>@NamedQuery</code> annotation</p>
</li>
<li>
<p>The argument to the <code>Persistence.createEntityManagerFactory</code> method</p>
</li>
<li>
<p>The value in the <code>persistence.xml</code> deployment descriptor</p>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="creating-fetch-plans-with-entity-graphs"><a class="anchor" href="#creating-fetch-plans-with-entity-graphs"></a>Creating Fetch Plans with Entity Graphs</h3>
<div class="paragraph">
<p><a id="BABIJIAC"></a><a id="creating-fetch-plans-with-entity-graphs"></a></p>
</div>
<div class="paragraph">
<p>This chapter explains how to use entity graphs to create fetch plans for
Jakarta Persistence operations and queries.</p>
</div>
<div class="paragraph">
<p><a id="A1153411"></a><a id="overview-of-using-fetch-plans-and-entity-graphs"></a></p>
</div>
<div class="sect3">
<h4 id="overview-of-using-fetch-plans-and-entity-graphs"><a class="anchor" href="#overview-of-using-fetch-plans-and-entity-graphs"></a>Overview of Using Fetch Plans and Entity Graphs</h4>
<div class="paragraph">
<p>Entity graphs are templates for a particular Persistence query or
operation. They are used when creating fetch plans, or groups of
persistent fields that are retrieved at the same time. Application
developers use fetch plans to group together related persistent fields
to improve runtime performance.</p>
</div>
<div class="paragraph">
<p>By default, entity fields or properties are fetched lazily. Developers
specify fields or properties as part of a fetch plan, and the
persistence provider will fetch them eagerly.</p>
</div>
<div class="paragraph">
<p>For example, an email application that stores messages as <code>EmailMessage</code>
entities prioritizes fetching some fields over others. The sender,
subject, and date will be viewed the most often, in mailbox views and
when the message is displayed. The <code>EmailMessage</code> entity has a
collection of related <code>EmailAttachment</code> entities. For performance
reasons the attachments should not be fetched until they are needed, but
the file names of the attachment are important. A developer working on
this application might make a fetch plan that eagerly fetches the
important fields from <code>EmailMessage</code> and <code>EmailAttachment</code> while
fetching the lower priority data lazily.</p>
</div>
<div class="paragraph">
<p><a id="BABCJBCG"></a><a id="entity-graph-basics"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="entity-graph-basics"><a class="anchor" href="#entity-graph-basics"></a>Entity Graph Basics</h4>
<div class="paragraph">
<p>You can create entity graphs statically by using annotations or a
deployment descriptor, or dynamically by using standard interfaces.</p>
</div>
<div class="paragraph">
<p>You can use an entity graph with the <code>EntityManager.find</code> method or as
part of a JPQL or Criteria API query by specifying the entity graph as a
hint to the operation or query.</p>
</div>
<div class="paragraph">
<p>Entity graphs have attributes that correspond to the fields that will be
eagerly fetched during a <code>find</code> or query operation. The primary key and
version fields of the entity class are always fetched and do not need to
be explicitly added to an entity graph.</p>
</div>
<div class="paragraph">
<p><a id="sthref184"></a><a id="the-default-entity-graph"></a></p>
</div>
<div class="sect4">
<h5 id="the-default-entity-graph"><a class="anchor" href="#the-default-entity-graph"></a>The Default Entity Graph</h5>
<div class="paragraph">
<p>By default, all fields in an entity are fetched lazily unless the
<code>fetch</code> attribute of the entity metadata is set to
<code>javax.persistence.FetchType.EAGER</code>. The default entity graph consists
of all the fields of an entity whose fields are set to be eagerly
fetched.</p>
</div>
<div class="paragraph">
<p>For example, the following <code>EmailMessage</code> entity specifies that some
fields will be fetched eagerly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">EmailMessage</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {
    <span class="annotation">@Id</span>
    <span class="predefined-type">String</span> messageId;
    <span class="annotation">@Basic</span>(fetch=EAGER)
    <span class="predefined-type">String</span> subject;
    <span class="predefined-type">String</span> body;
    <span class="annotation">@Basic</span>(fetch=EAGER)
    <span class="predefined-type">String</span> sender;
    <span class="annotation">@OneToMany</span>(mappedBy=<span class="string"><span class="delimiter">&quot;</span><span class="content">message</span><span class="delimiter">&quot;</span></span>, fetch=LAZY)
    <span class="predefined-type">Set</span>&lt;EmailAttachment&gt; attachments;
    ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The default entity graph for this entity would contain the <code>messageId</code>,
<code>subject</code>, and <code>sender</code> fields, but not the <code>body</code> or <code>attachments</code>
fields.</p>
</div>
<div class="paragraph">
<p><a id="sthref185"></a><a id="using-entity-graphs-in-persistence-operations"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="using-entity-graphs-in-persistence-operations"><a class="anchor" href="#using-entity-graphs-in-persistence-operations"></a>Using Entity Graphs in Persistence Operations</h5>
<div class="paragraph">
<p>Entity graphs are used by creating an instance of the
<code>javax.persistence.EntityGraph</code> interface by calling either
<code>EntityManager.getEntityGraph</code> for named entity graphs or
<code>EntityManager.createEntityGraph</code> for creating dynamic entity graphs.</p>
</div>
<div class="paragraph">
<p>A named entity graph is an entity graph specified by the
<code>@NamedEntityGraph</code> annotation applied to entity classes, or the
<code>named-entity-graph</code> element in the application&#8217;s deployment
descriptors. Named entity graphs defined within the deployment
descriptor override any annotation-based entity graphs with the same
name.</p>
</div>
<div class="paragraph">
<p>The created entity graph can be either a fetch graph or a load graph.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#BABGEFCG">Fetch Graphs</a></p>
</li>
<li>
<p><a href="#BABHJBHG">Load Graphs</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BABGEFCG"></a><a id="fetch-graphs"></a></p>
</div>
<div class="sect5">
<h6 id="fetch-graphs"><a class="anchor" href="#fetch-graphs"></a>Fetch Graphs</h6>
<div class="paragraph">
<p>To specify a fetch graph, set the <code>javax.persistence.fetchgraph</code>
property when you execute an <code>EntityManager.find</code> or query operation. A
fetch graph consists of only the fields explicitly specified in the
<code>EntityGraph</code> instance, and ignores the default entity graph settings.</p>
</div>
<div class="paragraph">
<p>In the following example, the default entity graph is ignored, and only
the <code>body</code> field is included in the dynamically created fetch graph:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityGraph&lt;EmailMessage&gt; eg = em.createEntityGraph(EmailMessage.class);
eg.addAttributeNodes(<span class="string"><span class="delimiter">&quot;</span><span class="content">body</span><span class="delimiter">&quot;</span></span>);
...
Properties props = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.fetchgraph</span><span class="delimiter">&quot;</span></span>, eg);
EmailMessage message = em.find(EmailMessage.class, id, props);</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BABHJBHG"></a><a id="load-graphs"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="load-graphs"><a class="anchor" href="#load-graphs"></a>Load Graphs</h6>
<div class="paragraph">
<p>To specify a load graph, set the <code>javax.persistence.loadgraph</code> property
when you execute an <code>EntityManager.find</code> or query operation. A load
graph consists of the fields explicitly specified in the <code>EntityGraph</code>
instance plus any fields in the default entity graph.</p>
</div>
<div class="paragraph">
<p>In the following example, the dynamically created load graph contains
all the fields in the default entity graph plus the <code>body</code> field:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityGraph&lt;EmailMessage&gt; eg = em.createEntityGraph(EmailMessage.class);
eg.addAttributeNodes(<span class="string"><span class="delimiter">&quot;</span><span class="content">body</span><span class="delimiter">&quot;</span></span>);
...
Properties props = <span class="keyword">new</span> <span class="predefined-type">Properties</span>();
props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.loadgraph</span><span class="delimiter">&quot;</span></span>, eg);
EmailMessage message = em.find(EmailMessage.class, id, props);</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BABFIGEI"></a><a id="using-named-entity-graphs"></a></p>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="using-named-entity-graphs"><a class="anchor" href="#using-named-entity-graphs"></a>Using Named Entity Graphs</h4>
<div class="paragraph">
<p>Named entity graphs are created using annotations applied to entity
classes or the <code>named-entity-graph</code> element and its sub-elements in the
application&#8217;s deployment descriptor. The persistence provider will scan
for all named entity graphs, defined in both annotations and in XML,
within an application. A named entity graph set using an annotation may
be overridden using <code>named-entity-graph</code>.</p>
</div>
<div class="paragraph">
<p><a id="sthref186"></a><a id="applying-named-entity-graph-annotations-to-entity-classes"></a></p>
</div>
<div class="sect4">
<h5 id="applying-named-entity-graph-annotations-to-entity-classes"><a class="anchor" href="#applying-named-entity-graph-annotations-to-entity-classes"></a>Applying Named Entity Graph Annotations to Entity Classes</h5>
<div class="paragraph">
<p>The <code>javax.persistence.NamedEntityGraph</code> annotation defines a single
named entity graph and is applied at the class level. Multiple
<code>@NamedEntityGraph</code> annotations may be defined for a class by adding
them within a <code>javax.persistence.NamedEntityGraphs</code> class-level
annotation.</p>
</div>
<div class="paragraph">
<p>The <code>@NamedEntityGraph</code> annotation must be applied on the root of the
graph of entities. That is, if the <code>EntityManager.find</code> or query
operation has as its root entity the <code>EmailMessage</code> class, the named
entity graph used in the operation must be defined in the <code>EmailMessage</code>
class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@NamedEntityGraph</span>
<span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">EmailMessage</span> {
    <span class="annotation">@Id</span>
    <span class="predefined-type">String</span> messageId;
    <span class="predefined-type">String</span> subject;
    <span class="predefined-type">String</span> body;
    <span class="predefined-type">String</span> sender;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <code>EmailMessage</code> class has a <code>@NamedEntityGraph</code>
annotation to define a named entity graph that defaults to the name of
the class, <code>EmailMessage</code>. No fields are included in the
<code>@NamedEntityGraph</code> annotation as attribute nodes, and the fields are
not annotated with metadata to set the fetch type, so the only field
that will be eagerly fetched in either a load graph or fetch graph is
<code>messageId</code>.</p>
</div>
<div class="paragraph">
<p>The attributes of a named entity graph are the fields of the entity that
should be included in the entity graph. Add the fields to the entity
graph by specifying them in the <code>attributeNodes</code> element of
<code>@NamedEntityGraph</code> with a <code>javax.persistence.NamedAttributeNode</code>
annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@NamedEntityGraph</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">emailEntityGraph</span><span class="delimiter">&quot;</span></span>, attributeNodes={
    <span class="annotation">@NamedAttributeNode</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">subject</span><span class="delimiter">&quot;</span></span>),
    <span class="annotation">@NamedAttributeNode</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">sender</span><span class="delimiter">&quot;</span></span>)
})
<span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">EmailMessage</span> { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the name of the named entity graph is
<code>emailEntityGraph</code> and includes the <code>subject</code> and <code>sender</code> fields.</p>
</div>
<div class="paragraph">
<p>Multiple <code>@NamedEntityGraph</code> definitions may be applied to a class by
grouping them within a <code>@NamedEntityGraphs</code> annotation.</p>
</div>
<div class="paragraph">
<p>In the following example, two entity graphs are defined on the
<code>EmailMessage</code> class. One is for a preview pane, which fetches only the
sender, subject, and body of the message. The other is for a full view
of the message, including any message attachments:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@NamedEntityGraphs</span>({
    <span class="annotation">@NamedEntityGraph</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">previewEmailEntityGraph</span><span class="delimiter">&quot;</span></span>, attributeNodes={
        <span class="annotation">@NamedAttributeNode</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">subject</span><span class="delimiter">&quot;</span></span>),
        <span class="annotation">@NamedAttributeNode</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">sender</span><span class="delimiter">&quot;</span></span>),
        <span class="annotation">@NamedAttributeNode</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">body</span><span class="delimiter">&quot;</span></span>)
    }),
    <span class="annotation">@NamedEntityGraph</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">fullEmailEntityGraph</span><span class="delimiter">&quot;</span></span>, attributeNodes={
        <span class="annotation">@NamedAttributeNode</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">sender</span><span class="delimiter">&quot;</span></span>),
        <span class="annotation">@NamedAttributeNode</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">subject</span><span class="delimiter">&quot;</span></span>),
        <span class="annotation">@NamedAttributeNode</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">body</span><span class="delimiter">&quot;</span></span>),
        <span class="annotation">@NamedAttributeNode</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">attachments</span><span class="delimiter">&quot;</span></span>)
    })
})
<span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">EmailMessage</span> { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="sthref187"></a><a id="obtaining-entitygraph-instances-from-named-entity-graphs"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="obtaining-entitygraph-instances-from-named-entity-graphs"><a class="anchor" href="#obtaining-entitygraph-instances-from-named-entity-graphs"></a>Obtaining EntityGraph Instances from Named Entity Graphs</h5>
<div class="paragraph">
<p>Use the <code>EntityManager.getEntityGraph</code> method, passing in the named
entity graph name, to obtain <code>EntityGraph</code> instances for a named entity
graph:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityGraph&lt;EmailMessage&gt; eg = em.getEntityGraph(<span class="string"><span class="delimiter">&quot;</span><span class="content">emailEntityGraph</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BABGJDAJ"></a><a id="using-entity-graphs-in-query-operations"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="using-entity-graphs-in-query-operations"><a class="anchor" href="#using-entity-graphs-in-query-operations"></a>Using Entity Graphs in Query Operations</h4>
<div class="paragraph">
<p>To specify entity graphs for both typed and untyped queries, call the
<code>setHint</code> method on the query object and specify either
<code>javax.persistence.loadgraph</code> or <code>javax.persistence.fetchgraph</code> as the
property name and an <code>EntityGraph</code> instance as the value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityGraph&lt;EmailMessage&gt; eg = em.getEntityGraph(<span class="string"><span class="delimiter">&quot;</span><span class="content">previewEmailEntityGraph</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">List</span>&lt;EmailMessage&gt; messages = em.createNamedQuery(<span class="string"><span class="delimiter">&quot;</span><span class="content">findAllEmailMessages</span><span class="delimiter">&quot;</span></span>)
        .setParameter(<span class="string"><span class="delimiter">&quot;</span><span class="content">mailbox</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">inbox</span><span class="delimiter">&quot;</span></span>)
        .setHint(<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.loadgraph</span><span class="delimiter">&quot;</span></span>, eg)
        .getResultList();</code></pre>
</div>
</div>
<div class="paragraph">
<p>In this example, the <code>previewEmailEntityGraph</code> is used for the
<code>findAllEmailMessages</code> named query.</p>
</div>
<div class="paragraph">
<p>Typed queries use the same technique:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityGraph&lt;EmailMessage&gt; eg = em.getEntityGraph(<span class="string"><span class="delimiter">&quot;</span><span class="content">previewEmailEntityGraph</span><span class="delimiter">&quot;</span></span>);

CriteriaQuery&lt;EmailMessage&gt; cq = cb.createQuery(EmailMessage.class);
Root&lt;EmailMessage&gt; message = cq.from(EmailMessage.class);
TypedQuery&lt;EmailMessage&gt; q = em.createQuery(cq);
q.setHint(<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.loadgraph</span><span class="delimiter">&quot;</span></span>, eg);
<span class="predefined-type">List</span>&lt;EmailMessage&gt; messages = q.getResultList();</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="using-a-second-level-cache-with-jakarta-persistence-applications"><a class="anchor" href="#using-a-second-level-cache-with-jakarta-persistence-applications"></a>Using a Second-Level Cache with Jakarta Persistence Applications</h3>
<div class="paragraph">
<p><a id="GKJIA"></a><a id="using-a-second-level-cache-with-java-persistence-api-applications"></a></p>
</div>
<div class="paragraph">
<p>This chapter explains how to modify the second-level cache mode settings
to improve the performance of applications that use the Jakarta Persistence
API.</p>
</div>
<div class="paragraph">
<p><a id="GKJIO"></a><a id="overview-of-the-second-level-cache"></a></p>
</div>
<div class="sect3">
<h4 id="overview-of-the-second-level-cache"><a class="anchor" href="#overview-of-the-second-level-cache"></a>Overview of the Second-Level Cache</h4>
<div class="paragraph">
<p>A second-level cache is a local store of entity data managed by the
persistence provider to improve application performance. A second-level
cache helps improve performance by avoiding expensive database calls,
keeping the entity data local to the application. A second-level cache
is typically transparent to the application, as it is managed by the
persistence provider and underlies the persistence context of an
application. That is, the application reads and commits data through the
normal entity manager operations without knowing about the cache.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Note</strong>:</p>
</div>
<div class="paragraph">
<p>Persistence providers are not required to support a second-level cache.
Portable applications should not rely on support by persistence
providers for a second-level cache.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The second-level cache for a persistence unit may be configured to one
of several second-level cache modes. The following cache mode settings
are defined by Jakarta Persistence.</p>
</div>
<div class="paragraph">
<p><a id="sthref188"></a><a id="GKJDG"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 47-1 Cache Mode Settings for the Second-Level Cache</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Cache Mode Setting</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ALL</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">All entity data is stored in the second-level cache for this
persistence unit.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>NONE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No data is cached in the persistence unit. The persistence
provider must not cache any data.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ENABLE_SELECTIVE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable caching for entities that have been
explicitly set with the <code>@Cacheable</code> annotation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>DISABLE_SELECTIVE</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Enable caching for all entities except those that
have been explicitly set with the <code>@Cacheable(false)</code> annotation.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>UNSPECIFIED</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The caching behavior for the persistence unit is
undefined. The persistence provider&#8217;s default caching behavior will be
used.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>One consequence of using a second-level cache in an application is that
the underlying data may have changed in the database tables, while the
value in the cache has not, a circumstance called a stale read. To avoid
stale reads, use any of these strategies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Change the second-level cache to one of the cache mode settings</p>
</li>
<li>
<p>Control which entities may be cached (see <a href="#GKJIW">Controlling
whether Entities May Be Cached</a>)</p>
</li>
<li>
<p>Change the cache&#8217;s retrieval or store modes (see
<a href="#GKJDK">Setting the Cache Retrieval and
Store Modes</a>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Which of these strategies works best to avoid stale reads depends upon
the application.</p>
</div>
<div class="paragraph">
<p><a id="GKJIW"></a><a id="controlling-whether-entities-may-be-cached"></a></p>
</div>
<div class="sect4">
<h5 id="controlling-whether-entities-may-be-cached"><a class="anchor" href="#controlling-whether-entities-may-be-cached"></a>Controlling whether Entities May Be Cached</h5>
<div class="paragraph">
<p>The <code>javax.persistence.Cacheable</code> annotation is used to specify that an
entity class, and any subclasses, may be cached when using the
<code>ENABLE_SELECTIVE</code> or <code>DISABLE_SELECTIVE</code> cache modes. Subclasses may
override the <code>@Cacheable</code> setting by adding a <code>@Cacheable</code> annotation
and changing the value.</p>
</div>
<div class="paragraph">
<p>To specify that an entity may be cached, add a <code>@Cacheable</code> annotation
at the class level:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Cacheable</span>
<span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Person</span> { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>By default, the <code>@Cacheable</code> annotation is <code>true</code>. The following example
is equivalent:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Cacheable</span>(<span class="predefined-constant">true</span>)
<span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">Person</span>{ ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>To specify that an entity must not be cached, add a <code>@Cacheable</code>
annotation and set it to <code>false</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Cacheable</span>(<span class="predefined-constant">false</span>)
<span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">OrderStatus</span> { ... }</code></pre>
</div>
</div>
<div class="paragraph">
<p>When the <code>ENABLE_SELECTIVE</code> cache mode is set, the persistence provider
will cache any entities that have the <code>@Cacheable(true)</code> annotation and
any subclasses of that entity that have not been overridden. The
persistence provider will not cache entities that have
<code>@Cacheable(false)</code> or have no <code>@Cacheable</code> annotation. That is, the
<code>ENABLE_SELECTIVE</code> mode will cache only entities that have been
explicitly marked for the cache using the <code>@Cacheable</code> annotation.</p>
</div>
<div class="paragraph">
<p>When the <code>DISABLE_SELECTIVE</code> cache mode is set, the persistence provider
will cache any entities that do not have the <code>@Cacheable(false)</code>
annotation. Entities that do not have <code>@Cacheable</code> annotations, and
entities with the <code>@Cacheable(true)</code> annotation, will be cached. That
is, the <code>DISABLE_SELECTIVE</code> mode will cache all entities that have not
been explicitly prevented from being cached.</p>
</div>
<div class="paragraph">
<p>If the cache mode is set to <code>UNDEFINED</code>, or is left unset, the behavior
of entities annotated with <code>@Cacheable</code> is undefined. If the cache mode
is set to <code>ALL</code> or <code>NONE</code>, the value of the <code>@Cacheable</code> annotation is
ignored by the persistence provider.</p>
</div>
<div class="paragraph">
<p><a id="GKJJJ"></a><a id="specifying-the-cache-mode-settings-to-improve-performance"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="specifying-the-cache-mode-settings-to-improve-performance"><a class="anchor" href="#specifying-the-cache-mode-settings-to-improve-performance"></a>Specifying the Cache Mode Settings to Improve Performance</h4>
<div class="paragraph">
<p>To adjust the cache mode settings for a persistence unit, specify one of
the cache modes as the value of the <code>shared-cache-mode</code> element in the
<code>persistence.xml</code> deployment descriptor (shown in bold):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="tag">&lt;persistence-unit</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">examplePU</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transaction-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">JTA</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;provider&gt;</span>org.eclipse.persistence.jpa.PersistenceProvider<span class="tag">&lt;/provider&gt;</span>
    <span class="tag">&lt;jta-data-source&gt;</span>java:comp/DefaultDataSource<span class="tag">&lt;/jta-data-source&gt;</span>
    <span class="tag">&lt;shared-cache-mode&gt;</span>DISABLE_SELECTIVE<span class="tag">&lt;/shared-cache-mode&gt;</span>
<span class="tag">&lt;/persistence-unit&gt;</span></code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Note:</p>
</div>
<div class="paragraph">
<p>Because support for a second-level cache is not required by the Jakarta
Persistence specification, setting the second-level cache mode in
<code>persistence.xml</code> will have no effect when you use a persistence
provider that does not implement a second-level cache.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Alternatively, you can specify the shared cache mode by setting the
<code>javax.persistence.sharedCache.mode</code> property to one of the shared cache
mode settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManagerFactory emf =
    Persistence.createEntityManagerFactory(
        <span class="string"><span class="delimiter">&quot;</span><span class="content">myExamplePU</span><span class="delimiter">&quot;</span></span>, <span class="keyword">new</span> <span class="predefined-type">Properties</span>().add(
            <span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.sharedCache.mode</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">ENABLE_SELECTIVE</span><span class="delimiter">&quot;</span></span>));</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="GKJDK"></a><a id="setting-the-cache-retrieval-and-store-modes"></a></p>
</div>
<div class="sect4">
<h5 id="setting-the-cache-retrieval-and-store-modes"><a class="anchor" href="#setting-the-cache-retrieval-and-store-modes"></a>Setting the Cache Retrieval and Store Modes</h5>
<div class="paragraph">
<p>If you have enabled the second-level cache for a persistence unit by
setting the shared cache mode, you can further modify the behavior of
the second-level cache by setting the
<code>javax.persistence.cache.retrieveMode</code> and
<code>javax.persistence.cache.storeMode</code> properties. You can set these
properties at the persistence context level by passing the property name
and value to the <code>EntityManager.setProperty</code> method, or you can set them
on a per-<code>EntityManager</code> operation (<code>EntityManager.find</code> or
<code>EntityManager.refresh</code>) or on a per-query level.</p>
</div>
<div class="paragraph">
<p><a id="GKJDR"></a><a id="cache-retrieval-mode"></a></p>
</div>
<div class="sect5">
<h6 id="cache-retrieval-mode"><a class="anchor" href="#cache-retrieval-mode"></a>Cache Retrieval Mode</h6>
<div class="paragraph">
<p>The cache retrieval mode, set by the <code>javax.persistence.retrieveMode</code>
property, controls how data is read from the cache for calls to the
<code>EntityManager.find</code> method and from queries.</p>
</div>
<div class="paragraph">
<p>You can set the <code>retrieveMode</code> property to one of the constants defined
by the <code>javax.persistence.CacheRetrieveMode</code> enumerated type, either
<code>USE</code> (the default) or <code>BYPASS</code>.</p>
</div>
<div class="paragraph">
<p>When the property is set to <code>USE</code>, data is retrieved from the
second-level cache, if available. If the data is not in the cache, the
persistence provider will read it from the database.</p>
</div>
<div class="paragraph">
<p>When the property is set to <code>BYPASS</code>, the second-level cache is bypassed
and a call to the database is made to retrieve the data.</p>
</div>
<div class="paragraph">
<p><a id="GKJDD"></a><a id="cache-store-mode"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="cache-store-mode"><a class="anchor" href="#cache-store-mode"></a>Cache Store Mode</h6>
<div class="paragraph">
<p>The cache store mode, set by the <code>javax.persistence.storeMode</code> property,
controls how data is stored in the cache.</p>
</div>
<div class="paragraph">
<p>The <code>storeMode</code> property can be set to one of the constants defined by
the <code>javax.persistence.CacheStoreMode</code> enumerated type: either <code>USE</code>
(the default), <code>BYPASS</code>, or <code>REFRESH</code>.</p>
</div>
<div class="paragraph">
<p>When the property is set to <code>USE</code>, the cache data is created or updated
when data is read from or committed to the database. If data is already
in the cache, setting the store mode to <code>USE</code> will not force a refresh
when data is read from the database.</p>
</div>
<div class="paragraph">
<p>When the property is set to <code>BYPASS</code>, data read from or committed to the
database is not inserted or updated in the cache. That is, the cache is
unchanged.</p>
</div>
<div class="paragraph">
<p>When the property is set to <code>REFRESH</code>, the cache data is created or
updated when data is read from or committed to the database, and a
refresh is forced on data in the cache upon database reads.</p>
</div>
<div class="paragraph">
<p><a id="GKJDS"></a><a id="setting-the-cache-retrieval-or-store-mode"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="setting-the-cache-retrieval-or-store-mode"><a class="anchor" href="#setting-the-cache-retrieval-or-store-mode"></a>Setting the Cache Retrieval or Store Mode</h6>
<div class="paragraph">
<p>To set the cache retrieval or store mode for the persistence context,
call the <code>EntityManager.setProperty</code> method with the property name and
value pair:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = ...;
em.setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.cache.storeMode</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">BYPASS</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>To set the cache retrieval or store mode when calling the
<code>EntityManager.find</code> or <code>EntityManager.refresh</code> methods, first create a
<code>Map&lt;String, Object&gt;</code> instance and add a name/value pair as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = ...;
<span class="predefined-type">Map</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt; props = <span class="keyword">new</span> <span class="predefined-type">HashMap</span>&lt;<span class="predefined-type">String</span>, <span class="predefined-type">Object</span>&gt;();
props.put(<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.cache.retrieveMode</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">BYPASS</span><span class="delimiter">&quot;</span></span>);
<span class="predefined-type">String</span> personPK = ...;
Person person = em.find(Person.class, personPK, props);</code></pre>
</div>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Note:</p>
</div>
<div class="paragraph">
<p>The cache retrieval mode is ignored when calling the
<code>EntityManager.refresh</code> method, as calls to <code>refresh</code> always result in
data being read from the database, not the cache.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>To set the retrieval or store mode when using queries, call the
<code>Query.setHint</code> or <code>TypedQuery.setHint</code> methods, depending on the type
of query:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = ...;
CriteriaQuery&lt;Person&gt; cq = ...;
TypedQuery&lt;Person&gt; q = em.createQuery(cq);
q.setHint(<span class="string"><span class="delimiter">&quot;</span><span class="content">javax.persistence.cache.storeMode</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">REFRESH</span><span class="delimiter">&quot;</span></span>);
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Setting the store or retrieve mode in a query or when calling the
<code>EntityManager.find</code> or <code>EntityManager.refresh</code> method overrides the
setting of the entity manager.</p>
</div>
<div class="paragraph">
<p><a id="GKJEB"></a><a id="controlling-the-second-level-cache-programmatically"></a></p>
</div>
</div>
</div>
<div class="sect4">
<h5 id="controlling-the-second-level-cache-programmatically"><a class="anchor" href="#controlling-the-second-level-cache-programmatically"></a>Controlling the Second-Level Cache Programmatically</h5>
<div class="paragraph">
<p>The <code>javax.persistence.Cache</code> interface defines methods for interacting
with the second-level cache programmatically.</p>
</div>
<div class="paragraph">
<p>The following topics are addressed here:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#CHDEECCF">Overview of the javax.persistence.Cache Interface</a></p>
</li>
<li>
<p><a href="#GKJDZ">Checking whether an Entity&#8217;s Data Is Cached</a></p>
</li>
<li>
<p><a href="#GKJDQ">Removing an Entity from the Cache</a></p>
</li>
<li>
<p><a href="#GKJDA">Removing All Data from the Cache</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="CHDEECCF"></a><a id="overview-of-the-javax.persistence.cache-interface"></a></p>
</div>
<div class="sect5">
<h6 id="overview-of-the-javax-persistence-cache-interface"><a class="anchor" href="#overview-of-the-javax-persistence-cache-interface"></a>Overview of the javax.persistence.Cache Interface</h6>
<div class="paragraph">
<p>The <code>Cache</code> interface defines methods to do the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Check whether a particular entity has cached data</p>
</li>
<li>
<p>Remove a particular entity from the cache</p>
</li>
<li>
<p>Remove all instances (and instances of subclasses) of an entity class
from the cache</p>
</li>
<li>
<p>Clear the cache of all entity data</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Note:</p>
</div>
<div class="paragraph">
<p>If the second-level cache has been disabled, calls to the <code>Cache</code>
interface&#8217;s methods have no effect, except for <code>contains</code>, which will
always return <code>false</code>.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="GKJDZ"></a><a id="checking-whether-an-entitys-data-is-cached"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="checking-whether-an-entitys-data-is-cached"><a class="anchor" href="#checking-whether-an-entitys-data-is-cached"></a>Checking whether an Entity&#8217;s Data Is Cached</h6>
<div class="paragraph">
<p>To find out whether a given entity is currently in the second-level
cache:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Call the <code>Cache.contains</code> method . The <code>contains</code> method returns
<code>true</code> if the entity&#8217;s data is cached, and <code>false</code> if the data is not in
the cache:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = ...;
Cache cache = em.getEntityManagerFactory().getCache();
<span class="predefined-type">String</span> personPK = ...;
<span class="keyword">if</span> (cache.contains(Person.class, personPK)) {
  <span class="comment">// the data is cached</span>
} <span class="keyword">else</span> {
  <span class="comment">// the data is NOT cached</span>
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="GKJDQ"></a><a id="removing-an-entity-from-the-cache"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="removing-an-entity-from-the-cache"><a class="anchor" href="#removing-an-entity-from-the-cache"></a>Removing an Entity from the Cache</h6>
<div class="paragraph">
<p>To remove a particular entity or all entities of a given type from the
second-level cache:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Call one of the <code>Cache.evict</code> methods .</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>To remove a particular entity from the cache, call the <code>evict</code> method and pass in the entity class and the primary key of the entity:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = ...;
Cache cache = em.getEntityManagerFactory().getCache();
<span class="predefined-type">String</span> personPK = ...;
cache.evict(Person.class, personPK);</code></pre>
</div>
</div>
</li>
<li>
<p>To remove all instances of a particular entity class, including subclasses, call the <code>evict</code> method and specify the entity class:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = ...;
Cache cache = em.getEntityManagerFactory().getCache();
cache.evict(Person.class);</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>All instances of the <code>Person</code> entity class will be removed from the
cache. If the <code>Person</code> entity has a subclass, <code>Student</code>, calls to the
above method will remove all instances of <code>Student</code> from the cache as
well.</p>
</div>
<div class="paragraph">
<p><a id="GKJDA"></a><a id="removing-all-data-from-the-cache"></a></p>
</div>
</div>
<div class="sect5">
<h6 id="removing-all-data-from-the-cache"><a class="anchor" href="#removing-all-data-from-the-cache"></a>Removing All Data from the Cache</h6>
<div class="paragraph">
<p>To completely clear the second-level cache, call the <code>Cache.evictAll</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">EntityManager em = ...;
Cache cache = em.getEntityManagerFactory().getCache();
cache.evictAll();</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-04-26 15:32:37 UTC
</div>
</div>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</body>
</html>