<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.2">
<title>Messaging</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement when using as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed;word-wrap:break-word}
:not(pre)>code.nobreak{word-wrap:normal}
:not(pre)>code.nowrap{white-space:nowrap}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt,.quoteblock .quoteblock{margin:0 0 1.25em;padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
table.tableblock{max-width:100%;border-collapse:separate}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>thead>tr>.tableblock,table.grid-all>tbody>tr>.tableblock{border-width:0 1px 1px 0}
table.grid-all>tfoot>tr>.tableblock{border-width:1px 1px 0 0}
table.grid-cols>*>tr>.tableblock{border-width:0 1px 0 0}
table.grid-rows>thead>tr>.tableblock,table.grid-rows>tbody>tr>.tableblock{border-width:0 0 1px}
table.grid-rows>tfoot>tr>.tableblock{border-width:1px 0 0}
table.grid-all>*>tr>.tableblock:last-child,table.grid-cols>*>tr>.tableblock:last-child{border-right-width:0}
table.grid-all>tbody>tr:last-child>.tableblock,table.grid-all>thead:last-child>tr>.tableblock,table.grid-rows>tbody>tr:last-child>.tableblock,table.grid-rows>thead:last-child>tr>.tableblock{border-bottom-width:0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot,table.frame-ends{border-width:1px 0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
</head>
<body class="article toc2 toc-left">
<div id="header">
<h1>Messaging</h1>
<div id="toc" class="toc2">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_jakarta_messaging_concepts">1. Jakarta Messaging Concepts</a>
<ul class="sectlevel2">
<li><a href="#_jakarta_messaging_overview">1.1. Jakarta Messaging Overview</a></li>
<li><a href="#_basic_jakarta_messaging_concepts">1.2. Basic Jakarta Messaging Concepts</a></li>
<li><a href="#_jakarta_messaging_programming_model">1.3. Jakarta Messaging Programming Model</a></li>
<li><a href="#_using_advanced_jakarta_messaging_features">1.4. Using Advanced Jakarta Messaging Features</a></li>
<li><a href="#_using_jakarta_messaging_in_jakarta_ee_applications">1.5. Using Jakarta Messaging in Jakarta EE Applications</a></li>
<li><a href="#_further_information_about_jakarta_messaging">1.6. Further Information about Jakarta Messaging</a></li>
</ul>
</li>
<li><a href="#_jakarta_messaging_examples">2. Jakarta Messaging Examples</a>
<ul class="sectlevel2">
<li><a href="#_building_and_running_jakarta_messaging_examples">2.1. Building and Running Jakarta Messaging Examples</a></li>
<li><a href="#_overview_of_the_jakarta_messaging_examples">2.2. Overview of the Jakarta Messaging Examples</a></li>
<li><a href="#_writing_simple_jakarta_messaging_applications">2.3. Writing Simple Jakarta Messaging Applications</a></li>
<li><a href="#_writing_more_advanced_jakarta_messaging_applications">2.4. Writing More Advanced Jakarta Messaging Applications</a></li>
<li><a href="#_writing_high_performance_and_scalable_jakarta_messaging_applications">2.5. Writing High Performance and Scalable Jakarta Messaging Applications</a></li>
<li><a href="#_sending_and_receiving_messages_using_a_simple_web_application">2.6. Sending and Receiving Messages Using a Simple Web Application</a></li>
<li><a href="#_receiving_messages_asynchronously_using_a_message_driven_bean">2.7. Receiving Messages Asynchronously Using a Message-Driven Bean</a></li>
<li><a href="#_sending_messages_from_a_session_bean_to_an_mdb">2.8. Sending Messages from a Session Bean to an MDB</a></li>
<li><a href="#_using_an_entity_to_join_messages_from_two_mdbs">2.9. Using an Entity to Join Messages from Two MDBs</a></li>
<li><a href="#_using_netbeans_ide_to_create_jakarta_messaging_resources">2.10. Using NetBeans IDE to Create Jakarta Messaging Resources</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_jakarta_messaging_concepts">1. Jakarta Messaging Concepts</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a id="BNCDQ"></a><a id="java-message-service-concepts"></a></p>
</div>
<div class="paragraph">
<p>This chapter provides an introduction to Jakarta Messaging,
a Java API that allows applications to create, send, receive, and
read messages using reliable, asynchronous, loosely coupled
communication.</p>
</div>
<div class="paragraph">
<p><a id="BNCDR"></a><a id="overview-of-the-jms-api"></a></p>
</div>
<div class="sect2">
<h3 id="_jakarta_messaging_overview">1.1. Jakarta Messaging Overview</h3>
<div class="paragraph">
<p>This overview defines the concept of messaging, describes Jakarta Messaging
and where it can be used, and explains how Jakarta Messaging works within the
Jakarta EE platform.</p>
</div>
<div class="paragraph">
<p><a id="BNCDS"></a><a id="what-is-messaging"></a></p>
</div>
<div class="sect3">
<h4 id="_what_is_messaging">1.1.1. What Is Messaging?</h4>
<div class="paragraph">
<p>Messaging is a method of communication between software components or
applications. A messaging system is a peer-to-peer facility: A messaging
client can send messages to, and receive messages from, any other
client. Each client connects to a messaging agent that provides
facilities for creating, sending, receiving, and reading messages.</p>
</div>
<div class="paragraph">
<p>Messaging enables distributed communication that is loosely coupled. A
component sends a message to a destination, and the recipient can
retrieve the message from the destination. What makes the communication
loosely coupled is that the destination is all that the sender and
receiver have in common. The sender and the receiver do not have to be
available at the same time in order to communicate. In fact, the sender
does not need to know anything about the receiver; nor does the receiver
need to know anything about the sender. The sender and the receiver need
to know only which message format and which destination to use. In this
respect, messaging differs from tightly coupled technologies, such as
Remote Method Invocation (RMI), which require an application to know a
remote application&#8217;s methods.</p>
</div>
<div class="paragraph">
<p>Messaging also differs from electronic mail (email), which is a method
of communication between people or between software applications and
people. Messaging is used for communication between software
applications or software components.</p>
</div>
<div class="paragraph">
<p><a id="BNCDT"></a><a id="what-is-the-jms-api"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_what_is_jakarta_messaging">1.1.2. What Is Jakarta Messaging?</h4>
<div class="paragraph">
<p>Jakarta Messaging is a Java API that allows applications to
create, send, receive, and read messages. Jakarta Messaging defines a common
set of interfaces and associated semantics that allow programs written
in the Java programming language to communicate with other messaging
implementations.</p>
</div>
<div class="paragraph">
<p>Jakarta Messaging minimizes the set of concepts a programmer must learn in
order to use messaging products but provides enough features to support
sophisticated messaging applications. It also strives to maximize the
portability of Messaging applications across providers.</p>
</div>
<div class="paragraph">
<p>Jakarta Messaging enables communication that is not only loosely coupled but also</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Asynchronous: A receiving client does not have to receive messages at
the same time the sending client sends them. The sending client can send
them and go on to other tasks; the receiving client can receive them
much later.</p>
</li>
<li>
<p>Reliable: A messaging provider that implements Jakarta Messaging can ensure
that a message is delivered once and only once. Lower levels of
reliability are available for applications that can afford to miss
messages or to receive duplicate messages.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The current version of the Jakarta Messaging specification is Version 2.0.</p>
</div>
<div class="paragraph">
<p><a id="BNCDU"></a><a id="when-can-you-use-the-jms-api"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_when_can_you_use_jakarta_messaging">1.1.3. When Can You Use Jakarta Messaging?</h4>
<div class="paragraph">
<p>An enterprise application provider is likely to choose a messaging API
over a tightly coupled API, such as a remote procedure call (RPC), under
the following circumstances.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The provider wants the components not to depend on information about
other components' interfaces, so components can be easily replaced.</p>
</li>
<li>
<p>The provider wants the application to run whether or not all
components are up and running simultaneously.</p>
</li>
<li>
<p>The application business model allows a component to send information
to another and to continue to operate without receiving an immediate
response.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>For example, components of an enterprise application for an automobile
manufacturer can use Jakarta Messaging in situations like the following.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The inventory component can send a message to the factory component
when the inventory level for a product goes below a certain level so the
factory can make more cars.</p>
</li>
<li>
<p>The factory component can send a message to the parts components so
the factory can assemble the parts it needs.</p>
</li>
<li>
<p>The parts components in turn can send messages to their own inventory
and order components to update their inventories and to order new parts
from suppliers.</p>
</li>
<li>
<p>Both the factory and the parts components can send messages to the
accounting component to update budget numbers.</p>
</li>
<li>
<p>The business can publish updated catalog items to its sales force.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Using messaging for these tasks allows the various components to
interact with one another efficiently, without tying up network or other
resources. <a href="#BNCDV">Figure 48-1</a> illustrates how this simple example
might work.</p>
</div>
<div id="BNCDV" class="paragraph">
<div class="title"><strong>Figure 48-1 Messaging in an Enterprise Application</strong></div>
<p><span class="image"><img src="../images/jakartaeett_dt_026.png" alt="Diagram showing messaging between various departments in an enterprise"></span></p>
</div>
<div class="paragraph">
<p>Manufacturing is only one example of how an enterprise can use the Jakarta Messaging
API. Retail applications, financial services applications, health
services applications, and many others can make use of messaging.</p>
</div>
<div class="paragraph">
<p><a id="BNCDW"></a><a id="how-does-the-jms-api-work-with-the-jakarta-ee-platform"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_how_does_jakarta_messaging_work_with_the_jakarta_ee_platform">1.1.4. How Does Jakarta Messaging Work with the Jakarta EE Platform?</h4>
<div class="paragraph">
<p>When JMS was first introduced, its most important purpose was to
allow Java applications to access existing messaging-oriented middleware
(MOM) systems. Since that time, many vendors have adopted and
implemented JMS, so a Jakarta Messaging product can now provide a complete
messaging capability for an enterprise.</p>
</div>
<div class="paragraph">
<p>Jakarta Messaging is an integral part of the Jakarta EE platform, and application
developers can use messaging with Jakarta EE components. Jakarta Messaging 2.0 is part of
the Jakarta EE 8 release.</p>
</div>
<div class="paragraph">
<p>Jakarta Messaging in the Jakarta EE platform has the following features.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Application clients, Jakarta Enterprise Beans components, and web
components can send or synchronously receive a Jakarta Messaging message. Application
clients can in addition set a message listener that allows Jakarta Messaging messages
to be delivered to it asynchronously by being notified when a message is
available.</p>
</li>
<li>
<p>Message-driven beans, which are a kind of enterprise bean, enable the
asynchronous consumption of messages in the enterprise bean container. An
application server typically pools message-driven beans to implement
concurrent processing of messages.</p>
</li>
<li>
<p>Message send and receive operations can participate in Jakarta transactions,
which allow Jakarta Messaging operations and database accesses to take place within a single transaction.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Jakarta Messaging enhances the other parts of the Jakarta EE platform by
simplifying enterprise development, allowing loosely coupled, reliable,
asynchronous interactions among Jakarta EE components and legacy systems
capable of messaging. A developer can easily add new behavior to a Jakarta
EE application that has existing business events by adding a new
message-driven bean to operate on specific business events. The Jakarta EE
platform, moreover, enhances Jakarta Messaging by providing support for Jakarta Transactions
and allowing for the concurrent consumption of messages.
For more information, see the Jakarta Enterprise Beans specification, v3.2.</p>
</div>
<div class="paragraph">
<p>The Jakarta Messaging provider can be integrated with the application server using the
Jakarta EE Connector architecture. You access the Messaging provider through a
resource adapter. This capability allows vendors to create Messaging providers
that can be plugged in to multiple application servers, and it allows
application servers to support multiple Messaging providers. For more
information, see the Jakarta EE Connector architecture specification, v1.7.</p>
</div>
<div class="paragraph">
<p><a id="BNCDX"></a><a id="basic-jms-api-concepts"></a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_basic_jakarta_messaging_concepts">1.2. Basic Jakarta Messaging Concepts</h3>
<div class="paragraph">
<p>This section introduces the most basic Jakarta Messaging concepts, the ones you
must know to get started writing simple application clients that use the
Jakarta Messaging.</p>
</div>
<div class="paragraph">
<p>The next section introduces the Jakarta Messaging programming model. Later
sections cover more advanced concepts, including the ones you need in
order to write applications that use message-driven beans.</p>
</div>
<div class="paragraph">
<p><a id="BNCDY"></a><a id="jms-api-architecture"></a></p>
</div>
<div class="sect3">
<h4 id="_jakarta_messaging_architecture">1.2.1. Jakarta Messaging Architecture</h4>
<div class="paragraph">
<p>A Jakarta Messaging application is composed of the following parts.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A Jakarta Messaging provider is a messaging system that implements the Messaging
interfaces and provides administrative and control features. An
implementation of the Jakarta EE platform that supports the full profile
includes a Messaging provider.</p>
</li>
<li>
<p>Jakarta Messaging clients are the programs or components, written in the Java
programming language, that produce and consume messages. Any Jakarta EE
application component can act as a Messaging client.</p>
<div class="paragraph">
<p>Java SE applications can also act as Jakarta Messaging clients; the Message Queue
Developer&#8217;s Guide for Java Clients in the GlassFish Server documentation
(<code><a href="https://eclipse-ee4j.github.io/glassfish/documentation" class="bare">https://eclipse-ee4j.github.io/glassfish/documentation</a></code>) explains how to make this work.</p>
</div>
</li>
<li>
<p>Messages are the objects that communicate information between Jakarta Messaging
clients.</p>
</li>
<li>
<p>Administered objects are Jakarta Messaging objects configured for the use of
clients. The two kinds of Jakarta Messaging administered objects are destinations and
connection factories, described in <a href="#BNCEJ">Jakarta Messaging
Administered Objects</a>. An administrator can create objects that are
available to all applications that use a particular installation of
GlassFish Server; alternatively, a developer can use annotations to
create objects that are specific to a particular application.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#BNCDZ">Figure 48-2</a> illustrates the way these parts interact.
Administrative tools or annotations allow you to bind destinations and
connection factories into a JNDI namespace. A Messaging client can then use
resource injection to access the administered objects in the namespace
and then establish a logical connection to the same objects through the
Jakarta Messaging provider.</p>
</div>
<div class="paragraph">
<p><a id="BNCDZ"></a>.<strong>Figure 48-2 Jakarta Messaging Architecture</strong></p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../images/jakartaeett_dt_027.png" alt="Diagram of Jakarta Messaging architecture, showing administrative tool, Jakarta Messaging client, JNDI namespace, and JMS provider"></span></p>
</div>
<div class="paragraph">
<p><a id="BNCEA"></a><a id="messaging-styles"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_messaging_styles">1.2.2. Messaging Styles</h4>
<div class="paragraph">
<p>Before the Jakarta Messaging existed, most messaging products supported either the
point-to-point or the publish/subscribe style of messaging. The Jakarta Messaging
specification defines compliance for each style. A Messaging provider must
implement both styles, and the Jakarta Messaging provides interfaces that are
specific to each. The following subsections describe these messaging
styles.</p>
</div>
<div class="paragraph">
<p>Jakarta Messaging, however, makes it unnecessary to use only one of the two
styles. It allows you to use the same code to send and receive messages
using either the PTP or the pub/sub style. The destinations you use
remain specific to one style, and the behavior of the application will
depend in part on whether you are using a queue or a topic. However, the
code itself can be common to both styles, making your applications
flexible and reusable. This tutorial describes and illustrates this
coding approach, using the greatly simplified API provided by Jakarta Messaging 2.0.</p>
</div>
<div class="paragraph">
<p><a id="BNCEB"></a><a id="point-to-point-messaging-style"></a></p>
</div>
<div class="sect4">
<h5 id="_point_to_point_messaging_style">Point-to-Point Messaging Style</h5>
<div class="paragraph">
<p>A point-to-point (PTP) product or application is built on the concept of
message queues, senders, and receivers. Each message is addressed to a
specific queue, and receiving clients extract messages from the queues
established to hold their messages. Queues retain all messages sent to
them until the messages are consumed or expire.</p>
</div>
<div class="paragraph">
<p>PTP messaging, illustrated in <a href="#BNCEC">Figure 48-3</a>, has the
following characteristics.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each message has only one consumer.</p>
</li>
<li>
<p>The receiver can fetch the message whether or not it was running when
the client sent the message.</p>
</li>
</ul>
</div>
<div id="BNCEC" class="paragraph">
<div class="title"><strong>Figure 48-3 Point-to-Point Messaging</strong></div>
<p><span class="image"><img src="../images/jakartaeett_dt_028.png" alt="Diagram of point-to-point messaging, showing Client 1 sending a message to a queue, and Client 2 consuming and acknowledging the message"></span></p>
</div>
<div class="paragraph">
<p>Use PTP messaging when every message you send must be processed
successfully by one consumer.</p>
</div>
<div class="paragraph">
<p><a id="BNCED"></a><a id="publishsubscribe-messaging-style"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_publishsubscribe_messaging_style">Publish/Subscribe Messaging Style</h5>
<div class="paragraph">
<p>In a publish/subscribe (pub/sub) product or application, clients address
messages to a topic, which functions somewhat like a bulletin board.
Publishers and subscribers can dynamically publish or subscribe to the
topic. The system takes care of distributing the messages arriving from
a topic&#8217;s multiple publishers to its multiple subscribers. Topics retain
messages only as long as it takes to distribute them to subscribers.</p>
</div>
<div class="paragraph">
<p>With pub/sub messaging, it is important to distinguish between the
consumer that subscribes to a topic (the subscriber) and the
subscription that is created. The consumer is a Jakarta Messaging object within an
application, while the subscription is an entity within the Jakarta Messaging
provider. Normally, a topic can have many consumers, but a subscription
has only one subscriber. It is possible, however, to create shared
subscriptions; see <a href="#BABJCIGJ">Creating Shared
Subscriptions</a> for details. See
<a href="#BABEEJJJ">Consuming Messages from Topics</a> for
details on the semantics of pub/sub messaging.</p>
</div>
<div class="paragraph">
<p>Pub/sub messaging has the following characteristics.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Each message can have multiple consumers.</p>
</li>
<li>
<p>A client that subscribes to a topic can consume only messages sent
after the client has created a subscription, and the consumer must
continue to be active in order for it to consume messages.</p>
<div class="paragraph">
<p>The Jakarta Messaging relaxes this requirement to some extent by allowing
applications to create durable subscriptions, which receive messages
sent while the consumers are not active. Durable subscriptions provide
the flexibility and reliability of queues but still allow clients to
send messages to many recipients. For more information about durable
subscriptions, see <a href="#BNCGD">Creating Durable
Subscriptions</a>.</p>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p>Use pub/sub messaging when each message can be processed by any number
of consumers (or none). <a href="#BNCEE">Figure 48-4</a> illustrates pub/sub
messaging.</p>
</div>
<div id="BNCEE" class="paragraph">
<div class="title"><strong>Figure 48-4 Publish/Subscribe Messaging</strong></div>
<p><span class="image"><img src="../images/jakartaeett_dt_029.png" alt="Diagram of pub/sub messaging, showing Client 1 sending a message to a topic, and the message being delivered to two consumers to the topic"></span></p>
</div>
<div class="paragraph">
<p><a id="BNCEG"></a><a id="message-consumption"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_message_consumption">1.2.3. Message Consumption</h4>
<div class="paragraph">
<p>Messaging products are inherently asynchronous: There is no fundamental
timing dependency between the production and the consumption of a
message. However, the Jakarta Messaging specification uses this term in a more precise
sense. Messages can be consumed in either of two ways.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Synchronously: A consumer explicitly fetches the message from the
destination by calling the <code>receive</code> method. The <code>receive</code> method can
block until a message arrives or can time out if a message does not
arrive within a specified time limit.</p>
</li>
<li>
<p>Asynchronously: An application client or a Java SE client can register
a message listener with a consumer. A message listener is similar to an
event listener. Whenever a message arrives at the destination, the JMS
provider delivers the message by calling the listener&#8217;s <code>onMessage</code>
method, which acts on the contents of the message. In a Jakarta EE
application, a message-driven bean serves as a message listener (it too
has an <code>onMessage</code> method), but a client does not need to register it
with a consumer.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNCEH"></a><a id="the-jms-api-programming-model"></a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_jakarta_messaging_programming_model">1.3. Jakarta Messaging Programming Model</h3>
<div class="paragraph">
<p>The basic building blocks of a Jakarta Messaging application are</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Administered objects: connection factories and destinations</p>
</li>
<li>
<p>Connections</p>
</li>
<li>
<p>Sessions</p>
</li>
<li>
<p><code>JMSContext</code> objects, which combine a connection and a session in one
object</p>
</li>
<li>
<p>Message producers</p>
</li>
<li>
<p>Message consumers</p>
</li>
<li>
<p>Messages</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#BNCEI">Figure 48-5</a> shows how all these objects fit together in a
Messaging client application.</p>
</div>
<div id="BNCEI" class="paragraph">
<div class="title"><strong>Figure 48-5 Jakarta Messaging Programming Model</strong></div>
<p><span class="image"><img src="../images/jakartaeett_dt_030.png" alt="Diagram of Jakarta Messaging programming model: connection factory, JMSContext, connection, session, message producer, message consumer, messages, and destinations"></span></p>
</div>
<div class="paragraph">
<p>Jakarta Messaging also provides queue browsers, objects that allow an application to
browse messages on a queue.</p>
</div>
<div class="paragraph">
<p>This section describes all these objects briefly and provides sample
commands and code snippets that show how to create and use the objects.
The last subsection briefly describes Jakarta Messaging API exception handling.</p>
</div>
<div class="paragraph">
<p>Examples that show how to combine all these objects in applications
appear in <a href="#BNCGV">Chapter 49, "Java Message Service
Examples,"</a> beginning with <a href="#BNCFA">Writing Simple
Jakarta Messaging Applications</a>. For more detail, see Jakarta Messaging documentation, part
of the Jakarta EE API documentation.</p>
</div>
<div class="paragraph">
<p><a id="BNCEJ"></a><a id="jms-administered-objects"></a></p>
</div>
<div class="sect3">
<h4 id="_jakarta_messaging_administered_objects">1.3.1. Jakarta Messaging Administered Objects</h4>
<div class="paragraph">
<p>Two parts of a Jakarta Messaging application, destinations and connection factories,
are commonly maintained administratively rather than programmatically.
The technology underlying these objects is likely to be very different
from one implementation of Jakarta Messaging to another. Therefore, the
management of these objects belongs with other administrative tasks that
vary from provider to provider.</p>
</div>
<div class="paragraph">
<p>Messaging clients access administered objects through interfaces that are
portable, so a client application can run with little or no change on
more than one implementation of Jakarta Messaging. Ordinarily, an
administrator configures administered objects in a JNDI namespace, and
Messaging clients then access them by using resource injection.</p>
</div>
<div class="paragraph">
<p>With GlassFish Server, you can use the <code>asadmin create-jms-resource</code>
command or the Administration Console to create Jakarta Messaging administered objects
in the form of connector resources. You can also specify the resources
in a file named <code>glassfish-resources.xml</code> that you can bundle with an
application.</p>
</div>
<div class="paragraph">
<p>NetBeans IDE provides a wizard that allows you to create Jakarta Messaging resources
for GlassFish Server. See <a href="#GKTJS">Creating Jakarta Messaging
Administered Objects</a> for details.</p>
</div>
<div class="paragraph">
<p>The Jakarta EE platform specification allows a developer to create
administered objects using annotations or deployment descriptor
elements. Objects created in this way are specific to the application
for which they are created. See
<a href="#BABHFBDH">Creating Resources for Jakarta EE
Applications</a> for details. Definitions in a deployment descriptor
override those specified by annotations.</p>
</div>
<div class="paragraph">
<p><a id="BNCEK"></a><a id="jms-connection-factories"></a></p>
</div>
<div class="sect4">
<h5 id="_jakarta_messaging_connection_factories">Jakarta Messaging Connection Factories</h5>
<div class="paragraph">
<p>A connection factory is the object a client uses to create a connection
to a provider. A connection factory encapsulates a set of connection
configuration parameters that has been defined by an administrator. Each
connection factory is an instance of the <code>ConnectionFactory</code>,
<code>QueueConnectionFactory</code>, or <code>TopicConnectionFactory</code> interface. To
learn how to create connection factories, see
<a href="#GKTJS">Creating Jakarta Messaging Administered Objects</a>.</p>
</div>
<div class="paragraph">
<p>At the beginning of a Messaging client program, you usually inject a
connection factory resource into a <code>ConnectionFactory</code> object. A Jakarta EE
server must provide a Jakarta Messaging connection factory with the logical JNDI name
<code>java:comp/DefaultJMSConnectionFactory</code>. The actual JNDI name will be
implementation-specific.</p>
</div>
<div class="paragraph">
<p>For example, the following code fragment looks up the default Jakarta Messaging
connection factory and assigns it to a <code>ConnectionFactory</code> object:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:comp/DefaultJMSConnectionFactory</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="directive">static</span> ConnectionFactory connectionFactory;</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNCEL"></a><a id="jms-destinations"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_jakarta_messaging_destinations">Jakarta Messaging Destinations</h5>
<div class="paragraph">
<p>A destination is the object a client uses to specify the target of
messages it produces and the source of messages it consumes. In the PTP
messaging style, destinations are called queues. In the pub/sub
messaging style, destinations are called topics. A Jakarta Messaging application can
use multiple queues or topics (or both). To learn how to create
destination resources, see <a href="#GKTJS">Creating Jakarta Messaging
Administered Objects</a>.</p>
</div>
<div class="paragraph">
<p>To create a destination using GlassFish Server, you create a Jakarta Messaging
destination resource that specifies a JNDI name for the destination.</p>
</div>
<div class="paragraph">
<p>In the GlassFish Server implementation of Jakarta Messaging, each destination resource
refers to a physical destination. You can create a physical destination
explicitly, but if you do not, the Application Server creates it when it
is needed and deletes it when you delete the destination resource.</p>
</div>
<div class="paragraph">
<p>In addition to injecting a connection factory resource into a client
program, you usually inject a destination resource. Unlike connection
factories, destinations are specific to either the PTP or pub/sub
messaging style. To create an application that allows you to use the
same code for both topics and queues, you assign the destination to a
<code>Destination</code> object.</p>
</div>
<div class="paragraph">
<p>The following code specifies two resources, a queue and a topic. The
resource names are mapped to destination resources created in the JNDI
namespace:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">jms/MyQueue</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">Queue</span> queue;

<span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">jms/MyTopic</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="directive">static</span> Topic topic;</code></pre>
</div>
</div>
<div class="paragraph">
<p>In a Jakarta EE application, Jakarta Messaging administered objects are normally placed
in the <code>jms</code> naming subcontext.</p>
</div>
<div class="paragraph">
<p>With the common interfaces, you can mix or match connection factories
and destinations. That is, in addition to using the <code>ConnectionFactory</code>
interface, you can inject a <code>QueueConnectionFactory</code> resource and use it
with a <code>Topic</code>, and you can inject a <code>TopicConnectionFactory</code> resource
and use it with a <code>Queue</code>. The behavior of the application will depend
on the kind of destination you use and not on the kind of connection
factory you use.</p>
</div>
<div class="paragraph">
<p><a id="BNCEM"></a><a id="connections"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_connections">1.3.2. Connections</h4>
<div class="paragraph">
<p>A connection encapsulates a virtual connection with a Messaging provider. For
example, a connection could represent an open TCP/IP socket between a
client and a provider service daemon. You use a connection to create one
or more sessions.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Note</strong>:</p>
</div>
<div class="paragraph">
<p>In the Jakarta EE platform, the ability to create multiple sessions from a
single connection is limited to application clients. In web and
enterprise bean components, a connection can create no more than one
session.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>You normally create a connection by creating a <code>JMSContext</code> object. See
<a href="#BABGDFEA">JMSContext Objects</a> for details.</p>
</div>
<div class="paragraph">
<p><a id="BNCEN"></a><a id="sessions"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_sessions">1.3.3. Sessions</h4>
<div class="paragraph">
<p>A session is a single-threaded context for producing and consuming
messages.</p>
</div>
<div class="paragraph">
<p>You normally create a session (as well as a connection) by creating a
<code>JMSContext</code> object. See <a href="#BABGDFEA">JMSContext Objects</a> for details.
You use sessions to create message producers, message consumers,
messages, queue browsers, and temporary destinations.</p>
</div>
<div class="paragraph">
<p>Sessions serialize the execution of message listeners; for details, see
<a href="#BNCEQ">Jakarta Messaging Message Listeners</a>.</p>
</div>
<div class="paragraph">
<p>A session provides a transactional context with which to group a set of
sends and receives into an atomic unit of work. For details, see
<a href="#BNCGH">Using Jakarta Messaging Local Transactions</a>.</p>
</div>
<div class="paragraph">
<p><a id="BABGDFEA"></a><a id="jmscontext-objects"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_jmscontext_objects">1.3.4. JMSContext Objects</h4>
<div class="paragraph">
<p>A <code>JMSContext</code> object combines a connection and a session in a single
object. That is, it provides both an active connection to a Messaging provider
and a single-threaded context for sending and receiving messages.</p>
</div>
<div class="paragraph">
<p>You use the <code>JMSContext</code> to create the following objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Message producers</p>
</li>
<li>
<p>Message consumers</p>
</li>
<li>
<p>Messages</p>
</li>
<li>
<p>Queue browsers</p>
</li>
<li>
<p>Temporary queues and topics (see
<a href="#BNCGB">Creating Temporary Destinations</a>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can create a <code>JMSContext</code> in a <code>try</code>-with-resources block.</p>
</div>
<div class="paragraph">
<p>To create a <code>JMSContext</code>, call the <code>createContext</code> method on the
connection factory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">JMSContext context = connectionFactory.createContext();</code></pre>
</div>
</div>
<div class="paragraph">
<p>When called with no arguments from an application client or a Java SE
client, or from the Jakarta EE web or EJB container when there is no active
JTA transaction in progress, the <code>createContext</code> method creates a
non-transacted session with an acknowledgment mode of
<code>JMSContext.AUTO_ACKNOWLEDGE</code>. When called with no arguments from the
web or EJB container when there is an active JTA transaction in
progress, the <code>createContext</code> method creates a transacted session. For
information about the way Jakarta Messaging transactions work in Jakarta EE applications,
see <a href="#BNCGL">Using Jakarta Messaging in Jakarta EE
Applications</a>.</p>
</div>
<div class="paragraph">
<p>From an application client or a Java SE client, you can also call the
<code>createContext</code> method with the argument <code>JMSContext.SESSION_TRANSACTED</code>
to create a transacted session:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">JMSContext context =
        connectionFactory.createContext(JMSContext.SESSION_TRANSACTED);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The session uses local transactions; see
<a href="#BNCGH">Using Jakarta Messaging Local Transactions</a> for
details.</p>
</div>
<div class="paragraph">
<p>Alternatively, you can specify a non-default acknowledgment mode; see
<a href="#BNCFW">Controlling Message Acknowledgment</a> for
more information.</p>
</div>
<div class="paragraph">
<p>When you use a <code>JMSContext</code>, message delivery normally begins as soon as
you create a consumer. See <a href="#BNCEP">Jakarta Messaging Message Consumers</a> for more
information.</p>
</div>
<div class="paragraph">
<p>If you create a <code>JMSContext</code> in a <code>try</code>-with-resources block, you do not
need to close it explicitly. It will be closed when the <code>try</code> block
comes to an end. Make sure that your application completes all its Jakarta Messaging
activity within the <code>try</code>-with-resources block. If you do not use a
<code>try</code>-with-resources block, you must call the <code>close</code> method on the
<code>JMSContext</code> to close the connection when the application has finished
its work.</p>
</div>
<div class="paragraph">
<p><a id="BNCEO"></a><a id="jms-message-producers"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_jakarta_messaging_message_producers">1.3.5. Jakarta Messaging Message Producers</h4>
<div class="paragraph">
<p>A message producer is an object that is created by a <code>JMSContext</code> or a
session and used for sending messages to a destination. A message
producer created by a <code>JMSContext</code> implements the <code>JMSProducer</code>
interface. You could create it this way:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (JMSContext context = connectionFactory.createContext();) {
    JMSProducer producer = context.createProducer();
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, a <code>JMSProducer</code> is a lightweight object that does not consume
significant resources. For this reason, you do not need to save the
<code>JMSProducer</code> in a variable; you can create a new one each time you send
a message. You send messages to a specific destination by using the
<code>send</code> method. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">context.createProducer().send(dest, message);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can create the message in a variable before sending it, as shown
here, or you can create it within the <code>send</code> call. See <a href="#BNCES">JMS
Messages</a> for more information.</p>
</div>
<div class="paragraph">
<p><a id="BNCEP"></a><a id="jms-message-consumers"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_jakarta_messaging_message_consumers">1.3.6. Jakarta Messaging Message Consumers</h4>
<div class="paragraph">
<p>A message consumer is an object that is created by a <code>JMSContext</code> or a
session and used for receiving messages sent to a destination. A message
producer created by a <code>JMSContext</code> implements the <code>JMSConsumer</code>
interface. The simplest way to create a message consumer is to use the
<code>JMSContext.createConsumer</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (JMSContext context = connectionFactory.createContext();) {
    JMSConsumer consumer = context.createConsumer(dest);
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>A message consumer allows a Messaging client to register interest in a
destination with a Messaging provider. The Jakarta Messaging provider manages the delivery
of messages from a destination to the registered consumers of the
destination.</p>
</div>
<div class="paragraph">
<p>When you use a <code>JMSContext</code> to create a message consumer, message
delivery begins as soon as you have created the consumer. You can
disable this behavior by calling <code>setAutoStart(false)</code> when you create
the <code>JMSContext</code> and then calling the <code>start</code> method explicitly to start
message delivery. If you want to stop message delivery temporarily
without closing the connection, you can call the <code>stop</code> method; to
restart message delivery, call <code>start</code>.</p>
</div>
<div class="paragraph">
<p>You use the <code>receive</code> method to consume a message synchronously. You can
use this method at any time after you create the consumer.</p>
</div>
<div class="paragraph">
<p>If you specify no arguments or an argument of <code>0</code>, the method blocks
indefinitely until a message arrives:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Message m = consumer.receive();
Message m = consumer.receive(<span class="integer">0</span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For a simple client, this may not matter. But if it is possible that a
message might not be available, use a synchronous receive with a
timeout: Call the <code>receive</code> method with a timeout argument greater than
<code>0</code>. One second is a recommended timeout value:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Message m = consumer.receive(<span class="integer">1000</span>); <span class="comment">// time out after a second</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>To enable asynchronous message delivery from an application client or a
Java SE client, you use a message listener, as described in the next
section.</p>
</div>
<div class="paragraph">
<p>You can use the <code>JMSContext.createDurableConsumer</code> method to create a
durable topic subscription. This method is valid only if you are using a
topic. For details, see <a href="#BNCGD">Creating Durable Subscriptions</a>. For
topics, you can also create shared consumers; see
<a href="#BABJCIGJ">Creating Shared Subscriptions</a>.</p>
</div>
<div class="paragraph">
<p><a id="BNCEQ"></a><a id="jms-message-listeners"></a></p>
</div>
<div class="sect4">
<h5 id="_jakarta_messaging_message_listeners">Jakarta Messaging Message Listeners</h5>
<div class="paragraph">
<p>A message listener is an object that acts as an asynchronous event
handler for messages. This object implements the <code>MessageListener</code>
interface, which contains one method, <code>onMessage</code>. In the <code>onMessage</code>
method, you define the actions to be taken when a message arrives.</p>
</div>
<div class="paragraph">
<p>From an application client or a Java SE client, you register the message
listener with a specific message consumer by using the
<code>setMessageListener</code> method. For example, if you define a class named
<code>Listener</code> that implements the <code>MessageListener</code> interface, you can
register the message listener as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Listener myListener = <span class="keyword">new</span> Listener();
consumer.setMessageListener(myListener);</code></pre>
</div>
</div>
<div class="paragraph">
<p>When message delivery begins, the Messaging provider automatically calls the
message listener&#8217;s <code>onMessage</code> method whenever a message is delivered.
The <code>onMessage</code> method takes one argument of type <code>Message</code>, which your
implementation of the method can cast to another message subtype as
needed (see <a href="#BNCEW">Message Bodies</a>).</p>
</div>
<div class="paragraph">
<p>In the Jakarta EE web or EJB container, you use message-driven beans for
asynchronous message delivery. A message-driven bean also implements the
<code>MessageListener</code> interface and contains an <code>onMessage</code> method. For
details, see <a href="#BNCGQ">Using Message-Driven Beans
to Receive Messages Asynchronously</a>.</p>
</div>
<div class="paragraph">
<p>Your <code>onMessage</code> method should handle all exceptions. Throwing a
<code>RuntimeException</code> is considered a programming error.</p>
</div>
<div class="paragraph">
<p>For a simple example of the use of a message listener, see
<a href="#BNCFH">Using a Message Listener for Asynchronous
Message Delivery</a>. <a href="#BNCGV">Chapter 49, "Java Message
Service Examples,"</a> contains several more examples of message listeners
and message-driven beans.</p>
</div>
<div class="paragraph">
<p><a id="BNCER"></a><a id="jms-message-selectors"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_jakarta_messaging_message_selectors">Jakarta Messaging Message Selectors</h5>
<div class="paragraph">
<p>If your messaging application needs to filter the messages it receives,
you can use a Jakarta Messaging message selector, which allows a message consumer for
a destination to specify the messages that interest it. Message
selectors assign the work of filtering messages to the Messaging provider
rather than to the application. For an example of an application that
uses a message selector, see <a href="#BNCGW">Sending
Messages from a Session Bean to an MDB</a>.</p>
</div>
<div class="paragraph">
<p>A message selector is a <code>String</code> that contains an expression. The syntax
of the expression is based on a subset of the SQL92 conditional
expression syntax. The message selector in the example selects any
message that has a <code>NewsType</code> property that is set to the value
<code>'Sports'</code> or <code>'Opinion'</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">NewsType = <span class="string"><span class="delimiter">'</span><span class="content">Sports</span><span class="delimiter">'</span></span> OR NewsType = <span class="string"><span class="delimiter">'</span><span class="content">Opinion</span><span class="delimiter">'</span></span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>createConsumer</code> and <code>createDurableConsumer</code> methods, as well as the
methods for creating shared consumers, allow you to specify a message
selector as an argument when you create a message consumer.</p>
</div>
<div class="paragraph">
<p>The message consumer then receives only messages whose headers and
properties match the selector. (See <a href="#BNCET">Message Headers</a> and
<a href="#BNCEV">Message Properties</a>.) A message selector cannot select
messages on the basis of the content of the message body.</p>
</div>
<div class="paragraph">
<p><a id="BABEEJJJ"></a><a id="consuming-messages-from-topics"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_consuming_messages_from_topics">Consuming Messages from Topics</h5>
<div class="paragraph">
<p>The semantics of consuming messages from topics are more complex than
the semantics of consuming messages from queues.</p>
</div>
<div class="paragraph">
<p>An application consumes messages from a topic by creating a subscription
on that topic and creating a consumer on that subscription.
Subscriptions may be durable or nondurable, and they may be shared or
unshared.</p>
</div>
<div class="paragraph">
<p>A subscription may be thought of as an entity within the Messaging provider
itself, whereas a consumer is a Jakarta Messaging object within the application.</p>
</div>
<div class="paragraph">
<p>A subscription will receive a copy of every message that is sent to the
topic after the subscription is created, unless a message selector is
specified. If a message selector is specified, only those messages whose
properties match the message selector will be added to the subscription.</p>
</div>
<div class="paragraph">
<p>Unshared subscriptions are restricted to a single consumer. In this
case, all the messages in the subscription are delivered to that
consumer. Shared subscriptions allow multiple consumers. In this case,
each message in the subscription is delivered to only one consumer. Jakarta Messaging
does not define how messages are distributed between multiple consumers
on the same subscription.</p>
</div>
<div class="paragraph">
<p>Subscriptions may be durable or nondurable.</p>
</div>
<div class="paragraph">
<p>A nondurable subscription exists only as long as there is an active
consumer on the subscription. This means that any messages sent to the
topic will be added to the subscription only while a consumer exists and
is not closed.</p>
</div>
<div class="paragraph">
<p>A nondurable subscription may be either unshared or shared.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An unshared nondurable subscription does not have a name and may have
only a single consumer object associated with it. It is created
automatically when the consumer object is created. It is not persisted
and is deleted automatically when the consumer object is closed.</p>
<div class="paragraph">
<p>The <code>JMSContext.createConsumer</code> method creates a consumer on an unshared
nondurable subscription if a topic is specified as the destination.</p>
</div>
</li>
<li>
<p>A shared nondurable subscription is identified by name and an optional
client identifier, and may have several consumer objects consuming
messages from it. It is created automatically when the first consumer
object is created. It is not persisted and is deleted automatically when
the last consumer object is closed. See <a href="#BABJCIGJ">Creating Shared
Subscriptions</a> for more information.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>At the cost of higher overhead, a subscription may be durable. A durable
subscription is persisted and continues to accumulate messages until
explicitly deleted, even if there are no consumer objects consuming
messages from it. See <a href="#BNCGD">Creating Durable Subscriptions</a> for
details.</p>
</div>
<div class="paragraph">
<p><a id="BNCGD"></a><a id="creating-durable-subscriptions"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_creating_durable_subscriptions">Creating Durable Subscriptions</h5>
<div class="paragraph">
<p>To ensure that a pub/sub application receives all sent messages, use
durable subscriptions for the consumers on the topic.</p>
</div>
<div class="paragraph">
<p>Like a nondurable subscription, a durable subscription may be either
unshared or shared.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An unshared durable subscription is identified by name and client
identifier (which must be set) and may have only a single consumer
object associated with it.</p>
</li>
<li>
<p>A shared durable subscription is identified by name and an optional
client identifier, and may have several consumer objects consuming
messages from it.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A durable subscription that exists but that does not currently have a
non-closed consumer object associated with it is described as being
inactive.</p>
</div>
<div class="paragraph">
<p>You can use the <code>JMSContext.createDurableConsumer</code> method to create a
consumer on an unshared durable subscription. An unshared durable
subscription can have only one active consumer at a time.</p>
</div>
<div class="paragraph">
<p>A consumer identifies the durable subscription from which it consumes
messages by specifying a unique identity that is retained by the Messaging
provider. Subsequent consumer objects that have the same identity resume
the subscription in the state in which it was left by the preceding
consumer. If a durable subscription has no active consumer, the Messaging
provider retains the subscription&#8217;s messages until they are received by
the subscription or until they expire.</p>
</div>
<div class="paragraph">
<p>You establish the unique identity of an unshared durable subscription by
setting the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A client ID for the connection</p>
</li>
<li>
<p>A topic and a subscription name for the subscription</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can set the client ID administratively for a client-specific
connection factory using either the command line or the Administration
Console. (In an application client or a Java SE client, you can instead
call <code>JMSContext.setClientID</code>.)</p>
</div>
<div class="paragraph">
<p>After using this connection factory to create the <code>JMSContext</code>, you call
the <code>createDurableConsumer</code> method with two arguments: the topic and a
string that specifies the name of the subscription:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> subName = <span class="string"><span class="delimiter">&quot;</span><span class="content">MySub</span><span class="delimiter">&quot;</span></span>;
JMSConsumer consumer = context.createDurableConsumer(myTopic, subName);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The subscription becomes active after you create the consumer. Later,
you might close the consumer:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">consumer.close();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The Messaging provider stores the messages sent to the topic, as it would
store messages sent to a queue. If the program or another application
calls <code>createDurableConsumer</code> using the same connection factory and its
client ID, the same topic, and the same subscription name, then the
subscription is reactivated and the Messaging provider delivers the messages
that were sent while the subscription was inactive.</p>
</div>
<div class="paragraph">
<p>To delete a durable subscription, first close the consumer, then call
the <code>unsubscribe</code> method with the subscription name as the argument:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">consumer.close();
context.unsubscribe(subName);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>unsubscribe</code> method deletes the state the provider maintains for
the subscription.</p>
</div>
<div class="paragraph">
<p><a href="#BNCGF">Figure 48-7</a> show the
difference between a nondurable and a durable subscription. With an
ordinary, nondurable subscription, the consumer and the subscription
begin and end at the same point and are, in effect, identical. When the
consumer is closed, the subscription also ends. Here, <code>create</code> stands
for a call to <code>JMSContext.createConsumer</code> with a <code>Topic</code> argument, and
<code>close</code> stands for a call to <code>JMSConsumer.close</code>. Any messages sent to
the topic between the time of the first <code>close</code> and the time of the
second <code>create</code> are not added to either subscription. In
<a href="#BNCGE">Figure 48-6</a>, the consumers receive messages M1, M2, M5, and
M6, but they do not receive messages M3 and M4.</p>
</div>
<div id="BNCGE" class="paragraph">
<div class="title"><strong>Figure 48-6 Nondurable Subscriptions and Consumers</strong></div>
<p><span class="image"><img src="../images/jakartaeett_dt_031.png" alt="Diagram showing messages being lost when nondurable subscriptions are used"></span></p>
</div>
<div class="paragraph">
<p>With a durable subscription, the consumer can be closed and re-created,
but the subscription continues to exist and to hold messages until the
application calls the <code>unsubscribe</code> method. In <a href="#BNCGF">Figure 48-7</a>,
<code>create</code> stands for a call to <code>JMSContext.createDurableConsumer</code>,
<code>close</code> stands for a call to <code>JMSConsumer.close</code>, and <code>unsubscribe</code>
stands for a call to <code>JMSContext.unsubscribe</code>. Messages sent after the
first consumer is closed are received when the second consumer is
created (on the same durable subscription), so even though messages M2,
M4, and M5 arrive while there is no consumer, they are not lost.</p>
</div>
<div id="BNCGF" class="paragraph">
<div class="title"><strong>Figure 48-7 Consumers on a Durable Subscription</strong></div>
<p><span class="image"><img src="../images/jakartaeett_dt_032.png" alt="Diagram showing messages being preserved when durable subscriptions are used"></span></p>
</div>
<div class="paragraph">
<p>A shared durable subscription allows you to use multiple consumers to
receive messages from a durable subscription. If you use a shared
durable subscription, the connection factory you use does not need to
have a client identifier. To create a shared durable subscription, call
the <code>JMSContext.createSharedDurableConsumer</code> method, specifying the
topic and subscription name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">JMSConsumer consumer =
        context.createSharedDurableConsumer(topic, <span class="string"><span class="delimiter">&quot;</span><span class="content">MakeItLast</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#BNCFX">Acknowledging Messages</a>,
<a href="#BNCGG">Using Durable Subscriptions</a>,
<a href="#BABEJBHA">Using Shared Durable Subscriptions</a>,
and <a href="#BNCGW">Sending Messages from a Session Bean
to an MDB</a> for examples of Jakarta EE applications that use durable
subscriptions.</p>
</div>
<div class="paragraph">
<p><a id="BABJCIGJ"></a><a id="creating-shared-subscriptions"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_creating_shared_subscriptions">Creating Shared Subscriptions</h5>
<div class="paragraph">
<p>A topic subscription created by the <code>createConsumer</code> or
<code>createDurableConsumer</code> method can have only one consumer (although a
topic can have many). Multiple clients consuming from the same topic
have, by definition, multiple subscriptions to the topic, and all the
clients receive all the messages sent to the topic (unless they filter
them with message selectors).</p>
</div>
<div class="paragraph">
<p>It is, however, possible to create a nondurable shared subscription to a
topic by using the <code>createSharedConsumer</code> method and specifying not only
a destination but a subscription name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">consumer = context.createSharedConsumer(topicName, <span class="string"><span class="delimiter">&quot;</span><span class="content">SubName</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>With a shared subscription, messages will be distributed among multiple
clients that use the same topic and subscription name. Each message sent
to the topic will be added to every subscription (subject to any message
selectors), but each message added to a subscription will be delivered
to only one of the consumers on that subscription, so it will be
received by only one of the clients. A shared subscription can be useful
if you want to share the message load among several consumers on the
subscription rather than having just one consumer on the subscription
receive each message. This feature can improve the scalability of Java
EE application client applications and Java SE applications.
(Message-driven beans share the work of processing messages from a topic
among multiple threads.)</p>
</div>
<div class="paragraph">
<p>See <a href="#BABIBEAC">Using Shared Nondurable
Subscriptions</a> for a simple example of using shared nondurable
consumers.</p>
</div>
<div class="paragraph">
<p>You can also create shared durable subscriptions by using the
<code>JMSContext.createSharedDurableConsumer</code> method. For details, see
<a href="#BNCGD">Creating Durable Subscriptions</a>.</p>
</div>
<div class="paragraph">
<p><a id="BNCES"></a><a id="jms-messages"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jakarta_messaging_messages">1.3.7. Jakarta Messaging Messages</h4>
<div class="paragraph">
<p>The ultimate purpose of a Jakarta Messaging application is to produce and consume
messages that can then be used by other software applications. Jakarta Messaging
messages have a basic format that is simple but highly flexible,
allowing you to create messages that match formats used by non-Jakarta Messaging
applications on heterogeneous platforms.</p>
</div>
<div class="paragraph">
<p>A Jakarta Messaging message can have three parts: a header, properties, and a body.
Only the header is required. The following sections describe these
parts.</p>
</div>
<div class="paragraph">
<p>For complete documentation of message headers, properties, and bodies,
see the documentation of the <code>Message</code> interface in the API
documentation. For a list of possible message types, see
<a href="#BNCEW">Message Bodies</a>.</p>
</div>
<div class="paragraph">
<p><a id="BNCET"></a><a id="message-headers"></a></p>
</div>
<div class="sect4">
<h5 id="_message_headers">Message Headers</h5>
<div class="paragraph">
<p>A Jakarta Messaging message header contains a number of predefined fields that contain
values used by both clients and providers to identify and route
messages. <a href="#BNCEU">Table 48-1</a> lists and describes the Jakarta Messaging message
header fields and indicates how their values are set. For example, every
message has a unique identifier, which is represented in the header
field <code>JMSMessageID</code>. The value of another header field,
<code>JMSDestination</code>, represents the queue or the topic to which the message
is sent. Other fields include a timestamp and a priority level.</p>
</div>
<div class="paragraph">
<p>Each header field has associated setter and getter methods, which are
documented in the description of the <code>Message</code> interface. Some header
fields are intended to be set by a client, but many are set
automatically by the <code>send</code> method, which overrides any client-set
values.</p>
</div>
<div class="paragraph">
<p><a id="sthref196"></a><a id="BNCEU"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 48-1 How Jakarta Messaging Message Header Field Values Are Set</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 99%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 60%;">
<col style="width: 20%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Header Field</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Set By</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JMSDestination</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destination to which the message is being sent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JMS
provider <code>send</code> method</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JMSDeliveryMode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Delivery mode specified when the message was sent
(see <a href="#BNCFY">Specifying Message Persistence</a>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Messaging provider <code>send</code> method</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JMSDeliveryTime</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time the message was sent plus the delivery
delay specified when the message was sent (see
<a href="#BABGEADH">Specifying a Delivery Delay</a></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JMS
provider <code>send</code> method</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JMSExpiration</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Expiration time of the message (see
<a href="#BNCGA">Allowing Messages to Expire</a>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">JMS
provider <code>send</code> method</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JMSPriority</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The priority of the message (see
<a href="#BNCFZ">Setting Message Priority Levels</a>)</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jakarta Messaging
provider <code>send</code> method</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JMSMessageID</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value that uniquely identifies each message sent by a
provider</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Messaging provider <code>send</code> method</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JMSTimestamp</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The time the message was handed off to a provider to be
sent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Messaging provider <code>send</code> method</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JMSCorrelationID</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Value that links one message to another; commonly
the <code>JMSMessageID</code> value is used</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client application</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JMSReplyTo</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Destination where replies to the message should be sent</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client application</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JMSType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Type identifier supplied by client application</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client
application</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>JMSRedelivered</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Whether the message is being redelivered</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Jakarta Messaging
provider prior to delivery</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="BNCEV"></a><a id="message-properties"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_message_properties">Message Properties</h5>
<div class="paragraph">
<p>You can create and set properties for messages if you need values in
addition to those provided by the header fields. You can use properties
to provide compatibility with other messaging systems, or you can use
them to create message selectors (see <a href="#BNCER">Jakarta Messaging Message
Selectors</a>). For an example of setting a property to be used as a
message selector, see <a href="#BNCGW">Sending Messages
from a Session Bean to an MDB</a>.</p>
</div>
<div class="paragraph">
<p>Jakarta Messaging provides some predefined property names that begin with
<code>JMSX</code>. A Messaging provider is required to implement only one of these,
<code>JMSXDeliveryCount</code> (which specifies the number of times a message has
been delivered); the rest are optional. The use of these predefined
properties or of user-defined properties in applications is optional.</p>
</div>
<div class="paragraph">
<p><a id="BNCEW"></a><a id="message-bodies"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_message_bodies">Message Bodies</h5>
<div class="paragraph">
<p>Jakarta Messaging defines six different types of messages. Each message type
corresponds to a different message body. These message types allow you
to send and receive data in many different forms. <a href="#BNCEX">Table
48-2</a> describes these message types.</p>
</div>
<div class="paragraph">
<p><a id="sthref197"></a><a id="BNCEX"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 48-2 Jakarta Messaging Message Types</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 75%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 80%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Message Type</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Body Contains</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>TextMessage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>java.lang.String</code> object (for example, the contents
of an XML file).</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>MapMessage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A set of name-value pairs, with names as <code>String</code> objects
and values as primitive types in the Java programming language. The
entries can be accessed sequentially by enumerator or randomly by name.
The order of the entries is undefined.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>BytesMessage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A stream of uninterpreted bytes. This message type is
for literally encoding a body to match an existing message format.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>StreamMessage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A stream of primitive values in the Java programming
language, filled and read sequentially.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>ObjectMessage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A <code>Serializable</code> object in the Java programming
language.</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>Message</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Nothing. Composed of header fields and properties only. This
message type is useful when a message body is not required.</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>Jakarta Messaging provides methods for creating messages of each type and for
filling in their contents. For example, to create and send a
<code>TextMessage</code>, you might use the following statements:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">TextMessage message = context.createTextMessage();
message.setText(msg_text);     <span class="comment">// msg_text is a String</span>
context.createProducer().send(message);</code></pre>
</div>
</div>
<div class="paragraph">
<p>At the consuming end, a message arrives as a generic <code>Message</code> object.
You can then cast the object to the appropriate message type and use
more specific methods to access the body and extract the message
contents (and its headers and properties if needed). For example, you
might use the stream-oriented read methods of <code>BytesMessage</code>. You must
always cast to the appropriate message type to retrieve the body of a
<code>StreamMessage</code>.</p>
</div>
<div class="paragraph">
<p>Instead of casting the message to a message type, you can call the
<code>getBody</code> method on the <code>Message</code>, specifying the type of the message as
an argument. For example, you can retrieve a <code>TextMessage</code> as a
<code>String</code>. The following code fragment uses the <code>getBody</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Message m = consumer.receive();
<span class="keyword">if</span> (m <span class="keyword">instanceof</span> TextMessage) {
    <span class="predefined-type">String</span> message = m.getBody(<span class="predefined-type">String</span>.class);
    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Reading message: </span><span class="delimiter">&quot;</span></span> + message);
} <span class="keyword">else</span> {
    <span class="comment">// Handle error or process another message type</span>
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Jakarta Messaging provides shortcuts for creating and receiving a
<code>TextMessage</code>, <code>BytesMessage</code>, <code>MapMessage</code>, or <code>ObjectMessage</code>. For
example, you do not have to wrap a string in a <code>TextMessage</code>; instead,
you can send and receive the string directly. For example, you can send
a string as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> message = <span class="string"><span class="delimiter">&quot;</span><span class="content">This is a message</span><span class="delimiter">&quot;</span></span>;
context.createProducer().send(dest, message);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can receive the message by using the <code>receiveBody</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> message = receiver.receiveBody(<span class="predefined-type">String</span>.class);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can use the <code>receiveBody</code> method to receive any type of message
except <code>StreamMessage</code> and <code>Message</code>, as long as the body of the message
can be assigned to a particular type.</p>
</div>
<div class="paragraph">
<p>An empty <code>Message</code> can be useful if you want to send a message that is
simply a signal to the application. Some of the examples in
<a href="#BNCGV">Chapter 49, "Jakarta Messaging
Examples,"</a> send an empty message after sending a series of text
messages. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">context.createProducer().send(dest, context.createMessage());</code></pre>
</div>
</div>
<div class="paragraph">
<p>The consumer code can then interpret a non-text message as a signal that
all the messages sent have now been received.</p>
</div>
<div class="paragraph">
<p>The examples in <a href="#BNCGV">Chapter 49, "Jakarta Messaging
Examples,"</a> use messages of type <code>TextMessage</code>, <code>MapMessage</code>,
and <code>Message</code>.</p>
</div>
<div class="paragraph">
<p><a id="BNCEY"></a><a id="jms-queue-browsers"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_jakarta_messaging_queue_browsers">1.3.8. Jakarta Messaging Queue Browsers</h4>
<div class="paragraph">
<p>Messages sent to a queue remain in the queue until the message consumer
for that queue consumes them. Jakarta Messaging provides a <code>QueueBrowser</code>
object that allows you to browse the messages in the queue and display
the header values for each message. To create a <code>QueueBrowser</code> object,
use the <code>JMSContext.createBrowser</code> method. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">QueueBrowser browser = context.createBrowser(queue);</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#BNCFL">Browsing Messages on a Queue</a> for an
example of using a <code>QueueBrowser</code> object.</p>
</div>
<div class="paragraph">
<p>The <code>createBrowser</code> method allows you to specify a message selector as a
second argument when you create a <code>QueueBrowser</code>. For information on
message selectors, see <a href="#BNCER">Jakarta Messaging Message Selectors</a>.</p>
</div>
<div class="paragraph">
<p>Jakarta Messaging provides no mechanism for browsing a topic. Messages usually
disappear from a topic as soon as they appear: If there are no message
consumers to consume them, the Messaging provider removes them. Although
durable subscriptions allow messages to remain on a topic while the
message consumer is not active, Jakarta Messaging does not define any facility for
examining them.</p>
</div>
<div class="paragraph">
<p><a id="BNCEZ"></a><a id="jms-exception-handling"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_jakarta_messaging_exception_handling">1.3.9. Jakarta Messaging Exception Handling</h4>
<div class="paragraph">
<p>The root class for all checked exceptions in Jakarta Messaging is
<code>JMSException</code>. The root cause for all unchecked exceptions in the Jakarta Messaging
API is <code>JMSRuntimeException</code>.</p>
</div>
<div class="paragraph">
<p>Catching <code>JMSException</code> and <code>JMSRuntimeException</code> provides a generic way
of handling all exceptions related to Jakarta Messaging.</p>
</div>
<div class="paragraph">
<p>The <code>JMSException</code> and <code>JMSRuntimeException</code> classes include the
following subclasses, described in the API documentation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>IllegalStateException</code>, <code>IllegalStateRuntimeException</code></p>
</li>
<li>
<p><code>InvalidClientIDException</code>, <code>InvalidClientIDRuntimeException</code></p>
</li>
<li>
<p><code>InvalidDestinationException</code>, <code>InvalidDestinationRuntimeException</code></p>
</li>
<li>
<p><code>InvalidSelectorException</code>, <code>InvalidSelectorRuntimeException</code></p>
</li>
<li>
<p><code>JMSSecurityException</code>, <code>JMSSecurityRuntimeException</code></p>
</li>
<li>
<p><code>MessageEOFException</code></p>
</li>
<li>
<p><code>MessageFormatException</code>, <code>MessageFormatRuntimeException</code></p>
</li>
<li>
<p><code>MessageNotReadableException</code></p>
</li>
<li>
<p><code>MessageNotWriteableException</code>, <code>MessageNotWriteableRuntimeException</code></p>
</li>
<li>
<p><code>ResourceAllocationException</code>, <code>ResourceAllocationRuntimeException</code></p>
</li>
<li>
<p><code>TransactionInProgressException</code>,
<code>TransactionInProgressRuntimeException</code></p>
</li>
<li>
<p><code>TransactionRolledBackException</code>,
<code>TransactionRolledBackRuntimeException</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>All the examples in the tutorial catch and handle <code>JMSException</code> or
<code>JMSRuntimeException</code> when it is appropriate to do so.</p>
</div>
<div class="paragraph">
<p><a id="BNCFU"></a><a id="using-advanced-jms-features"></a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_advanced_jakarta_messaging_features">1.4. Using Advanced Jakarta Messaging Features</h3>
<div class="paragraph">
<p>This section explains how to use features of Jakarta Messaging to achieve the
level of reliability and performance your application requires. Many
people use Jakarta Messaging in their applications because they cannot tolerate
dropped or duplicate messages and because they require that every
message be received once and only once. Jakarta Messaging provides this
functionality.</p>
</div>
<div class="paragraph">
<p>The most reliable way to produce a message is to send a <code>PERSISTENT</code>
message, and to do so within a transaction.</p>
</div>
<div class="paragraph">
<p>Jakarta Messaging messages are <code>PERSISTENT</code> by default; <code>PERSISTENT</code> messages will not
be lost in the event of Messaging provider failure. For details, see
<a href="#BNCFY">Specifying Message Persistence</a>.</p>
</div>
<div class="paragraph">
<p>Transactions allow multiple messages to be sent or received in an atomic
operation. In the Jakarta EE platform they also allow message sends and
receives to be combined with database reads and writes in an atomic
transaction. A transaction is a unit of work into which you can group a
series of operations, such as message sends and receives, so that the
operations either all succeed or all fail. For details, see
<a href="#BNCGH">Using Jakarta Messaging Local Transactions</a>.</p>
</div>
<div class="paragraph">
<p>The most reliable way to consume a message is to do so within a
transaction, either from a queue or from a durable subscription to a
topic. For details, see <a href="#BNCGD">Creating Durable
Subscriptions</a>, <a href="#BNCGB">Creating Temporary Destinations</a>, and
<a href="#BNCGH">Using Jakarta Messaging Local Transactions</a>.</p>
</div>
<div class="paragraph">
<p>Some features primarily allow an application to improve performance. For
example, you can set messages to expire after a certain length of time
(see <a href="#BNCGA">Allowing Messages to Expire</a>), so that consumers do not
receive unnecessary outdated information. You can send messages
asynchronously; see <a href="#BABFIFAJ">Sending Messages Asynchronously</a>.</p>
</div>
<div class="paragraph">
<p>You can also specify various levels of control over message
acknowledgment; see <a href="#BNCFW">Controlling Message Acknowledgment</a>.</p>
</div>
<div class="paragraph">
<p>Other features can provide useful capabilities unrelated to reliability.
For example, you can create temporary destinations that last only for
the duration of the connection in which they are created. See
<a href="#BNCGB">Creating Temporary Destinations</a> for details.</p>
</div>
<div class="paragraph">
<p>The following sections describe these features as they apply to
application clients or Java SE clients. Some of the features work
differently in the Jakarta EE web or enterprise bean container; in these cases, the
differences are noted here and are explained in detail in
<a href="#BNCGL">Using Jakarta Messaging in Jakarta EE
Applications</a>.</p>
</div>
<div class="paragraph">
<p><a id="BNCFW"></a><a id="controlling-message-acknowledgment"></a></p>
</div>
<div class="sect3">
<h4 id="_controlling_message_acknowledgment">1.4.1. Controlling Message Acknowledgment</h4>
<div class="paragraph">
<p>Until a Jakarta Messaging message has been acknowledged, it is not considered to be
successfully consumed. The successful consumption of a message
ordinarily takes place in three stages.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The client receives the message.</p>
</li>
<li>
<p>The client processes the message.</p>
</li>
<li>
<p>The message is acknowledged. Acknowledgment is initiated either by
the Messaging provider or by the client, depending on the session
acknowledgment mode.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In locally transacted sessions (see <a href="#BNCGH">Using Jakarta Messaging Local
Transactions</a>), a message is acknowledged when the session is committed.
If a transaction is rolled back, all consumed messages are redelivered.</p>
</div>
<div class="paragraph">
<p>In a Jakarta transaction (in the Jakarta EE web or enterprise bean container) a message is
acknowledged when the transaction is committed.</p>
</div>
<div class="paragraph">
<p>In nontransacted sessions, when and how a message is acknowledged depend
on a value that may be specified as an argument of the <code>createContext</code>
method. The possible argument values are as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>JMSContext.AUTO_ACKNOWLEDGE</code>: This setting is the default for
application clients and Java SE clients. The <code>JMSContext</code> automatically
acknowledges a client&#8217;s receipt of a message either when the client has
successfully returned from a call to <code>receive</code> or when the
<code>MessageListener</code> it has called to process the message returns
successfully.</p>
<div class="paragraph">
<p>A synchronous receive in a <code>JMSContext</code> that is configured to use
auto-acknowledgment is the one exception to the rule that message
consumption is a three-stage process as described earlier. In this case,
the receipt and acknowledgment take place in one step, followed by the
processing of the message.</p>
</div>
</li>
<li>
<p><code>JMSContext.CLIENT_ACKNOWLEDGE</code>: A client acknowledges a message by
calling the message&#8217;s <code>acknowledge</code> method. In this mode, acknowledgment
takes place on the session level: Acknowledging a consumed message
automatically acknowledges the receipt of all messages that have been
consumed by its session. For example, if a message consumer consumes ten
messages and then acknowledges the fifth message delivered, all ten
messages are acknowledged.</p>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p>Note:</p>
</div>
<div class="paragraph">
<p>In the Jakarta EE platform, the <code>JMSContext.CLIENT_ACKNOWLEDGE</code> setting can
be used only in an application client, not in a web component or
enterprise bean.</p>
</div></div></td>
</tr>
</tbody>
</table>
</li>
<li>
<p><code>JMSContext.DUPS_OK_ACKNOWLEDGE</code>: This option instructs the
<code>JMSContext</code> to lazily acknowledge the delivery of messages. This is
likely to result in the delivery of some duplicate messages if the Messaging
provider fails, so it should be used only by consumers that can tolerate
duplicate messages. (If the Messaging provider redelivers a message, it must
set the value of the <code>JMSRedelivered</code> message header to <code>true</code>.) This
option can reduce session overhead by minimizing the work the session
does to prevent duplicates.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If messages have been received from a queue but not acknowledged when a
<code>JMSContext</code> is closed, the Messaging provider retains them and redelivers
them when a consumer next accesses the queue. The provider also retains
unacknowledged messages if an application closes a <code>JMSContext</code> that has
been consuming messages from a durable subscription. (See
<a href="#BNCGD">Creating Durable Subscriptions</a>.)
Unacknowledged messages that have been received from a nondurable
subscription will be dropped when the <code>JMSContext</code> is closed.</p>
</div>
<div class="paragraph">
<p>If you use a queue or a durable subscription, you can use the
<code>JMSContext.recover</code> method to stop a nontransacted <code>JMSContext</code> and
restart it with its first unacknowledged message. In effect, the
<code>JMSContext&#8217;s series of delivered messages is reset to the point after
its last acknowledged message. The messages it now delivers may be
different from those that were originally delivered, if messages have
expired or if higher-priority messages have arrived. For a consumer on a
nondurable subscription, the provider may drop unacknowledged messages
when the `JMSContext.recover</code> method is called.</p>
</div>
<div class="paragraph">
<p>The sample program in <a href="#BNCFX">Acknowledging
Messages</a> demonstrates two ways to ensure that a message will not be
acknowledged until processing of the message is complete.</p>
</div>
<div class="paragraph">
<p><a id="BNCFV"></a><a id="specifying-options-for-sending-messages"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_specifying_options_for_sending_messages">1.4.2. Specifying Options for Sending Messages</h4>
<div class="paragraph">
<p>You can set a number of options when you send a message. These options
enable you to perform the tasks described in the following topics:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="#BNCFY">Specifying Message Persistence</a> – Specify that messages
are persistent, meaning they must not be lost in the event of a provider
failure.</p>
</li>
<li>
<p><a href="#BNCFZ">Setting Message Priority Levels</a> – Set priority levels for
messages, which can affect the order in which the messages are
delivered.</p>
</li>
<li>
<p><a href="#BNCGA">Allowing Messages to Expire</a> – Specify an expiration time
for messages so they will not be delivered if they are obsolete.</p>
</li>
<li>
<p><a href="#BABGEADH">Specifying a Delivery Delay</a>– Specify a delivery delay
for messages so that they will not be delivered until a specified amount
of time has expired.</p>
</li>
<li>
<p><a href="#BABJFIAD">Using JMSProducer Method Chaining</a> – Method chaining
allows you to specify more than one of these options when you create a
producer and call the <code>send</code> method.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNCFY"></a><a id="specifying-message-persistence"></a></p>
</div>
<div class="sect4">
<h5 id="_specifying_message_persistence">Specifying Message Persistence</h5>
<div class="paragraph">
<p>Jakarta Messaging supports two delivery modes specifying whether messages are
lost if the Messaging provider fails. These delivery modes are fields of the
<code>DeliveryMode</code> interface.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The default delivery mode, <code>PERSISTENT</code>, instructs the Messaging provider to
take extra care to ensure that a message is not lost in transit in case
of a Messaging provider failure. A message sent with this delivery mode is
logged to stable storage when it is sent.</p>
</li>
<li>
<p>The <code>NON_PERSISTENT</code> delivery mode does not require the Messaging provider
to store the message or otherwise guarantee that it is not lost if the
provider fails.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To specify the delivery mode, use the <code>setDeliveryMode</code> method of the
<code>JMSProducer</code> interface to set the delivery mode for all messages sent
by that producer.</p>
</div>
<div class="paragraph">
<p>You can use method chaining to set the delivery mode when you create a
producer and send a message. The following call creates a producer with
a <code>NON_PERSISTENT</code> delivery mode and uses it to send a message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">context.createProducer()
       .setDeliveryMode(DeliveryMode.NON_PERSISTENT).send(dest, msg);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you do not specify a delivery mode, the default is <code>PERSISTENT</code>.
Using the <code>NON_PERSISTENT</code> delivery mode may improve performance and
reduce storage overhead, but you should use it only if your application
can afford to miss messages.</p>
</div>
<div class="paragraph">
<p><a id="BNCFZ"></a><a id="setting-message-priority-levels"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_setting_message_priority_levels">Setting Message Priority Levels</h5>
<div class="paragraph">
<p>You can use message priority levels to instruct the Messaging provider to
deliver urgent messages first. Use the <code>setPriority</code> method of the
<code>JMSProducer</code> interface to set the priority level for all messages sent
by that producer.</p>
</div>
<div class="paragraph">
<p>You can use method chaining to set the priority level when you create a
producer and send a message. For example, the following call sets a
priority level of 7 for a producer and then sends a message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">context.createProducer().setPriority(<span class="integer">7</span>).send(dest, msg);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The ten levels of priority range from 0 (lowest) to 9 (highest). If you
do not specify a priority level, the default level is 4. A Messaging provider
tries to deliver higher-priority messages before lower-priority ones,
but does not have to deliver messages in exact order of priority.</p>
</div>
<div class="paragraph">
<p><a id="BNCGA"></a><a id="allowing-messages-to-expire"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_allowing_messages_to_expire">Allowing Messages to Expire</h5>
<div class="paragraph">
<p>By default, a message never expires. If a message will become obsolete
after a certain period, however, you may want to set an expiration time.
Use the <code>setTimeToLive</code> method of the <code>JMSProducer</code> interface to set a
default expiration time for all messages sent by that producer.</p>
</div>
<div class="paragraph">
<p>For example, a message that contains rapidly changing data such as a
stock price will become obsolete after a few minutes, so you might
configure messages to expire after that time.</p>
</div>
<div class="paragraph">
<p>You can use method chaining to set the time to live when you create a
producer and send a message. For example, the following call sets a time
to live of five minutes for a producer and then sends a message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">context.createProducer().setTimeToLive(<span class="integer">300000</span>).send(dest, msg);</code></pre>
</div>
</div>
<div class="paragraph">
<p>If the specified <code>timeToLive</code> value is <code>0</code>, the message never expires.</p>
</div>
<div class="paragraph">
<p>When the message is sent, the specified <code>timeToLive</code> is added to the
current time to give the expiration time. Any message not delivered
before the specified expiration time is destroyed. The destruction of
obsolete messages conserves storage and computing resources.</p>
</div>
<div class="paragraph">
<p><a id="BABGEADH"></a><a id="specifying-a-delivery-delay"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_specifying_a_delivery_delay">Specifying a Delivery Delay</h5>
<div class="paragraph">
<p>You can specify a length of time that must elapse after a message is
sent before the Messaging provider delivers the message. Use the
<code>setDeliveryDelay</code> method of the <code>JMSProducer</code> interface to set a
delivery delay for all messages sent by that producer.</p>
</div>
<div class="paragraph">
<p>You can use method chaining to set the delivery delay when you create a
producer and send a message. For example, the following call sets a
delivery delay of 3 seconds for a producer and then sends a message:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">context.createProducer().setDeliveryDelay(<span class="integer">3000</span>).send(dest, msg);</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BABJFIAD"></a><a id="using-jmsproducer-method-chaining"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_using_jmsproducer_method_chaining">Using JMSProducer Method Chaining</h5>
<div class="paragraph">
<p>The setter methods on the <code>JMSProducer</code> interface return <code>JMSProducer</code>
objects, so you can use method chaining to create a producer, set
multiple properties, and send a message. For example, the following
chained method calls create a producer, set a user-defined property, set
the expiration, delivery mode, and priority for the message, and then
send a message to a queue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">context.createProducer()
        .setProperty(<span class="string"><span class="delimiter">&quot;</span><span class="content">MyProperty</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">MyValue</span><span class="delimiter">&quot;</span></span>)
        .setTimeToLive(<span class="integer">10000</span>)
        .setDeliveryMode(NON_PERSISTENT)
        .setPriority(<span class="integer">2</span>)
        .send(queue, body);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can also call the <code>JMSProducer</code> methods to set properties on a
message and then send the message in a separate <code>send</code> method call. You
can also set message properties directly on a message.</p>
</div>
<div class="paragraph">
<p><a id="BNCGB"></a><a id="creating-temporary-destinations"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creating_temporary_destinations">1.4.3. Creating Temporary Destinations</h4>
<div class="paragraph">
<p>Normally, you create JMS destinations (queues and topics)
administratively rather than programmatically. Your Messaging provider
includes a tool to create and remove destinations, and it is common for
destinations to be long-lasting.</p>
</div>
<div class="paragraph">
<p>Jakarta Messaging also enables you to create destinations (<code>TemporaryQueue</code>
and <code>TemporaryTopic</code> objects) that last only for the duration of the
connection in which they are created. You create these destinations
dynamically using the <code>JMSContext.createTemporaryQueue</code> and the
<code>JMSContext.createTemporaryTopic</code> methods, as in the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">TemporaryTopic replyTopic = context.createTemporaryTopic();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The only message consumers that can consume from a temporary destination
are those created by the same connection that created the destination.
Any message producer can send to the temporary destination. If you close
the connection to which a temporary destination belongs, the destination
is closed and its contents are lost.</p>
</div>
<div class="paragraph">
<p>You can use temporary destinations to implement a simple request/reply
mechanism. If you create a temporary destination and specify it as the
value of the <code>JMSReplyTo</code> message header field when you send a message,
then the consumer of the message can use the value of the <code>JMSReplyTo</code>
field as the destination to which it sends a reply. The consumer can
also reference the original request by setting the <code>JMSCorrelationID</code>
header field of the reply message to the value of the <code>JMSMessageID</code>
header field of the request. For example, an <code>onMessage</code> method can
create a <code>JMSContext</code> so that it can send a reply to the message it
receives. It can use code such as the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">replyMsg = context.createTextMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">Consumer processed message: </span><span class="delimiter">&quot;</span></span>
        + msg.getText());
replyMsg.setJMSCorrelationID(msg.getJMSMessageID());
context.createProducer().send((Topic) msg.getJMSReplyTo(), replyMsg);</code></pre>
</div>
</div>
<div class="paragraph">
<p>For an example, see <a href="#BNCHF">Using an Entity to
Join Messages from Two MDBs</a>.</p>
</div>
<div class="paragraph">
<p><a id="BNCGH"></a><a id="using-jms-local-transactions"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_using_jakarta_messaging_local_transactions">1.4.4. Using Jakarta Messaging Local Transactions</h4>
<div class="paragraph">
<p>A transaction groups a series of operations into an atomic unit of work.
If any one of the operations fails, the transaction can be rolled back,
and the operations can be attempted again from the beginning. If all the
operations succeed, the transaction can be committed.</p>
</div>
<div class="paragraph">
<p>In an application client or a Java SE client, you can use local
transactions to group message sends and receives. You use the
<code>JMSContext.commit</code> method to commit a transaction. You can send
multiple messages in a transaction, and the messages will not be added
to the queue or topic until the transaction is committed. If you receive
multiple messages in a transaction, they will not be acknowledged until
the transaction is committed.</p>
</div>
<div class="paragraph">
<p>You can use the <code>JMSContext.rollback</code> method to roll back a transaction.
A transaction rollback means that all produced messages are destroyed
and all consumed messages are recovered and redelivered unless they have
expired (see <a href="#BNCGA">Allowing Messages to Expire</a>).</p>
</div>
<div class="paragraph">
<p>A transacted session is always involved in a transaction. To create a
transacted session, call the <code>createContext</code> method as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">JMSContext context =
        connectionFactory.createContext(JMSContext.SESSION_TRANSACTED);</code></pre>
</div>
</div>
<div class="paragraph">
<p>As soon as the <code>commit</code> or the <code>rollback</code> method is called, one
transaction ends and another transaction begins. Closing a transacted
session rolls back its transaction in progress, including any pending
sends and receives.</p>
</div>
<div class="paragraph">
<p>In an application running in the Jakarta EE web or enterprise bean container, you
cannot use local transactions. Instead, you use Jakarta Transactions,
described in <a href="#BNCGL">Using Jakarta Messaging in Jakarta EE
Applications</a>.</p>
</div>
<div class="paragraph">
<p>You can combine several sends and receives in a single Jakarta Messaging local
transaction, so long as they are all performed using the same
<code>JMSContext</code>.</p>
</div>
<div class="paragraph">
<p>Do not use a single transaction if you use a request/reply mechanism, in
which you send a message and then receive a reply to that message. If
you try to use a single transaction, the program will hang, because the
send cannot take place until the transaction is committed. The following
code fragment illustrates the problem:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="comment">// Don't do this!</span>
outMsg.setJMSReplyTo(replyQueue);
context.createProducer().send(outQueue, outMsg);
consumer = context.createConsumer(replyQueue);
inMsg = consumer.receive();
context.commit();</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because a message sent during a transaction is not actually sent until
the transaction is committed, the transaction cannot contain any
receives that depend on that message&#8217;s having been sent.</p>
</div>
<div class="paragraph">
<p>The production and the consumption of a message cannot both be part of
the same transaction. The reason is that the transactions take place
between the clients and the Messaging provider, which intervenes between the
production and the consumption of the message. <a href="#BNCGI">Figure 48-8</a>
illustrates this interaction.</p>
</div>
<div id="BNCGI" class="paragraph">
<div class="title"><strong>Figure 48-8 Using Jakarta Messaging Local Transactions</strong></div>
<p><span class="image"><img src="../images/jakartaeett_dt_033.png" alt="Diagram of local transactions, showing separate transactions for sending and consuming a message"></span></p>
</div>
<div class="paragraph">
<p>The sending of one or more messages to one or more destinations by
Client 1 can form a single transaction, because it forms a single set of
interactions with the Messaging provider using a single <code>JMSContext</code>.
Similarly, the receiving of one or more messages from one or more
destinations by Client 2 also forms a single transaction using a single
<code>JMSContext</code>. But because the two clients have no direct interaction and
are using two different <code>JMSContext</code> objects, no transactions can take
place between them.</p>
</div>
<div class="paragraph">
<p>Another way of putting this is that a transaction is a contract between
a client and a Messaging provider that defines whether a message is sent to a
destination or whether a message is received from the destination. It is
not a contract between the sending client and the receiving client.</p>
</div>
<div class="paragraph">
<p>This is the fundamental difference between messaging and synchronized
processing. Instead of tightly coupling the sender and the receiver of a
message, JMS couples the sender of a message with the destination, and
it separately couples the destination with the receiver of the message.
Therefore, while the sends and receives each have a tight coupling with
the Messaging provider, they do not have any coupling with each other.</p>
</div>
<div class="paragraph">
<p>When you create a <code>JMSContext</code>, you can specify whether it is transacted
by using the <code>JMSContext.SESSION_TRANSACTED</code> argument to the
<code>createContext</code> method. For example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (JMSContext context = connectionFactory.createContext(
        JMSContext.SESSION_TRANSACTED);) {
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>commit</code> and the <code>rollback</code> methods for local transactions are
associated with the session that underlies the <code>JMSContext</code>. You can
combine operations on more than one queue or topic, or on a combination
of queues and topics, in a single transaction if you use the same
session to perform the operations. For example, you can use the same
<code>JMSContext</code> to receive a message from a queue and send a message to a
topic in the same transaction.</p>
</div>
<div class="paragraph">
<p>The example in <a href="#BNCGJ">Using Local Transactions</a>
shows how to use Jakarta Messaging local transactions.</p>
</div>
<div class="paragraph">
<p><a id="BABFIFAJ"></a><a id="sending-messages-asynchronously"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_sending_messages_asynchronously">1.4.5. Sending Messages Asynchronously</h4>
<div class="paragraph">
<p>Normally, when you send a persistent message, the <code>send</code> method blocks
until the Messaging provider confirms that the message was sent successfully.
The asynchronous send mechanism allows your application to send a
message and continue work while waiting to learn whether the send
completed.</p>
</div>
<div class="paragraph">
<p>This feature is currently available only in application clients and Java
SE clients.</p>
</div>
<div class="paragraph">
<p>Sending a message asynchronously involves supplying a callback object.
You specify a <code>CompletionListener</code> with an <code>onCompletion</code> method. For
example, the following code instantiates a <code>CompletionListener</code> named
<code>SendListener</code>. It then calls the <code>setAsync</code> method to specify that
sends from this producer should be asynchronous and should use the
specified listener:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CompletionListener listener = <span class="keyword">new</span> SendListener();
context.createProducer().setAsync(listener).send(dest, message);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>CompletionListener</code> class must implement two methods,
<code>onCompletion</code> and <code>onException</code>. The <code>onCompletion</code> method is called if
the send succeeds, and the <code>onException</code> method is called if it fails. A
simple implementation of these methods might look like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> onCompletion(Message message) {
    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">onCompletion method: Send has completed.</span><span class="delimiter">&quot;</span></span>);
}

<span class="annotation">@Override</span>
<span class="directive">public</span> <span class="type">void</span> onException(Message message, <span class="exception">Exception</span> e) {
    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">onException method: send failed: </span><span class="delimiter">&quot;</span></span> + e.toString());
    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unsent message is: </span><span class="char">\n</span><span class="delimiter">&quot;</span></span> + message);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNCGL"></a><a id="using-the-jms-api-in-jakarta-ee-applications"></a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_jakarta_messaging_in_jakarta_ee_applications">1.5. Using Jakarta Messaging in Jakarta EE Applications</h3>
<div class="paragraph">
<p>This section describes how using Jakarta Messaging in enterprise bean
applications or web applications differs from using it in application
clients.</p>
</div>
<div class="paragraph">
<p><a id="CHDGICJB"></a><a id="overview-of-using-the-jms-api"></a></p>
</div>
<div class="sect3">
<h4 id="_overview_of_using_jakarta_messaging">1.5.1. Overview of Using Jakarta Messaging</h4>
<div class="paragraph">
<p>A general rule in the Jakarta EE platform specification applies to all Java
EE components that use Jakarta Messaging within enterprise bean or web containers:
Application components in the web and enterprise bean containers must not attempt to
create more than one active (not closed) <code>Session</code> object per
connection. Multiple <code>JMSContext</code> objects are permitted, however, since
they combine a single connection and a single session.</p>
</div>
<div class="paragraph">
<p>This rule does not apply to application clients. The application client
container supports the creation of multiple sessions for each
connection.</p>
</div>
<div class="paragraph">
<p><a id="BABHFBDH"></a><a id="creating-resources-for-jakarta-ee-applications"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_resources_for_jakarta_ee_applications">1.5.2. Creating Resources for Jakarta EE Applications</h4>
<div class="paragraph">
<p>You can use annotations to create application-specific connection
factories and destinations for Jakarta EE enterprise bean or web
components. The resources you create in this way are visible only to the
application for which you create them.</p>
</div>
<div class="paragraph">
<p>You can also use deployment descriptor elements to create these
resources. Elements specified in the deployment descriptor override
elements specified in annotations. See
<a href="#BCGDJDFB">Packaging Applications</a> for basic
information about deployment descriptors. You must use a deployment
descriptor to create application-specific resources for application
clients.</p>
</div>
<div class="paragraph">
<p>To create a destination, use a <code>@JMSDestinationDefinition</code> annotation
like the following on a class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JMSDestinationDefinition</span>(
    name = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:app/jms/myappTopic</span><span class="delimiter">&quot;</span></span>,
    interfaceName = <span class="string"><span class="delimiter">&quot;</span><span class="content">javax.jms.Topic</span><span class="delimiter">&quot;</span></span>,
    destinationName = <span class="string"><span class="delimiter">&quot;</span><span class="content">MyPhysicalAppTopic</span><span class="delimiter">&quot;</span></span>
  )</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>name</code>, <code>interfaceName</code>, and <code>destinationName</code> elements are
required. You can optionally specify a <code>description</code> element. To create
multiple destinations, enclose them in a <code>@JMSDestinationDefinitions</code>
annotation, separated by commas.</p>
</div>
<div class="paragraph">
<p>To create a connection factory, use a <code>@JMSConnectionFactoryDefinition</code>
annotation like the following on a class:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JMSConnectionFactoryDefinition</span>(
    name=<span class="string"><span class="delimiter">&quot;</span><span class="content">java:app/jms/MyConnectionFactory</span><span class="delimiter">&quot;</span></span>
)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>name</code> element is required. You can optionally specify a number of
other elements, such as <code>clientId</code> if you want to use the connection
factory for durable subscriptions, or <code>description</code>. If you do not
specify the <code>interfaceName</code> element, the default interface is
<code>javax.jms.ConnectionFactory</code>. To create multiple connection factories,
enclose them in a <code>@JMSConnectionFactoryDefinitions</code> annotation,
separated by commas.</p>
</div>
<div class="paragraph">
<p>You need to specify the annotation only once for a given application, in
any of the components.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Note</strong>:</p>
</div>
<div class="paragraph">
<p>If your application contains one or more message-driven beans, you may
want to place the annotation on one of the message-driven beans. If you
place the annotation on a sending component such as an application
client, you need to specify the <code>mappedName</code> element to look up the
topic, instead of using the <code>destinationLookup</code> property of the
activation configuration specification.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>When you inject the resource into a component, use the value of the
<code>name</code> element in the definition annotation as the value of the <code>lookup</code>
element in the <code>@Resource</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:app/jms/myappTopic</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> Topic topic;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following portable JNDI namespaces are available. Which ones you can
use depends on how your application is packaged.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>java:global</code>: Makes the resource available to all deployed
applications</p>
</li>
<li>
<p><code>java:app</code>: Makes the resource available to all components in all
modules in a single application</p>
</li>
<li>
<p><code>java:module</code>: Makes the resource available to all components within a
given module (for example, all enterprise beans within a Jakarta Enterprise Beans module)</p>
</li>
<li>
<p><code>java:comp</code>: Makes the resource available to a single component only
(except in a web application, where it is equivalent to <code>java:module</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>See the API documentation for details on these annotations. The examples
in <a href="#BABBABFC">Sending and Receiving Messages
Using a Simple Web Application</a>, <a href="#BNCGW">Sending
Messages from a Session Bean to an MDB</a>, and
<a href="#BNCHF">Using an Entity to Join Messages from Two
MDBs</a> all use the <code>@JMSDestinationDefinition</code> annotation. The other JMS
examples do not use these annotations. The examples that consist only of
application clients are not deployed in the application server and must
therefore communicate with each other using administratively created
resources that exist outside of individual applications.</p>
</div>
<div class="paragraph">
<p><a id="BNCGM"></a><a id="using-resource-injection-in-enterprise-bean-or-web-components"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_using_resource_injection_in_enterprise_bean_or_web_components">1.5.3. Using Resource Injection in Enterprise Bean or Web Components</h4>
<div class="paragraph">
<p>You may use resource injection to inject both administered objects and
<code>JMSContext</code> objects in Jakarta EE applications.</p>
</div>
<div class="paragraph">
<p><a id="CHDCHDIJ"></a><a id="injecting-a-connectionfactory-queue-or-topic"></a></p>
</div>
<div class="sect4">
<h5 id="_injecting_a_connectionfactory_queue_or_topic">Injecting a ConnectionFactory, Queue, or Topic</h5>
<div class="paragraph">
<p>Normally, you use the <code>@Resource</code> annotation to inject a
<code>ConnectionFactory</code>, <code>Queue</code>, or <code>Topic</code> into your Jakarta EE application.
These objects must be created administratively before you deploy your
application. You may want to use the default connection factory, whose
JNDI name is <code>java:comp/DefaultJMSConnectionFactory</code>.</p>
</div>
<div class="paragraph">
<p>When you use resource injection in an application client component, you
normally declare the Messaging resource static:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:comp/DefaultJMSConnectionFactory</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="directive">static</span> ConnectionFactory connectionFactory;

<span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">jms/MyQueue</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">Queue</span> queue;</code></pre>
</div>
</div>
<div class="paragraph">
<p>However, when you use this annotation in a session bean, a
message-driven bean, or a web component, do not declare the resource
static:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:comp/DefaultJMSConnectionFactory</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> ConnectionFactory connectionFactory;

<span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">jms/MyTopic</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> Topic topic;</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you declare the resource static in these components, runtime errors
will result.</p>
</div>
<div class="paragraph">
<p><a id="BABCJBEE"></a><a id="injecting-a-jmscontext-object"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_injecting_a_jmscontext_object">Injecting a JMSContext Object</h5>
<div class="paragraph">
<p>To access a <code>JMSContext</code> object in an enterprise bean or web component,
instead of injecting the <code>ConnectionFactory</code> resource and then creating
a <code>JMSContext</code>, you can use the <code>@Inject</code> and <code>@JMSConnectionFactory</code>
annotations to inject a <code>JMSContext</code>. To use the default connection
factory, use code like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Inject</span>
<span class="directive">private</span> JMSContext context1;</code></pre>
</div>
</div>
<div class="paragraph">
<p>To use your own connection factory, use code like the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Inject</span>
<span class="annotation">@JMSConnectionFactory</span>(<span class="string"><span class="delimiter">&quot;</span><span class="content">jms/MyConnectionFactory</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> JMSContext context2;</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNCGN"></a><a id="using-jakarta-ee-components-to-produce-and-to-synchronously-receive-messages"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_jakarta_ee_components_to_produce_and_to_synchronously_receive_messages">1.5.4. Using Jakarta EE Components to Produce and to Synchronously Receive Messages</h4>
<div class="paragraph">
<p>An application that produces messages or synchronously receives them can
use a Jakarta EE web or Jakarta Enterprise Beans component, such as a managed bean, a servlet,
or a session bean, to perform these operations. The example in
<a href="#BNCGW">Sending Messages from a Session Bean to
an MDB</a> uses a stateless session bean to send messages to a topic. The
example in <a href="#BABBABFC">Sending and Receiving
Messages Using a Simple Web Application</a> uses managed beans to produce
and to consume messages.</p>
</div>
<div class="paragraph">
<p>Because a synchronous receive with no specified timeout ties up server
resources, this mechanism usually is not the best application design for
a web or Jakarta Enterprise Beans component. Instead, use a synchronous receive that
specifies a timeout value, or use a message-driven bean to receive
messages asynchronously. For details about synchronous receives, see
<a href="#BNCEP">Jakarta Messaging Message Consumers</a>.</p>
</div>
<div class="paragraph">
<p>Using Jakarta Messaging in a Jakarta EE component is in many ways similar to
using it in an application client. The main differences are the areas of
resource management and transactions.</p>
</div>
<div class="paragraph">
<p><a id="BNCGO"></a><a id="managing-jms-resources-in-web-and-ejb-components"></a></p>
</div>
<div class="sect4">
<h5 id="_managing_jakarta_messaging_resources_in_web_and_jakarta_enterprise_beans_components">Managing Jakarta Messaging Resources in Web and Jakarta Enterprise Beans Components</h5>
<div class="paragraph">
<p>The Jakarta Messaging resources are a connection and a session, usually combined in a
<code>JMSContext</code> object. In general, it is important to release Messaging
resources when they are no longer being used. Here are some useful
practices to follow.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>If you wish to maintain a Messaging resource only for the life span of a
business method, use a <code>try</code>-with-resources statement to create the
<code>JMSContext</code> so that it will be closed automatically at the end of the
<code>try</code> block.</p>
</li>
<li>
<p>To maintain a Messaging resource for the duration of a transaction or
request, inject the <code>JMSContext</code> as described in
<a href="#BABCJBEE">Injecting a JMSContext Object</a>. This will also cause the
resource to be released when it is no longer needed.</p>
</li>
<li>
<p>If you would like to maintain a Messaging resource for the life span of an
enterprise bean instance, you can use a <code>@PostConstruct</code> callback method
to create the resource and a <code>@PreDestroy</code> callback method to close the
resource. However, there is normally no need to do this, since
application servers usually maintain a pool of connections. If you use a
stateful session bean and you wish to maintain the Messaging resource in a
cached state, you must close the resource in a <code>@PrePassivate</code> callback
method and set its value to <code>null</code>, and you must create it again in a
<code>@PostActivate</code> callback method.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="BNCGP"></a><a id="managing-transactions-in-session-beans"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_managing_transactions_in_session_beans">Managing Transactions in Session Beans</h5>
<div class="paragraph">
<p>Instead of using local transactions, you use Jakarta transactions. You can
use either container-managed transactions or bean-managed transactions.
Normally, you use container-managed transactions for bean methods that
perform sends or receives, allowing the enterprise bean container to handle
transaction demarcation. Because container-managed transactions are the
default, you do not have to specify them.</p>
</div>
<div class="paragraph">
<p>You can use bean-managed transactions and the
<code>javax.transaction.UserTransaction</code> interface&#8217;s transaction demarcation
methods, but you should do so only if your application has special
requirements and you are an expert in using transactions. Usually,
container-managed transactions produce the most efficient and correct
behavior. This tutorial does not provide any examples of bean-managed
transactions.</p>
</div>
<div class="paragraph">
<p><a id="BNCGQ"></a><a id="using-message-driven-beans-to-receive-messages-asynchronously"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_message_driven_beans_to_receive_messages_asynchronously">1.5.5. Using Message-Driven Beans to Receive Messages Asynchronously</h4>
<div class="paragraph">
<p>The sections <a href="#GIPKO">What Is a Message-Driven Bean?</a>
and <a href="#BNCDW">How Does Jakarta Messaging Work with the
Jakarta EE Platform?</a> describe how the Jakarta EE platform supports a special
kind of enterprise bean, the message-driven bean, which allows Jakarta EE
applications to process Jakarta Messaging messages asynchronously. Other Jakarta EE web
and Jakarta Enterprise Beans components allow you to send messages and to receive them
synchronously but not asynchronously.</p>
</div>
<div class="paragraph">
<p>A message-driven bean is a message listener to which messages can be
delivered from either a queue or a topic. The messages can be sent by
any Jakarta EE component (from an application client, another enterprise
bean, or a web component) or from an application or a system that does
not use Jakarta EE technology.</p>
</div>
<div class="paragraph">
<p>A message-driven bean class has the following requirements.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>It must be annotated with the <code>@MessageDriven</code> annotation if it does
not use a deployment descriptor.</p>
</li>
<li>
<p>The class must be defined as <code>public</code>, but not as <code>abstract</code> or
<code>final</code>.</p>
</li>
<li>
<p>It must contain a public constructor with no arguments.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>It is recommended, but not required, that a message-driven bean class
implement the message listener interface for the message type it
supports. A bean that supports Jakarta Messaging implements the
<code>javax.jms.MessageListener</code> interface, which means that it must provide
an <code>onMessage</code> method with the following signature:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">void</span> onMessage(Message inMessage)</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>onMessage</code> method is called by the bean&#8217;s container when a message
has arrived for the bean to service. This method contains the business
logic that handles the processing of the message. It is the
message-driven bean&#8217;s responsibility to parse the message and perform
the necessary business logic.</p>
</div>
<div class="paragraph">
<p>A message-driven bean differs from an application client&#8217;s message
listener in the following ways.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>In an application client, you must create a <code>JMSContext</code>, then create
a <code>JMSConsumer</code>, then call <code>setMessageListener</code> to activate the
listener. For a message-driven bean, you need only define the class and
annotate it, and the enterprise bean container creates it for you.</p>
</li>
<li>
<p>The bean class uses the <code>@MessageDriven</code> annotation, which typically
contains an <code>activationConfig</code> element containing
<code>@ActivationConfigProperty</code> annotations that specify properties used by
the bean or the connection factory. These properties can include the
connection factory, a destination type, a durable subscription, a
message selector, or an acknowledgment mode. Some of the examples in
<a href="#BNCGV">Chapter 49, "Java Message Service Examples"</a>
set these properties. You can also set the properties in the deployment
descriptor.</p>
</li>
<li>
<p>The application client container has only one instance of a
<code>MessageListener</code>, which is called on a single thread at a time. A
message-driven bean, however, may have multiple instances, configured by
the container, which may be called concurrently by multiple threads
(although each instance is called by only one thread at a time).
Message-driven beans may therefore allow much faster processing of
messages than message listeners.</p>
</li>
<li>
<p>You do not need to specify a message acknowledgment mode unless you
use bean-managed transactions. The message is consumed in the
transaction in which the <code>onMessage</code> method is invoked.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#GJKOH">Table 48-3</a> lists the activation configuration properties
defined by the JMS specification.</p>
</div>
<div class="paragraph">
<p><a id="sthref199"></a><a id="GJKOH"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 48-3 @ActivationConfigProperty Settings for Message-Driven Beans</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Property Name</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Description</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>acknowledgeMode</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Acknowledgment mode, used only for bean-managed
transactions; the default is <code>Auto-acknowledge</code> (<code>Dups-ok-acknowledge</code>
is also permitted)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>destinationLookup</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The lookup name of the queue or topic from which
the bean will receive messages</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>destinationType</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Either <code>javax.jms.Queue</code> or <code>javax.jms.Topic</code></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>subscriptionDurability</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For durable subscriptions, set the value to
<code>Durable</code>; see <a href="#BNCGD">Creating Durable
Subscriptions</a> for more information</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>clientId</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For durable subscriptions, the client ID for the connection
(optional)</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>subscriptionName</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">For durable subscriptions, the name of the
subscription</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>messageSelector</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">A string that filters messages; see
<a href="#BNCER">Jakarta Messaging Message Selectors</a> for information</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>connectionFactoryLookup</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">The lookup name of the connection factory to
be used to connect to the Messaging provider from which the bean will receive
messages</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>For example, here is the message-driven bean used in
<a href="#BNBPK">Receiving Messages Asynchronously Using a
Message-Driven Bean</a>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@MessageDriven</span>(activationConfig = {
    <span class="annotation">@ActivationConfigProperty</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">destinationLookup</span><span class="delimiter">&quot;</span></span>,
            propertyValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">jms/MyQueue</span><span class="delimiter">&quot;</span></span>),
    <span class="annotation">@ActivationConfigProperty</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">destinationType</span><span class="delimiter">&quot;</span></span>,
            propertyValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">javax.jms.Queue</span><span class="delimiter">&quot;</span></span>)
})
<span class="directive">public</span> <span class="type">class</span> <span class="class">SimpleMessageBean</span> <span class="directive">implements</span> MessageListener {

    <span class="annotation">@Resource</span>
    <span class="directive">private</span> MessageDrivenContext mdc;
    <span class="directive">static</span> <span class="directive">final</span> <span class="predefined-type">Logger</span> logger = <span class="predefined-type">Logger</span>.getLogger(<span class="string"><span class="delimiter">&quot;</span><span class="content">SimpleMessageBean</span><span class="delimiter">&quot;</span></span>);

    <span class="directive">public</span> SimpleMessageBean() {
    }

    <span class="annotation">@Override</span>
    <span class="directive">public</span> <span class="type">void</span> onMessage(Message inMessage) {

        <span class="keyword">try</span> {
            <span class="keyword">if</span> (inMessage <span class="keyword">instanceof</span> TextMessage) {
                logger.log(<span class="predefined-type">Level</span>.INFO,
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">MESSAGE BEAN: Message received: {0}</span><span class="delimiter">&quot;</span></span>,
                        inMessage.getBody(<span class="predefined-type">String</span>.class));
            } <span class="keyword">else</span> {
                logger.log(<span class="predefined-type">Level</span>.WARNING,
                        <span class="string"><span class="delimiter">&quot;</span><span class="content">Message of wrong type: {0}</span><span class="delimiter">&quot;</span></span>,
                        inMessage.getClass().getName());
            }
        } <span class="keyword">catch</span> (JMSException e) {
            logger.log(<span class="predefined-type">Level</span>.SEVERE,
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">SimpleMessageBean.onMessage: JMSException: {0}</span><span class="delimiter">&quot;</span></span>,
                    e.toString());
            mdc.setRollbackOnly();
        }
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>If Jakarta Messaging is integrated with the application server using a resource
adapter, the Messaging resource adapter handles these tasks for the enterprise bean
container.</p>
</div>
<div class="paragraph">
<p>The bean class commonly injects a <code>MessageDrivenContext</code> resource, which
provides some additional methods you can use for transaction management
(<code>setRollbackOnly</code>, for example):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="annotation">@Resource</span>
    <span class="directive">private</span> MessageDrivenContext mdc;</code></pre>
</div>
</div>
<div class="paragraph">
<p>A message-driven bean never has a local or remote interface. Instead, it
has only a bean class.</p>
</div>
<div class="paragraph">
<p>A message-driven bean is similar in some ways to a stateless session
bean: Its instances are relatively short-lived and retain no state for a
specific client. The instance variables of the message-driven bean
instance can contain some state across the handling of client messages:
for example, an open database connection, or an object reference to an
enterprise bean object.</p>
</div>
<div class="paragraph">
<p>Like a stateless session bean, a message-driven bean can have many
interchangeable instances running at the same time. The container can
pool these instances to allow streams of messages to be processed
concurrently. The container attempts to deliver messages in
chronological order when that would not impair the concurrency of
message processing, but no guarantees are made as to the exact order in
which messages are delivered to the instances of the message-driven bean
class. If message order is essential to your application, you may want
to configure your application server to use just one instance of the
message-driven bean.</p>
</div>
<div class="paragraph">
<p>For details on the lifecycle of a message-driven bean, see
<a href="#GIPKW">The Lifecycle of a Message-Driven Bean</a>.</p>
</div>
<div class="paragraph">
<p><a id="BNCGS"></a><a id="managing-jta-transactions"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_managing_jakarta_transactions">1.5.6. Managing JakartA Transactions</h4>
<div class="paragraph">
<p>Jakarta EE application clients and Java SE clients use JMS local
transactions (described in <a href="#BNCGH">Using Jakarta Messaging
Local Transactions</a>), which allow the grouping of sends and receives
within a specific Messaging session. Jakarta EE applications that run in the web
or enterprise bean container commonly use Jakarta Transactions to ensure the integrity
of accesses to external resources. The key difference between a Jakarta
transaction and a Jakarta Messaging local transaction is that a Jakarta transaction is
controlled by the application server&#8217;s transaction managers. Jakarta
transactions may be distributed, which means that they can encompass
multiple resources in the same transaction, such as a Messaging provider and a
database.</p>
</div>
<div class="paragraph">
<p>For example, distributed transactions allow multiple applications to
perform atomic updates on the same database, and they allow a single
application to perform atomic updates on multiple databases.</p>
</div>
<div class="paragraph">
<p>In a Jakarta EE application that uses Jakarta Messaging, you can use transactions
to combine message sends or receives with database updates and other
resource manager operations. You can access resources from multiple
application components within a single transaction. For example, a
servlet can start a transaction, access multiple databases, invoke an
enterprise bean that sends a Jakarta Messaging message, invoke another enterprise bean
that modifies an EIS system using the Connector Architecture, and
finally commit the transaction. Your application cannot, however, both
send a Jakarta Messaging message and receive a reply to it within the same
transaction.</p>
</div>
<div class="paragraph">
<p>Jakarta Transactions within the enterprise bean and web containers can be either of two
kinds.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Container-managed transactions: The container controls the integrity
of your transactions without your having to call <code>commit</code> or <code>rollback</code>.
Container-managed transactions are easier to use than bean-managed
transactions. You can specify appropriate transaction attributes for
your enterprise bean methods.</p>
<div class="paragraph">
<p>Use the <code>Required</code> transaction attribute (the default) to ensure that a
method is always part of a transaction. If a transaction is in progress
when the method is called, the method will be part of that transaction;
if not, a new transaction will be started before the method is called
and will be committed when the method returns. See
<a href="#BNCIK">Transaction Attributes</a> for more
information.</p>
</div>
</li>
<li>
<p>Bean-managed transactions: You can use these in conjunction with the
<code>javax.transaction.UserTransaction</code> interface, which provides its own
<code>commit</code> and <code>rollback</code> methods you can use to delimit transaction
boundaries. Bean-managed transactions are recommended only for those who
are experienced in programming transactions.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You can use either container-managed transactions or bean-managed
transactions with message-driven beans. To ensure that all messages are
received and handled within the context of a transaction, use
container-managed transactions and use the <code>Required</code> transaction
attribute (the default) for the <code>onMessage</code> method.</p>
</div>
<div class="paragraph">
<p>When you use container-managed transactions, you can call the following
<code>MessageDrivenContext</code> methods.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>setRollbackOnly</code>: Use this method for error handling. If an exception
occurs, <code>setRollbackOnly</code> marks the current transaction so that the only
possible outcome of the transaction is a rollback.</p>
</li>
<li>
<p><code>getRollbackOnly</code>: Use this method to test whether the current
transaction has been marked for rollback.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If you use bean-managed transactions, the delivery of a message to the
<code>onMessage</code> method takes place outside the Jakarta transaction context. The
transaction begins when you call the <code>UserTransaction.begin</code> method
within the <code>onMessage</code> method, and it ends when you call
<code>UserTransaction.commit</code> or <code>UserTransaction.rollback</code>. Any call to the
<code>Connection.createSession</code> method must take place within the
transaction.</p>
</div>
<div class="paragraph">
<p>Using bean-managed transactions allows you to process the message by
using more than one transaction or to have some parts of the message
processing take place outside a transaction context. However, if you use
container-managed transactions, the message is received by the MDB and
processed by the <code>onMessage</code> method within the same transaction. It is
not possible to achieve this behavior with bean-managed transactions.</p>
</div>
<div class="paragraph">
<p>When you create a <code>JMSContext</code> in a Jakarta transaction (in the web or enterprise bean
container), the container ignores any arguments you specify, because it
manages all transactional properties. When you create a <code>JMSContext</code> in
the web or enterprise bean container and there is no Jakarta transaction, the value (if
any) passed to the <code>createContext</code> method should be
<code>JMSContext.AUTO_ACKNOWLEDGE</code> or <code>JMSContext.DUPS_OK_ACKNOWLEDGE</code>.</p>
</div>
<div class="paragraph">
<p>When you use container-managed transactions, you normally use the
<code>Required</code> transaction attribute (the default) for your enterprise
bean&#8217;s business methods.</p>
</div>
<div class="paragraph">
<p>You do not specify the activation configuration property
<code>acknowledgeMode</code> when you create a message-driven bean that uses
container-managed transactions. The container acknowledges the message
automatically when it commits the transaction.</p>
</div>
<div class="paragraph">
<p>If a message-driven bean uses bean-managed transactions, the message
receipt cannot be part of the bean-managed transaction. You can set the
activation configuration property <code>acknowledgeMode</code> to
<code>Auto-acknowledge</code> or <code>Dups-ok-acknowledge</code> to specify how you want the
message received by the message-driven bean to be acknowledged.</p>
</div>
<div class="paragraph">
<p>If the <code>onMessage</code> method throws a <code>RuntimeException</code>, the container
does not acknowledge processing the message. In that case, the Messaging
provider will redeliver the unacknowledged message in the future.</p>
</div>
<div class="paragraph">
<p><a id="BNCGU"></a><a id="further-information-about-jms"></a></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_further_information_about_jakarta_messaging">1.6. Further Information about Jakarta Messaging</h3>
<div class="paragraph">
<p>For more information about Jakarta Messaging, see</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Jakarta Messaging website:</p>
<div class="paragraph">
<p><code><a href="https://projects.eclipse.org/projects/ee4j.jms" class="bare">https://projects.eclipse.org/projects/ee4j.jms</a></code></p>
</div>
</li>
<li>
<p>Jakarta Messaging specification, version 2.0, available from:</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code><a href="https://jakarta.ee/specifications/messaging/2.0/" class="bare">https://jakarta.ee/specifications/messaging/2.0/</a></code></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_jakarta_messaging_examples">2. Jakarta Messaging Examples</h2>
<div class="sectionbody">
<div class="paragraph">
<p><a id="BNCGV"></a><a id="java-message-service-examples"></a></p>
</div>
<div class="paragraph">
<p>This chapter provides examples that show how to use Jakarta Messaging in
various kinds of Jakarta EE applications.</p>
</div>
<div class="paragraph">
<p><a id="A1251921"></a><a id="building-and-running-java-message-service-examples"></a></p>
</div>
<div class="sect2">
<h3 id="_building_and_running_jakarta_messaging_examples">2.1. Building and Running Jakarta Messaging Examples</h3>
<div class="paragraph">
<p>The examples are in the <code><em>tut-install</em>/examples/jms/</code> directory.</p>
</div>
<div class="paragraph">
<p>To build and run each example:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Use NetBeans IDE or Maven to compile, package, and in some cases
deploy the example.</p>
</li>
<li>
<p>Use NetBeans IDE, Maven, or the <code>appclient</code> command to run the
application client, or use the browser to run the web application
examples.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Before you deploy or run the examples, you need to create resources for
them. Some examples have a <code>glassfish-resources.xml</code> file that is used
to create resources for that example and others. You can use the
<code>asadmin</code> command to create the resources.</p>
</div>
<div class="paragraph">
<p>To use the <code>asadmin</code> and <code>appclient</code> commands, you need to put the
GlassFish Server <code>bin</code> directories in your command path, as described in
<a href="#GEXBC">SDK Installation Tips</a>.</p>
</div>
<div class="paragraph">
<p><a id="BABEFBHJ"></a><a id="overview-of-the-jms-examples"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_overview_of_the_jakarta_messaging_examples">2.2. Overview of the Jakarta Messaging Examples</h3>
<div class="paragraph">
<p>The following tables list the examples used in this chapter, describe
what they do, and link to the section that describes them fully. The
example directory for each example is relative to the
<code><em>tut-install</em>/examples/jms/</code> directory.</p>
</div>
<div class="paragraph">
<p><a id="sthref200"></a>[sthref201]]</p>
</div>
<div class="paragraph">
<p><strong>Table 49-1 Jakarta Messaging Examples That Show the Use of Jakarta EE Application Clients</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example Directory</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><strong>Description</strong></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>simple/producer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Using an application client to send messages; see
<a href="#BABIHCAE">Sending Messages</a></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>simple/synchconsumer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Using an application client to receive messages
synchronously; see <a href="#BNCFB">Receiving Messages
Synchronously</a></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>simple/asynchconsumer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Using an application client to receive
messages asynchronously; see <a href="#BNCFH">Using a
Message Listener for Asynchronous Message Delivery</a></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>simple/messagebrowser</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Using an application client to use a
<code>QueueBrowser</code> to browse a queue; see
<a href="#BNCFL">Browsing Messages on a Queue</a></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>simple/clientackconsumer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Using an application client to acknowledge
messages received synchronously; see
<a href="#BNCFX">Acknowledging Messages</a></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>durablesubscriptionexample</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Using an application client to create a
durable subscription on a topic; see
<a href="#BNCGG">Using Durable Subscriptions</a></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>transactedexample</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Using an application client to send and receive
messages in local transactions (also uses request-reply messaging); see
<a href="#BNCGJ">Using Local Transactions</a></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>shared/sharedconsumer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Using an application client to create shared
nondurable topic subscriptions; see
<a href="#BABIBEAC">Using Shared Nondurable Subscriptions</a></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>shared/shareddurableconsumer</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Using an application client to create
shared durable topic subscriptions; see
<a href="#BABEJBHA">Using Shared Durable Subscriptions</a></strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="sthref202"></a><a id="sthref203"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 49-2 Jakarta Messaging Examples That Show the Use of Jakarta EE Web and Enterprise Bean
Components</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 80%;">
<colgroup>
<col style="width: 25%;">
<col style="width: 75%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Example Directory</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong><strong>Description</strong></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>websimplemessage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Using managed beans to send messages and to receive
messages synchronously; see <a href="#BABBABFC">Sending
and Receiving Messages Using a Simple Web Application</a></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>simplemessage</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Using an application client to send messages, and
using a message-driven bean to receive messages asynchronously; see
<a href="#BNBPK">Receiving Messages Asynchronously Using a
Message-Driven Bean</a></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>clientsessionmdb</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Using a session bean to send messages, and using a
message-driven bean to receive messages; see
<a href="#BNCGW">Sending Messages from a Session Bean to
an MDB</a></strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><code>clientmdbentity</code></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Using an application client, two message-driven
beans, and JPA persistence to create a simple HR application; see
<a href="#BNCHF">Using an Entity to Join Messages from Two
MDBs</a></strong></p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="BNCFA"></a><a id="writing-simple-jms-applications"></a></p>
</div>
</div>
<div class="sect2">
<h3 id="_writing_simple_jakarta_messaging_applications">2.3. Writing Simple Jakarta Messaging Applications</h3>
<div class="paragraph">
<p>This section shows how to create, package, and run simple Messaging clients
that are packaged as application clients.</p>
</div>
<div class="paragraph">
<p><a id="CHDCEFGA"></a><a id="overview-of-writing-simple-jms-application"></a></p>
</div>
<div class="sect3">
<h4 id="_overview_of_writing_simple_jakarta_messaging_application">2.3.1. Overview of Writing Simple Jakarta Messaging Application</h4>
<div class="paragraph">
<p>The clients demonstrate the basic tasks a Jakarta Messaging application must perform:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Creating a <code>JMSContext</code></p>
</li>
<li>
<p>Creating message producers and consumers</p>
</li>
<li>
<p>Sending and receiving messages</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Each example uses two clients: one that sends messages and one that
receives them. You can run the clients in two terminal windows.</p>
</div>
<div class="paragraph">
<p>When you write a Messaging client to run in an enterprise bean application,
you use many of the same methods in much the same sequence as for an
application client. However, there are some significant differences.
<a href="#BNCGL">Using Jakarta Messaging in Jakarta EE
Applications</a> describes these differences, and this chapter provides
examples that illustrate them.</p>
</div>
<div class="paragraph">
<p>The examples for this section are in the
<code><em>tut-install</em>/examples/jms/simple/</code> directory, under the following
subdirectories:</p>
</div>
<div class="paragraph">
<p><code>producer/</code><br>
<code>synchconsumer/</code><br>
<code>asynchconsumer/</code><br>
<code>messagebrowser/</code><br>
<code>clientackconsumer/</code><br></p>
</div>
<div class="paragraph">
<p>Before running the examples, you need to start GlassFish Server and
create administered objects.</p>
</div>
<div class="paragraph">
<p><a id="BNCFD"></a><a id="starting-the-jms-provider"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_starting_the_jakarta_messaging_provider">2.3.2. Starting the Jakarta Messaging Provider</h4>
<div class="paragraph">
<p>When you use GlassFish Server, your Messaging provider is GlassFish Server.
Start the server as described in
<a href="#BNADI">Starting and Stopping GlassFish Server</a>.</p>
</div>
<div class="paragraph">
<p><a id="GKTJS"></a><a id="creating-jms-administered-objects"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_creating_jakarta_messaging_administered_objects">2.3.3. Creating Jakarta Messaging Administered Objects</h4>
<div class="paragraph">
<p>This example uses the following Jakarta Messaging administered objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A connection factory</p>
</li>
<li>
<p>Two destination resources: a topic and a queue</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before you run the applications, you can use the <code>asadmin add-resources</code>
command to create needed Messaging resources, specifying as the argument a
file named <code>glassfish-resources.xml</code>. This file can be created in any
project using NetBeans IDE, although you can also create it by hand. A
file for the needed resources is present in the
<code>jms/simple/producer/src/main/setup/</code> directory.</p>
</div>
<div class="paragraph">
<p>The Jakarta Messaging examples use a connection factory with the logical JNDI lookup
name <code>java:comp/DefaultJMSConnectionFactory</code>, which is preconfigured in
GlassFish Server.</p>
</div>
<div class="paragraph">
<p>You can also use the <code>asadmin create-jms-resource</code> command to create
resources, the <code>asadmin list-jms-resources</code> command to display their
names, and the <code>asadmin delete-jms-resource</code> command to remove them.</p>
</div>
<div class="paragraph">
<p><a id="BABHEFCB"></a><a id="to-create-resources-for-the-simple-examples"></a></p>
</div>
<div class="sect4">
<h5 id="_to_create_resources_for_the_simple_examples">To Create Resources for the Simple Examples</h5>
<div class="paragraph">
<p>A <code>glassfish-resources.xml</code> file in one of the Maven projects can create
all the resources needed for the simple examples.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>).</p>
</li>
<li>
<p>In a command window, go to the <code>Producer</code> example.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd tut-install/jms/simple/producer</code></pre>
</div>
</div>
</li>
<li>
<p>Create the resources using the <code>asadmin add-resources</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">asadmin add-resources src/main/setup/glassfish-resources.xml</code></pre>
</div>
</div>
</li>
<li>
<p>Verify the creation of the resources:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">asadmin list-jms-resources</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command lists the two destinations and connection factory specified
in the <code>glassfish-resources.xml</code> file in addition to the platform
default connection factory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jms/MyQueue
jms/MyTopic
jms/__defaultConnectionFactory
Command list-jms-resources executed successfully.</code></pre>
</div>
</div>
<div class="paragraph">
<p>In GlassFish Server, the Jakarta EE <code>java:comp/DefaultJMSConnectionFactory</code>
resource is mapped to a connection factory named
<code>jms/__defaultConnectionFactory</code>.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="BABEEABE"></a><a id="building-all-the-simple-examples"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_building_all_the_simple_examples">2.3.4. Building All the Simple Examples</h4>
<div class="paragraph">
<p>To run the simple examples using GlassFish Server, package each example
in an application client JAR file. The application client JAR file
requires a manifest file, located in the <code>src/main/java/META-INF/</code>
directory for each example, along with the <code>.class</code> file.</p>
</div>
<div class="paragraph">
<p>The <code>pom.xml</code> file for each example specifies a plugin that creates an
application client JAR file. You can build the examples using either
NetBeans IDE or Maven.</p>
</div>
<div class="paragraph">
<p><a id="CHDJEJCD"></a><a id="to-build-all-the-simple-examples-using-netbeans-ide"></a></p>
</div>
<div class="sect4">
<h5 id="_to_build_all_the_simple_examples_using_netbeans_ide">To Build All the Simple Examples Using NetBeans IDE</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>From the File menu, choose Open Project.</p>
</li>
<li>
<p>In the Open Project dialog box, navigate to:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/jms</code></pre>
</div>
</div>
</li>
<li>
<p>Expand the <code>jms</code> node and select the <code>simple</code> folder.</p>
</li>
<li>
<p>Click Open Project to open all the simple examples.</p>
</li>
<li>
<p>In the Projects tab, right-click the <code>simple</code> project and select
Build to build all the examples.</p>
<div class="paragraph">
<p>This command places the application client JAR files in the <code>target</code>
directories for the examples.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="CHDGHJAA"></a><a id="to-build-all-the-simple-examples-using-maven"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_to_build_all_the_simple_examples_using_maven">To Build All the Simple Examples Using Maven</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In a terminal window, go to the <code>simple</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd tut-install/jms/simple/</code></pre>
</div>
</div>
</li>
<li>
<p>Enter the following command to build all the projects:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">mvn install</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command places the application client JAR files in the <code>target</code>
directories for the examples.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="BABIHCAE"></a><a id="sending-messages"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_sending_messages">2.3.5. Sending Messages</h4>
<div class="paragraph">
<p>This section describes how to use a client to send messages. The
<code>Producer.java</code> client will send messages in all of these examples.</p>
</div>
<div class="paragraph">
<p><a id="CHDGHJHH"></a><a id="general-steps-performed-in-the-example"></a></p>
</div>
<div class="sect4">
<h5 id="_general_steps_performed_in_the_example">General Steps Performed in the Example</h5>
<div class="paragraph">
<p>General steps this example performs are as follows.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Inject resources for the administered objects used by the example.</p>
</li>
<li>
<p>Accept and verify command-line arguments. You can use this example
to send any number of messages to either a queue or a topic, so you
specify the destination type and the number of messages on the command
line when you run the program.</p>
</li>
<li>
<p>Create a <code>JMSContext</code>, then send the specified number of text
messages in the form of strings, as described in
<a href="#BNCEW">Message Bodies</a>.</p>
</li>
<li>
<p>Send a final message of type <code>Message</code> to indicate that the consumer
should expect no more messages.</p>
</li>
<li>
<p>Catch any exceptions.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="CHDFBABB"></a><a id="the-producer.java-client"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_the_producer_java_client">The Producer.java Client</h5>
<div class="paragraph">
<p>The sending client, <code>Producer.java</code>, performs the following steps.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Injects resources for a connection factory, queue, and topic:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:comp/DefaultJMSConnectionFactory</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="directive">static</span> ConnectionFactory connectionFactory;
<span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">jms/MyQueue</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">Queue</span> queue;
<span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">jms/MyTopic</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="directive">static</span> Topic topic;</code></pre>
</div>
</div>
</li>
<li>
<p>Retrieves and verifies command-line arguments that specify the
destination type and the number of arguments:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">final</span> <span class="type">int</span> NUM_MSGS;
<span class="predefined-type">String</span> destType = args[<span class="integer">0</span>];
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Destination type is </span><span class="delimiter">&quot;</span></span> + destType);
<span class="keyword">if</span> ( ! ( destType.equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">queue</span><span class="delimiter">&quot;</span></span>) || destType.equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">topic</span><span class="delimiter">&quot;</span></span>) ) ) {
    <span class="predefined-type">System</span>.err.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Argument must be </span><span class="char">\&quot;</span><span class="content">queue</span><span class="char">\&quot;</span><span class="content"> or </span><span class="delimiter">&quot;</span></span> + <span class="string"><span class="delimiter">&quot;</span><span class="char">\&quot;</span><span class="content">topic</span><span class="char">\&quot;</span><span class="delimiter">&quot;</span></span>);
    <span class="predefined-type">System</span>.exit(<span class="integer">1</span>);
}
<span class="keyword">if</span> (args.length == <span class="integer">2</span>){
    NUM_MSGS = (<span class="keyword">new</span> <span class="predefined-type">Integer</span>(args[<span class="integer">1</span>])).intValue();
} <span class="keyword">else</span> {
    NUM_MSGS = <span class="integer">1</span>;
}</code></pre>
</div>
</div>
</li>
<li>
<p>Assigns either the queue or the topic to a destination object, based
on the specified destination type:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Destination</span> dest = <span class="predefined-constant">null</span>;
<span class="keyword">try</span> {
    <span class="keyword">if</span> (destType.equals(<span class="string"><span class="delimiter">&quot;</span><span class="content">queue</span><span class="delimiter">&quot;</span></span>)) {
        dest = (<span class="predefined-type">Destination</span>) queue;
    } <span class="keyword">else</span> {
        dest = (<span class="predefined-type">Destination</span>) topic;
    }
} <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
    <span class="predefined-type">System</span>.err.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Error setting destination: </span><span class="delimiter">&quot;</span></span> + e.toString());
    <span class="predefined-type">System</span>.exit(<span class="integer">1</span>);
}</code></pre>
</div>
</div>
</li>
<li>
<p>Within a <code>try</code>-with-resources block, creates a <code>JMSContext</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (JMSContext context = connectionFactory.createContext();) {</code></pre>
</div>
</div>
</li>
<li>
<p>Sets the message count to zero, then creates a <code>JMSProducer</code> and
sends one or more messages to the destination and increments the count.
Messages in the form of strings are of the <code>TextMessage</code> message type:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    <span class="type">int</span> count = <span class="integer">0</span>;
    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; NUM_MSGS; i++) {
        <span class="predefined-type">String</span> message = <span class="string"><span class="delimiter">&quot;</span><span class="content">This is message </span><span class="delimiter">&quot;</span></span> + (i + <span class="integer">1</span>)
                + <span class="string"><span class="delimiter">&quot;</span><span class="content"> from producer</span><span class="delimiter">&quot;</span></span>;
        <span class="comment">// Comment out the following line to send many messages</span>
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Sending message: </span><span class="delimiter">&quot;</span></span> + message);
        context.createProducer().send(dest, message);
        count += <span class="integer">1</span>;
    }
    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Text messages sent: </span><span class="delimiter">&quot;</span></span> + count);</code></pre>
</div>
</div>
</li>
<li>
<p>Sends an empty control message to indicate the end of the message
stream:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">    context.createProducer().send(dest, context.createMessage());</code></pre>
</div>
</div>
<div class="paragraph">
<p>Sending an empty message of no specified type is a convenient way for an
application to indicate to the consumer that the final message has
arrived.</p>
</div>
</li>
<li>
<p>Catches and handles any exceptions. The end of the
<code>try</code>-with-resources block automatically causes the <code>JMSContext</code> to be
closed:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">} <span class="keyword">catch</span> (<span class="exception">Exception</span> e) {
    <span class="predefined-type">System</span>.err.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Exception occurred: </span><span class="delimiter">&quot;</span></span> + e.toString());
    <span class="predefined-type">System</span>.exit(<span class="integer">1</span>);
}
<span class="predefined-type">System</span>.exit(<span class="integer">0</span>);</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="CHDHIIHE"></a><a id="to-run-the-producer-client"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_to_run_the_producer_client">To Run the Producer Client</h5>
<div class="paragraph">
<p>You can run the client using the <code>appclient</code> command. The <code>Producer</code>
client takes one or two command-line arguments: a destination type and,
optionally, a number of messages. If you do not specify a number of
messages, the client sends one message.</p>
</div>
<div class="paragraph">
<p>You will use the client to send three messages to a queue.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish Server</a>)
and that you have created resources and built the simple Jakarta Messaging examples
(see <a href="#GKTJS">Creating Jakarta Messaging Administered Objects</a> and
<a href="#BABEEABE">Building All the Simple Examples</a>).</p>
</li>
<li>
<p>In a terminal window, go to the <code>producer</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd producer</code></pre>
</div>
</div>
</li>
<li>
<p>Run the <code>Producer</code> program, sending three messages to the queue:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/producer.jar queue <span class="integer">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the program looks like this (along with some additional
output):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Destination</span> type is queue
Sending message: This is message <span class="integer">1</span> from producer
Sending message: This is message <span class="integer">2</span> from producer
Sending message: This is message <span class="integer">3</span> from producer
Text messages sent: <span class="integer">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The messages are now in the queue, waiting to be received.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Note</strong>:</p>
</div>
<div class="paragraph">
<p>When you run an application client, the command may take a long time to
complete.</p>
</div></div></td>
</tr>
</tbody>
</table>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="BNCFB"></a><a id="receiving-messages-synchronously"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_receiving_messages_synchronously">2.3.6. Receiving Messages Synchronously</h4>
<div class="paragraph">
<p>This section describes the receiving client, which uses the <code>receive</code>
method to consume messages synchronously. This section then explains how
to run the clients using GlassFish Server.</p>
</div>
<div class="paragraph">
<p><a id="BNCFC"></a><a id="the-synchconsumer.java-client"></a></p>
</div>
<div class="sect4">
<h5 id="_the_synchconsumer_java_client">The SynchConsumer.java Client</h5>
<div class="paragraph">
<p>The receiving client, <code>SynchConsumer.java</code>, performs the following
steps.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Injects resources for a connection factory, queue, and topic.</p>
</li>
<li>
<p>Assigns either the queue or the topic to a destination object, based
on the specified destination type.</p>
</li>
<li>
<p>Within a <code>try</code>-with-resources block, creates a <code>JMSContext</code>.</p>
</li>
<li>
<p>Creates a <code>JMSConsumer</code>, starting message delivery:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">consumer = context.createConsumer(dest);</code></pre>
</div>
</div>
</li>
<li>
<p>Receives the messages sent to the destination until the
end-of-message-stream control message is received:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="type">int</span> count = <span class="integer">0</span>;
<span class="keyword">while</span> (<span class="predefined-constant">true</span>) {
    Message m = consumer.receive(<span class="integer">1000</span>);
    <span class="keyword">if</span> (m != <span class="predefined-constant">null</span>) {
        <span class="keyword">if</span> (m <span class="keyword">instanceof</span> TextMessage) {
            <span class="predefined-type">System</span>.out.println(
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">Reading message: </span><span class="delimiter">&quot;</span></span> + m.getBody(<span class="predefined-type">String</span>.class));
            count += <span class="integer">1</span>;
        } <span class="keyword">else</span> {
            <span class="keyword">break</span>;
        }
    }
}
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Messages received: </span><span class="delimiter">&quot;</span></span> + count);</code></pre>
</div>
</div>
<div class="paragraph">
<p>Because the control message is not a <code>TextMessage</code>, the receiving client
terminates the <code>while</code> loop and stops receiving messages after the
control message arrives.</p>
</div>
</li>
<li>
<p>Catches and handles any exceptions. The end of the
<code>try</code>-with-resources block automatically causes the <code>JMSContext</code> to be
closed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <code>SynchConsumer</code> client uses an indefinite <code>while</code> loop to receive
messages, calling <code>receive</code> with a timeout argument.</p>
</div>
<div class="paragraph">
<p><a id="BNCFG"></a><a id="to-run-the-synchconsumer-and-producer-clients"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_to_run_the_synchconsumer_and_producer_clients">To Run the SynchConsumer and Producer Clients</h5>
<div class="paragraph">
<p>You can run the client using the <code>appclient</code> command. The
<code>SynchConsumer</code> client takes one command-line argument, the destination
type.</p>
</div>
<div class="paragraph">
<p>These steps show how to receive and send messages synchronously using
both a queue and a topic. The steps assume you already ran the
<code>Producer</code> client and have three messages waiting in the queue.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the same terminal window where you ran <code>Producer</code>, go to the
<code>synchconsumer</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd ../synchconsumer</code></pre>
</div>
</div>
</li>
<li>
<p>Run the <code>SynchConsumer</code> client, specifying the queue:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/synchconsumer.jar queue</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the client looks like this (along with some additional
output):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Destination</span> type is queue
Reading message: This is message <span class="integer">1</span> from producer
Reading message: This is message <span class="integer">2</span> from producer
Reading message: This is message <span class="integer">3</span> from producer
Messages received: <span class="integer">3</span></code></pre>
</div>
</div>
</li>
<li>
<p>Now try running the clients in the opposite order. Run the
<code>SynchConsumer</code> client:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/synchconsumer.jar queue</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client displays the destination type and then waits for messages.</p>
</div>
</li>
<li>
<p>Open a new terminal window and run the <code>Producer</code> client:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd tut-install/jms/simple/producer
appclient -client target/producer.jar queue <span class="integer">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>When the messages have been sent, the <code>SynchConsumer</code> client receives
them and exits.</p>
</div>
</li>
<li>
<p>Now run the <code>Producer</code> client using a topic instead of a queue:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/producer.jar topic <span class="integer">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the client looks like this (along with some additional
output):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Destination</span> type is topic
Sending message: This is message <span class="integer">1</span> from producer
Sending message: This is message <span class="integer">2</span> from producer
Sending message: This is message <span class="integer">3</span> from producer
Text messages sent: <span class="integer">3</span></code></pre>
</div>
</div>
</li>
<li>
<p>Now, in the other terminal window, run the <code>SynchConsumer</code> client
using the topic:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/synchconsumer.jar topic</code></pre>
</div>
</div>
<div class="paragraph">
<p>The result, however, is different. Because you are using a subscription
on a topic, messages that were sent before you created the subscription
on the topic will not be added to the subscription and delivered to the
consumer. (See <a href="#BNCED">Publish/Subscribe
Messaging Style</a> and <a href="#BABEEJJJ">Consuming
Messages from Topics</a> for details.) Instead of receiving the messages,
the client waits for messages to arrive.</p>
</div>
</li>
<li>
<p>Leave the <code>SynchConsumer</code> client running and run the <code>Producer</code>
client again:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/producer.jar topic <span class="integer">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the <code>SynchConsumer</code> client receives the messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Destination</span> type is topic
Reading message: This is message <span class="integer">1</span> from producer
Reading message: This is message <span class="integer">2</span> from producer
Reading message: This is message <span class="integer">3</span> from producer
Messages received: <span class="integer">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Because these messages were sent after the consumer was started, the
client receives them.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="BNCFH"></a><a id="using-a-message-listener-for-asynchronous-message-delivery"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_a_message_listener_for_asynchronous_message_delivery">2.3.7. Using a Message Listener for Asynchronous Message Delivery</h4>
<div class="paragraph">
<p>This section describes the receiving clients in an example that uses a
message listener for asynchronous message delivery. This section then
explains how to compile and run the clients using GlassFish Server.</p>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Note</strong>:</p>
</div>
<div class="paragraph">
<p>In the Jakarta EE platform, message listeners can be used only in
application clients, as in this example. To allow asynchronous message
delivery in a web or enterprise bean application, you use a
message-driven bean, shown in later examples in this chapter.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p><a id="BNCFI"></a><a id="writing-the-asynchconsumer.java-and-textlistener.java-clients"></a></p>
</div>
<div class="sect4">
<h5 id="_writing_the_asynchconsumer_java_and_textlistener_java_clients">Writing the AsynchConsumer.java and TextListener.java Clients</h5>
<div class="paragraph">
<p>The sending client is <code>Producer.java</code>, the same client used in
<a href="#BNCFB">Receiving Messages
Synchronously</a>.</p>
</div>
<div class="paragraph">
<p>An asynchronous consumer normally runs indefinitely. This one runs until
the user types the character <code>q</code> or <code>Q</code> to stop the client.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The client, <code>AsynchConsumer.java</code>, performs the following steps.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>Injects resources for a connection factory, queue, and topic.</p>
</li>
<li>
<p>Assigns either the queue or the topic to a destination object, based on the specified destination type.</p>
</li>
<li>
<p>In a <code>try</code>-with-resources block, creates a <code>JMSContext</code>.</p>
</li>
<li>
<p>Creates a <code>JMSConsumer</code>.</p>
</li>
<li>
<p>Creates an instance of the <code>TextListener</code> class and registers it asthe message listener for the <code>JMSConsumer</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">listener = <span class="keyword">new</span> <span class="predefined-type">TextListener</span>();
consumer.setMessageListener(listener);</code></pre>
</div>
</div>
</li>
<li>
<p>Listens for the messages sent to the destination, stopping when the
user types the character <code>q</code> or <code>Q</code> (it uses a
<code>java.io.InputStreamReader</code> to do this).</p>
</li>
<li>
<p>Catches and handles any exceptions. The end of the
<code>try</code>-with-resources block automatically causes the <code>JMSContext</code> to be
closed, thus stopping delivery of messages to the message listener.</p>
</li>
</ol>
</div>
</li>
<li>
<p>The message listener, <code>TextListener.java</code>, follows these steps:</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>When a message arrives, the <code>onMessage</code> method is called
automatically.</p>
</li>
<li>
<p>If the message is a <code>TextMessage</code>, the <code>onMessage</code> method displays
its content as a string value. If the message is not a text message, it
reports this fact:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> onMessage(Message m) {
    <span class="keyword">try</span> {
        <span class="keyword">if</span> (m <span class="keyword">instanceof</span> TextMessage) {
            <span class="predefined-type">System</span>.out.println(
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">Reading message: </span><span class="delimiter">&quot;</span></span> + m.getBody(<span class="predefined-type">String</span>.class));
        } <span class="keyword">else</span> {
             <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Message is not a TextMessage</span><span class="delimiter">&quot;</span></span>);
        }
    } <span class="keyword">catch</span> (JMSException | JMSRuntimeException e) {
        <span class="predefined-type">System</span>.err.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">JMSException in onMessage(): </span><span class="delimiter">&quot;</span></span> + e.toString());
    }
}</code></pre>
</div>
</div>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p>For this example, you will use the same connection factory and
destinations you created in <a href="#BABHEFCB">To Create Resources for the
Simple Examples</a>.</p>
</div>
<div class="paragraph">
<p>The steps assume that you have already built and packaged all the
examples using NetBeans IDE or Maven.</p>
</div>
<div class="paragraph">
<p><a id="BNCFK"></a><a id="to-run-the-asynchconsumer-and-producer-clients"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_to_run_the_asynchconsumer_and_producer_clients">To Run the AsynchConsumer and Producer Clients</h5>
<div class="paragraph">
<p>You will need two terminal windows, as you did in <a href="#BNCFB">Receiving
Messages Synchronously</a>.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the terminal window where you ran the <code>SynchConsumer</code> client, go
to the <code>asynchconsumer</code> example directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd tut-install/jms/simple/asynchconsumer</code></pre>
</div>
</div>
</li>
<li>
<p>Run the <code>AsynchConsumer</code> client, specifying the <code>topic</code> destination
type:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/asynchconsumer.jar topic</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client displays the following lines (along with some additional
output) and then waits for messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Destination</span> type is topic
To end program, enter Q or q, then &lt;<span class="keyword">return</span>&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>In the terminal window where you ran the <code>Producer</code> client
previously, run the client again, sending three messages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/producer.jar topic <span class="integer">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the client looks like this (along with some additional
output):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Destination</span> type is topic
Sending message: This is message <span class="integer">1</span> from producer
Sending message: This is message <span class="integer">2</span> from producer
Sending message: This is message <span class="integer">3</span> from producer
Text messages sent: <span class="integer">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>In the other window, the <code>AsynchConsumer</code> client displays the following
(along with some additional output):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Destination</span> type is topic
To end program, enter Q or q, then &lt;<span class="keyword">return</span>&gt;
Reading message: This is message <span class="integer">1</span> from producer
Reading message: This is message <span class="integer">2</span> from producer
Reading message: This is message <span class="integer">3</span> from producer
Message is not a TextMessage</code></pre>
</div>
</div>
<div class="paragraph">
<p>The last line appears because the client has received the non-text
control message sent by the <code>Producer</code> client.</p>
</div>
</li>
<li>
<p>Enter <code>Q</code> or <code>q</code> and press Return to stop the <code>AsynchConsumer</code>
client.</p>
</li>
<li>
<p>Now run the clients using a queue.</p>
<div class="paragraph">
<p>In this case, as with the synchronous example, you can run the
<code>Producer</code> client first, because there is no timing dependency between
the sender and receiver:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/producer.jar queue <span class="integer">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the client looks like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Destination</span> type is queue
Sending message: This is message <span class="integer">1</span> from producer
Sending message: This is message <span class="integer">2</span> from producer
Sending message: This is message <span class="integer">3</span> from producer
Text messages sent: <span class="integer">3</span></code></pre>
</div>
</div>
</li>
<li>
<p>In the other window, run the <code>AsynchConsumer</code> client:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/asynchconsumer.jar queue</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the client looks like this (along with some additional
output):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Destination</span> type is queue
To end program, enter Q or q, then &lt;<span class="keyword">return</span>&gt;
Reading message: This is message <span class="integer">1</span> from producer
Reading message: This is message <span class="integer">2</span> from producer
Reading message: This is message <span class="integer">3</span> from producer
Message is not a TextMessage</code></pre>
</div>
</div>
</li>
<li>
<p>Enter <code>Q</code> or <code>q</code> and press Return to stop the client.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="BNCFL"></a><a id="browsing-messages-on-a-queue"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_browsing_messages_on_a_queue">2.3.8. Browsing Messages on a Queue</h4>
<div class="paragraph">
<p>This section describes an example that creates a <code>QueueBrowser</code> object
to examine messages on a queue, as described in
<a href="#BNCEY">JMS Queue Browsers</a>. This section then
explains how to compile, package, and run the example using GlassFish
Server.</p>
</div>
<div class="paragraph">
<p><a id="BNCFM"></a><a id="the-messagebrowser.java-client"></a></p>
</div>
<div class="sect4">
<h5 id="_the_messagebrowser_java_client">The MessageBrowser.java Client</h5>
<div class="paragraph">
<p>To create a <code>QueueBrowser</code> for a queue, you call the
<code>JMSContext.createBrowser</code> method with the queue as the argument. You
obtain the messages in the queue as an <code>Enumeration</code> object. You can
then iterate through the <code>Enumeration</code> object and display the contents
of each message.</p>
</div>
<div class="paragraph">
<p>The <code>MessageBrowser.java</code> client performs the following steps.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Injects resources for a connection factory and a queue.</p>
</li>
<li>
<p>In a <code>try</code>-with-resources block, creates a <code>JMSContext</code>.</p>
</li>
<li>
<p>Creates a <code>QueueBrowser</code>:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">QueueBrowser browser = context.createBrowser(queue);</code></pre>
</div>
</div>
</li>
<li>
<p>Retrieves the <code>Enumeration</code> that contains the messages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Enumeration</span> msgs = browser.getEnumeration();</code></pre>
</div>
</div>
</li>
<li>
<p>Verifies that the <code>Enumeration</code> contains messages, then displays the
contents of the messages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">if</span> ( !msgs.hasMoreElements() ) {
    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">No messages in queue</span><span class="delimiter">&quot;</span></span>);
} <span class="keyword">else</span> {
    <span class="keyword">while</span> (msgs.hasMoreElements()) {
        Message tempMsg = (Message)msgs.nextElement();
        <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Message: </span><span class="delimiter">&quot;</span></span> + tempMsg);
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p>Catches and handles any exceptions. The end of the
<code>try</code>-with-resources block automatically causes the <code>JMSContext</code> to be
closed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Dumping the message contents to standard output retrieves the message
body and properties in a format that depends on the implementation of
the <code>toString</code> method. In GlassFish Server, the message format looks
something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Text:   This is message <span class="integer">3</span> from producer
<span class="predefined-type">Class</span>:                  com.sun.messaging.jmq.jmsclient.TextMessageImpl
getJMSMessageID():      ID:<span class="integer">8</span>-<span class="float">10.152</span><span class="float">.23</span><span class="float">.26</span>(bf:<span class="integer">27</span>:<span class="integer">4</span>:e:e7:ec)-<span class="integer">55645</span>-<span class="integer">1363100335526</span>
getJMSTimestamp():      <span class="integer">1129061034355</span>
getJMSCorrelationID():  <span class="predefined-constant">null</span>
JMSReplyTo:             <span class="predefined-constant">null</span>
JMSDestination:         PhysicalQueue
getJMSDeliveryMode():   PERSISTENT
getJMSRedelivered():    <span class="predefined-constant">false</span>
getJMSType():           <span class="predefined-constant">null</span>
getJMSExpiration():     <span class="integer">0</span>
getJMSPriority():       <span class="integer">4</span>
<span class="predefined-type">Properties</span>:             {JMSXDeliveryCount=<span class="integer">0</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instead of displaying the message contents this way, you can call some
of the <code>Message</code> interface&#8217;s getter methods to retrieve the parts of the
message you want to see.</p>
</div>
<div class="paragraph">
<p>For this example, you will use the connection factory and queue you
created for <a href="#BNCFB">Receiving Messages Synchronously</a>. It is assumed
that you have already built and packaged all the examples.</p>
</div>
<div class="paragraph">
<p><a id="BNCFN"></a><a id="to-run-the-queuebrowser-client"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_to_run_the_queuebrowser_client">To Run the QueueBrowser Client</h5>
<div class="paragraph">
<p>To run the <code>MessageBrowser</code> example using the <code>appclient</code> command,
follow these steps.</p>
</div>
<div class="paragraph">
<p>You also need the <code>Producer</code> example to send the message to the queue,
and one of the consumer clients to consume the messages after you
inspect them.</p>
</div>
<div class="paragraph">
<p>To run the clients, you need two terminal windows.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In a terminal window, go to the <code>producer</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd tut-install/examples/jms/simple/producer/</code></pre>
</div>
</div>
</li>
<li>
<p>Run the <code>Producer</code> client, sending one message to the queue, along
with the non-text control message:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/producer.jar queue</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the client looks like this (along with some additional
output):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Destination</span> type is queue
Sending message: This is message <span class="integer">1</span> from producer
Text messages sent: <span class="integer">1</span></code></pre>
</div>
</div>
</li>
<li>
<p>In another terminal window, go to the <code>messagebrowser</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd tut-install/jms/simple/messagebrowser</code></pre>
</div>
</div>
</li>
<li>
<p>Run the <code>MessageBrowser</code> client using the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/messagebrowser.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the client looks something like this (along with some
additional output):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Message:
Text:   This is message <span class="integer">1</span> from producer
<span class="predefined-type">Class</span>:                  com.sun.messaging.jmq.jmsclient.TextMessageImpl
getJMSMessageID():      ID:<span class="integer">9</span>-<span class="float">10.152</span><span class="float">.23</span><span class="float">.26</span>(bf:<span class="integer">27</span>:<span class="integer">4</span>:e:e7:ec)-<span class="integer">55645</span>-<span class="integer">1363100335526</span>
getJMSTimestamp():      <span class="integer">1363100335526</span>
getJMSCorrelationID():  <span class="predefined-constant">null</span>
JMSReplyTo:             <span class="predefined-constant">null</span>
JMSDestination:         PhysicalQueue
getJMSDeliveryMode():   PERSISTENT
getJMSRedelivered():    <span class="predefined-constant">false</span>
getJMSType():           <span class="predefined-constant">null</span>
getJMSExpiration():     <span class="integer">0</span>
getJMSPriority():       <span class="integer">4</span>
<span class="predefined-type">Properties</span>:             {JMSXDeliveryCount=<span class="integer">0</span>}

Message:
<span class="predefined-type">Class</span>:                  com.sun.messaging.jmq.jmsclient.MessageImpl
getJMSMessageID():      ID:<span class="integer">10</span>-<span class="float">10.152</span><span class="float">.23</span><span class="float">.26</span>(bf:<span class="integer">27</span>:<span class="integer">4</span>:e:e7:ec)-<span class="integer">55645</span>-<span class="integer">1363100335526</span>
getJMSTimestamp():      <span class="integer">1363100335526</span>
getJMSCorrelationID():  <span class="predefined-constant">null</span>
JMSReplyTo:             <span class="predefined-constant">null</span>
JMSDestination:         PhysicalQueue
getJMSDeliveryMode():   PERSISTENT
getJMSRedelivered():    <span class="predefined-constant">false</span>
getJMSType():           <span class="predefined-constant">null</span>
getJMSExpiration():     <span class="integer">0</span>
getJMSPriority():       <span class="integer">4</span>
<span class="predefined-type">Properties</span>:             {JMSXDeliveryCount=<span class="integer">0</span>}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The first message is the <code>TextMessage</code>, and the second is the non-text
control message.</p>
</div>
</li>
<li>
<p>Go to the <code>synchconsumer</code> directory.</p>
</li>
<li>
<p>Run the <code>SynchConsumer</code> client to consume the messages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/synchconsumer.jar queue</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output of the client looks like this (along with some additional
output):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Destination</span> type is queue
Reading message: This is message <span class="integer">1</span> from producer
Messages received: <span class="integer">1</span></code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="BABDDHHC"></a><a id="running-multiple-consumers-on-the-same-destination"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_multiple_consumers_on_the_same_destination">2.3.9. Running Multiple Consumers on the Same Destination</h4>
<div class="paragraph">
<p>To illustrate further the way point-to-point and publish/subscribe
messaging works, you can use the <code>Producer</code> and <code>SynchConsumer</code> examples
to send messages that are then consumed by two clients running
simultaneously.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Open three command windows. In one, go to the <code>producer</code> directory.
In the other two, go to the <code>synchconsumer</code> directory.</p>
</li>
<li>
<p>In each of the <code>synchconsumer</code> windows, start running the client,
receiving messages from a queue:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/synchconsumer.jar queue</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait until you see the "Destination type is queue" message in both
windows.</p>
</div>
</li>
<li>
<p>In the <code>producer</code> window, run the client, sending 20 or so messages
to the queue:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/producer.jar queue <span class="integer">20</span></code></pre>
</div>
</div>
</li>
<li>
<p>Look at the output in the <code>synchconsumer</code> windows. In point-to-point
messaging, each message can have only one consumer. Therefore, each of
the clients receives some of the messages. One of the clients receives
the non-text control message, reports the number of messages received,
and exits.</p>
</li>
<li>
<p>In the window of the client that did not receive the non-text
control message, enter Control-C to exit the program.</p>
</li>
<li>
<p>Next, run the <code>synchconsumer</code> clients using a topic. In each window,
run the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/synchconsumer.jar topic</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait until you see the "Destination type is topic" message in both
windows.</p>
</div>
</li>
<li>
<p>In the <code>producer</code> window, run the client, sending 20 or so messages
to the topic:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/producer.jar topic <span class="integer">20</span></code></pre>
</div>
</div>
</li>
<li>
<p>Again, look at the output in the <code>synchconsumer</code> windows. In
publish/subscribe messaging, a copy of every message is sent to each
subscription on the topic. Therefore, each of the clients receives all
20 text messages as well as the non-text control message.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="BNCFX"></a><a id="acknowledging-messages"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_acknowledging_messages">2.3.10. Acknowledging Messages</h4>
<div class="paragraph">
<p>Jakarta Messaging provides two alternative ways for a consuming client to ensure that
a message is not acknowledged until the application has finished
processing the message:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Using a synchronous consumer in a <code>JMSContext</code> that has been
configured to use the <code>CLIENT_ACKNOWLEDGE</code> setting</p>
</li>
<li>
<p>Using a message listener for asynchronous message delivery in a
<code>JMSContext</code> that has been configured to use the default
<code>AUTO_ACKNOWLEDGE</code> setting</p>
</li>
</ul>
</div>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 100%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><div class="content"><div class="paragraph">
<p><strong>Note</strong>:</p>
</div>
<div class="paragraph">
<p>In the Jakarta EE platform, <code>CLIENT_ACKNOWLEDGE</code> sessions can be used only
in application clients, as in this example.</p>
</div></div></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The <code>clientackconsumer</code> example demonstrates the first alternative, in
which a synchronous consumer uses client acknowledgment. The
<code>asynchconsumer</code> example described in <a href="#BNCFH">Using a Message
Listener for Asynchronous Message Delivery</a> demonstrates the second
alternative.</p>
</div>
<div class="paragraph">
<p>For information about message acknowledgment, see
<a href="#BNCFW">Controlling Message Acknowledgment</a>.</p>
</div>
<div class="paragraph">
<p>The following table describes four possible interactions between types
of consumers and types of acknowledgment.</p>
</div>
<div class="paragraph">
<p><a id="sthref204"></a><a id="sthref205"></a></p>
</div>
<div class="paragraph">
<p><strong>Table 49-3 Message Acknowledgment with Synchronous and Asynchronous
Consumers</strong></p>
</div>
<table class="tableblock frame-all grid-all" style="width: 99%;">
<colgroup>
<col style="width: 20%;">
<col style="width: 20%;">
<col style="width: 60%;">
</colgroup>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Consumer Type</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Acknowledgment Type</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Behavior</strong></p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Synchronous</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client acknowledges message after processing is
complete</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Asynchronous</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Client acknowledges message after processing is
complete</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Synchronous</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Auto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Acknowledgment happens immediately after <code>receive</code>
call; message cannot be redelivered if any subsequent processing steps
fail</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock">Asynchronous</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Auto</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Message is automatically acknowledged when
<code>onMessage</code> method returns</p></td>
</tr>
</tbody>
</table>
<div class="paragraph">
<p>The example is under the
tut-install`/examples/jms/simple/clientackconsumer/` directory.</p>
</div>
<div class="paragraph">
<p>The example client, <code>ClientAckConsumer.java</code>, creates a <code>JMSContext</code>
that specifies client acknowledgment:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (JMSContext context =
      connectionFactory.createContext(JMSContext.CLIENT_ACKNOWLEDGE);) {
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client uses a <code>while</code> loop almost identical to that used by
<code>SynchConsumer.java</code>, with the exception that after processing each
message, it calls the <code>acknowledge</code> method on the <code>JMSContext</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">context.acknowledge();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The example uses the following objects:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>jms/MyQueue</code> resource that you created for <a href="#BNCFB">Receiving
Messages Synchronously</a>.</p>
</li>
<li>
<p><code>java:comp/DefaultJMSConnectionFactory</code>, the platform default
connection factory preconfigured with GlassFish Server</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="GJSCG"></a><a id="to-run-the-clientackconsumer-client"></a></p>
</div>
<div class="sect4">
<h5 id="_to_run_the_clientackconsumer_client">To Run the ClientAckConsumer Client</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In a terminal window, go to the following directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/jms/simple/producer/</code></pre>
</div>
</div>
</li>
<li>
<p>Run the <code>Producer</code> client, sending some messages to the queue:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/producer.jar queue <span class="integer">3</span></code></pre>
</div>
</div>
</li>
<li>
<p>In another terminal window, go to the following directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/jms/simple/clientackconsumer/</code></pre>
</div>
</div>
</li>
<li>
<p>To run the client, use the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/clientackconsumer.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client output looks like this (along with some additional output):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Created client-acknowledge JMSContext
Reading message: This is message <span class="integer">1</span> from producer
Acknowledging TextMessage
Reading message: This is message <span class="integer">2</span> from producer
Acknowledging TextMessage
Reading message: This is message <span class="integer">3</span> from producer
Acknowledging TextMessage
Acknowledging non-text control message</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client acknowledges each message explicitly after processing it,
just as a <code>JMSContext</code> configured to use <code>AUTO_ACKNOWLEDGE</code> does
automatically after a <code>MessageListener</code> returns successfully from
processing a message received asynchronously.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="GIWFH"></a><a id="writing-more-advanced-jms-applications"></a></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_writing_more_advanced_jakarta_messaging_applications">2.4. Writing More Advanced Jakarta Messaging Applications</h3>
<div class="paragraph">
<p>The following examples show how to use some of the more advanced Jakarta Messaging
features: durable subscriptions and transactions.</p>
</div>
<div class="paragraph">
<p><a id="BNCGG"></a><a id="using-durable-subscriptions"></a></p>
</div>
<div class="sect3">
<h4 id="_using_durable_subscriptions">2.4.1. Using Durable Subscriptions</h4>
<div class="paragraph">
<p>The <code>durablesubscriptionexample</code> example shows how unshared durable
subscriptions work. It demonstrates that a durable subscription
continues to exist and accumulate messages even when there is no active
consumer on it.</p>
</div>
<div class="paragraph">
<p>The example consists of two modules, a <code>durableconsumer</code> application
that creates a durable subscription and consumes messages, and an
<code>unsubscriber</code> application that enables you to unsubscribe from the
durable subscription after you have finished running the
<code>durableconsumer</code> application.</p>
</div>
<div class="paragraph">
<p>For information on durable subscriptions, see
<a href="#BNCGD">Creating Durable Subscriptions</a>.</p>
</div>
<div class="paragraph">
<p>The main client, <code>DurableConsumer.java</code>, is under the
<code><em>tut-install</em>/examples/jms/durablesubscriptionexample/durableconsumer</code>/
directory.</p>
</div>
<div class="paragraph">
<p>The example uses a connection factory, <code>jms/DurableConnectionFactory</code>,
that has a client ID.</p>
</div>
<div class="paragraph">
<p>The <code>DurableConsumer</code> client creates a <code>JMSContext</code> using the connection
factory. It then stops the <code>JMSContext</code>, calls <code>createDurableConsumer</code>
to create a durable subscription and a consumer on the topic by
specifying a subscription name, registers a message listener, and starts
the <code>JMSContext</code> again. The subscription is created only if it does not
already exist, so the example can be run repeatedly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (JMSContext context = durableConnectionFactory.createContext();) {
    context.stop();
    consumer = context.createDurableConsumer(topic, <span class="string"><span class="delimiter">&quot;</span><span class="content">MakeItLast</span><span class="delimiter">&quot;</span></span>);
    listener = <span class="keyword">new</span> <span class="predefined-type">TextListener</span>();
    consumer.setMessageListener(listener);
    context.start();
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>To send messages to the topic, you run the <code>producer</code> client.</p>
</div>
<div class="paragraph">
<p>The <code>unsubscriber</code> example contains a very simple <code>Unsubscriber</code> client,
which creates a <code>JMSContext</code> on the same connection factory and then
calls the <code>unsubscribe</code> method, specifying the subscription name:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">try</span> (JMSContext context = durableConnectionFactory.createContext();) {
    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Unsubscribing from durable subscription</span><span class="delimiter">&quot;</span></span>);
    context.unsubscribe(<span class="string"><span class="delimiter">&quot;</span><span class="content">MakeItLast</span><span class="delimiter">&quot;</span></span>);
} ...</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="sthref206"></a><a id="to-create-resources-for-the-durable-subscription-example"></a></p>
</div>
<div class="sect4">
<h5 id="_to_create_resources_for_the_durable_subscription_example">To Create Resources for the Durable Subscription Example</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>).</p>
</li>
<li>
<p>In a command window, go to the <code>durableconsumer</code> example.</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd tut-install/jms/durablesubscriptionexample/durableconsumer</code></pre>
</div>
</div>
</li>
<li>
<p>Create the resources using the <code>asadmin add-resources</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">asadmin add-resources src/main/setup/glassfish-resources.xml</code></pre>
</div>
</div>
<div class="paragraph">
<p>The command output reports the creation of a connector connection pool
and a connector resource.</p>
</div>
</li>
<li>
<p>Verify the creation of the resources:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">asadmin list-jms-resources</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to the resources you created for the simple examples, the
command lists the new connection factory:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jms/MyQueue
jms/MyTopic
jms/__defaultConnectionFactory
jms/DurableConnectionFactory
Command list-jms-resources executed successfully.</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="GJSCI"></a><a id="to-run-the-durable-subscription-example"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_to_run_the_durable_subscription_example">To Run the Durable Subscription Example</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In a terminal window, go to the following directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/jms/durablesubscriptionexample/</code></pre>
</div>
</div>
</li>
<li>
<p>Build the <code>durableconsumer</code> and <code>unsubscriber</code> examples:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">mvn install</code></pre>
</div>
</div>
</li>
<li>
<p>Go to the <code>durableconsumer</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd durableconsumer</code></pre>
</div>
</div>
</li>
<li>
<p>To run the client, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/durableconsumer.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client creates the durable consumer and then waits for messages:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Creating consumer <span class="keyword">for</span> topic
Starting consumer
To end program, enter Q or q, then &lt;<span class="keyword">return</span>&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>In another terminal window, run the <code>Producer</code> client, sending some
messages to the topic:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd tut-install/examples/jms/simple/producer
appclient -client target/producer.jar topic <span class="integer">3</span></code></pre>
</div>
</div>
</li>
<li>
<p>After the <code>DurableConsumer</code> client receives the messages, enter <code>q</code>
or <code>Q</code> to exit the program. At this point, the client has behaved like
any other asynchronous consumer.</p>
</li>
<li>
<p>Now, while the <code>DurableConsumer</code> client is not running, use the
<code>Producer</code> client to send more messages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/producer.jar topic <span class="integer">2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>If a durable subscription did not exist, these messages would be lost,
because no consumer on the topic is currently running. However, the
durable subscription is still active, and it retains the messages.</p>
</div>
</li>
<li>
<p>Run the <code>DurableConsumer</code> client again. It immediately receives the
messages that were sent while it was inactive:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Creating consumer <span class="keyword">for</span> topic
Starting consumer
To end program, enter Q or q, then &lt;<span class="keyword">return</span>&gt;
Reading message: This is message <span class="integer">1</span> from producer
Reading message: This is message <span class="integer">2</span> from producer
Message is not a TextMessage</code></pre>
</div>
</div>
</li>
<li>
<p>Enter <code>q</code> or <code>Q</code> to exit the program.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="sthref207"></a><a id="to-run-the-unsubscriber-example"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_to_run_the_unsubscriber_example">To Run the unsubscriber Example</h5>
<div class="paragraph">
<p>After you have finished running the <code>DurableConsumer</code> client, run the
<code>unsubscriber</code> example to unsubscribe from the durable subscription.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In a terminal window, go to the following directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/jms/durablesubscriptionexample/unsubscriber</code></pre>
</div>
</div>
</li>
<li>
<p>To run the <code>Unsubscriber</code> client, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/unsubscriber.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client reports that it is unsubscribing from the durable
subscription.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="BNCGJ"></a><a id="using-local-transactions"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_local_transactions">2.4.2. Using Local Transactions</h4>
<div class="paragraph">
<p>The <code>transactedexample</code> example demonstrates the use of local
transactions in a Messaging client application. It also demonstrates the use
of the request/reply messaging pattern described in
<a href="#BNCGB">Creating Temporary Destinations</a>,
although it uses permanent rather than temporary destinations. The
example consists of three modules, <code>genericsupplier</code>, <code>retailer</code>, and
<code>vendor</code>, which can be found under the
tut-install`/examples/jms/transactedexample/` directory. The source code
can be found in the <code>src/main/java/ee.jakarta.tutorial</code> trees for each
module. The <code>genericsupplier</code> and <code>retailer</code> modules each contain a
single class, <code>genericsupplier/GenericSupplier.java</code> and
<code>retailer/Retailer.java</code>, respectively. The <code>vendor</code> module is more
complex, containing four classes: <code>vendor/Vendor.java</code>,
<code>vendor/VendorMessageListener.java</code>, <code>vendor/Order.java</code>, and
<code>vendor/SampleUtilities.java</code>.</p>
</div>
<div class="paragraph">
<p>The example shows how to use a queue and a topic in a single transaction
as well as how to pass a <code>JMSContext</code> to a message listener&#8217;s
constructor function. The example represents a highly simplified
e-commerce application in which the following actions occur.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>A retailer
(<code>retailer/src/main/java/ee/jakarta/tutorial/retailer/Retailer.java</code>) sends a
<code>MapMessage</code> to a vendor order queue, ordering a quantity of computers,
and waits for the vendor&#8217;s reply:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">outMessage = context.createMapMessage();
outMessage.setString(<span class="string"><span class="delimiter">&quot;</span><span class="content">Item</span><span class="delimiter">&quot;</span></span>, <span class="string"><span class="delimiter">&quot;</span><span class="content">Computer(s)</span><span class="delimiter">&quot;</span></span>);
outMessage.setInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">Quantity</span><span class="delimiter">&quot;</span></span>, quantity);
outMessage.setJMSReplyTo(retailerConfirmQueue);
context.createProducer().send(vendorOrderQueue, outMessage);
<span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Retailer: ordered </span><span class="delimiter">&quot;</span></span> + quantity + <span class="string"><span class="delimiter">&quot;</span><span class="content"> computer(s)</span><span class="delimiter">&quot;</span></span>);
orderConfirmReceiver = context.createConsumer(retailerConfirmQueue);</code></pre>
</div>
</div>
</li>
<li>
<p>The vendor
(<code>vendor/src/main/java/ee/jakarta/tutorial/retailer/Vendor.java</code>) receives
the retailer&#8217;s order message and sends an order message to the supplier
order topic in one transaction. This Jakarta Messaging transaction uses a single
session, so you can combine a receive from a queue with a send to a
topic. Here is the code that uses the same session to create a consumer
for a queue:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">vendorOrderReceiver = session.createConsumer(vendorOrderQueue);</code></pre>
</div>
</div>
<div class="paragraph">
<p>The following code receives the incoming message, sends an outgoing
message, and commits the <code>JMSContext</code>. The message processing has been
removed to keep the sequence simple:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">inMessage = vendorOrderReceiver.receive();
<span class="comment">// Process the incoming message and format the outgoing</span>
<span class="comment">// message</span>
...
context.createProducer().send(supplierOrderTopic, orderMessage);
...
context.commit();</code></pre>
</div>
</div>
<div class="paragraph">
<p>For simplicity, there are only two suppliers, one for CPUs and one for
hard drives.</p>
</div>
</li>
<li>
<p>Each supplier
(<code>genericsupplier/src/main/java/ee/jakarta/tutorial/retailer/GenericSupplier.java</code>)
receives the order from the order topic, checks its inventory, and then
sends the items ordered to the queue named in the order message&#8217;s
<code>JMSReplyTo</code> field. If it does not have enough of the item in stock, the
supplier sends what it has. The synchronous receive from the topic and
the send to the queue take place in one Jakarta Messaging transaction:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">receiver = context.createConsumer(SupplierOrderTopic);
...
inMessage = receiver.receive();
<span class="keyword">if</span> (inMessage <span class="keyword">instanceof</span> MapMessage) {
    orderMessage = (MapMessage) inMessage;
} ...
<span class="comment">// Process message</span>
outMessage = context.createMapMessage();
<span class="comment">// Add content to message</span>
context.createProducer().send(
         (<span class="predefined-type">Queue</span>) orderMessage.getJMSReplyTo(),
         outMessage);
<span class="comment">// Display message contents</span>
context.commit();</code></pre>
</div>
</div>
</li>
<li>
<p>The vendor receives the suppliers' replies from its confirmation
queue and updates the state of the order. Messages are processed by an
asynchronous message listener, <code>VendorMessageListener</code>; this step shows
the use of Jakarta Messaging transactions with a message listener:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">MapMessage component = (MapMessage) message;
...
int orderNumber = component.getInt(<span class="string"><span class="delimiter">&quot;</span><span class="content">VendorOrderNumber</span><span class="delimiter">&quot;</span></span>);
Order order = Order.getOrder(orderNumber).processSubOrder(component);
context.commit();</code></pre>
</div>
</div>
</li>
<li>
<p>When all outstanding replies are processed for a given order, the
vendor message listener sends a message notifying the retailer whether
it can fulfill the order:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">Queue</span> replyQueue = (<span class="predefined-type">Queue</span>) order.order.getJMSReplyTo();
MapMessage retailerConfirmMessage = context.createMapMessage();
<span class="comment">// Format the message</span>
context.createProducer().send(replyQueue, retailerConfirmMessage);
context.commit();</code></pre>
</div>
</div>
</li>
<li>
<p>The retailer receives the message from the vendor:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">inMessage = (MapMessage) orderConfirmReceiver.receive();</code></pre>
</div>
</div>
<div class="paragraph">
<p>The retailer then places a second order for twice as many computers as
in the first order, so these steps are executed twice.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a href="#BNCGK">Figure 49-1</a> illustrates these steps.</p>
</div>
<div id="BNCGK" class="paragraph">
<div class="title"><strong>Figure 49-1 Transactions: Messaging Client Example</strong></div>
<p><span class="image"><img src="../images/jakartaeett_dt_034.png" alt="Diagram of steps in transaction example"></span></p>
</div>
<div class="paragraph">
<p>All the messages use the <code>MapMessage</code> message type. Synchronous receives
are used for all message reception except when the vendor processes the
replies of the suppliers. These replies are processed asynchronously and
demonstrate how to use transactions within a message listener.</p>
</div>
<div class="paragraph">
<p>At random intervals, the <code>Vendor</code> client throws an exception to simulate
a database problem and cause a rollback.</p>
</div>
<div class="paragraph">
<p>All clients except <code>Retailer</code> use transacted contexts.</p>
</div>
<div class="paragraph">
<p>The example uses three queues named <code>jms/AQueue</code>, <code>jms/BQueue</code>, and
<code>jms/CQueue</code>, and one topic named <code>jms/OTopic</code>.</p>
</div>
<div class="paragraph">
<p><a id="sthref209"></a><a id="to-create-resources-for-the-transactedexample-example"></a></p>
</div>
<div class="sect4">
<h5 id="_to_create_resources_for_the_transactedexample_example">To Create Resources for the transactedexample Example</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>).</p>
</li>
<li>
<p>In a command window, go to the <code>genericsupplier</code> example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd tut-install/jms/transactedexample/genericsupplier</code></pre>
</div>
</div>
</li>
<li>
<p>Create the resources using the <code>asadmin add-resources</code> command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">asadmin add-resources src/main/setup/glassfish-resources.xml</code></pre>
</div>
</div>
</li>
<li>
<p>Verify the creation of the resources:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">asadmin list-jms-resources</code></pre>
</div>
</div>
<div class="paragraph">
<p>In addition to the resources you created for the simple examples and the
durable subscription example, the command lists the four new
destinations:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">jms/MyQueue
jms/MyTopic
jms/AQueue
jms/BQueue
jms/CQueue
jms/OTopic
jms/__defaultConnectionFactory
jms/DurableConnectionFactory
Command list-jms-resources executed successfully.</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="GJSHA"></a><a id="to-run-the-transactedexample-clients"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_to_run_the_transactedexample_clients">To Run the transactedexample Clients</h5>
<div class="paragraph">
<p>You will need four terminal windows to run the clients. Make sure that
you start the clients in the correct order.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In a terminal window, go to the following directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/jms/transactedexample/</code></pre>
</div>
</div>
</li>
<li>
<p>To build and package all the modules, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">mvn install</code></pre>
</div>
</div>
</li>
<li>
<p>Go to the <code>genericsupplier</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd genericsupplier</code></pre>
</div>
</div>
</li>
<li>
<p><a id="BABFCGBI"></a></p>
<div class="paragraph">
<p>Use the following command to start the CPU supplier client:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target<span class="error">\</span>genericsupplier.jar CPU</code></pre>
</div>
</div>
<div class="paragraph">
<p>After some initial output, the client reports the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Starting CPU supplier</code></pre>
</div>
</div>
</li>
<li>
<p>In a second terminal window, go to the <code>genericsupplier</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd tut-install/examples/jms/transactedexample/genericsupplier</code></pre>
</div>
</div>
</li>
<li>
<p>Use the following command to start the hard drive supplier client:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target<span class="error">\</span>genericsupplier.jar HD</code></pre>
</div>
</div>
<div class="paragraph">
<p>After some initial output, the client reports the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Starting Hard Drive supplier</code></pre>
</div>
</div>
</li>
<li>
<p>In a third terminal window, go to the <code>vendor</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd tut-install/examples/jms/transactedexample/vendor</code></pre>
</div>
</div>
</li>
<li>
<p>Use the following command to start the <code>Vendor</code> client:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target<span class="error">\</span>vendor.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>After some initial output, the client reports the following:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Starting vendor</code></pre>
</div>
</div>
</li>
<li>
<p>In another terminal window, go to the <code>retailer</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd tut-install/examples/jms/transactedexample/retailer</code></pre>
</div>
</div>
</li>
<li>
<p><a id="BABBIHCE"></a></p>
<div class="paragraph">
<p>Use a command like the following to run the <code>Retailer</code> client. The
argument specifies the number of computers to order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/retailer.jar <span class="integer">4</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>After some initial output, the <code>Retailer</code> client reports something like
the following. In this case, the first order is filled, but the second
is not:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Retailer: Quantity to be ordered is <span class="integer">4</span>
Retailer: Ordered <span class="integer">4</span> computer(s)
Retailer: Order filled
Retailer: Placing another order
Retailer: Ordered <span class="integer">8</span> computer(s)
Retailer: Order not filled</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>Vendor</code> client reports something like the following, stating in
this case that it is able to send all the computers in the first order,
but not in the second:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Vendor: Retailer ordered <span class="integer">4</span> Computer(s)
Vendor: Ordered <span class="integer">4</span> CPU(s) and hard drive(s)
  Vendor: Committed transaction <span class="integer">1</span>
Vendor: Completed processing <span class="keyword">for</span> order <span class="integer">1</span>
Vendor: Sent <span class="integer">4</span> computer(s)
  Vendor: committed transaction <span class="integer">2</span>
Vendor: Retailer ordered <span class="integer">8</span> Computer(s)
Vendor: Ordered <span class="integer">8</span> CPU(s) and hard drive(s)
  Vendor: Committed transaction <span class="integer">1</span>
Vendor: Completed processing <span class="keyword">for</span> order <span class="integer">2</span>
Vendor: Unable to send <span class="integer">8</span> computer(s)
  Vendor: Committed transaction <span class="integer">2</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The CPU supplier reports something like the following. In this case, it
is able to send all the CPUs for both orders:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">CPU Supplier: Vendor ordered <span class="integer">4</span> CPU(s)
CPU Supplier: Sent <span class="integer">4</span> CPU(s)
  CPU Supplier: Committed transaction
CPU Supplier: Vendor ordered <span class="integer">8</span> CPU(s)
CPU Supplier: Sent <span class="integer">8</span> CPU(s)
  CPU Supplier: Committed transaction</code></pre>
</div>
</div>
<div class="paragraph">
<p>The hard drive supplier reports something like the following. In this
case, it has a shortage of hard drives for the second order:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Hard Drive Supplier: Vendor ordered <span class="integer">4</span> Hard Drive(s)
Hard Drive Supplier: Sent <span class="integer">4</span> Hard Drive(s)
  Hard Drive Supplier: Committed transaction
Hard Drive Supplier: Vendor ordered <span class="integer">8</span> Hard Drive(s)
Hard Drive Supplier: Sent <span class="integer">1</span> Hard Drive(s)
  Hard Drive Supplier: Committed transaction</code></pre>
</div>
</div>
</li>
<li>
<p>Repeat steps <a href="#BABBIHCE">10</a> as many
times as you wish. Occasionally, the vendor will report an exception
that causes a rollback:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Vendor: JMSException occurred: javax.jms.JMSException: Simulated
database concurrent access exception
  Vendor: Rolled back transaction <span class="integer">1</span></code></pre>
</div>
</div>
</li>
<li>
<p>After you finish running the clients, you can delete the destination
resources by using the following commands:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">asadmin delete-jms-resource jms/AQueue
asadmin delete-jms-resource jms/BQueue
asadmin delete-jms-resource jms/CQueue
asadmin delete-jms-resource jms/OTopic</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="BABGEFHC"></a><a id="writing-high-performance-and-scalable-jms-applications"></a></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_writing_high_performance_and_scalable_jakarta_messaging_applications">2.5. Writing High Performance and Scalable Jakarta Messaging Applications</h3>
<div class="paragraph">
<p>This section describes how to use Jakarta Messaging to write applications that
can handle high volumes of messages robustly. These examples use both
nondurable and durable shared consumers.</p>
</div>
<div class="paragraph">
<p><a id="BABIBEAC"></a><a id="using-shared-nondurable-subscriptions"></a></p>
</div>
<div class="sect3">
<h4 id="_using_shared_nondurable_subscriptions">2.5.1. Using Shared Nondurable Subscriptions</h4>
<div class="paragraph">
<p>This section describes the receiving clients in an example that shows
how to use a shared consumer to distribute messages sent to a topic
among different consumers. This section then explains how to compile and
run the clients using GlassFish Server.</p>
</div>
<div class="paragraph">
<p>You may wish to compare this example to the results of
<a href="#BABDDHHC">Running Multiple Consumers on the Same
Destination</a> using an unshared consumer. In that example, messages are
distributed among the consumers on a queue, but each consumer on the
topic receives all the messages because each consumer on the topic is
using a separate topic subscription.</p>
</div>
<div class="paragraph">
<p>In this example, however, messages are distributed among multiple
consumers on a topic, because all the consumers are sharing the same
subscription. Each message added to the topic subscription is received
by only one consumer, similarly to the way in which each message added
to a queue is received by only one consumer.</p>
</div>
<div class="paragraph">
<p>A topic may have multiple subscriptions. Each message sent to the topic
will be added to each topic subscription. However, if there are multiple
consumers on a particular subscription, each message added to that
subscription will be delivered to only one of those consumers.</p>
</div>
<div class="paragraph">
<p><a id="sthref210"></a><a id="writing-the-clients-for-the-shared-consumer-example"></a></p>
</div>
<div class="sect4">
<h5 id="_writing_the_clients_for_the_shared_consumer_example">Writing the Clients for the Shared Consumer Example</h5>
<div class="paragraph">
<p>The sending client is <code>Producer.java</code>, the same client used in previous
examples.</p>
</div>
<div class="paragraph">
<p>The receiving client is <code>SharedConsumer.java</code>. It is very similar to
<code>AsynchConsumer.java</code>, except that it always uses a topic. It performs
the following steps.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Injects resources for a connection factory and topic.</p>
</li>
<li>
<p>In a <code>try</code>-with-resources block, creates a <code>JMSContext</code>.</p>
</li>
<li>
<p>Creates a consumer on a shared nondurable subscription, specifying a
subscription name:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">consumer = context.createSharedConsumer(topic, <span class="string"><span class="delimiter">&quot;</span><span class="content">SubName</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
</li>
<li>
<p>Creates an instance of the <code>TextListener</code> class and registers it as
the message listener for the shared consumer.</p>
</li>
<li>
<p>Listens for the messages published to the destination, stopping when
the user types the character <code>q</code> or <code>Q</code>.</p>
</li>
<li>
<p>Catches and handles any exceptions. The end of the
<code>try</code>-with-resources block automatically causes the <code>JMSContext</code> to be
closed.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <code>TextListener.java</code> class is identical to the one for the
<code>asynchconsumer</code> example.</p>
</div>
<div class="paragraph">
<p>For this example, you will use the default connection factory and the
topic you created in <a href="#BABHEFCB">To Create
Resources for the Simple Examples</a>.</p>
</div>
<div class="paragraph">
<p><a id="sthref211"></a><a id="to-run-the-sharedconsumer-and-producer-clients"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_to_run_the_sharedconsumer_and_producer_clients">To Run the SharedConsumer and Producer Clients</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>).</p>
</li>
<li>
<p>Open three command windows. In the first, go to the
<code>simple/producer/</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd tut-install/examples/jms/simple/producer/</code></pre>
</div>
</div>
</li>
<li>
<p>In the second and third command windows, go to the
<code>shared/sharedconsumer/</code> directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd tut-install/examples/jms/shared/sharedconsumer/</code></pre>
</div>
</div>
</li>
<li>
<p>In one of the <code>sharedconsumer</code> windows, build the example:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">mvn install</code></pre>
</div>
</div>
</li>
<li>
<p>In each of the two <code>sharedconsumer</code> windows, start running the
client. You do not need to specify a <code>topic</code> argument:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/sharedconsumer.jar</code></pre>
</div>
</div>
<div class="paragraph">
<p>Wait until you see the following output in both windows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Waiting <span class="keyword">for</span> messages on topic
To end program, enter Q or q, then &lt;<span class="keyword">return</span>&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>In the <code>producer</code> window, run the client, specifying the topic and a
number of messages:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/producer.jar topic <span class="integer">20</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Each consumer client receives some of the messages. Only one of the
clients receives the non-text message that signals the end of the
message stream.</p>
</div>
</li>
<li>
<p>Enter <code>Q</code> or <code>q</code> and press Return to stop each client and see a
report of the number of text messages received.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="BABEJBHA"></a><a id="using-shared-durable-subscriptions"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_using_shared_durable_subscriptions">2.5.2. Using Shared Durable Subscriptions</h4>
<div class="paragraph">
<p>The <code>shareddurableconsumer</code> client shows how to use shared durable
subscriptions. It shows how shared durable subscriptions combine the
advantages of durable subscriptions (the subscription remains active
when the client is not) with those of shared consumers (the message load
can be divided among multiple clients).</p>
</div>
<div class="paragraph">
<p>The example is much more similar to the <code>sharedconsumer</code> example than to
the <code>DurableConsumer.java</code> client. It uses two classes,
<code>SharedDurableConsumer.java</code> and <code>TextListener.java</code>, which can be found
under the tut-install`/examples/jms/shared/shareddurableconsumer/`
directory.</p>
</div>
<div class="paragraph">
<p>The client uses <code>java:comp/DefaultJMSConnectionFactory</code>, the connection
factory that does not have a client identifier, as is recommended for
shared durable subscriptions. It uses the <code>createSharedDurableConsumer</code>
method with a subscription name to establish the subscription:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">consumer = context.createSharedDurableConsumer(topic, <span class="string"><span class="delimiter">&quot;</span><span class="content">MakeItLast</span><span class="delimiter">&quot;</span></span>);</code></pre>
</div>
</div>
<div class="paragraph">
<p>You run the example in combination with the <code>Producer.java</code> client.</p>
</div>
<div class="paragraph">
<p><a id="sthref212"></a><a id="to-run-the-shareddurableconsumer-and-producer-clients"></a></p>
</div>
<div class="sect4">
<h5 id="_to_run_the_shareddurableconsumer_and_producer_clients">To Run the SharedDurableConsumer and Producer Clients</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In a terminal window, go to the following directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/jms/shared/shareddurableconsumer</code></pre>
</div>
</div>
</li>
<li>
<p>To compile and package the client, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">mvn install</code></pre>
</div>
</div>
</li>
<li>
<p>Run the client first to establish the durable subscription:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/shareddurableconsumer.jar</code></pre>
</div>
</div>
</li>
<li>
<p>The client displays the following and pauses:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Waiting <span class="keyword">for</span> messages on topic
To end program, enter Q or q, then &lt;<span class="keyword">return</span>&gt;</code></pre>
</div>
</div>
</li>
<li>
<p>In the <code>shareddurableconsumer</code> window, enter <code>q</code> or <code>Q</code> to exit the
program. The subscription remains active, although the client is not
running.</p>
</li>
<li>
<p>Open another terminal window and go to the <code>producer</code> example
directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">cd tut-install/examples/jms/simple/producer</code></pre>
</div>
</div>
</li>
<li>
<p>Run the <code>producer</code> example, sending a number of messages to the
topic:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/producer.jar topic <span class="integer">6</span></code></pre>
</div>
</div>
</li>
<li>
<p>After the producer has sent the messages, open a third terminal
window and go to the <code>shareddurableconsumer</code> directory.</p>
</li>
<li>
<p>Run the client in both the first and third terminal windows.
Whichever client starts first will receive all the messages that were
sent when there was no active subscriber:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/shareddurableconsumer.jar</code></pre>
</div>
</div>
</li>
<li>
<p>With both <code>shareddurableconsumer</code> clients still running, go to the
<code>producer</code> window and send a larger number of messages to the topic:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">appclient -client target/producer.jar topic <span class="integer">25</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Now the messages will be shared by the two consumer clients. If you
continue sending groups of messages to the topic, each client receives
some of the messages. If you exit one of the clients and send more
messages, the other client will receive all the messages.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="BABBABFC"></a><a id="sending-and-receiving-messages-using-a-simple-web-application"></a></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sending_and_receiving_messages_using_a_simple_web_application">2.6. Sending and Receiving Messages Using a Simple Web Application</h3>
<div class="paragraph">
<p>Web applications can use Jakarta Messaging to send and receive messages, as
noted in <a href="#BNCGN">Using Jakarta EE Components to
Produce and to Synchronously Receive Messages</a>. This section describes
the components of a very simple web application that uses Jakarta Messaging.</p>
</div>
<div class="paragraph">
<p>This section assumes that you are familiar with the basics of Jakarta Server
Faces technology, described in <a href="#BNADP">Part IX, "The
Web Tier."</a></p>
</div>
<div class="paragraph">
<p>The example, <code>websimplemessage</code>, is under the
<code><em>tut-install</em>/jms/examples/</code> directory. It uses sending and receiving
Facelets pages as well as corresponding backing beans. When a user
enters a message in the text field of the sending page and clicks a
button, the backing bean for the page sends the message to a queue and
displays it on the page. When the user goes to the receiving page and
clicks another button, the backing bean for that page receives the
message synchronously and displays it.</p>
</div>
<div id="sthref213" class="paragraph">
<div class="title"><strong>Figure 49-2 The websimplemessage Application</strong></div>
<p><span class="image"><img src="../images/jakartaeett_dt_035.png" alt="Diagram showing a web application in which a managed bean sends a message to a queue, and another managed bean receives the message from the queue."></span></p>
</div>
<div class="paragraph">
<p><a id="sthref215"></a><a id="the-websimplemessage-facelets-pages"></a></p>
</div>
<div class="sect3">
<h4 id="_the_websimplemessage_facelets_pages">2.6.1. The websimplemessage Facelets Pages</h4>
<div class="paragraph">
<p>The Facelets pages for the example are as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>sender.xhtml</code>, which provides a labeled <code>h:InputText</code> tag where the
user enters the message, along with two command buttons. When the user
clicks the Send Message button, the <code>senderBean.sendMessage</code> method is
called to send the message to the queue and display its contents. When
the user clicks the Go to Receive Page button, the <code>receiver.xhtml</code> page
appears.</p>
</li>
<li>
<p><code>receiver.xhtml</code>, which also provides two command buttons. When the
user clicks the Receive Message button, the <code>receiverBean.getMessage</code>
method is called to fetch the message from the queue and display its
contents. When the user clicks the Send Another Message button, the
sender.xhtml page appears again.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="sthref216"></a><a id="the-websimplemessage-managed-beans"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_the_websimplemessage_managed_beans">2.6.2. The websimplemessage Managed Beans</h4>
<div class="paragraph">
<p>The two managed beans for the example are as follows.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SenderBean.java</code>, a CDI managed bean with one property,
<code>messageText</code>, and one business method, <code>sendMessage</code>. The class is
annotated with <code>@JMSDestinationDefinition</code> to create a component-private
queue:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JMSDestinationDefinition</span>(
        name = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:comp/jms/webappQueue</span><span class="delimiter">&quot;</span></span>,
        interfaceName = <span class="string"><span class="delimiter">&quot;</span><span class="content">javax.jms.Queue</span><span class="delimiter">&quot;</span></span>,
        destinationName = <span class="string"><span class="delimiter">&quot;</span><span class="content">PhysicalWebappQueue</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@Named</span>
<span class="annotation">@RequestScoped</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SenderBean</span> {</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>sendMessage</code> method injects a <code>JMSContext</code> (using the default
connection factory) and the queue, creates a producer, sends the message
the user typed on the Facelets page, and creates a <code>FacesMessage</code> to
display on the Facelets page:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Inject</span>
<span class="directive">private</span> JMSContext context;
<span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:comp/jms/webappQueue</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="predefined-type">Queue</span> queue;
<span class="directive">private</span> <span class="predefined-type">String</span> messageText;
...
public <span class="type">void</span> sendMessage() {
    <span class="keyword">try</span> {
        <span class="predefined-type">String</span> text = <span class="string"><span class="delimiter">&quot;</span><span class="content">Message from producer: </span><span class="delimiter">&quot;</span></span> + messageText;
        context.createProducer().send(queue, text);

        FacesMessage facesMessage =
                <span class="keyword">new</span> FacesMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">Sent message: </span><span class="delimiter">&quot;</span></span> + text);
        FacesContext.getCurrentInstance().addMessage(<span class="predefined-constant">null</span>, facesMessage);
    } <span class="keyword">catch</span> (<span class="predefined-type">Throwable</span> t) {
        logger.log(<span class="predefined-type">Level</span>.SEVERE,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">SenderBean.sendMessage: Exception: {0}</span><span class="delimiter">&quot;</span></span>,
                t.toString());
    }
}</code></pre>
</div>
</div>
</li>
<li>
<p><code>ReceiverBean.java</code>, a CDI managed bean with one business method,
<code>getMessage</code>. The method injects a <code>JMSContext</code> (using the default
connection factory) and the queue that was defined in <code>SenderBean</code>,
creates a consumer, receives the message, and creates a <code>FacesMessage</code>
to display on the Facelets page:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Inject</span>
<span class="directive">private</span> JMSContext context;
<span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:comp/jms/webappQueue</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="predefined-type">Queue</span> queue;
...
public <span class="type">void</span> getMessage() {
    <span class="keyword">try</span> {
        JMSConsumer receiver = context.createConsumer(queue);
        <span class="predefined-type">String</span> text = receiver.receiveBody(<span class="predefined-type">String</span>.class);

        <span class="keyword">if</span> (text != <span class="predefined-constant">null</span>) {
            FacesMessage facesMessage =
                    <span class="keyword">new</span> FacesMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">Reading message: </span><span class="delimiter">&quot;</span></span> + text);
            FacesContext.getCurrentInstance().addMessage(<span class="predefined-constant">null</span>, facesMessage);
        } <span class="keyword">else</span> {
            FacesMessage facesMessage =
                    <span class="keyword">new</span> FacesMessage(<span class="string"><span class="delimiter">&quot;</span><span class="content">No message received after 1 second</span><span class="delimiter">&quot;</span></span>);
            FacesContext.getCurrentInstance().addMessage(<span class="predefined-constant">null</span>, facesMessage);
        }
    } <span class="keyword">catch</span> (<span class="predefined-type">Throwable</span> t) {
        logger.log(<span class="predefined-type">Level</span>.SEVERE,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">ReceiverBean.getMessage: Exception: {0}</span><span class="delimiter">&quot;</span></span>,
                t.toString());
    }
}</code></pre>
</div>
</div>
</li>
</ul>
</div>
<div class="paragraph">
<p><a id="sthref217"></a><a id="running-the-websimplemessage-example"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_websimplemessage_example">2.6.3. Running the websimplemessage Example</h4>
<div class="paragraph">
<p>You can use either NetBeans IDE or Maven to build, package, deploy, and
run the <code>websimplemessage</code> application.</p>
</div>
<div class="paragraph">
<p><a id="CHDHEHAB"></a><a id="creating-resources-for-the-websimplemessage-example"></a></p>
</div>
<div class="sect4">
<h5 id="_creating_resources_for_the_websimplemessage_example">Creating Resources for the websimplemessage Example</h5>
<div class="paragraph">
<p>This example uses an annotation-defined queue and the preconfigured
default connection factory <code>java:comp/DefaultJMSConnectionFactory</code>.</p>
</div>
<div class="paragraph">
<p><a id="CHDBADGA"></a><a id="to-package-and-deploy-websimplemessage-using-netbeans-ide"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_to_package_and_deploy_websimplemessage_using_netbeans_ide">To Package and Deploy websimplemessage Using NetBeans IDE</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>).</p>
</li>
<li>
<p>From the File menu, choose Open Project.</p>
</li>
<li>
<p>In the Open Project dialog box, navigate to:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/jms</code></pre>
</div>
</div>
</li>
<li>
<p>Select the <code>websimplemessage</code> folder.</p>
</li>
<li>
<p>Click Open Project.</p>
</li>
<li>
<p>In the Projects tab, right-click the <code>websimplemessage</code> project and
select Build.</p>
<div class="paragraph">
<p>This command builds and deploys the project.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="CHDBBBEI"></a><a id="to-package-and-deploy-websimplemessage-using-maven"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_to_package_and_deploy_websimplemessage_using_maven">To Package and Deploy websimplemessage Using Maven</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>).</p>
</li>
<li>
<p>In a terminal window, go to:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/jms/websimplemessage/</code></pre>
</div>
</div>
</li>
<li>
<p>To compile the source files and package and deploy the application,
use the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">mvn install</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="CHDIFEHC"></a><a id="to-run-the-websimplemessage-example"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_to_run_the_websimplemessage_example">To Run the websimplemessage Example</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In a web browser, enter the following URL:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">http:<span class="comment">//localhost:8080/websimplemessage</span></code></pre>
</div>
</div>
</li>
<li>
<p>Enter a message in the text field and click Send Message.</p>
<div class="paragraph">
<p>If, for example, you enter "Hello, Duke", the following appears below
the buttons:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Sent message: Message from producer: Hello, Duke</code></pre>
</div>
</div>
</li>
<li>
<p>Click Go to Receive Page.</p>
</li>
<li>
<p>Click Receive Message.</p>
<div class="paragraph">
<p>The following appears below the buttons:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Reading message: Message from producer: Hello, Duke</code></pre>
</div>
</div>
</li>
<li>
<p>Click Send Another Message to return to the sending page.</p>
</li>
<li>
<p>After you have finished running the application, undeploy it using
either the Services tab of NetBeans IDE or the <code>mvn cargo:undeploy</code>
command.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="BNBPK"></a><a id="receiving-messages-asynchronously-using-a-message-driven-bean"></a></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_receiving_messages_asynchronously_using_a_message_driven_bean">2.7. Receiving Messages Asynchronously Using a Message-Driven Bean</h3>
<div class="paragraph">
<p>If you are writing an application to run in the Jakarta EE application
client container or on the Java SE platform, and you want to receive
messages asynchronously, you need to define a class that implements the
<code>MessageListener</code> interface, create a <code>JMSConsumer</code>, and call the method
<code>setMessageListener</code>.</p>
</div>
<div class="paragraph">
<p>If you&#8217;re writing an application to run in the Jakarta EE web or enterprise bean
container and want it to receive messages asynchronously, you also need
to need to define a class that implements the <code>MessageListener</code>
interface. However, instead of creating a <code>JMSConsumer</code> and calling the
method <code>setMessageListener</code>, you must configure your message listener
class to be a message-driven bean. The application server will then take
care of the rest.</p>
</div>
<div class="paragraph">
<p>Message-driven beans can implement any messaging type. Most commonly,
however, they implement the Jakarta Messaging technology.</p>
</div>
<div class="paragraph">
<p>This section describes a simple message-driven bean example. Before
proceeding, you should read the basic conceptual information in the
section <a href="#GIPKO">What Is a Message-Driven Bean?</a> as
well as <a href="#BNCGQ">Using Message-Driven Beans to
Receive Messages Asynchronously</a>.</p>
</div>
<div class="paragraph">
<p><a id="BNBPL"></a><a id="overview-of-the-simplemessage-example"></a></p>
</div>
<div class="sect3">
<h4 id="_overview_of_the_simplemessage_example">2.7.1. Overview of the simplemessage Example</h4>
<div class="paragraph">
<p>The <code>simplemessage</code> application has the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>SimpleMessageClient</code>: An application client that sends several
messages to a queue</p>
</li>
<li>
<p><code>SimpleMessageBean</code>: A message-driven bean that asynchronously
processes the messages that are sent to the queue</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><a href="#BNBPM">Figure 49-3</a> illustrates the structure of this application.
The application client sends messages to the queue, which was created
administratively using the Administration Console. The Messaging provider (in
this case, GlassFish Server) delivers the messages to the instances of
the message-driven bean, which then processes the messages.</p>
</div>
<div id="BNBPM" class="paragraph">
<div class="title"><strong>Figure 49-3 The simplemessage Application</strong></div>
<p><span class="image"><img src="../images/jakartaeett_dt_036.png" alt="Diagram of application showing an application client sending a message to a queue, and the message being delivered to a message-driven bean"></span></p>
</div>
<div class="paragraph">
<p>The source code for this application is in the
tut-install`/examples/jms/simplemessage/` directory.</p>
</div>
<div class="paragraph">
<p><a id="BNBPN"></a><a id="the-simplemessage-application-client"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_the_simplemessage_application_client">2.7.2. The simplemessage Application Client</h4>
<div class="paragraph">
<p>The <code>SimpleMessageClient</code> sends messages to the queue that the
<code>SimpleMessageBean</code> listens to. The client starts by injecting the
connection factory and queue resources:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:comp/DefaultJMSConnectionFactory</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="directive">static</span> ConnectionFactory connectionFactory;

<span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">jms/MyQueue</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="directive">static</span> <span class="predefined-type">Queue</span> queue;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, the client creates the <code>JMSContext</code> in a <code>try</code>-with-resources
block:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="predefined-type">String</span> text;
<span class="directive">final</span> <span class="type">int</span> NUM_MSGS = <span class="integer">3</span>;

<span class="keyword">try</span> (JMSContext context = connectionFactory.createContext();) {</code></pre>
</div>
</div>
<div class="paragraph">
<p>Finally, the client sends several text messages to the queue:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="keyword">for</span> (<span class="type">int</span> i = <span class="integer">0</span>; i &lt; NUM_MSGS; i++) {
    text = <span class="string"><span class="delimiter">&quot;</span><span class="content">This is message </span><span class="delimiter">&quot;</span></span> + (i + <span class="integer">1</span>);
    <span class="predefined-type">System</span>.out.println(<span class="string"><span class="delimiter">&quot;</span><span class="content">Sending message: </span><span class="delimiter">&quot;</span></span> + text);
    context.createProducer().send(queue, text);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBPO"></a><a id="the-simplemessage-message-driven-bean-class"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_the_simplemessage_message_driven_bean_class">2.7.3. The simplemessage Message-Driven Bean Class</h4>
<div class="paragraph">
<p>The code for the <code>SimpleMessageBean</code> class illustrates the requirements
of a message-driven bean class described in
<a href="#BNCGQ">Using Message-Driven Beans to Receive
Messages Asynchronously</a>.</p>
</div>
<div class="paragraph">
<p>The first few lines of the <code>SimpleMessageBean</code> class use the
<code>@MessageDriven</code> annotation&#8217;s <code>activationConfig</code> attribute to specify
configuration properties:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@MessageDriven</span>(activationConfig = {
    <span class="annotation">@ActivationConfigProperty</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">destinationLookup</span><span class="delimiter">&quot;</span></span>,
            propertyValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">jms/MyQueue</span><span class="delimiter">&quot;</span></span>),
    <span class="annotation">@ActivationConfigProperty</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">destinationType</span><span class="delimiter">&quot;</span></span>,
            propertyValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">javax.jms.Queue</span><span class="delimiter">&quot;</span></span>)
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>See <a href="#GJKOH">Table 48-3</a> for a list of the
available properties.</p>
</div>
<div class="paragraph">
<p>See <a href="#BNCGW">Sending Messages from a Session Bean
to an MDB</a> for examples of the <code>subscriptionDurability</code>, <code>clientId</code>,
<code>subscriptionName</code>, and <code>messageSelector</code> properties.</p>
</div>
<div class="paragraph">
<p><a id="BNBPP"></a><a id="the-onmessage-method"></a></p>
</div>
<div class="sect4">
<h5 id="_the_onmessage_method">The onMessage Method</h5>
<div class="paragraph">
<p>When the queue receives a message, the enterprise bean container invokes the message
listener method or methods. For a bean that uses Jakarta Messaging, this is the
<code>onMessage</code> method of the <code>MessageListener</code> interface.</p>
</div>
<div class="paragraph">
<p>In the <code>SimpleMessageBean</code> class, the <code>onMessage</code> method casts the
incoming message to a <code>TextMessage</code> and displays the text:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="directive">public</span> <span class="type">void</span> onMessage(Message inMessage) {

    <span class="keyword">try</span> {
        <span class="keyword">if</span> (inMessage <span class="keyword">instanceof</span> TextMessage) {
            logger.log(<span class="predefined-type">Level</span>.INFO,
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">MESSAGE BEAN: Message received: {0}</span><span class="delimiter">&quot;</span></span>,
                    inMessage.getBody(<span class="predefined-type">String</span>.class));
        } <span class="keyword">else</span> {
            logger.log(<span class="predefined-type">Level</span>.WARNING,
                    <span class="string"><span class="delimiter">&quot;</span><span class="content">Message of wrong type: {0}</span><span class="delimiter">&quot;</span></span>,
                    inMessage.getClass().getName());
        }
    } <span class="keyword">catch</span> (JMSException e) {
        logger.log(<span class="predefined-type">Level</span>.SEVERE,
                <span class="string"><span class="delimiter">&quot;</span><span class="content">SimpleMessageBean.onMessage: JMSException: {0}</span><span class="delimiter">&quot;</span></span>,
                e.toString());
        mdc.setRollbackOnly();
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="BNBPQ"></a><a id="running-the-simplemessage-example"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_simplemessage_example">2.7.4. Running the simplemessage Example</h4>
<div class="paragraph">
<p>You can use either NetBeans IDE or Maven to build, deploy, and run the
<code>simplemessage</code> example.</p>
</div>
<div class="paragraph">
<p><a id="BNBPR"></a><a id="creating-resources-for-the-simplemessage-example"></a></p>
</div>
<div class="sect4">
<h5 id="_creating_resources_for_the_simplemessage_example">Creating Resources for the simplemessage Example</h5>
<div class="paragraph">
<p>This example uses the queue named <code>jms/MyQueue</code> and the preconfigured
default connection factory <code>java:comp/DefaultJMSConnectionFactory</code>.</p>
</div>
<div class="paragraph">
<p>If you have run the simple Jakarta Messaging examples in
<a href="#BNCFA">Writing Simple Jakarta Messaging Applications</a> and have
not deleted the resources, you already have the queue. Otherwise, follow
the instructions in <a href="#BABHEFCB">To Create
Resources for the Simple Examples</a> to create it.</p>
</div>
<div class="paragraph">
<p>For more information on creating Messaging resources, see
<a href="#GKTJS">Creating Jakarta Messaging Administered Objects</a>.</p>
</div>
<div class="paragraph">
<p><a id="CHDFBDDA"></a><a id="to-run-the-simplemessage-example-using-netbeans-ide"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_to_run_the_simplemessage_example_using_netbeans_ide">To Run the simplemessage Example Using NetBeans IDE</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>).</p>
</li>
<li>
<p>From the File menu, choose Open Project.</p>
</li>
<li>
<p>In the Open Project dialog box, navigate to:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/jms/simplemessage</code></pre>
</div>
</div>
</li>
<li>
<p>Select the <code>simplemessage</code> folder.</p>
</li>
<li>
<p>Make sure that the Open Required Projects check box is selected,
then click Open Project.</p>
</li>
<li>
<p>In the Projects tab, right-click the <code>simplemessage</code> project and
select Build. (If NetBeans IDE suggests that you run a priming build,
click the box to do so.)</p>
<div class="paragraph">
<p>This command packages the application client and the message-driven
bean, then creates a file named <code>simplemessage.ear</code> in the
<code>simplemessage-ear/target/</code> directory. It then deploys the
<code>simplemessage-ear</code> module, retrieves the client stubs, and runs the
application client.</p>
</div>
<div class="paragraph">
<p>The output in the output window looks like this (preceded by application
client container output):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Sending message: This is message <span class="integer">1</span>
Sending message: This is message <span class="integer">2</span>
Sending message: This is message <span class="integer">3</span>
To see <span class="keyword">if</span> the bean received the messages,
 check &lt;install_dir&gt;/domains/domain1/logs/server.log.</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the server log file, lines similar to the following appear:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">MESSAGE BEAN: Message received: This is message <span class="integer">1</span>
MESSAGE BEAN: Message received: This is message <span class="integer">2</span>
MESSAGE BEAN: Message received: This is message <span class="integer">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The received messages may appear in a different order from the order in
which they were sent.</p>
</div>
</li>
<li>
<p>After you have finished running the application, undeploy it using
the Services tab.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="BNBPT"></a><a id="to-run-the-simplemessage-example-using-maven"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_to_run_the_simplemessage_example_using_maven">To Run the simplemessage Example Using Maven</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>).</p>
</li>
<li>
<p>In a terminal window, go to:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/jms/simplemessage/</code></pre>
</div>
</div>
</li>
<li>
<p>To compile the source files and package the application, use the
following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">mvn install</code></pre>
</div>
</div>
<div class="paragraph">
<p>This target packages the application client and the message-driven bean,
then creates a file named <code>simplemessage.ear</code> in the
<code>simplemessage-ear/target/</code> directory. It then deploys the
<code>simplemessage-ear</code> module, retrieves the client stubs, and runs the
application client.</p>
</div>
<div class="paragraph">
<p>The output in the terminal window looks like this (preceded by
application client container output):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">Sending message: This is message <span class="integer">1</span>
Sending message: This is message <span class="integer">2</span>
Sending message: This is message <span class="integer">3</span>
To see <span class="keyword">if</span> the bean received the messages,
 check &lt;install_dir&gt;/domains/domain1/logs/server.log.</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the server log file, lines similar to the following appear:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">MESSAGE BEAN: Message received: This is message <span class="integer">1</span>
MESSAGE BEAN: Message received: This is message <span class="integer">2</span>
MESSAGE BEAN: Message received: This is message <span class="integer">3</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The received messages may appear in a different order from the order in
which they were sent.</p>
</div>
</li>
<li>
<p>After you have finished running the application, undeploy it using
the <code>mvn cargo:undeploy</code> command.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="BNCGW"></a><a id="sending-messages-from-a-session-bean-to-an-mdb"></a></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_sending_messages_from_a_session_bean_to_an_mdb">2.8. Sending Messages from a Session Bean to an MDB</h3>
<div class="paragraph">
<p>This section explains how to write, compile, package, deploy, and run an
application that uses Jakarta Messaging in conjunction with a session bean.
The application contains the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An application client that invokes a session bean</p>
</li>
<li>
<p>A session bean that publishes several messages to a topic</p>
</li>
<li>
<p>A message-driven bean that receives and processes the messages using a
durable topic subscription and a message selector</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You will find the source files for this section in the
tut-install`/examples/jms/clientsessionmdb/` directory. Path names in
this section are relative to this directory.</p>
</div>
<div class="paragraph">
<p><a id="BNCGX"></a><a id="writing-the-application-components-for-the-clientsessionmdb-example"></a></p>
</div>
<div class="sect3">
<h4 id="_writing_the_application_components_for_the_clientsessionmdb_example">2.8.1. Writing the Application Components for the clientsessionmdb Example</h4>
<div class="paragraph">
<p>This application demonstrates how to send messages from an enterprise
bean (in this case, a session bean) rather than from an application
client, as in the example in <a href="#BNBPK">Receiving
Messages Asynchronously Using a Message-Driven Bean</a>. <a href="#BNCGY">Figure
49-4</a> illustrates the structure of this application. Sending messages
from an enterprise bean is very similar to sending messages from a
managed bean, which was shown in
<a href="#BABBABFC">Sending and Receiving Messages Using a
Simple Web Application</a>.</p>
</div>
<div id="BNCGY" class="paragraph">
<div class="title"><strong>Figure 49-4 An Enterprise Bean Application: Client to Session Bean to Message-Driven Bean</strong></div>
<p><span class="image"><img src="../images/jakartaeett_dt_037.png" alt="Diagram of application showing an application client calling a session bean, which sends messages that are processed by a message-driven bean"></span></p>
</div>
<div class="paragraph">
<p>The Publisher enterprise bean in this example is the
enterprise-application equivalent of a wire-service news feed that
categorizes news events into six news categories. The message-driven
bean could represent a newsroom, where the sports desk, for example,
would set up a subscription for all news events pertaining to sports.</p>
</div>
<div class="paragraph">
<p>The application client in the example injects the Publisher enterprise
bean&#8217;s remote home interface and then calls the bean&#8217;s business method.
The enterprise bean creates 18 text messages. For each message, it sets
a <code>String</code> property randomly to one of six values representing the news
categories and then publishes the message to a topic. The message-driven
bean uses a message selector for the property to limit which of the
published messages will be delivered to it.</p>
</div>
<div class="paragraph">
<p><a id="BNCGZ"></a><a id="coding-the-application-client-myappclient.java"></a></p>
</div>
<div class="sect4">
<h5 id="_coding_the_application_client_myappclient_java">Coding the Application Client: MyAppClient.java</h5>
<div class="paragraph">
<p>The application client, <code>MyAppClient.java</code>, found under
<code>clientsessionmdb-app-client</code>, performs no Messaging operations and so is
simpler than the client in <a href="#BNBPK">Receiving
Messages Asynchronously Using a Message-Driven Bean</a>. The client uses
dependency injection to obtain the Publisher enterprise bean&#8217;s business
interface:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@EJB</span>(name=<span class="string"><span class="delimiter">&quot;</span><span class="content">PublisherRemote</span><span class="delimiter">&quot;</span></span>)
<span class="directive">private</span> <span class="directive">static</span> PublisherRemote publisher;</code></pre>
</div>
</div>
<div class="paragraph">
<p>The client then calls the bean&#8217;s business method twice.</p>
</div>
<div class="paragraph">
<p><a id="BNCHA"></a><a id="coding-the-publisher-session-bean"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_coding_the_publisher_session_bean">Coding the Publisher Session Bean</h5>
<div class="paragraph">
<p>The Publisher bean is a stateless session bean that has one business
method. The Publisher bean uses a remote interface rather than a local
interface because it is accessed from the application client.</p>
</div>
<div class="paragraph">
<p>The remote interface, <code>PublisherRemote.java</code>, found under
<code>clientsessionmdb-ejb</code>, declares a single business method,
<code>publishNews</code>.</p>
</div>
<div class="paragraph">
<p>The bean class, <code>PublisherBean.java</code>, also found under
<code>clientsessionmdb-ejb</code>, implements the <code>publishNews</code> method and its
helper method <code>chooseType</code>. The bean class injects <code>SessionContext</code> and
<code>Topic</code> resources (the topic is defined in the message-driven bean). It
then injects a <code>JMSContext</code>, which uses the preconfigured default
connection factory unless you specify otherwise. The bean class begins
as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Stateless</span>
<span class="annotation">@Remote</span>({
    PublisherRemote.class
})
<span class="directive">public</span> <span class="type">class</span> <span class="class">PublisherBean</span> <span class="directive">implements</span> PublisherRemote {

    <span class="annotation">@Resource</span>
    <span class="directive">private</span> SessionContext sc;
    <span class="annotation">@Resource</span>(lookup = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:module/jms/newsTopic</span><span class="delimiter">&quot;</span></span>)
    <span class="directive">private</span> Topic topic;
    <span class="annotation">@Inject</span>
    <span class="directive">private</span> JMSContext context;
    ...</code></pre>
</div>
</div>
<div class="paragraph">
<p>The business method <code>publishNews</code> creates a <code>JMSProducer</code> and publishes
the messages.</p>
</div>
<div class="paragraph">
<p><a id="BNCHB"></a><a id="coding-the-message-driven-bean-messagebean.java"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_coding_the_message_driven_bean_messagebean_java">Coding the Message-Driven Bean: MessageBean.java</h5>
<div class="paragraph">
<p>The message-driven bean class, <code>MessageBean.java</code>, found under
<code>clientsessionmdb-ejb</code>, is almost identical to the one in
<a href="#BNBPK">Receiving Messages Asynchronously Using a
Message-Driven Bean</a>. However, the <code>@MessageDriven</code> annotation is
different, because instead of a queue, the bean is using a topic, a
durable subscription, and a message selector. The bean defines a topic
for the use of the application; the definition uses the <code>java:module</code>
scope because both the session bean and the message-driven bean are in
the same module. Because the destination is defined in the
message-driven bean, the <code>@MessageDriven</code> annotation uses the
<code>destinationLookup</code> activation config property. (See
<a href="#BABHFBDH">Creating Resources for Jakarta EE
Applications</a> for more information.) The annotation also sets the
activation config properties <code>messageSelector</code>,
<code>subscriptionDurability</code>, <code>clientId</code>, and <code>subscriptionName</code>, as
follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@JMSDestinationDefinition</span>(
        name = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:module/jms/newsTopic</span><span class="delimiter">&quot;</span></span>,
        interfaceName = <span class="string"><span class="delimiter">&quot;</span><span class="content">javax.jms.Topic</span><span class="delimiter">&quot;</span></span>,
        destinationName = <span class="string"><span class="delimiter">&quot;</span><span class="content">PhysicalNewsTopic</span><span class="delimiter">&quot;</span></span>)
<span class="annotation">@MessageDriven</span>(activationConfig = {
    <span class="annotation">@ActivationConfigProperty</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">destinationLookup</span><span class="delimiter">&quot;</span></span>,
            propertyValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">java:module/jms/newsTopic</span><span class="delimiter">&quot;</span></span>),
    <span class="annotation">@ActivationConfigProperty</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">destinationType</span><span class="delimiter">&quot;</span></span>,
            propertyValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">javax.jms.Topic</span><span class="delimiter">&quot;</span></span>),
    <span class="annotation">@ActivationConfigProperty</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">messageSelector</span><span class="delimiter">&quot;</span></span>,
            propertyValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">NewsType = 'Sports' OR NewsType = 'Opinion'</span><span class="delimiter">&quot;</span></span>),
    <span class="annotation">@ActivationConfigProperty</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">subscriptionDurability</span><span class="delimiter">&quot;</span></span>,
            propertyValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">Durable</span><span class="delimiter">&quot;</span></span>),
    <span class="annotation">@ActivationConfigProperty</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">clientId</span><span class="delimiter">&quot;</span></span>,
            propertyValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">MyID</span><span class="delimiter">&quot;</span></span>),
    <span class="annotation">@ActivationConfigProperty</span>(propertyName = <span class="string"><span class="delimiter">&quot;</span><span class="content">subscriptionName</span><span class="delimiter">&quot;</span></span>,
            propertyValue = <span class="string"><span class="delimiter">&quot;</span><span class="content">MySub</span><span class="delimiter">&quot;</span></span>)
})</code></pre>
</div>
</div>
<div class="paragraph">
<p>The topic is the one defined in the <code>PublisherBean</code>. The message
selector in this case represents both the sports and opinion desks, just
to demonstrate the syntax of message selectors.</p>
</div>
<div class="paragraph">
<p>The Jakarta Messaging resource adapter uses these properties to create a connection
factory for the message-driven bean that allows the bean to use a
durable subscription.</p>
</div>
<div class="paragraph">
<p><a id="CHDDFAHA"></a><a id="running-the-clientsessionmdb-example"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_clientsessionmdb_example">2.8.2. Running the clientsessionmdb Example</h4>
<div class="paragraph">
<p>You can use either NetBeans IDE or Maven to build, deploy, and run the
<code>simplemessage</code> example.</p>
</div>
<div class="paragraph">
<p>This example uses an annotation-defined topic and the preconfigured
default connection factory <code>java:comp/DefaultJMSConnectionFactory</code>, so
you do not have to create resources for it.</p>
</div>
<div class="paragraph">
<p><a id="CHDGGAIB"></a><a id="to-run-clientsessionmdb-using-netbeans-ide"></a></p>
</div>
<div class="sect4">
<h5 id="_to_run_clientsessionmdb_using_netbeans_ide">To Run clientsessionmdb Using NetBeans IDE</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>).</p>
</li>
<li>
<p>From the File menu, choose Open Project.</p>
</li>
<li>
<p>In the Open Project dialog box, navigate to:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/jms/clientsessionmdb</code></pre>
</div>
</div>
</li>
<li>
<p>Select the <code>clientsessionmdb</code> folder.</p>
</li>
<li>
<p>Make sure that the Open Required Projects check box is selected, then click Open Project.</p>
</li>
<li>
<p>In the Projects tab, right-click the <code>clientsessionmdb</code> project and select Build. (If NetBeans IDE suggests that you run a priming build, click the box to do so.)</p>
<div class="paragraph">
<p>This command creates the following:
.. An application client JAR file that contains the client class file and the session bean&#8217;s remote interface, along with a manifest file that specifies the main class and places the Jakarta Enterprise Beans JAR file in its classpath
.. An enterprise bean JAR file that contains both the session bean and the message-driven bean</p>
</div>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>An application EAR file that contains the two JAR files</p>
<div class="paragraph">
<p>The <code>clientsessionmdb.ear</code> file is created in the <code>clientsessionmdb-ear/target/</code> directory.</p>
</div>
<div class="paragraph">
<p>The command then deploys the EAR file, retrieves the client stubs, andruns the client.</p>
</div>
<div class="paragraph">
<p>The client displays these lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">To view the bean output,
 check &lt;install_dir&gt;/domains/domain1/logs/server.log.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output from the enterprise beans appears in the server log file. The Publisher session bean sends two sets of 18 messages numbered 0 through 17. Because of the message selector, the message-driven bean receives only the messages whose <code>NewsType</code> property is <code>Sports</code> or <code>Opinion</code>.</p>
</div>
</li>
</ol>
</div>
</li>
<li>
<p>Use the Services tab to undeploy the application after you have finished running it.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="CHDDDHBE"></a><a id="to-run-clientsessionmdb-using-maven"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_to_run_clientsessionmdb_using_maven">To Run clientsessionmdb Using Maven</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>).</p>
</li>
<li>
<p>Go to the following directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/jms/clientsessionmdb/</code></pre>
</div>
</div>
</li>
<li>
<p>To compile the source files and package, deploy, and run the
application, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">mvn install</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command creates the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An application client JAR file that contains the client class file and
the session bean&#8217;s remote interface, along with a manifest file that
specifies the main class and places the enterprise bean JAR file in its classpath</p>
</li>
<li>
<p>An enterprise bean JAR file that contains both the session bean and the
message-driven bean</p>
</li>
<li>
<p>An application EAR file that contains the two JAR files</p>
<div class="paragraph">
<p>The <code>clientsessionmdb.ear</code> file is created in the
<code>clientsessionmdb-ear/target/</code> directory.</p>
</div>
<div class="paragraph">
<p>The command then deploys the EAR file, retrieves the client stubs, and
runs the client.</p>
</div>
<div class="paragraph">
<p>The client displays these lines:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">To view the bean output,
 check &lt;install_dir&gt;/domains/domain1/logs/server.log.</code></pre>
</div>
</div>
<div class="paragraph">
<p>The output from the enterprise beans appears in the server log file. The
Publisher session bean sends two sets of 18 messages numbered 0 through 17. Because of the message selector, the message-driven bean receives only the messages whose <code>NewsType</code> property is <code>Sports</code> or <code>Opinion</code>.</p>
</div>
</li>
</ul>
</div>
</li>
<li>
<p>Undeploy the application after you have finished running it:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">mvn cargo:undeploy</code></pre>
</div>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="BNCHF"></a><a id="using-an-entity-to-join-messages-from-two-mdbs"></a></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_an_entity_to_join_messages_from_two_mdbs">2.9. Using an Entity to Join Messages from Two MDBs</h3>
<div class="paragraph">
<p>This section explains how to write, compile, package, deploy, and run an
application that uses the Jakarta Messaging with an entity. The application uses
the following components:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An application client that both sends and receives messages</p>
</li>
<li>
<p>Two message-driven beans</p>
</li>
<li>
<p>An entity class</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>You will find the source files for this section in the
tut-install`/examples/jms/clientmdbentity/` directory. Path names in
this section are relative to this directory.</p>
</div>
<div class="paragraph">
<p><a id="BNCHG"></a><a id="overview-of-the-clientmdbentity-example-application"></a></p>
</div>
<div class="sect3">
<h4 id="_overview_of_the_clientmdbentity_example_application">2.9.1. Overview of the clientmdbentity Example Application</h4>
<div class="paragraph">
<p>This application simulates, in a simplified way, the work flow of a
company&#8217;s human resources (HR) department when it processes a new hire.
This application also demonstrates how to use the Jakarta EE platform to
accomplish a task that many Messaging applications need to perform.</p>
</div>
<div class="paragraph">
<p>A messaging client must often wait for several messages from various
sources. It then uses the information in all these messages to assemble
a message that it then sends to another destination. The common term for
this design pattern (which is not specific to Jakarta Messaging) is joining messages.
Such a task must be transactional, with all the receives and the send as
a single transaction. If not all the messages are received successfully,
the transaction can be rolled back. For an application client example
that illustrates this task, see <a href="#BNCGJ">Using
Local Transactions</a>.</p>
</div>
<div class="paragraph">
<p>A message-driven bean can process only one message at a time in a
transaction. To provide the ability to join messages, an application can
have the message-driven bean store the interim information in a Jakarta
Persistence entity. The entity can then determine whether all the
information has been received; when it has, the entity can report this
back to one of the message-driven beans, which then creates and sends
the message to the other destination. After it has completed its task,
the entity can be removed.</p>
</div>
<div class="paragraph">
<p>The basic steps of the application are as follows.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The HR department&#8217;s application client generates an employee ID for
each new hire and then publishes a message (M1) containing the new
hire&#8217;s name, employee ID, and position. It publishes the message to a
topic because the message needs to be consumed by two message-driven
beans. The client then creates a temporary queue, <code>ReplyQueue</code>, with a
message listener that waits for a reply to the message. (See
<a href="#BNCGB">Creating Temporary Destinations</a> for more
information.)</p>
</li>
<li>
<p>Two message-driven beans process each message: One bean,
<code>OfficeMDB</code>, assigns the new hire&#8217;s office number, and the other bean,
<code>EquipmentMDB</code>, assigns the new hire&#8217;s equipment. The first bean to
process the message creates and persists an entity named <code>SetupOffice</code>,
then calls a business method of the entity to store the information it
has generated. The second bean locates the existing entity and calls
another business method to add its information.</p>
</li>
<li>
<p>When both the office and the equipment have been assigned, the
entity business method returns a value of <code>true</code> to the message-driven
bean that called the method. The message-driven bean then sends to the
reply queue a message (M2) describing the assignments. Then it removes
the entity. The application client&#8217;s message listener retrieves the
information.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><a href="#BNCHH">Figure 49-5</a> illustrates the structure of this application.
Of course, an actual HR application would have more components; other
beans could set up payroll and benefits records, schedule orientation,
and so on.</p>
</div>
<div class="paragraph">
<p><a href="#BNCHH">Figure 49-5</a> assumes that <code>OfficeMDB</code> is the first
message-driven bean to consume the message from the client. <code>OfficeMDB</code>
then creates and persists the <code>SetupOffice</code> entity and stores the office
information. <code>EquipmentMDB</code> then finds the entity, stores the equipment
information, and learns that the entity has completed its work.
<code>EquipmentMDB</code> then sends the message to the reply queue and removes the
entity.</p>
</div>
<div id="BNCHH" class="paragraph">
<div class="title"><strong>Figure 49-5 An Enterprise Bean Application: Client to Message-Driven Beans to Entity</strong></div>
<p><span class="image"><img src="../images/jakartaeett_dt_038.png" alt="Diagram of application showing an application client, two message-driven beans, and an entity, as well as the associated topic and queue"></span></p>
</div>
<div class="paragraph">
<p><a id="BNCHI"></a><a id="writing-the-application-components-for-the-clientmdbentity-example"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_writing_the_application_components_for_the_clientmdbentity_example">2.9.2. Writing the Application Components for the clientmdbentity Example</h4>
<div class="paragraph">
<p>Writing the components of the application involves coding the
application client, the message-driven beans, and the entity class.</p>
</div>
<div class="paragraph">
<p><a id="BNCHJ"></a><a id="coding-the-application-client-humanresourceclient.java"></a></p>
</div>
<div class="sect4">
<h5 id="_coding_the_application_client_humanresourceclient_java">Coding the Application Client: HumanResourceClient.java</h5>
<div class="paragraph">
<p>The application client, <code>HumanResourceClient.java</code>, found under
<code>clientmdbentity-app-client</code>, performs the following steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Defines a topic for the application, using the <code>java:app</code> namespace
because the topic is used in both the application client and the Jakarta Enterprise Beans
module</p>
</li>
<li>
<p>Injects <code>ConnectionFactory</code> and <code>Topic</code> resources</p>
</li>
<li>
<p>Creates a <code>TemporaryQueue</code> to receive notification of processing
that occurs, based on new-hire events it has published</p>
</li>
<li>
<p>Creates a <code>JMSConsumer</code> for the <code>TemporaryQueue</code>, sets the
`JMSConsumer&#8217;s message listener, and starts the connection</p>
</li>
<li>
<p>Creates a <code>MapMessage</code></p>
</li>
<li>
<p>Creates five new employees with randomly generated names, positions,
and ID numbers (in sequence) and publishes five messages containing this
information</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The message listener, <code>HRListener</code>, waits for messages that contain the
assigned office and equipment for each employee. When a message arrives,
the message listener displays the information received and determines
whether all five messages have arrived. When they have, the message
listener notifies the <code>main</code> method, which then exits.</p>
</div>
<div class="paragraph">
<p><a id="BNCHK"></a><a id="coding-the-message-driven-beans-for-the-clientmdbentity-example"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_coding_the_message_driven_beans_for_the_clientmdbentity_example">Coding the Message-Driven Beans for the clientmdbentity Example</h5>
<div class="paragraph">
<p>This example uses two message-driven beans, both under
<code>clientmdbentity-ejb</code>:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>EquipmentMDB.java</code></p>
</li>
<li>
<p><code>OfficeMDB.java</code></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The beans take the following steps.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>They inject a <code>MessageDrivenContext</code> resource, an <code>EntityManager</code>,
and a <code>JMSContext</code>.</p>
</li>
<li>
<p>The <code>onMessage</code> method retrieves the information in the message. The
<code>EquipmentMDB&#8217;s `onMessage</code> method chooses equipment, based on the new
hire&#8217;s position; the <code>OfficeMDB&#8217;s `onMessage</code> method randomly generates
an office number.</p>
</li>
<li>
<p>After a slight delay to simulate real world processing hitches, the
<code>onMessage</code> method calls a helper method, <code>compose</code>.</p>
</li>
<li>
<p>The <code>compose</code> method takes the following steps.</p>
<div class="olist loweralpha">
<ol class="loweralpha" type="a">
<li>
<p>It either creates and persists the <code>SetupOffice</code> entity or finds it
by primary key.</p>
</li>
<li>
<p>It uses the entity to store the equipment or the office information
in the database, calling either the <code>doEquipmentList</code> or the
<code>doOfficeNumber</code> business method.</p>
</li>
<li>
<p>If the business method returns <code>true</code>, meaning that all of the
information has been stored, it retrieves the reply destination
information from the message, creates a <code>JMSProducer</code>, and sends a reply
message that contains the information stored in the entity.</p>
</li>
<li>
<p>It removes the entity.</p>
</li>
</ol>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="BNCHL"></a><a id="coding-the-entity-class-for-the-clientmdbentity-example"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_coding_the_entity_class_for_the_clientmdbentity_example">Coding the Entity Class for the clientmdbentity Example</h5>
<div class="paragraph">
<p>The <code>SetupOffice.java</code> class, also under <code>clientmdbentity-ejb</code>, is an
entity class. The entity and the message-driven beans are packaged
together in an enterprise bean JAR file. The entity class is declared as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Entity</span>
<span class="directive">public</span> <span class="type">class</span> <span class="class">SetupOffice</span> <span class="directive">implements</span> <span class="predefined-type">Serializable</span> {</code></pre>
</div>
</div>
<div class="paragraph">
<p>The class contains a no-argument constructor and a constructor that
takes two arguments, the employee ID and name. It also contains getter
and setter methods for the employee ID, name, office number, and
equipment list. The getter method for the employee ID has the <code>@Id</code>
annotation to indicate that this field is the primary key:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java"><span class="annotation">@Id</span>
<span class="directive">public</span> <span class="predefined-type">String</span> getEmployeeId() {
    <span class="keyword">return</span> id;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The class also implements the two business methods, <code>doEquipmentList</code>
and <code>doOfficeNumber</code>, and their helper method, <code>checkIfSetupComplete</code>.</p>
</div>
<div class="paragraph">
<p>The message-driven beans call the business methods and the getter
methods.</p>
</div>
<div class="paragraph">
<p>The <code>persistence.xml</code> file for the entity specifies the most basic
settings:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="xml"><span class="preprocessor">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span>
<span class="tag">&lt;persistence</span> <span class="attribute-name">version</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">2.1</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">xmlns</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/persistence</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">xmlns:xsi</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://www.w3.org/2001/XMLSchema-instance</span><span class="delimiter">&quot;</span></span>
             <span class="attribute-name">xsi:schemaLocation</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">http://xmlns.jcp.org/xml/ns/persistence</span>
               <span class="content">http://xmlns.jcp.org/xml/ns/persistence/persistence_2_1.xsd</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
  <span class="tag">&lt;persistence-unit</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">clientmdbentity-ejbPU</span><span class="delimiter">&quot;</span></span> <span class="attribute-name">transaction-type</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">JTA</span><span class="delimiter">&quot;</span></span><span class="tag">&gt;</span>
    <span class="tag">&lt;provider&gt;</span>org.eclipse.persistence.jpa.PersistenceProvider<span class="tag">&lt;/provider&gt;</span>
    <span class="tag">&lt;jta-data-source&gt;</span>java:comp/DefaultDataSource<span class="tag">&lt;/jta-data-source&gt;</span>
    <span class="tag">&lt;properties&gt;</span>
      <span class="tag">&lt;property</span> <span class="attribute-name">name</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">eclipselink.ddl-generation</span><span class="delimiter">&quot;</span></span>
                <span class="attribute-name">value</span>=<span class="string"><span class="delimiter">&quot;</span><span class="content">drop-and-create-tables</span><span class="delimiter">&quot;</span></span><span class="tag">/&gt;</span>
    <span class="tag">&lt;/properties&gt;</span>
  <span class="tag">&lt;/persistence-unit&gt;</span>
<span class="tag">&lt;/persistence&gt;</span></code></pre>
</div>
</div>
<div class="paragraph">
<p><a id="CHDEEDJH"></a><a id="running-the-clientmdbentity-example"></a></p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_running_the_clientmdbentity_example">2.9.3. Running the clientmdbentity Example</h4>
<div class="paragraph">
<p>You can use either NetBeans IDE or Maven to build, deploy, and run the
<code>clientmdbentity</code> example.</p>
</div>
<div class="paragraph">
<p>Because the example defines its own application-private topic and uses
the preconfigured default connection factory
<code>java:comp/DefaultJMSConnectionFactory</code> and the preconfigured default
JDBC resource <code>java:comp/DefaultDataSource</code>, you do not need to create
resources for it.</p>
</div>
<div class="paragraph">
<p><a id="CHDIJDEE"></a><a id="to-run-clientmdbentity-using-netbeans-ide"></a></p>
</div>
<div class="sect4">
<h5 id="_to_run_clientmdbentity_using_netbeans_ide">To Run clientmdbentity Using NetBeans IDE</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>), as well as the database server (see
<a href="#BNADK">Starting and Stopping Apache Derby</a>).</p>
</li>
<li>
<p>From the File menu, choose Open Project.</p>
</li>
<li>
<p>In the Open Project dialog box, navigate to:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/jms/clientmdbentity</code></pre>
</div>
</div>
</li>
<li>
<p>Select the <code>clientmdbentity</code> folder.</p>
</li>
<li>
<p>Click Open Project.</p>
</li>
<li>
<p>In the Projects tab, right-click the <code>clientmdbentity</code> project and
select Build.</p>
<div class="paragraph">
<p>This command creates the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An application client JAR file that contains the client class and
listener class files, along with a manifest file that specifies the main
class</p>
</li>
<li>
<p>An enterprise bean JAR file that contains the message-driven beans and the entity
class, along with the <code>persistence.xml</code> file</p>
</li>
<li>
<p>An application EAR file that contains the two JAR files along with an
<code>application.xml</code> file</p>
<div class="paragraph">
<p>The <code>clientmdbentity.ear</code> file is created in the
<code>clientmdbentity-ear/target/</code> directory.</p>
</div>
<div class="paragraph">
<p>The command then deploys the EAR file, retrieves the client stubs, and
runs the application client.</p>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="CHDICHGH"></a><a id="to-run-clientmdbentity-using-maven"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_to_run_clientmdbentity_using_maven">To Run clientmdbentity Using Maven</h5>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Make sure that GlassFish Server has been started (see
<a href="#BNADI">Starting and Stopping GlassFish
Server</a>), as well as the database server (see
<a href="#BNADK">Starting and Stopping Apache Derby</a>).</p>
</li>
<li>
<p>Go to the following directory:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">tut-install/examples/jms/clientmdbentity/</code></pre>
</div>
</div>
</li>
<li>
<p>To compile the source files and package, deploy, and run the
application, enter the following command:</p>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">mvn install</code></pre>
</div>
</div>
<div class="paragraph">
<p>This command creates the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An application client JAR file that contains the client class and
listener class files, along with a manifest file that specifies the main
class</p>
</li>
<li>
<p>An enterprise bean JAR file that contains the message-driven beans and the entity
class, along with the <code>persistence.xml</code> file</p>
</li>
<li>
<p>An application EAR file that contains the two JAR files along with an
<code>application.xml</code> file</p>
<div class="paragraph">
<p>The command then deploys the application, retrieves the client stubs,
and runs the application client.</p>
</div>
</li>
</ul>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="CHDCDEEF"></a><a id="viewing-the-application-output"></a></p>
</div>
</div>
<div class="sect4">
<h5 id="_viewing_the_application_output">Viewing the Application Output</h5>
<div class="paragraph">
<p>The output in the NetBeans IDE output window or in the terminal window
looks something like this (preceded by application client container
output and Maven output):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="java">SENDER: Setting hire ID to <span class="integer">50</span>, name Bill Tudor, position Programmer
SENDER: Setting hire ID to <span class="integer">51</span>, name Carol Jones, position Senior Programmer
SENDER: Setting hire ID to <span class="integer">52</span>, name Mark Wilson, position Manager
SENDER: Setting hire ID to <span class="integer">53</span>, name Polly Wren, position Senior Programmer
SENDER: Setting hire ID to <span class="integer">54</span>, name Joe Lawrence, position Director
Waiting <span class="keyword">for</span> <span class="integer">5</span> message(s)
New hire event processed:
  Employee ID: <span class="integer">52</span>
  <span class="predefined-type">Name</span>: Mark Wilson
  Equipment: Tablet
  Office number: <span class="integer">294</span>
Waiting <span class="keyword">for</span> <span class="integer">4</span> message(s)
New hire event processed:
  Employee ID: <span class="integer">53</span>
  <span class="predefined-type">Name</span>: Polly Wren
  Equipment: Laptop
  Office number: <span class="integer">186</span>
Waiting <span class="keyword">for</span> <span class="integer">3</span> message(s)
New hire event processed:
  Employee ID: <span class="integer">54</span>
  <span class="predefined-type">Name</span>: Joe Lawrence
  Equipment: Mobile Phone
  Office number: <span class="integer">135</span>
Waiting <span class="keyword">for</span> <span class="integer">2</span> message(s)
New hire event processed:
  Employee ID: <span class="integer">50</span>
  <span class="predefined-type">Name</span>: Bill Tudor
  Equipment: Desktop <span class="predefined-type">System</span>
  Office number: <span class="integer">200</span>
Waiting <span class="keyword">for</span> <span class="integer">1</span> message(s)
New hire event processed:
  Employee ID: <span class="integer">51</span>
  <span class="predefined-type">Name</span>: Carol Jones
  Equipment: Laptop
  Office number: <span class="integer">262</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>The output from the message-driven beans and the entity class appears in
the server log.</p>
</div>
<div class="paragraph">
<p>For each employee, the application first creates the entity and then
finds it. You may see runtime errors in the server log, and transaction
rollbacks may occur. The errors occur if both of the message-driven
beans discover at the same time that the entity does not yet exist, so
they both try to create it. The first attempt succeeds, but the second
fails because the bean already exists. After the rollback, the second
message-driven bean tries again and succeeds in finding the entity.
Container-managed transactions allow the application to run correctly,
in spite of these errors, with no special programming.</p>
</div>
<div class="paragraph">
<p>To undeploy the application after you have finished running it, use the
Services tab or issue the <code>mvn cargo:undeploy</code> command.</p>
</div>
<div class="paragraph">
<p><a id="BABDFDJC"></a><a id="using-netbeans-ide-to-create-jms-resources"></a></p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_using_netbeans_ide_to_create_jakarta_messaging_resources">2.10. Using NetBeans IDE to Create Jakarta Messaging Resources</h3>
<div class="paragraph">
<p>When you write your own Messaging applications, you will need to create
resources for them. This section explains how to use NetBeans IDE to
create <code>src/main/setup/glassfish-resources.xml</code> files similar to those
used in the examples in this chapter. It also explains how to use
NetBeans IDE to delete the resources.</p>
</div>
<div class="paragraph">
<p>You can also create, list, and delete Jakarta Messaging resources using the
Administration Console or the <code>asadmin create-jms-resource</code>,
<code>asadmin list-jms-resources</code>, and <code>asadmin delete-jms-resources</code>
commands. For information, consult the GlassFish Server documentation or
enter <code>asadmin help</code> command-name.</p>
</div>
<div class="paragraph">
<p><a id="CHDFIJBJ"></a><a id="to-create-jms-resources-using-netbeans-ide"></a></p>
</div>
<div class="sect3">
<h4 id="_to_create_jakarta_messaging_resources_using_netbeans_ide">2.10.1. To Create Jakarta Messaging Resources Using NetBeans IDE</h4>
<div class="paragraph">
<p>Follow these steps to create a Jakarta Messaging resource in GlassFish Server using
NetBeans IDE. Repeat these steps for each resource you need.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Right-click the project for which you want to create resources and
select New, then select Other.</p>
</li>
<li>
<p>In the New File wizard, under Categories, select GlassFish.</p>
</li>
<li>
<p>Under File Types, select JMS Resource.</p>
</li>
<li>
<p>On the General Attributes - JMS Resource page, in the JNDI Name
field, enter the name of the resource.</p>
<div class="paragraph">
<p>By convention, Messaging resource names begin with <code>jms/</code>.</p>
</div>
</li>
<li>
<p>Select the option for the resource type.</p>
<div class="paragraph">
<p>Normally, this is either <code>javax.jms.Queue</code>, <code>javax.jms.Topic</code>, or
<code>javax.jms.ConnectionFactory</code>.</p>
</div>
</li>
<li>
<p>Click Next.</p>
</li>
<li>
<p>On the JMS Properties page, for a queue or topic, enter a name for a
physical queue in the Value field for the Name property.</p>
<div class="paragraph">
<p>You can enter any value for this required field.</p>
</div>
<div class="paragraph">
<p>Connection factories have no required properties. In a few situations,
you may need to specify a property.</p>
</div>
</li>
<li>
<p>Click Finish.</p>
<div class="paragraph">
<p>A file named <code>glassfish-resources.xml</code> is created in your Maven project,
in a directory named <code>src/main/setup/</code>. In the Projects tab, you can
find it under the Other Sources node. You will need to run the
<code>asadmin add-resources</code> command to create the resources in GlassFish
Server.</p>
</div>
</li>
</ol>
</div>
<div class="paragraph">
<p><a id="CHDCFADI"></a><a id="to-delete-jms-resources-using-netbeans-ide"></a></p>
</div>
</div>
<div class="sect3">
<h4 id="_to_delete_jakarta_messaging_resources_using_netbeans_ide">2.10.2. To Delete Jakarta Messaging Resources Using NetBeans IDE</h4>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>In the Services tab, expand the Servers node, then expand the
GlassFish Server node.</p>
</li>
<li>
<p>Expand the Resources node, then expand the Connector Resources node.</p>
</li>
<li>
<p>Expand the Admin Object Resources node.</p>
</li>
<li>
<p>Right-click any destination you want to remove and select
Unregister.</p>
</li>
<li>
<p>Expand the Connector Connection Pools node.</p>
</li>
<li>
<p>Right-click the connection pool that corresponds to the connection
factory you removed and select Unregister.</p>
<div class="paragraph">
<p>When you remove a connector connection pool, the associated connector
resource is also deleted. This action removes the connection factory.</p>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2021-01-08 17:03:44 UTC
</div>
</div>
<style>
/* Stylesheet for CodeRay to match GitHub theme | MIT License | http://foundation.zurb.com */
pre.CodeRay{background:#f7f7f8}
.CodeRay .line-numbers{border-right:1px solid currentColor;opacity:.35;padding:0 .5em 0 0}
.CodeRay span.line-numbers{display:inline-block;margin-right:.75em}
.CodeRay .line-numbers strong{color:#000}
table.CodeRay{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.CodeRay td{vertical-align:top;line-height:inherit}
table.CodeRay td.line-numbers{text-align:right}
table.CodeRay td.code{padding:0 0 0 .75em}
.CodeRay .debug{color:#fff !important;background:#000080 !important}
.CodeRay .annotation{color:#007}
.CodeRay .attribute-name{color:#000080}
.CodeRay .attribute-value{color:#700}
.CodeRay .binary{color:#509}
.CodeRay .comment{color:#998;font-style:italic}
.CodeRay .char{color:#04d}
.CodeRay .char .content{color:#04d}
.CodeRay .char .delimiter{color:#039}
.CodeRay .class{color:#458;font-weight:bold}
.CodeRay .complex{color:#a08}
.CodeRay .constant,.CodeRay .predefined-constant{color:#008080}
.CodeRay .color{color:#099}
.CodeRay .class-variable{color:#369}
.CodeRay .decorator{color:#b0b}
.CodeRay .definition{color:#099}
.CodeRay .delimiter{color:#000}
.CodeRay .doc{color:#970}
.CodeRay .doctype{color:#34b}
.CodeRay .doc-string{color:#d42}
.CodeRay .escape{color:#666}
.CodeRay .entity{color:#800}
.CodeRay .error{color:#808}
.CodeRay .exception{color:inherit}
.CodeRay .filename{color:#099}
.CodeRay .function{color:#900;font-weight:bold}
.CodeRay .global-variable{color:#008080}
.CodeRay .hex{color:#058}
.CodeRay .integer,.CodeRay .float{color:#099}
.CodeRay .include{color:#555}
.CodeRay .inline{color:#000}
.CodeRay .inline .inline{background:#ccc}
.CodeRay .inline .inline .inline{background:#bbb}
.CodeRay .inline .inline-delimiter{color:#d14}
.CodeRay .inline-delimiter{color:#d14}
.CodeRay .important{color:#555;font-weight:bold}
.CodeRay .interpreted{color:#b2b}
.CodeRay .instance-variable{color:#008080}
.CodeRay .label{color:#970}
.CodeRay .local-variable{color:#963}
.CodeRay .octal{color:#40e}
.CodeRay .predefined{color:#369}
.CodeRay .preprocessor{color:#579}
.CodeRay .pseudo-class{color:#555}
.CodeRay .directive{font-weight:bold}
.CodeRay .type{font-weight:bold}
.CodeRay .predefined-type{color:inherit}
.CodeRay .reserved,.CodeRay .keyword {color:#000;font-weight:bold}
.CodeRay .key{color:#808}
.CodeRay .key .delimiter{color:#606}
.CodeRay .key .char{color:#80f}
.CodeRay .value{color:#088}
.CodeRay .regexp .delimiter{color:#808}
.CodeRay .regexp .content{color:#808}
.CodeRay .regexp .modifier{color:#808}
.CodeRay .regexp .char{color:#d14}
.CodeRay .regexp .function{color:#404;font-weight:bold}
.CodeRay .string{color:#d20}
.CodeRay .string .string .string{background:#ffd0d0}
.CodeRay .string .content{color:#d14}
.CodeRay .string .char{color:#d14}
.CodeRay .string .delimiter{color:#d14}
.CodeRay .shell{color:#d14}
.CodeRay .shell .delimiter{color:#d14}
.CodeRay .symbol{color:#990073}
.CodeRay .symbol .content{color:#a60}
.CodeRay .symbol .delimiter{color:#630}
.CodeRay .tag{color:#008080}
.CodeRay .tag-special{color:#d70}
.CodeRay .variable{color:#036}
.CodeRay .insert{background:#afa}
.CodeRay .delete{background:#faa}
.CodeRay .change{color:#aaf;background:#007}
.CodeRay .head{color:#f8f;background:#505}
.CodeRay .insert .insert{color:#080}
.CodeRay .delete .delete{color:#800}
.CodeRay .change .change{color:#66f}
.CodeRay .head .head{color:#f4f}
</style>
</body>
</html>